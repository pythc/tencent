{"sql_id": "sql_6_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.06.12-2025.07.14手游 T2 活跃用户在 2025.05.31 之前端游注册的号码包。\n输出：vplayerid\n【表】dim_argothek_gplayerid2qqwxid_df, dws_argothek_ce1_cbt2_vplayerid_suserid_di\n【口径】手游活跃口径：dws_argothek_ce1_cbt2_vplayerid_suserid_di.itag = 'T2'\n端游注册时间：dim_argothek_gplayerid2qqwxid_df.iregdate < '20250531'\n所有日期统一使用字符串 YYYYMMDD"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH mobile_t2 AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate BETWEEN '20250614' AND '20250716'\n    AND itag = 'T2'\n),\npc_reg AS (\n  SELECT DISTINCT iuserid AS vplayerid\n  FROM dim_argothek_gplayerid2qqwxid_df\n  WHERE dtstatdate <= '20250531'\n    AND iregdate < '20250531'\n)\nSELECT DISTINCT m.vplayerid\nFROM mobile_t2 m\nJOIN pc_reg p\n  ON m.vplayerid = p.vplayerid\nORDER BY m.vplayerid\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH mobile_t2 AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate > '20250614'\n    AND itag = 'T2'\n),\npc_reg AS (\n  SELECT DISTINCT iuserid AS vplayerid\n  FROM dim_argothek_gplayerid2qqwxid_df\n  WHERE dtstatdate <= '20250531'\n    AND iregdate < '20250531'\n)\nSELECT DISTINCT m.vplayerid\nFROM mobile_t2 m\nJOIN pc_reg p\n  ON m.vplayerid = p.vplayerid\nORDER BY m.vplayerid\n) AS final_query;", "meta": {"origin": "sql_6", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_13_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20230712以来，历史累计活跃30天以上，但3月12日及以后未活跃过的用户且剔除掉历史充值 1500 元以上的用户后的玩家wxid\n输出：玩家wxid\n时间统计范围:20230715-20250615\n【表】dim_mgamejp_tbplayerid2wxid_nf, dws_argothek_oss_portaltransaction_di, dim_mgamejp_idconversion_wxid_qq_nf, dws_argothek_oss_login_di, dim_mgamejp_tbplayerid2qq_nf\n【口径】历史充值1500以上的用户：\nsum(ftranamt)/100 > 1500\n限制sappid in (\"qq\",\"wx\")"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH login_window AS (\n  SELECT\n    iuserid,\n    COUNT(DISTINCT statis_date) AS active_days,\n    MAX(statis_date) AS last_active_date\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20230715 AND 20250615\n  GROUP BY iuserid\n), qualified_login AS (\n  SELECT iuserid\n  FROM login_window\n  WHERE active_days >= 30\n    AND last_active_date < 20250315\n), pay_window AS (\n  SELECT\n    iuserid,\n    SUM(ftranamt) / 100.0 AS total_pay\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date BETWEEN '20230715' AND '20250615'\n  GROUP BY iuserid\n), filtered_user AS (\n  SELECT\n    q.iuserid,\n    COALESCE(p.total_pay, 0) AS total_pay\n  FROM qualified_login q\n  LEFT JOIN pay_window p\n    ON q.iuserid = p.iuserid\n  WHERE COALESCE(p.total_pay, 0) <= 1500\n), wxid_map AS (\n  SELECT\n    splayerid AS iuserid,\n    swxid\n  FROM dim_mgamejp_tbplayerid2wxid_nf\n  WHERE dtstatdate = 20250615\n    AND sappid IN ('qq', 'wx')\n    AND swxid IS NOT NULL\n)\nSELECT DISTINCT\n  m.swxid AS player_wxid\nFROM filtered_user f\nJOIN wxid_map m\n  ON f.iuserid = m.iuserid\nWHERE m.swxid <> ''\nORDER BY player_wxid\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH login_window AS (\n  SELECT\n    iuserid,\n    COUNT(DISTINCT statis_date) AS active_days,\n    MAX(statis_date) AS last_active_date\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20230715 AND 20250615\n  GROUP BY iuserid\n), qualified_login AS (\n  SELECT iuserid\n  FROM login_window\n  WHERE active_days >= 30\n    AND last_active_date < 20250315\n), pay_window AS (\n  SELECT\n    iuserid,\n    SUM(ftranamt) / 100.0 AS total_pay\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date > '20230715'\n  GROUP BY iuserid\n), filtered_user AS (\n  SELECT\n    q.iuserid,\n    COALESCE(p.total_pay, 0) AS total_pay\n  FROM qualified_login q\n  LEFT JOIN pay_window p\n    ON q.iuserid = p.iuserid\n  WHERE COALESCE(p.total_pay, 0) <= 1500\n), wxid_map AS (\n  SELECT\n    splayerid AS iuserid,\n    swxid\n  FROM dim_mgamejp_tbplayerid2wxid_nf\n  WHERE dtstatdate = 20250615\n    AND sappid IN ('qq', 'wx')\n    AND swxid IS NOT NULL\n)\nSELECT DISTINCT\n  m.swxid AS player_wxid\nFROM filtered_user f\nJOIN wxid_map m\n  ON f.iuserid = m.iuserid\nWHERE m.swxid <> ''\nORDER BY player_wxid\n) AS final_query;", "meta": {"origin": "sql_13", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_50_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.10.1-2024.10.31期间点击400211，点击400212，点击400211及400212的重合用户作为用户类型，看不同性别、砺刃活跃度和乐园活跃度情况\n\n输出：用户类型（400211、400212、400211&400212、other），游戏角色性别（male、female、other）、乐园活跃度（light、medium、heavy、other）、砺刃活跃度（light、medium、heavy、other），人数\n\n乐园跟砺刃的活跃度： 轻度1-4天；中度5-15天；重度>=16天\n【表】dws_jordass_matchlog_stat_di, dws_jordass_login_di, dwd_jordass_playerlogin_hi, dws_jordass_buttonpress_pre_di\n【口径】性别根据时间开窗取最新一条\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH base_players AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20241028' AND '20241127'\n    AND platid = 255\n), button_flags AS (\n  SELECT\n    vplayerid,\n    MAX(CASE WHEN buttontype = '400211' THEN 1 ELSE 0 END) AS clicked_400211,\n    MAX(CASE WHEN buttontype = '400212' THEN 1 ELSE 0 END) AS clicked_400212\n  FROM dws_jordass_buttonpress_pre_di\n  WHERE dtstatdate BETWEEN '20241028' AND '20241127'\n  GROUP BY vplayerid\n), user_type_base AS (\n  SELECT\n    b.vplayerid,\n    CASE\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400211&400212'\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 0 THEN '400211'\n      WHEN COALESCE(f.clicked_400211, 0) = 0 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400212'\n      ELSE 'other'\n    END AS user_type\n  FROM base_players b\n  LEFT JOIN button_flags f\n    ON b.vplayerid = f.vplayerid\n), gender_latest AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN gender = 1 THEN 'male'\n      WHEN gender = 2 THEN 'female'\n      ELSE 'other'\n    END AS gender_bucket\n  FROM (\n    SELECT\n      vplayerid,\n      gender,\n      ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n    FROM dwd_jordass_playerlogin_hi\n    WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y-%m-%d') <= '2024-11-27'\n  ) t\n  WHERE rn = 1\n), arena_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS arena_active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20241028' AND '20241127'\n    AND platid = 255\n  GROUP BY vplayerid\n), park_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS park_active_days\n  FROM dws_jordass_matchlog_stat_di\n  WHERE dtstatdate BETWEEN '20241028' AND '20241127'\n    AND platid = 255\n  GROUP BY vplayerid\n), enriched AS (\n  SELECT\n    u.vplayerid,\n    u.user_type,\n    COALESCE(g.gender_bucket, 'other') AS gender_bucket,\n    COALESCE(park_active_days, 0) AS park_days,\n    COALESCE(arena_active_days, 0) AS arena_days\n  FROM user_type_base u\n  LEFT JOIN gender_latest g\n    ON u.vplayerid = g.vplayerid\n  LEFT JOIN park_active p\n    ON u.vplayerid = p.vplayerid\n  LEFT JOIN arena_active a\n    ON u.vplayerid = a.vplayerid\n), final AS (\n  SELECT\n    user_type,\n    gender_bucket,\n    CASE\n      WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN park_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS park_active_level,\n    CASE\n      WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN arena_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS arena_active_level,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM enriched\n  GROUP BY user_type, gender_bucket,\n           CASE\n             WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN park_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END,\n           CASE\n             WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN arena_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END\n)\nSELECT\n  user_type,\n  gender_bucket,\n  park_active_level,\n  arena_active_level,\n  user_cnt\nFROM final\nORDER BY user_type, gender_bucket, park_active_level, arena_active_level;"}], "rejected": "WITH base_players AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate > '20241028'\n    AND platid = 255\n), button_flags AS (\n  SELECT\n    vplayerid,\n    MAX(CASE WHEN buttontype = '400211' THEN 1 ELSE 0 END) AS clicked_400211,\n    MAX(CASE WHEN buttontype = '400212' THEN 1 ELSE 0 END) AS clicked_400212\n  FROM dws_jordass_buttonpress_pre_di\n  WHERE dtstatdate BETWEEN '20241028' AND '20241127'\n  GROUP BY vplayerid\n), user_type_base AS (\n  SELECT\n    b.vplayerid,\n    CASE\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400211&400212'\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 0 THEN '400211'\n      WHEN COALESCE(f.clicked_400211, 0) = 0 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400212'\n      ELSE 'other'\n    END AS user_type\n  FROM base_players b\n  LEFT JOIN button_flags f\n    ON b.vplayerid = f.vplayerid\n), gender_latest AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN gender = 1 THEN 'male'\n      WHEN gender = 2 THEN 'female'\n      ELSE 'other'\n    END AS gender_bucket\n  FROM (\n    SELECT\n      vplayerid,\n      gender,\n      ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n    FROM dwd_jordass_playerlogin_hi\n    WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y-%m-%d') <= '2024-11-27'\n  ) t\n  WHERE rn = 1\n), arena_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS arena_active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20241028' AND '20241127'\n    AND platid = 255\n  GROUP BY vplayerid\n), park_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS park_active_days\n  FROM dws_jordass_matchlog_stat_di\n  WHERE dtstatdate BETWEEN '20241028' AND '20241127'\n    AND platid = 255\n  GROUP BY vplayerid\n), enriched AS (\n  SELECT\n    u.vplayerid,\n    u.user_type,\n    COALESCE(g.gender_bucket, 'other') AS gender_bucket,\n    COALESCE(park_active_days, 0) AS park_days,\n    COALESCE(arena_active_days, 0) AS arena_days\n  FROM user_type_base u\n  LEFT JOIN gender_latest g\n    ON u.vplayerid = g.vplayerid\n  LEFT JOIN park_active p\n    ON u.vplayerid = p.vplayerid\n  LEFT JOIN arena_active a\n    ON u.vplayerid = a.vplayerid\n), final AS (\n  SELECT\n    user_type,\n    gender_bucket,\n    CASE\n      WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN park_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS park_active_level,\n    CASE\n      WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN arena_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS arena_active_level,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM enriched\n  GROUP BY user_type, gender_bucket,\n           CASE\n             WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN park_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END,\n           CASE\n             WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN arena_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END\n)\nSELECT\n  user_type,\n  gender_bucket,\n  park_active_level,\n  arena_active_level,\n  user_cnt\nFROM final\nORDER BY user_type, gender_bucket, park_active_level, arena_active_level;", "meta": {"origin": "sql_50", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_28_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计各个玩法上线首周留存情况\n输出：玩法、上线首周首次玩的日期、第几天留存（0,1,2...7)、玩法留存用户数\n\n各玩法首周上线日期：\n\"广域战场\": \"20240816\",\n\"消灭战\": \"20230828\",\n\"幻想混战\": \"20241209\",\n\"荒野传说\": \"20240927\",\n\"策略载具\": \"20241103\",\n\"炎夏混战\": \"20240719\",\n\"单人装备\": \"20240610\",\n\"交叉堡垒\": \"20240506\"\n【表】dws_jordass_mode_roundrecord_di\n【口径】说明：\n广域战场 （2024/7/23）submodename= '广域战场模式'，\n消灭战（2023/8/4） modename='组队竞技' and submodename like '%消灭战模式%'，\n幻想混战（2024/12/09）modename='创意创作间' and submodename='幻想混战'，\n荒野传说（2024-09-27）modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')，\n策略载具（2024-11-03）modename='休闲模式' and submodename like '%策略载具%'，\n炎夏混战（2024-07-19）modename='创意创作间' and submodename like '%炎夏混战%'，\n单人装备（2024.5.17）modename='组队竞技' and submodename like '%单人装备%'，\n交叉堡垒（2024.4.12） modename='组队竞技' and submodename like '%交叉堡垒%'\n\n第几天留存：0表示当天参与、1表示当天参与在第2天也参与、2表示当天参与在第3天也参与，依此类推\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select  a.itype,\n        a.dtstatdate,\n        datediff(b.dtstatdate,a.dtstatdate) as idaynum,\n        count(distinct a.vplayerid)           as iusernum\nfrom (                      \n    select\n        itype,\n        min(dtstatdate) as dtstatdate,\n        vplayerid\n    from  (\n        select '广域战场'      as itype,\n                min(dtstatdate) as dtstatdate,\n                vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240816' and dtstatdate <= date_add('20240816',6)\n        and submodename = '广域战场模式'\n        group by vplayerid\n\n        union all\n        select '消灭战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230828' and dtstatdate <= date_add('20230828',6)\n        and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by vplayerid\n\n        union all\n        select '幻想混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241209' and dtstatdate <= date_add('20241209',6)\n        and modename='创意创作间' and submodename='幻想混战'\n        group by vplayerid\n\n        union all\n        select '荒野传说', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240927' and dtstatdate <= date_add('20240927',6)\n        and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by vplayerid\n\n        union all\n        select '策略载具', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241103' and dtstatdate <= date_add('20241103',6)\n        and modename='休闲模式' and submodename like '%策略载具%'\n        group by vplayerid\n\n        union all\n        select '炎夏混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240719' and dtstatdate <= date_add('20240719',6)\n        and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by vplayerid\n\n        union all\n        select '单人装备', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240610' and dtstatdate <= date_add('20240610',6)\n        and modename='组队竞技' and submodename like '%单人装备%'\n        group by vplayerid\n\n        union all\n        select '交叉堡垒', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240506' and dtstatdate <= date_add('20240506',6)\n        and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by vplayerid\n    ) t\n    group by itype, vplayerid\n) a\nleft join (\n        select '广域战场' as itype, dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240816' and dtstatdate <= date_add('20240816',13)\n          and submodename = '广域战场模式'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '消灭战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230828' and dtstatdate <= date_add('20230828',13)\n          and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '幻想混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241209' and dtstatdate <= date_add('20241209',13)\n          and modename='创意创作间' and submodename='幻想混战'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '荒野传说', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240927' and dtstatdate <= date_add('20240927',13)\n          and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by dtstatdate, vplayerid\n\n        union all\n        select '策略载具', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241103' and dtstatdate <= date_add('20241103',13)\n          and modename='休闲模式' and submodename like '%策略载具%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '炎夏混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240719' and dtstatdate <= date_add('20240719',13)\n          and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '单人装备', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240610' and dtstatdate <= date_add('20240610',13)\n          and modename='组队竞技' and submodename like '%单人装备%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '交叉堡垒', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240506' and dtstatdate <= date_add('20240506',13)\n          and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by dtstatdate, vplayerid\n) b\n  on  a.itype      = b.itype\nand  a.vplayerid    = b.vplayerid\nwhere datediff(b.dtstatdate,a.dtstatdate) between 0 and 7\ngroup by a.itype, a.dtstatdate, datediff(b.dtstatdate,a.dtstatdate);"}], "rejected": "select  a.itype,\n        a.dtstatdate,\n        datediff(b.dtstatdate,a.dtstatdate) as idaynum,\n        count(distinct a.vplayerid)           as iusernum\nfrom (                      \n    select\n        itype,\n        min(dtstatdate) as dtstatdate,\n        vplayerid\n    from  (\n        select '广域战场'      as itype,\n                min(dtstatdate) as dtstatdate,\n                vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240816' and dtstatdate <= date_add('20240816',6)\n        and submodename = '广域战场模式'\n        group by vplayerid\n\n        union all\n        select '消灭战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230828' and dtstatdate <= date_add('20230828',6)\n        and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by vplayerid\n\n        union all\n        select '幻想混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241209' and dtstatdate <= date_add('20241209',6)\n        and modename='创意创作间' and submodename='幻想混战'\n        group by vplayerid\n\n        union all\n        select '荒野传说', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240927' and dtstatdate <= date_add('20240927',6)\n        and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by vplayerid\n\n        union all\n        select '策略载具', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241103' and dtstatdate <= date_add('20241103',6)\n        and modename='休闲模式' and submodename like '%策略载具%'\n        group by vplayerid\n\n        union all\n        select '炎夏混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240719' and dtstatdate <= date_add('20240719',6)\n        and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by vplayerid\n\n        union all\n        select '单人装备', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240610' and dtstatdate <= date_add('20240610',6)\n        and modename='组队竞技' and submodename like '%单人装备%'\n        group by vplayerid\n\n        union all\n        select '交叉堡垒', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240506' and dtstatdate <= date_add('20240506',6)\n        and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by vplayerid\n    ) t\n    group by itype, vplayerid\n) a\nleft join (\n        select '广域战场' as itype, dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240816' and dtstatdate <= date_add('20240816',13)\n          and submodename = '广域战场模式'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '消灭战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230828' and dtstatdate <= date_add('20230828',13)\n          and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '幻想混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241209' and dtstatdate <= date_add('20241209',13)\n          and modename='创意创作间' and submodename='幻想混战'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '荒野传说', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240927' and dtstatdate <= date_add('20240927',13)\n          and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by dtstatdate, vplayerid\n\n        union all\n        select '策略载具', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241103' and dtstatdate <= date_add('20241103',13)\n          and modename='休闲模式' and submodename like '%策略载具%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '炎夏混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240719' and dtstatdate <= date_add('20240719',13)\n          and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '单人装备', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240610' and dtstatdate <= date_add('20240610',13)\n          and modename='组队竞技' and submodename like '%单人装备%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '交叉堡垒', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240506' and dtstatdate <= date_add('20240506',13)\n          and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by dtstatdate, vplayerid\n) b\n  on  a.itype      = b.itype\nand  a.vplayerid    = b.vplayerid\nwhere datediff(b.dtstatdate,a.dtstatdate) between 0 and 7\ngroup by a.itype, a.dtstatdate, datediff(b.dtstatdate,a.dtstatdate);", "meta": {"origin": "sql_28", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_2_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】提取1个抽样号码包，2025.07.19-2025.07.23期间付费且不包含721号码包内的用户全量。\n输出：gplayerid\n【表】dim_extract_311381_conf, dws_argothek_ce1_login_di, dws_argothek_ce1_cbt2_vplayerid_suserid_di, dws_jordass_water_di, dwd_jordass_privpackagelog_hi\n【口径】抽样号码包来源：dim_extract_311381_conf（字段 vplayerid）\n付费筛选：dws_jordass_water_di.dtstatdate 在 20250719-20250725，imoney > 0\n排除721号码包：dwd_jordass_privpackagelog_hi.packageid = 721\n渠道映射：dws_argothek_ce1_cbt2_vplayerid_suserid_di、dws_argothek_ce1_login_di\n所有日期使用字符串格式 YYYYMMDD"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH sample_user AS (\n  SELECT DISTINCT vplayerid\n  FROM dim_extract_311381_conf\n),\npaid_user AS (\n  SELECT vplayerid\n  FROM dws_jordass_water_di\n  WHERE dtstatdate BETWEEN '20250719' AND '20250725'\n    AND imoney > 0\n  GROUP BY vplayerid\n),\nexclude_721 AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_privpackagelog_hi\n  WHERE packageid = 721\n),\ntarget_user AS (\n  SELECT s.vplayerid\n  FROM sample_user s\n  JOIN paid_user p ON s.vplayerid = p.vplayerid\n  WHERE NOT EXISTS (\n    SELECT 1\n    FROM exclude_721 e\n    WHERE e.vplayerid = s.vplayerid\n  )\n)\nSELECT DISTINCT u.vplayerid AS gplayerid\nFROM target_user u\nJOIN dws_argothek_ce1_cbt2_vplayerid_suserid_di m\n  ON u.vplayerid = m.vplayerid\n AND m.dtstatdate BETWEEN '20250719' AND '20250725'\nJOIN dws_argothek_ce1_login_di l\n  ON u.vplayerid = l.vplayerid\n AND l.dtstatdate BETWEEN '20250719' AND '20250725'\n AND l.platid = 255\nORDER BY gplayerid\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH sample_user AS (\n  SELECT DISTINCT vplayerid\n  FROM dim_extract_311381_conf\n),\npaid_user AS (\n  SELECT vplayerid\n  FROM dws_jordass_water_di\n  WHERE dtstatdate > '20250719'\n    AND imoney > 0\n  GROUP BY vplayerid\n),\nexclude_721 AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_privpackagelog_hi\n  WHERE packageid = 721\n),\ntarget_user AS (\n  SELECT s.vplayerid\n  FROM sample_user s\n  JOIN paid_user p ON s.vplayerid = p.vplayerid\n  WHERE NOT EXISTS (\n    SELECT 1\n    FROM exclude_721 e\n    WHERE e.vplayerid = s.vplayerid\n  )\n)\nSELECT DISTINCT u.vplayerid AS gplayerid\nFROM target_user u\nJOIN dws_argothek_ce1_cbt2_vplayerid_suserid_di m\n  ON u.vplayerid = m.vplayerid\n AND m.dtstatdate BETWEEN '20250719' AND '20250725'\nJOIN dws_argothek_ce1_login_di l\n  ON u.vplayerid = l.vplayerid\n AND l.dtstatdate BETWEEN '20250719' AND '20250725'\n AND l.platid = 255\nORDER BY gplayerid\n) AS final_query;", "meta": {"origin": "sql_2", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_113_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20220425-20220508组竞商店购买情况\n输出：统计日期（YYYYMMDD），商店id，人数，次数\n【表】dwd_jordass_vsteamshoplog_hi\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(shopid as string) as shop_id,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as buy_cnt\nfrom dwd_jordass_vsteamshoplog_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20220430' and '20220513'\ngroup by substr(tdbank_imp_date, 1, 8), shopid\norder by stat_date, shop_id\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(shopid as string) as shop_id,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as buy_cnt\nfrom dwd_jordass_vsteamshoplog_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20220430'\ngroup by substr(tdbank_imp_date, 1, 8), shopid\norder by stat_date, shop_id\n) AS final_query;", "meta": {"origin": "sql_113", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_40_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】sql_40时间段2024.3.1-2024.6.30分月看用户当月在砺刃的 新进、回流、轻度留存、中度留存、重度留存\n\n输出：月份(202403、...、202406)、新进人数、回流人数、轻度留存人数、中度留存人数、重度留存人数\n【表】dws_jordass_login_di, dws_jordass_login_df\n【口径】新进：当月新进 \n回流：上个月未活跃的历史注册用户，在当月活跃\n轻度留存：留存用户（上个月活跃，本月也活跃的用户）在本月的活跃度1-4天\n中度留存：留存用户（上个月活跃，本月也活跃的用户）在本月的活跃度5-15天\n重度留存：留存用户（上个月活跃，本月也活跃的用户）在本月的活跃度16天及以上"}, {"role": "assistant", "content": "WITH base AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(dtstatdate, '%Y%m%d'), '%Y%m') AS stat_month,\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20240304' AND '20240703'\n    AND platid = 255\n  GROUP BY stat_month, vplayerid\n),\nmonth_info AS (\n  SELECT\n    b.stat_month,\n    b.vplayerid,\n    b.active_days,\n    MIN(b.stat_month) OVER (PARTITION BY b.vplayerid) AS first_month\n  FROM base b\n),\nprev_month_map AS (\n  SELECT\n    stat_month,\n    DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(stat_month, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m') AS prev_month\n  FROM (SELECT DISTINCT stat_month FROM base) t\n),\nclassified AS (\n  SELECT\n    m.stat_month,\n    m.vplayerid,\n    m.active_days,\n    CASE\n      WHEN m.stat_month = m.first_month THEN 'new'\n      WHEN prev.vplayerid IS NOT NULL THEN 'retained'\n      WHEN m.stat_month > m.first_month THEN 'return'\n      ELSE 'other'\n    END AS user_type\n  FROM month_info m\n  LEFT JOIN prev_month_map pm ON m.stat_month = pm.stat_month\n  LEFT JOIN base prev ON prev.stat_month = pm.prev_month AND prev.vplayerid = m.vplayerid\n)\nSELECT\n  stat_month,\n  SUM(CASE WHEN user_type = 'new' THEN 1 ELSE 0 END) AS new_user_cnt,\n  SUM(CASE WHEN user_type = 'return' THEN 1 ELSE 0 END) AS return_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 1 AND 4 THEN 1 ELSE 0 END) AS light_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 5 AND 15 THEN 1 ELSE 0 END) AS medium_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days >= 16 THEN 1 ELSE 0 END) AS heavy_retained_user_cnt\nFROM classified\nGROUP BY stat_month\nORDER BY stat_month;"}], "rejected": "WITH base AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(dtstatdate, '%Y%m%d'), '%Y%m') AS stat_month,\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate > '20240304'\n    AND platid = 255\n  GROUP BY stat_month, vplayerid\n),\nmonth_info AS (\n  SELECT\n    b.stat_month,\n    b.vplayerid,\n    b.active_days,\n    MIN(b.stat_month) OVER (PARTITION BY b.vplayerid) AS first_month\n  FROM base b\n),\nprev_month_map AS (\n  SELECT\n    stat_month,\n    DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(stat_month, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m') AS prev_month\n  FROM (SELECT DISTINCT stat_month FROM base) t\n),\nclassified AS (\n  SELECT\n    m.stat_month,\n    m.vplayerid,\n    m.active_days,\n    CASE\n      WHEN m.stat_month = m.first_month THEN 'new'\n      WHEN prev.vplayerid IS NOT NULL THEN 'retained'\n      WHEN m.stat_month > m.first_month THEN 'return'\n      ELSE 'other'\n    END AS user_type\n  FROM month_info m\n  LEFT JOIN prev_month_map pm ON m.stat_month = pm.stat_month\n  LEFT JOIN base prev ON prev.stat_month = pm.prev_month AND prev.vplayerid = m.vplayerid\n)\nSELECT\n  stat_month,\n  SUM(CASE WHEN user_type = 'new' THEN 1 ELSE 0 END) AS new_user_cnt,\n  SUM(CASE WHEN user_type = 'return' THEN 1 ELSE 0 END) AS return_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 1 AND 4 THEN 1 ELSE 0 END) AS light_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 5 AND 15 THEN 1 ELSE 0 END) AS medium_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days >= 16 THEN 1 ELSE 0 END) AS heavy_retained_user_cnt\nFROM classified\nGROUP BY stat_month\nORDER BY stat_month;", "meta": {"origin": "sql_40", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_19_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024年5月02日-2024年5月02日，日活跃用户的周边休闲模式情况。\n\n活跃日期区间：\"20250428-20250504\"\n\n输出：\n日活跃中仅玩QuickMatch模式的玩家数\n日活跃中仅玩RushMode模式的玩家数\n日活跃中仅玩CombatArena模式的玩家数\n日活跃中仅玩以上三个模式不玩其他模式的玩家数\n日活跃中仅玩以上三个模式不玩其他模式的玩家周活跃频次\n【表】dws_argothek_oss_login_di, dwd_argothek_playermatchstats_hi, dim_argothek_gplayerid_vroleid_df\n【口径】仅玩单一模式逻辑：\nhaving count(distinct queueid) = 1 -- 只玩一个模式\nand max(queueid) = \"xxx\" -- 模式ID为RushMode\n用户角色映射逻辑：\niareaid = \"101\""}, {"role": "assistant", "content": "WITH active_login AS (\n  SELECT\n    statis_date,\n    iuserid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20250428 AND 20250504\n  GROUP BY statis_date, iuserid\n), role_map AS (\n  SELECT vroleid, iuserid\n  FROM (\n    SELECT\n      vroleid,\n      iuserid,\n      ROW_NUMBER() OVER (PARTITION BY vroleid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid_vroleid_df\n    WHERE iAreaID = '101'\n      AND dtstatdate <= '20250504'\n  ) t\n  WHERE rn = 1\n), match_log AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    vroleid,\n    LOWER(queueid) AS queueid\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') BETWEEN '20250428' AND '20250504'\n), match_player AS (\n  SELECT\n    m.statis_date,\n    r.iuserid,\n    m.queueid\n  FROM match_log m\n  JOIN role_map r\n    ON m.vroleid = r.vroleid\n), player_modes AS (\n  SELECT\n    a.statis_date,\n    a.iuserid,\n    COUNT(DISTINCT mp.queueid) AS total_modes_cnt,\n    MAX(CASE WHEN mp.queueid = 'quickmatch' THEN 1 ELSE 0 END) AS has_quick,\n    MAX(CASE WHEN mp.queueid = 'rushmode' THEN 1 ELSE 0 END) AS has_rush,\n    MAX(CASE WHEN mp.queueid = 'combatarena' THEN 1 ELSE 0 END) AS has_combat,\n    MAX(CASE WHEN mp.queueid IS NOT NULL AND mp.queueid NOT IN ('quickmatch', 'rushmode', 'combatarena') THEN 1 ELSE 0 END) AS has_other\n  FROM active_login a\n  LEFT JOIN match_player mp\n    ON a.statis_date = mp.statis_date\n   AND a.iuserid = mp.iuserid\n  GROUP BY a.statis_date, a.iuserid\n), player_day_flags AS (\n  SELECT\n    statis_date,\n    iuserid,\n    CASE WHEN total_modes_cnt = 1 AND has_quick = 1 THEN 1 ELSE 0 END AS only_quick_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_rush = 1 THEN 1 ELSE 0 END AS only_rush_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_combat = 1 THEN 1 ELSE 0 END AS only_combat_flag,\n    CASE WHEN total_modes_cnt > 0 AND COALESCE(has_other, 0) = 0 THEN 1 ELSE 0 END AS only_three_flag\n  FROM player_modes\n), daily_summary AS (\n  SELECT\n    statis_date,\n    SUM(only_quick_flag) AS only_quick_user_cnt,\n    SUM(only_rush_flag) AS only_rush_user_cnt,\n    SUM(only_combat_flag) AS only_combat_user_cnt,\n    SUM(only_three_flag) AS only_three_modes_user_cnt\n  FROM player_day_flags\n  GROUP BY statis_date\n), weekly_freq AS (\n  SELECT SUM(only_three_flag) AS only_three_modes_week_freq\n  FROM player_day_flags\n)\nSELECT\n  d.statis_date AS statis_date,\n  d.only_quick_user_cnt AS only_quick_user_cnt,\n  d.only_rush_user_cnt AS only_rush_user_cnt,\n  d.only_combat_user_cnt AS only_combat_user_cnt,\n  d.only_three_modes_user_cnt AS only_three_modes_user_cnt,\n  wf.only_three_modes_week_freq AS only_three_modes_week_freq\nFROM daily_summary d\nCROSS JOIN weekly_freq wf\nORDER BY statis_date;"}], "rejected": "WITH active_login AS (\n  SELECT\n    statis_date,\n    iuserid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20250428 AND 20250504\n  GROUP BY statis_date, iuserid\n), role_map AS (\n  SELECT vroleid, iuserid\n  FROM (\n    SELECT\n      vroleid,\n      iuserid,\n      ROW_NUMBER() OVER (PARTITION BY vroleid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid_vroleid_df\n    WHERE iAreaID = '101'\n      AND dtstatdate <= '20250504'\n  ) t\n  WHERE rn = 1\n), match_log AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    vroleid,\n    LOWER(queueid) AS queueid\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') > '20250428'\n), match_player AS (\n  SELECT\n    m.statis_date,\n    r.iuserid,\n    m.queueid\n  FROM match_log m\n  JOIN role_map r\n    ON m.vroleid = r.vroleid\n), player_modes AS (\n  SELECT\n    a.statis_date,\n    a.iuserid,\n    COUNT(DISTINCT mp.queueid) AS total_modes_cnt,\n    MAX(CASE WHEN mp.queueid = 'quickmatch' THEN 1 ELSE 0 END) AS has_quick,\n    MAX(CASE WHEN mp.queueid = 'rushmode' THEN 1 ELSE 0 END) AS has_rush,\n    MAX(CASE WHEN mp.queueid = 'combatarena' THEN 1 ELSE 0 END) AS has_combat,\n    MAX(CASE WHEN mp.queueid IS NOT NULL AND mp.queueid NOT IN ('quickmatch', 'rushmode', 'combatarena') THEN 1 ELSE 0 END) AS has_other\n  FROM active_login a\n  LEFT JOIN match_player mp\n    ON a.statis_date = mp.statis_date\n   AND a.iuserid = mp.iuserid\n  GROUP BY a.statis_date, a.iuserid\n), player_day_flags AS (\n  SELECT\n    statis_date,\n    iuserid,\n    CASE WHEN total_modes_cnt = 1 AND has_quick = 1 THEN 1 ELSE 0 END AS only_quick_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_rush = 1 THEN 1 ELSE 0 END AS only_rush_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_combat = 1 THEN 1 ELSE 0 END AS only_combat_flag,\n    CASE WHEN total_modes_cnt > 0 AND COALESCE(has_other, 0) = 0 THEN 1 ELSE 0 END AS only_three_flag\n  FROM player_modes\n), daily_summary AS (\n  SELECT\n    statis_date,\n    SUM(only_quick_flag) AS only_quick_user_cnt,\n    SUM(only_rush_flag) AS only_rush_user_cnt,\n    SUM(only_combat_flag) AS only_combat_user_cnt,\n    SUM(only_three_flag) AS only_three_modes_user_cnt\n  FROM player_day_flags\n  GROUP BY statis_date\n), weekly_freq AS (\n  SELECT SUM(only_three_flag) AS only_three_modes_week_freq\n  FROM player_day_flags\n)\nSELECT\n  d.statis_date AS statis_date,\n  d.only_quick_user_cnt AS only_quick_user_cnt,\n  d.only_rush_user_cnt AS only_rush_user_cnt,\n  d.only_combat_user_cnt AS only_combat_user_cnt,\n  d.only_three_modes_user_cnt AS only_three_modes_user_cnt,\n  wf.only_three_modes_week_freq AS only_three_modes_week_freq\nFROM daily_summary d\nCROSS JOIN weekly_freq wf\nORDER BY statis_date;", "meta": {"origin": "sql_19", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_15_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年5月勇者盟约流失用户中，流向峡谷PC的玩家gplayerid\n输出：玩家gplayerid\n【表】dws_argothek_oss_useractivity_df, dim_argothek_gplayerid2qqwxid_df, dws_mgamejp_login_user_activity_di\n【口径】sgamecode = \"initiatived\" -- 筛选峡谷游戏\nand itimes >= 1 -- 活跃用户条件\nand saccounttype = \"-100\" -- 账号体系，取-100表示汇总\nand suseridtype in (\"qq\", \"wxid\") -- 账号类型，取qq或wxid\nand splattype = \"PC\" -- 峡谷端游玩家\nand splat IN (\"-100\",\"PC\") -- 写死为-100\n5月流失：限定INSTR(SUBSTR(REVERSE(RPAD(iactivity,128,'0')),1,31),'1') = 0 AND INSTR(SUBSTR(REVERSE(RPAD(iactivity,128,'0')),32,31),'1') > 0\n取20250608的数据做账号转换"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith lost_may as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date = 20250614\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 1, 31), '1') = 0\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 32, 31), '1') > 0\n),\nmap_info as (\n  select\n    iuserid,\n    suserid,\n    swxid_type\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250614'\n    and suserid is not null\n    and swxid_type in ('qq', 'wx', 'wxid')\n),\npc_active as (\n  select distinct\n    suserid,\n    suseridtype\n  from dws_mgamejp_login_user_activity_di\n  where dtstatdate between '20250607' and '20250706'\n    and sgamecode = 'initiatived'\n    and itimes >= 1\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid', 'wx')\n    and splattype = 'PC'\n    and splat IN ('-100','PC')\n)\nselect distinct l.iuserid as gplayerid\nfrom lost_may l\njoin map_info m\n  on l.iuserid = m.iuserid\njoin pc_active p\n  on p.suserid = m.suserid\n and p.suseridtype = case when m.swxid_type = 'wxid' then 'wx' else m.swxid_type end\norder by gplayerid\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith lost_may as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date = 20250614\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 1, 31), '1') = 0\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 32, 31), '1') > 0\n),\nmap_info as (\n  select\n    iuserid,\n    suserid,\n    swxid_type\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250614'\n    and suserid is not null\n    and swxid_type in ('qq', 'wx', 'wxid')\n),\npc_active as (\n  select distinct\n    suserid,\n    suseridtype\n  from dws_mgamejp_login_user_activity_di\n  where dtstatdate > '20250607'\n    and sgamecode = 'initiatived'\n    and itimes >= 1\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid', 'wx')\n    and splattype = 'PC'\n    and splat IN ('-100','PC')\n)\nselect distinct l.iuserid as gplayerid\nfrom lost_may l\njoin map_info m\n  on l.iuserid = m.iuserid\njoin pc_active p\n  on p.suserid = m.suserid\n and p.suseridtype = case when m.swxid_type = 'wxid' then 'wx' else m.swxid_type end\norder by gplayerid\n) AS final_query;", "meta": {"origin": "sql_15", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_69_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.12.25——2025.1.5 ，不同信息类型的玩家数量\n\n信息类型:chattype in (20,25,26,16,27,8)\n\n输出 日期（20241228-20250108），信息类型，人数，次数\n【表】dwd_jordass_msgchatrecord_hi\n【口径】chattype in (20,25,26,16,27,8)"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(chattype as string) as chat_type,\n  count(distinct playerid) as user_cnt,\n  count(*) as msg_cnt\nfrom dwd_jordass_msgchatrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20241228' and '20250108'\n  and chattype in (20, 25, 26, 16, 27, 8)\ngroup by substr(tdbank_imp_date, 1, 8), chattype\norder by stat_date, chat_type\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(chattype as string) as chat_type,\n  count(distinct playerid) as user_cnt,\n  count(*) as msg_cnt\nfrom dwd_jordass_msgchatrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20241228'\n  and chattype in (20, 25, 26, 16, 27, 8)\ngroup by substr(tdbank_imp_date, 1, 8), chattype\norder by stat_date, chat_type\n) AS final_query;", "meta": {"origin": "sql_69", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_43_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.1.1-2025.1.31期间活跃度分布\n输出：活跃度（轻度、中度、重度）、玩家数\n\n活跃度：轻度1-5天，中度6-15天，重度大于16天\n【表】dws_jordass_login_di\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith jan_active as (\n  select\n    vplayerid,\n    count(distinct dtstatdate) as active_days\n  from dws_jordass_login_di\n  where dtstatdate between '20250104' and '20250203'\n  group by vplayerid\n)\nselect\n  case\n    when active_days between 1 and 5 then '轻度'\n    when active_days between 6 and 15 then '中度'\n    when active_days >= 16 then '重度'\n    else '未知'\n  end as actv_level,\n  count(*) as player_cnt\nfrom jan_active\nwhere active_days > 0\ngroup by actv_level\norder by actv_level\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith jan_active as (\n  select\n    vplayerid,\n    count(distinct dtstatdate) as active_days\n  from dws_jordass_login_di\n  where dtstatdate > '20250104'\n  group by vplayerid\n)\nselect\n  case\n    when active_days between 1 and 5 then '轻度'\n    when active_days between 6 and 15 then '中度'\n    when active_days >= 16 then '重度'\n    else '未知'\n  end as actv_level,\n  count(*) as player_cnt\nfrom jan_active\nwhere active_days > 0\ngroup by actv_level\norder by actv_level\n) AS final_query;", "meta": {"origin": "sql_43", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_38_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计不同玩法不同用户类型的参与情况\n\n输出：玩法、用户类型（砺刃新增、砺刃回流（流失60天以上）、砺刃回流（流失21-59天）、砺刃回流（流失14-20天）、砺刃回流（流失7-13天）、砺刃留存、平台盘内、平台盘外）、上线后3天参与用户数、上线后3天总用户数\n\n各玩法上线日期：\n\"广域战场\": \"20240724\",\n\"消灭战\": \"20230805\",\n\"幻想混战\": \"20241116\",\n\"荒野传说\": \"20240904\",\n\"策略载具\": \"20241011\",\n\"炎夏混战\": \"20240626\",\n\"单人装备\": \"20240518\",\n\"交叉堡垒\": \"20240413\"\n【表】dws_mgamejp_login_user_activity_di, dws_jordass_login_df, dim_jordass_playerid2suserid_nf, dws_jordass_mode_roundrecord_di\n【口径】从平台大盘表取数据固定逻辑：\nsAccountType ='-100' and sgamecode <>'-100' and splattype IN ('-100','PC') and splat IN ('-100','PC')\n\n- 用户类型的定义：\n砺刃新增：上线后3天(包含上线当天)砺刃新增用户，并且参与了玩法的用户\n砺刃留存：上线前一周在砺刃活跃过，并且在上线后3天参与了玩法的用户\n砺刃回流：上线前一周没有在砺刃活跃过，但是之前在砺刃注册过，并且上线后3天参与了玩法的用户，然后按上线日期前N天连续未活跃时长区分：流失(7-13]天，流失[14-20]天，流失[21-59]天，流失60天及以上\n平台盘内：上线前一周在平台大盘活跃过，并且没有在砺刃活跃过，并且上线后3天参与了玩法的用户\n平台盘外：上线前一周没有在平台大盘内活跃过的，并且上线后3天参与了玩法的用户；\n\n广域战场 （2024/7/23）submodename= '广域战场模式'，\n消灭战（2023/8/4） modename='组队竞技' and submodename like '%消灭战模式%'，\n幻想混战（2024/11/16）modename='创意创作间' and submodename='幻想混战'，\n荒野传说（2024-09-04）modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')，\n策略载具（2024-10-11）modename='休闲模式' and submodename like '%策略载具%'，\n炎夏混战（2024-06-26）modename='创意创作间' and submodename like '%炎夏混战%'，\n单人装备（2024.5.17）modename='组队竞技' and submodename like '%单人装备%'，\n交叉堡垒（2024.4.12） modename='组队竞技' and submodename like '%交叉堡垒%'\n\n\n注意：suserid 和 vplayerid是两套用户账号体系；平台大盘代表所有游戏的数据，sgamecode='jordass'代表砺刃使者"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith usertype as (\n    select '广域战场' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240724',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '消灭战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20230805',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '幻想混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241116',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '荒野传说' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240904',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '策略载具' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241011',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '炎夏混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240626',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '单人装备' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240518',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '交叉堡垒' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240413',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n),\ndapan as (\n    select '广域战场' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20240724',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20240724',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '消灭战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20230805',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20230805',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '幻想混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241116',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241116',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '荒野传说' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240904',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240904',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '策略载具' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241011',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241011',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '炎夏混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240626',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240626',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '单人装备' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240518',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240518',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '交叉堡垒' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240413',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240413',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n),\ndapan2jordass as (\n    select distinct itype, b.vplayerid, flag1\n    from dapan a\n    join (\n        select vplayerid,suserid from dim_jordass_playerid2suserid_nf\n    ) b on a.suserid = b.suserid\n),\nplayuser as (\n    select '广域战场' itype, min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240724' and dtstatdate <= date_add('20240724',2) and submodename= '广域战场模式'\n    group by vplayerid\n    union all\n    select '消灭战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20230805' and dtstatdate <= date_add('20230805',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by vplayerid\n    union all\n    select '幻想混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241116' and dtstatdate <= date_add('20241116',2) and modename='创意创作间' and submodename='幻想混战'\n    group by vplayerid\n    union all\n    select '荒野传说' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240904' and dtstatdate <= date_add('20240904',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by vplayerid\n    union all\n    select '策略载具' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241011' and dtstatdate <= date_add('20241011',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by vplayerid\n    union all\n    select '炎夏混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240626' and dtstatdate <= date_add('20240626',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by vplayerid\n    union all\n    select '单人装备' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240518' and dtstatdate <= date_add('20240518',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by vplayerid\n    union all\n    select '交叉堡垒' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240413' and dtstatdate <= date_add('20240413',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by vplayerid\n)\n\nselect \n    t.itype,\n    t.user_type,\n    t.iusernum1,\n    p.iusernum2\nfrom (\n    select \n        a.itype,\n        b.user_type,\n        count(distinct a.vplayerid) iusernum1\n    from playuser a\n    join (\n        select \n            itype, vplayerid,\n            case \n                when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n                when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n                when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n                when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n                when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n                when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n            end user_type\n        from usertype\n    ) b on a.itype = b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.user_type\n\n    union all\n    \n    select \n        a.itype, \n        case \n            when flag1=0 then '平台盘内' \n            when b.vplayerid is null then '平台盘外' \n        end user_type, \n    count(distinct a.vplayerid) iusernum1\n    from playuser a\n    left join dapan2jordass b \n    on a.itype = b.itype and a.vplayerid = b.vplayerid\n    where flag1=0 or b.vplayerid is null\n    group by a.itype, case when flag1=0 then '平台盘内' when b.vplayerid is null then '平台盘外' end\n) t\nleft join (\n    select itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end user_type,\n        count(distinct vplayerid) iusernum2\n    from usertype\n    group by itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end\n\n    union all\n\n    select itype,'平台盘内',count(distinct vplayerid) \n    from dapan2jordass \n    group by itype\n) p on t.itype=p.itype and t.user_type=p.user_type\n\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith usertype as (\n    select '广域战场' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240724',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '消灭战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20230805',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '幻想混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241116',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '荒野传说' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240904',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '策略载具' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241011',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '炎夏混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240626',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '单人装备' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240518',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '交叉堡垒' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240413',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n),\ndapan as (\n    select '广域战场' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20240724',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20240724',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '消灭战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20230805',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20230805',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '幻想混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241116',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241116',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '荒野传说' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240904',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240904',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '策略载具' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241011',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241011',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '炎夏混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240626',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240626',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '单人装备' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240518',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240518',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n    union all\n    select '交叉堡垒' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240413',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240413',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype IN ('-100','PC')\n        and splat IN ('-100','PC')\n    group by suserid\n),\ndapan2jordass as (\n    select distinct itype, b.vplayerid, flag1\n    from dapan a\n    join (\n        select vplayerid,suserid from dim_jordass_playerid2suserid_nf\n    ) b on a.suserid = b.suserid\n),\nplayuser as (\n    select '广域战场' itype, min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240724' and dtstatdate <= date_add('20240724',2) and submodename= '广域战场模式'\n    group by vplayerid\n    union all\n    select '消灭战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20230805' and dtstatdate <= date_add('20230805',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by vplayerid\n    union all\n    select '幻想混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241116' and dtstatdate <= date_add('20241116',2) and modename='创意创作间' and submodename='幻想混战'\n    group by vplayerid\n    union all\n    select '荒野传说' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240904' and dtstatdate <= date_add('20240904',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by vplayerid\n    union all\n    select '策略载具' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241011' and dtstatdate <= date_add('20241011',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by vplayerid\n    union all\n    select '炎夏混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240626' and dtstatdate <= date_add('20240626',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by vplayerid\n    union all\n    select '单人装备' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240518' and dtstatdate <= date_add('20240518',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by vplayerid\n    union all\n    select '交叉堡垒' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240413' and dtstatdate <= date_add('20240413',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by vplayerid\n)\n\nselect \n    t.itype,\n    t.user_type,\n    t.iusernum1,\n    p.iusernum2\nfrom (\n    select \n        a.itype,\n        b.user_type,\n        count(distinct a.vplayerid) iusernum1\n    from playuser a\n    join (\n        select \n            itype, vplayerid,\n            case \n                when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n                when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n                when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n                when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n                when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n                when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n            end user_type\n        from usertype\n    ) b on a.itype = b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.user_type\n\n    union all\n    \n    select \n        a.itype, \n        case \n            when flag1=0 then '平台盘内' \n            when b.vplayerid is null then '平台盘外' \n        end user_type, \n    count(distinct a.vplayerid) iusernum1\n    from playuser a\n    left join dapan2jordass b \n    on a.itype = b.itype and a.vplayerid = b.vplayerid\n    where flag1=0 or b.vplayerid is null\n    group by a.itype, case when flag1=0 then '平台盘内' when b.vplayerid is null then '平台盘外' end\n) t\nleft join (\n    select itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end user_type,\n        count(distinct vplayerid) iusernum2\n    from usertype\n    group by itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end\n\n    union all\n\n    select itype,'平台盘内',count(distinct vplayerid) \n    from dapan2jordass \n    group by itype\n) p on t.itype=p.itype and t.user_type=p.user_type\n\n) AS final_query;", "meta": {"origin": "sql_38", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_47_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.07.01-08.31期间，每天微信活跃用户在2023.09.1-09.21期间流失并且是2023.07.01-08.31有付费的用户\n输出：人数\n【表】dws_jordass_water_di, dws_jordass_login_di\n【口径】"}, {"role": "assistant", "content": "with pay_users as (\n  select distinct vplayerid\n  from dws_jordass_water_di\n  where dtstatdate between '20230703' and '20230902'\n),\nlater_active as (\n  select distinct vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230903' and '20230923'\n),\nearly_login as (\n  select\n    dtstatdate,\n    vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230703' and '20230902'\n    and vgameappid = 'wx'\n)\nselect\n  dtstatdate,\n  count(distinct vplayerid) as user_cnt\nfrom early_login l\nwhere exists (select 1 from pay_users p where p.vplayerid = l.vplayerid)\n  and not exists (select 1 from later_active a where a.vplayerid = l.vplayerid)\ngroup by dtstatdate\norder by dtstatdate;"}], "rejected": "with pay_users as (\n  select distinct vplayerid\n  from dws_jordass_water_di\n  where dtstatdate > '20230703'\n),\nlater_active as (\n  select distinct vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230903' and '20230923'\n),\nearly_login as (\n  select\n    dtstatdate,\n    vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230703' and '20230902'\n    and vgameappid = 'wx'\n)\nselect\n  dtstatdate,\n  count(distinct vplayerid) as user_cnt\nfrom early_login l\nwhere exists (select 1 from pay_users p where p.vplayerid = l.vplayerid)\n  and not exists (select 1 from later_active a where a.vplayerid = l.vplayerid)\ngroup by dtstatdate\norder by dtstatdate;", "meta": {"origin": "sql_47", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_26_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2024-01-01到2024-12-16，闪了敌人x次、闪了队友x次，除自定义模式、新手、训练场外所有模式。\n输出：闪了敌人x次、闪了队友x次\n【表】dwd_argothek_matchdetails_hi, dwd_argothek_abilityinfo_effects_hi\n【口径】provisioningflowid = \"Matchmaking\" -- 除自定义模式、新手、训练场外所有模式\n\n闪光弹区分逻辑：\n闪到敌人：tag = \"EnemiesBlinded\"\n闪到队友：tag = \"AlliesBlinded\"\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240128' and '20250112'\n    and provisioningflowid = 'Matchmaking'\n),\nflash_effect as (\n  select\n    tag,\n    sum(coalesce(amount, 0)) as total_cnt\n  from dwd_argothek_abilityinfo_effects_hi e\n  join valid_matches m on e.matchinfomatchid = m.matchid\n  where substr(e.tdbank_imp_date, 1, 8) between '20240128' and '20250112'\n    and tag in ('EnemiesBlinded', 'AlliesBlinded')\n  group by tag\n)\nselect\n  coalesce(max(case when tag = 'EnemiesBlinded' then total_cnt end), 0) as enemies_blinded_cnt,\n  coalesce(max(case when tag = 'AlliesBlinded' then total_cnt end), 0) as allies_blinded_cnt\nfrom flash_effect;"}], "rejected": "with valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) > '20240128'\n    and provisioningflowid = 'Matchmaking'\n),\nflash_effect as (\n  select\n    tag,\n    sum(coalesce(amount, 0)) as total_cnt\n  from dwd_argothek_abilityinfo_effects_hi e\n  join valid_matches m on e.matchinfomatchid = m.matchid\n  where substr(e.tdbank_imp_date, 1, 8) between '20240128' and '20250112'\n    and tag in ('EnemiesBlinded', 'AlliesBlinded')\n  group by tag\n)\nselect\n  coalesce(max(case when tag = 'EnemiesBlinded' then total_cnt end), 0) as enemies_blinded_cnt,\n  coalesce(max(case when tag = 'AlliesBlinded' then total_cnt end), 0) as allies_blinded_cnt\nfrom flash_effect;", "meta": {"origin": "sql_26", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_24_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计下列英雄和对应上线日期，新英雄上线首周的持续选择情况。限定除自定义模式，新手、训练场外所有模式\n输出：英雄id、首周选择新英雄次数超过3次的玩家、首周选择新英雄次数超过10次的玩家、首周选择过新英雄的玩家、超过3次的玩家占比、超过10次的玩家占比\n【表】dwd_argothek_playermatchdetail_hi\n【口径】英雄筛选逻辑：\n英雄1上线日期：2023/08/28\n英雄2上线日期：2023/12/04\n英雄3上线日期：2024/04/29\n英雄4上线日期：2024/10/01\n英雄5上线日期：2025/02/11\n英雄6上线日期：2025/04/08\n英雄1对应id:\"e370fa57-4757-3604-3648-499e1f642d3f\",\"cc8b64c8-4b25-4ff9-6e7f-37b4da43d235\"\n英雄2对应id:\"0e38b510-41a8-5780-5e8f-568b2a4f2d6c\"\n英雄3对应id:\"1dbf2edd-4729-0984-3115-daa5eed44993\"\n英雄4对应id:\"efba5359-4016-a1e5-7626-b1ae76895940\"\n英雄5对应id:\"b444168c-4e35-8076-db47-ef9bf368f384\"\n英雄6对应id:\"df1cb487-4902-002e-5c17-d28e83e78588\"\n\n对局筛选逻辑：\nprovisioningflowid = \"Matchmaking\" -- 除自定义模式、新手、训练场外所有模式\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH heroes AS (\n  SELECT 'e370fa57-4757-3604-3648-499e1f642d3f' AS hero_id, DATE '2023-08-28' AS start_date UNION ALL\n  SELECT 'cc8b64c8-4b25-4ff9-6e7f-37b4da43d235', DATE '2023-08-28' UNION ALL\n  SELECT '0e38b510-41a8-5780-5e8f-568b2a4f2d6c', DATE '2023-12-04' UNION ALL\n  SELECT '1dbf2edd-4729-0984-3115-daa5eed44993', DATE '2024-04-29' UNION ALL\n  SELECT 'efba5359-4016-a1e5-7626-b1ae76895940', DATE '2024-10-01' UNION ALL\n  SELECT 'b444168c-4e35-8076-db47-ef9bf368f384', DATE '2025-02-11' UNION ALL\n  SELECT 'df1cb487-4902-002e-5c17-d28e83e78588', DATE '2025-04-08'\n),\nfirst_week_matches AS (\n  SELECT\n    h.hero_id,\n    md.subject AS player_id,\n    COUNT(*) AS pick_cnt\n  FROM dwd_argothek_playermatchdetail_hi md\n  JOIN heroes h\n    ON md.characterid = h.hero_id\n  WHERE md.provisioningflowid = 'Matchmaking'\n    AND CAST(md.dteventtime AS DATE) BETWEEN h.start_date AND DATE_ADD(h.start_date, INTERVAL 6 DAY)\n  GROUP BY h.hero_id, md.subject\n),\nhero_summary AS (\n  SELECT\n    hero_id,\n    COUNT(*) AS total_players,\n    SUM(CASE WHEN pick_cnt > 3 THEN 1 ELSE 0 END) AS players_over_3,\n    SUM(CASE WHEN pick_cnt > 10 THEN 1 ELSE 0 END) AS players_over_10\n  FROM first_week_matches\n  GROUP BY hero_id\n)\nSELECT\n  hero_id,\n  players_over_3,\n  players_over_10,\n  total_players AS players_over_0,\n  IF(total_players = 0, 0, ROUND(players_over_3 / total_players, 4)) AS ratio_over_3,\n  IF(total_players = 0, 0, ROUND(players_over_10 / total_players, 4)) AS ratio_over_10\nFROM hero_summary\nORDER BY hero_id;"}], "rejected": "WITH heroes AS (\n  SELECT 'e370fa57-4757-3604-3648-499e1f642d3f' AS hero_id, DATE '2023-08-28' AS start_date UNION ALL\n  SELECT 'cc8b64c8-4b25-4ff9-6e7f-37b4da43d235', DATE '2023-08-28' UNION ALL\n  SELECT '0e38b510-41a8-5780-5e8f-568b2a4f2d6c', DATE '2023-12-04' UNION ALL\n  SELECT '1dbf2edd-4729-0984-3115-daa5eed44993', DATE '2024-04-29' UNION ALL\n  SELECT 'efba5359-4016-a1e5-7626-b1ae76895940', DATE '2024-10-01' UNION ALL\n  SELECT 'b444168c-4e35-8076-db47-ef9bf368f384', DATE '2025-02-11' UNION ALL\n  SELECT 'df1cb487-4902-002e-5c17-d28e83e78588', DATE '2025-04-08'\n),\nfirst_week_matches AS (\n  SELECT\n    h.hero_id,\n    md.subject AS player_id,\n    COUNT(*) AS pick_cnt\n  FROM dwd_argothek_playermatchdetail_hi md\n  JOIN heroes h\n    ON md.characterid = h.hero_id\n  WHERE md.provisioningflowid = 'Matchmaking'\n    AND CAST(md.dteventtime AS DATE) BETWEEN h.start_date AND DATE_ADD(h.start_date, INTERVAL 6 DAY)\n  GROUP BY h.hero_id, md.subject\n),\nhero_summary AS (\n  SELECT\n    hero_id,\n    COUNT(*) AS total_players,\n    SUM(CASE WHEN pick_cnt > 3 THEN 1 ELSE 0 END) AS players_over_3,\n    SUM(CASE WHEN pick_cnt > 10 THEN 1 ELSE 0 END) AS players_over_10\n  FROM first_week_matches\n  GROUP BY hero_id\n)\nSELECT\n  hero_id,\n  players_over_3,\n  players_over_10,\n  total_players AS players_over_0,\n  IF(total_players = 0, 0, ROUND(players_over_3 / total_players, 4)) AS ratio_over_3,\n  IF(total_players = 0, 0, ROUND(players_over_10 / total_players, 4)) AS ratio_over_10\nFROM hero_summary\nORDER BY hero_id;", "meta": {"origin": "sql_24", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_103_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.9.1到9.10每天productid的参与直购购买人数，直购购买金额以及数量，当天注册人数\n输出：统计日期(yyyymmdd),productid,直购购买人数,直购购买金额,直购购买数量\n【表】dws_jordass_login_df, dwd_jordass_directpaycommflow_hi\n【口径】productid的参与直购：op='take' and opres='ok'\n\tand productid in ('package_6','package_18','outfit_pack','weapon_pack')"}, {"role": "assistant", "content": "WITH purchase AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    productid,\n    vplayerid,\n    goodsnum,\n    money\n  FROM dwd_jordass_directpaycommflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-09-01' AND '2025-09-10'\n    AND op = 'take'\n    AND opres = 'ok'\n    AND productid IN ('package_6','package_18','outfit_pack','weapon_pack')\n)\nSELECT\n  DATE_FORMAT(stat_date, '%Y%m%d') AS stat_date,\n  productid,\n  COUNT(DISTINCT vplayerid) AS purchase_user_cnt,\n  ROUND(SUM(money) / 100.0, 2) AS purchase_amount,\n  SUM(goodsnum) AS purchase_qty\nFROM purchase\nGROUP BY stat_date, productid\nORDER BY stat_date, productid;"}], "rejected": "WITH purchase AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    productid,\n    vplayerid,\n    goodsnum,\n    money\n  FROM dwd_jordass_directpaycommflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-09-01' AND '2025-09-10'\n    AND op = 'take'\n    AND opres = 'ok'\n    AND productid IN ('package_6','package_18','outfit_pack','weapon_pack')\n)\nSELECT\n  DATE_FORMAT(stat_date, '%Y%m%d') AS stat_date,\n  productid,\n  COUNT(DISTINCT vplayerid) AS purchase_user_cnt,\n  ROUND(SUM(money) / 100.0, 2) AS purchase_amount,\n  SUM(goodsnum) AS purchase_qty\nFROM purchase\nGROUP BY stat_date, productid\nORDER BY stat_date, productid;", "meta": {"origin": "sql_103", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_9_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250702手游fps最后活跃日期为近半年的用户的城市等级分布。\n输出：城市等级，用户人数\n【表】dim_mgamejp_account_allinfo_nf, dim_uf_player_gameinfo_mf\n【口径】用户固定筛选逻辑:\nand saccounttype = \"-100\" -- 账户类型为-100\nand suseridtype in (\"qq\",\"wxid\",\"guest\") -- 用户类型为qq或wxid\nand sgamecode in (\"esports\",\"mobile_live\",\"initiatived\",\"allianceforce\",\"strategy\",\"jordass\",\"su\",\"playzone\",\"battlezone\",\"battlearena\",\"weapon\",\"playhub\",\"manager\",\"apgame\") -- 游戏代码为指定的手游fps\nand splattype IN (\"-100\",\"PC\") -- 平台类型为-100\n活跃日期逻辑:\n基于当前统计时间20250702向前计算6个月的登陆日期，即ilastactdate >= \"20250111\"\n城市等级分布：\n当前时间为20250702，城市等级分布的相关表是月表，所以需要取kp_imp_date = \"202506\"的数据作为关联数据"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    suserid,\n    suseridtype\n  from dim_mgamejp_account_allinfo_nf\n  where dtstatdate = 20250709\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid')\n    and sgamecode in ('esports','mobile_live','initiatived','allianceforce','strategy','jordass','su','playzone','battlezone','battlearena','weapon','playhub','manager','apgame')\n    and splattype IN ('-100','PC')\n    and splat IN ('-100','PC')\n    and ilastactdate >= 20250111\n),\njoined as (\n  select\n    b.suserid,\n    coalesce(u.city_level, '未知') as city_level\n  from base b\n  left join dim_uf_player_gameinfo_mf u\n    on u.kp_imp_date = '202506'\n   and u.userid = b.suserid\n   and u.id_type = case when b.suseridtype = 'wxid' then 'wx' else b.suseridtype end\n)\nselect\n  city_level,\n  count(distinct suserid) as user_cnt\nfrom joined\ngroup by city_level\norder by city_level\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    suserid,\n    suseridtype\n  from dim_mgamejp_account_allinfo_nf\n  where dtstatdate = 20250709\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid')\n    and sgamecode in ('esports','mobile_live','initiatived','allianceforce','strategy','jordass','su','playzone','battlezone','battlearena','weapon','playhub','manager','apgame')\n    and splattype IN ('-100','PC')\n    and splat IN ('-100','PC')\n    and ilastactdate >= 20250111\n),\njoined as (\n  select\n    b.suserid,\n    coalesce(u.city_level, '未知') as city_level\n  from base b\n  left join dim_uf_player_gameinfo_mf u\n    on u.kp_imp_date = '202506'\n   and u.userid = b.suserid\n   and u.id_type = case when b.suseridtype = 'wxid' then 'wx' else b.suseridtype end\n)\nselect\n  city_level,\n  count(distinct suserid) as user_cnt\nfrom joined\ngroup by city_level\norder by city_level\n) AS final_query;", "meta": {"origin": "sql_9", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_64_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2024.10.28-2024.11.25、2024.11.28-2024.12.25、2024.10.28-10.27、2024.11.03-11.03、2024.11.10-11.10、2024.11.17-11.17、2024.11.24-11.19、2024.11.28-11.24、2024.12.01-12.01、2024.12.08-12.08、2024.12.15-12.15、2024.12.22-12.19几个时间段的最近上新的曝光用户数（UV）、曝光次数（PV）\n输出：统计日期（例:20241029）、UV、PV\n【表】dws_jordass_buttonpress_pre_di\n【口径】buttontype=\"410012\"表示曝光，一条记录代表一次\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  dtstatdate,\n  count(distinct vplayerid) as uv,\n  count(*) as pv\nfrom dws_jordass_buttonpress_pre_di\nwhere buttontype = '410012'\n  and (\n        dtstatdate between '20241028' and '20241125'\n     or dtstatdate between '20241128' and '20241225'\n     or dtstatdate between '20241028' and '20241102'\n     or dtstatdate between '20241103' and '20241109'\n     or dtstatdate between '20241110' and '20241116'\n     or dtstatdate between '20241117' and '20241123'\n     or dtstatdate between '20241124' and '20241125'\n     or dtstatdate between '20241128' and '20241130'\n     or dtstatdate between '20241201' and '20241207'\n     or dtstatdate between '20241208' and '20241214'\n     or dtstatdate between '20241215' and '20241221'\n     or dtstatdate between '20241222' and '20241225'\n  )\ngroup by dtstatdate\norder by dtstatdate;"}], "rejected": "select\n  dtstatdate,\n  count(distinct vplayerid) as uv,\n  count(*) as pv\nfrom dws_jordass_buttonpress_pre_di\nwhere buttontype = '410012'\n  and (\n        dtstatdate > '20241028'\n     or dtstatdate between '20241128' and '20241225'\n     or dtstatdate between '20241028' and '20241102'\n     or dtstatdate between '20241103' and '20241109'\n     or dtstatdate between '20241110' and '20241116'\n     or dtstatdate between '20241117' and '20241123'\n     or dtstatdate between '20241124' and '20241125'\n     or dtstatdate between '20241128' and '20241130'\n     or dtstatdate between '20241201' and '20241207'\n     or dtstatdate between '20241208' and '20241214'\n     or dtstatdate between '20241215' and '20241221'\n     or dtstatdate between '20241222' and '20241225'\n  )\ngroup by dtstatdate\norder by dtstatdate;", "meta": {"origin": "sql_64", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_41_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.1.1～1.3，每天活跃玩家数\n输出：统计日期(20240101、20240102、20240103)、玩家数\n【表】dws_jordass_login_di\n【口径】"}, {"role": "assistant", "content": "select\n  dtstatdate as stat_date,\n  count(distinct vplayerid) as player_cnt\nfrom dws_jordass_login_di\nwhere dtstatdate between '20240101' and '20240103'\ngroup by dtstatdate\norder by dtstatdate;"}], "rejected": "select\n  dtstatdate as stat_date,\n  count(distinct vplayerid) as player_cnt\nfrom dws_jordass_login_di\nwhere dtstatdate > '20240101'\ngroup by dtstatdate\norder by dtstatdate;", "meta": {"origin": "sql_41", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_37_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计注册日期在2025.4.1-2025.5.30的模拟器新进用户在用户类型（模拟器、手机端、整体砺刃游戏内），次留、三留、七留、14留、30留情况\n输出:日期(20250405、...、20250603)、人数、用户类型（模拟器、手机端、游戏内、未知）、次留人数、三留人数、七留人数、14留人数、30留人数\n【表】dws_jordass_device_login_di, dws_jordass_emulator_df, dws_jordass_login_di\n【口径】模拟器新进用户从dws_jordass_emulator_df取，限制统计日期为20251001\n模拟器：device_type in (1,5)；\n手机端：device_type=0"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect \n    s1.ds as `ds`, -- 日期\n    count(distinct s1.vplayerid) as `user_cnt`, -- 人数\n    coalesce(user_type, '未知') as `user_type`, -- 用户类型\n    count(distinct case when s2.ds = date_add(s1.ds, 1) then s1.vplayerid else null end) as `next_day_retention`, -- 次留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 2) then s1.vplayerid else null end) as `three_day_retention`, -- 三留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 6) then s1.vplayerid else null end) as `seven_day_retention`, -- 七留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 13) then s1.vplayerid else null end) as `fourteen_day_retention`, -- 14留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 29) then s1.vplayerid else null end) as `thirty_day_retention` -- 30留人数\nfrom (\n    select \n        f1.dregdate as ds,  -- 日期\n        f1.vplayerid as vplayerid  -- 用户id\n    from  dws_jordass_emulator_df f1\n    where   f1.dtstatdate = '20251005'  \n        and f1.dregdate >= '20250405'  \n        and f1.dregdate <= '20250603'  \n        and f1.platid = 255  \n) s1\nleft join (\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '手机端' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type=0 -- 手机端\n    and f1.dtstatdate >= '20250405' and f1.dtstatdate <= date_add('20250603', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '模拟器' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type in (1,5) -- 模拟器\n    and f1.dtstatdate >= '20250405' and f1.dtstatdate <= date_add('20250603', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds,  -- 日期\n        f1.vplayerid as vplayerid,  -- 整体游戏内登录用户id\n        '游戏内' as user_type\n    from   dws_jordass_login_di f1  \n    where  f1.dtstatdate >= '20250405' and f1.dtstatdate <= date_add('20250603', 29)\n    and f1.platid = 255  -- 不区分系统平台\n) s2 \n    on   s1.vplayerid = s2.vplayerid\n    group by   s1.ds, user_type\n\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect \n    s1.ds as `ds`, -- 日期\n    count(distinct s1.vplayerid) as `user_cnt`, -- 人数\n    coalesce(user_type, '未知') as `user_type`, -- 用户类型\n    count(distinct case when s2.ds = date_add(s1.ds, 1) then s1.vplayerid else null end) as `next_day_retention`, -- 次留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 2) then s1.vplayerid else null end) as `three_day_retention`, -- 三留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 6) then s1.vplayerid else null end) as `seven_day_retention`, -- 七留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 13) then s1.vplayerid else null end) as `fourteen_day_retention`, -- 14留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 29) then s1.vplayerid else null end) as `thirty_day_retention` -- 30留人数\nfrom (\n    select \n        f1.dregdate as ds,  -- 日期\n        f1.vplayerid as vplayerid  -- 用户id\n    from  dws_jordass_emulator_df f1\n    where   f1.dtstatdate = '20251005'  \n        and f1.dregdate >= '20250405'  \n        and f1.dregdate <= '20250603'  \n        and f1.platid = 255  \n) s1\nleft join (\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '手机端' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type=0 -- 手机端\n    and f1.dtstatdate >= '20250405' and f1.dtstatdate <= date_add('20250603', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '模拟器' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type in (1,5) -- 模拟器\n    and f1.dtstatdate >= '20250405' and f1.dtstatdate <= date_add('20250603', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds,  -- 日期\n        f1.vplayerid as vplayerid,  -- 整体游戏内登录用户id\n        '游戏内' as user_type\n    from   dws_jordass_login_di f1  \n    where  f1.dtstatdate >= '20250405' and f1.dtstatdate <= date_add('20250603', 29)\n    and f1.platid = 255  -- 不区分系统平台\n) s2 \n    on   s1.vplayerid = s2.vplayerid\n    group by   s1.ds, user_type\n\n) AS final_query;", "meta": {"origin": "sql_37", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_39_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计各个玩法参与用户其他玩法流入和双栖情况\n\n输出：流入玩法、流出玩法、上线后3天流入玩法参与用户数、上线后3天流出用户数、上线后3天双栖用户数、上线前一周流出玩法总参与用户数、流出占比、上线后3天流出玩法总参与用户数、双栖占比\n【表】dws_jordass_mode_roundrecord_di\n【口径】流入玩法上线日期和取数逻辑：\n广域战场 （2024/7/23）submodename= '广域战场模式'，\n消灭战（2023/8/4） modename='组队竞技' and submodename like '%消灭战模式%'，\n幻想混战（2024/11/16）modename='创意创作间' and submodename='幻想混战'，\n荒野传说（2024-09-04）modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')，\n策略载具（2024-10-11）modename='休闲模式' and submodename like '%策略载具%'，\n炎夏混战（2024-06-26）modename='创意创作间' and submodename like '%炎夏混战%'，\n单人装备（2024.5.17）modename='组队竞技' and submodename like '%单人装备%'，\n交叉堡垒（2024.4.12） modename='组队竞技' and submodename like '%交叉堡垒%'，\n庆典混战（2024/4/26）submode in (2611)，\nCG28战场进化（2024/9/3） modename='传统模式' and submodename ='CG28-动物丛林'，\nCG29流浪地球（2024/11/5） modename='传统模式' and submodename ='CG29-流浪地球'\n\n流出玩法：从上往下匹配，如果满足任一条件则返回对应的玩法名称，否则返回“其他子模式”。\n主题群屿：modename='传统模式' and submodename like 'CG%' and mapname='群屿'\n传统群屿：modename='传统模式' and mapname='群屿'\n假日群岛：modename='传统模式' and mapname='假日群岛'\n山峦：modename='传统模式' and mapname='山峦'\n极能形态模式：submodename='极能形态模式'\n隧道：modename='生存模式'\n广域战场：submodename='广域战场模式'\n休闲模式：modename='休闲模式'\n乐园：modename='乐园'\n领地：modename='领地'\n广阔天地：modename='广阔天地'\n组队竞技：modename='组队竞技'\n\n用户定义：\n流出用户：流入玩法上线前一周玩了流出玩法，并且流入玩法上线后3天没有玩流出玩法，但是有玩流入玩法\n双栖用户：流入玩法上线前一周 和 上线后3天都玩了流出玩法\n流出占比：流出用户除以上线前一周流出玩法总参与\n双栖占比：双栖用户除以上线首周流出玩法总参与"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith playuser as (\n    select '广域战场' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate= '20240724'  and  date_add('20240724',2) and submodename= '广域战场模式'\n    group by 1,2,3\n    union all\n    select '消灭战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20230805'  and  date_add('20230805',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by 1,2,3\n    union all\n    select '幻想混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241116' and  date_add('20241116',2) and modename='创意创作间' and submodename='幻想混战'\n    group by 1,2,3\n    union all\n    select '荒野传说' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240904'  and  date_add('20240904',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by 1,2,3\n    union all\n    select '策略载具' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241011'   and  date_add('20241011',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by 1,2,3\n    union all\n    select '炎夏混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240626'   and  date_add('20240626',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by 1,2,3\n    union all\n    select '单人装备' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240518'   and  date_add('20240518',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by 1,2,3\n    union all\n    select '交叉堡垒' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240413'   and  date_add('20240413',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by 1,2,3\n    union all\n    select '庆典混战' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240427'  and  date_add('20240427',2) and submode in (2611)\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG29-流浪地球' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240904' and  date_add('20240904',2)and submodename = 'CG29-流浪地球'\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG28-动物丛林' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241106' and  date_add('20241106',2)and submodename = 'CG28-动物丛林'\n    group by dtstatdate,vplayerid\n),\nallplayuser as (\n    select '广域战场' itype,\n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240724' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240724' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240724',7) and dtstatdate <= date_add('20240724',2)  \n    group by \n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end ,\n        vplayerid\n    union all\n    select '消灭战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20230805' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20230805' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20230805',7) and dtstatdate <= date_add('20230805',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '幻想混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241116' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241116' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241116',7) and dtstatdate <= date_add('20241116',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '荒野传说' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240904' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240904' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240904',7) and dtstatdate <= date_add('20240904',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '策略载具' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241011' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241011' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241011',7) and dtstatdate <= date_add('20241011',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '炎夏混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240626' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240626' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240626',7) and dtstatdate <= date_add('20240626',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '单人装备' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240518' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240518' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240518',7) and dtstatdate <= date_add('20240518',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '交叉堡垒' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240413' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240413' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240413',7) and dtstatdate <= date_add('20240413',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '庆典混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240427' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240427' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240427',7) and dtstatdate <= date_add('20240427',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG28-动物丛林' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240904' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240904' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240904',7) and dtstatdate <= date_add('20240904',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG29-流浪地球' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241106' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241106' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241106',7) and dtstatdate <= date_add('20241106',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n)\n\nselect  \n    t.itype, \n    t.playclass1, \n    iusernum1, -- 流入玩法参与用户数\n    iusernum2, -- 流出用户数\n    iusernum3, -- 双栖用户数\n    iusernum4, -- 前一周流出玩法用户数\n    coalesce(round(iusernum2/iusernum4, 2), 0) as ratio1, -- 流出占比\n    iusernum5, -- 后3天流出玩法用户数\n    coalesce(round(iusernum3/iusernum5, 2), 0) as ratio2 -- 双栖占比\nfrom (\n    select itype,count(distinct vplayerid) iusernum1 from playuser group by itype\n)p\nleft join (\n    select \n        a.itype,\n        b.playclass1,\n        count(distinct case when islast=1 and isthis =0 then a.vplayerid end) iusernum2,\n        count(distinct case when islast=1 and isthis =1 then a.vplayerid end) iusernum3\n    from playuser a\n    left join allplayuser b \n    on a.itype =b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.playclass1\n)t on p.itype = t.itype\nleft join (\n    select \n        itype, \n        playclass1,\n        count(distinct case when islast=1 then vplayerid end) iusernum4,\n        count(distinct case when isthis=1 then vplayerid end) iusernum5\n    from allplayuser\n    group by itype,playclass1\n) m on t.playclass1=m.playclass1 and t.itype=m.itype\n\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith playuser as (\n    select '广域战场' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate= '20240724'  and  date_add('20240724',2) and submodename= '广域战场模式'\n    group by 1,2,3\n    union all\n    select '消灭战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20230805'  and  date_add('20230805',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by 1,2,3\n    union all\n    select '幻想混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241116' and  date_add('20241116',2) and modename='创意创作间' and submodename='幻想混战'\n    group by 1,2,3\n    union all\n    select '荒野传说' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240904'  and  date_add('20240904',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by 1,2,3\n    union all\n    select '策略载具' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241011'   and  date_add('20241011',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by 1,2,3\n    union all\n    select '炎夏混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240626'   and  date_add('20240626',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by 1,2,3\n    union all\n    select '单人装备' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240518'   and  date_add('20240518',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by 1,2,3\n    union all\n    select '交叉堡垒' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240413'   and  date_add('20240413',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by 1,2,3\n    union all\n    select '庆典混战' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240427'  and  date_add('20240427',2) and submode in (2611)\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG29-流浪地球' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240904' and  date_add('20240904',2)and submodename = 'CG29-流浪地球'\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG28-动物丛林' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241106' and  date_add('20241106',2)and submodename = 'CG28-动物丛林'\n    group by dtstatdate,vplayerid\n),\nallplayuser as (\n    select '广域战场' itype,\n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240724' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240724' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240724',7) and dtstatdate <= date_add('20240724',2)  \n    group by \n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end ,\n        vplayerid\n    union all\n    select '消灭战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20230805' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20230805' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20230805',7) and dtstatdate <= date_add('20230805',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '幻想混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241116' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241116' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241116',7) and dtstatdate <= date_add('20241116',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '荒野传说' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240904' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240904' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240904',7) and dtstatdate <= date_add('20240904',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '策略载具' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241011' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241011' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241011',7) and dtstatdate <= date_add('20241011',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '炎夏混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240626' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240626' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240626',7) and dtstatdate <= date_add('20240626',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '单人装备' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240518' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240518' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240518',7) and dtstatdate <= date_add('20240518',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '交叉堡垒' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240413' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240413' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240413',7) and dtstatdate <= date_add('20240413',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '庆典混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240427' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240427' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240427',7) and dtstatdate <= date_add('20240427',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG28-动物丛林' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240904' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240904' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240904',7) and dtstatdate <= date_add('20240904',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG29-流浪地球' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241106' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241106' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241106',7) and dtstatdate <= date_add('20241106',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n)\n\nselect  \n    t.itype, \n    t.playclass1, \n    iusernum1, -- 流入玩法参与用户数\n    iusernum2, -- 流出用户数\n    iusernum3, -- 双栖用户数\n    iusernum4, -- 前一周流出玩法用户数\n    coalesce(round(iusernum2/iusernum4, 2), 0) as ratio1, -- 流出占比\n    iusernum5, -- 后3天流出玩法用户数\n    coalesce(round(iusernum3/iusernum5, 2), 0) as ratio2 -- 双栖占比\nfrom (\n    select itype,count(distinct vplayerid) iusernum1 from playuser group by itype\n)p\nleft join (\n    select \n        a.itype,\n        b.playclass1,\n        count(distinct case when islast=1 and isthis =0 then a.vplayerid end) iusernum2,\n        count(distinct case when islast=1 and isthis =1 then a.vplayerid end) iusernum3\n    from playuser a\n    left join allplayuser b \n    on a.itype =b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.playclass1\n)t on p.itype = t.itype\nleft join (\n    select \n        itype, \n        playclass1,\n        count(distinct case when islast=1 then vplayerid end) iusernum4,\n        count(distinct case when isthis=1 then vplayerid end) iusernum5\n    from allplayuser\n    group by itype,playclass1\n) m on t.playclass1=m.playclass1 and t.itype=m.itype\n\n) AS final_query;", "meta": {"origin": "sql_39", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_10_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.7.12-2025.6.15，赛季bp道具皮肤的使用情况。\n输出：道具id、赛季名称、当前赛季使用人数、当前赛季购买人数\n【表】dwd_argothek_playerloadout_expressions_hi, dwd_argothek_playerloadout_hi, dwd_argothek_playerloadout_sprayslots_hi, dwd_argothek_commercialization_gearid_df, dim_argothek_seasondate_df\n【口径】bp枪皮购买逻辑:\nand purchaseSource = \"BATTLEPASS_PROGRESS\" -- 筛选来源为BATTLEPASS_PROGRESS\nand itemtype = \"d5f120f8-ff8c-4aac-92ea-f2b5acbe9475\" -- 筛选itemtype为指定值\n枪皮使用逻辑：\nexpressionassetid is not null and expressiontypeid = \"d5f120f8-ff8c-4aac-92ea-f2b5acbe9475\"\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH season_calendar AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    MIN(STR_TO_DATE(idate, '%Y%m%d')) AS season_start,\n    MAX(STR_TO_DATE(idate, '%Y%m%d')) AS season_end\n  FROM dim_argothek_seasondate_df\n  WHERE STR_TO_DATE(idate, '%Y%m%d') BETWEEN '2023-07-28' AND '2025-07-01'\n  GROUP BY seasonid, seasonidname\n), usage_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    e.expressionassetid AS item_id,\n    l.subject AS user_id\n  FROM dwd_argothek_playerloadout_expressions_hi e\n  JOIN dwd_argothek_playerloadout_hi l\n    ON e.apeventid = l.apeventid\n  JOIN season_calendar sc\n    ON STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN '2023-07-28' AND '2025-07-01'\n    AND e.expressionassetid IS NOT NULL\n    AND e.expressiontypeid = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n), usage_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT user_id) AS season_use_user_cnt\n  FROM usage_base\n  GROUP BY seasonid, seasonidname, item_id\n), purchase_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    g.purchaseditemid AS item_id,\n    g.vtemp1 AS buyer_id\n  FROM dwd_argothek_commercialization_gearid_df g\n  JOIN season_calendar sc\n    ON STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN '2023-07-28' AND '2025-07-01'\n    AND g.purchasesource = 'BATTLEPASS_PROGRESS'\n    AND g.itemtype = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n    AND g.vtemp1 IS NOT NULL\n), purchase_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT buyer_id) AS season_buy_user_cnt\n  FROM purchase_base\n  GROUP BY seasonid, seasonidname, item_id\n)\nSELECT\n  item_id,\n  season_name,\n  SUM(season_use_user_cnt) AS season_use_user_cnt,\n  SUM(season_buy_user_cnt) AS season_buy_user_cnt\nFROM (\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    season_use_user_cnt,\n    0 AS season_buy_user_cnt\n  FROM usage_agg\n  UNION ALL\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    0 AS season_use_user_cnt,\n    season_buy_user_cnt\n  FROM purchase_agg\n) merged\nGROUP BY item_id, season_name\nORDER BY season_name, item_id;"}], "rejected": "WITH season_calendar AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    MIN(STR_TO_DATE(idate, '%Y%m%d')) AS season_start,\n    MAX(STR_TO_DATE(idate, '%Y%m%d')) AS season_end\n  FROM dim_argothek_seasondate_df\n  WHERE STR_TO_DATE(idate, '%Y%m%d') BETWEEN '2023-07-28' AND '2025-07-01'\n  GROUP BY seasonid, seasonidname\n), usage_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    e.expressionassetid AS item_id,\n    l.subject AS user_id\n  FROM dwd_argothek_playerloadout_expressions_hi e\n  JOIN dwd_argothek_playerloadout_hi l\n    ON e.apeventid = l.apeventid\n  JOIN season_calendar sc\n    ON STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN '2023-07-28' AND '2025-07-01'\n    AND e.expressionassetid IS NOT NULL\n    AND e.expressiontypeid = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n), usage_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT user_id) AS season_use_user_cnt\n  FROM usage_base\n  GROUP BY seasonid, seasonidname, item_id\n), purchase_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    g.purchaseditemid AS item_id,\n    g.vtemp1 AS buyer_id\n  FROM dwd_argothek_commercialization_gearid_df g\n  JOIN season_calendar sc\n    ON STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN '2023-07-28' AND '2025-07-01'\n    AND g.purchasesource = 'BATTLEPASS_PROGRESS'\n    AND g.itemtype = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n    AND g.vtemp1 IS NOT NULL\n), purchase_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT buyer_id) AS season_buy_user_cnt\n  FROM purchase_base\n  GROUP BY seasonid, seasonidname, item_id\n)\nSELECT\n  item_id,\n  season_name,\n  SUM(season_use_user_cnt) AS season_use_user_cnt,\n  SUM(season_buy_user_cnt) AS season_buy_user_cnt\nFROM (\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    season_use_user_cnt,\n    0 AS season_buy_user_cnt\n  FROM usage_agg\n  UNION ALL\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    0 AS season_use_user_cnt,\n    season_buy_user_cnt\n  FROM purchase_agg\n) merged\nGROUP BY item_id, season_name\nORDER BY season_name, item_id;", "meta": {"origin": "sql_10", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_68_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计时间范围：25.1.28-25.2.10，新春华服id：848，841 \n输出：日期（YYDDMM），人数\n【表】dwd_jordass_lotteryrecord_hi\n【口径】新春华服：\nactivitytype in (848, 841)"}, {"role": "assistant", "content": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom dwd_jordass_lotteryrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20250203' and '20250216'\n  and activitytype in (848, 841)\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date;"}], "rejected": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom dwd_jordass_lotteryrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20250203'\n  and activitytype in (848, 841)\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date;", "meta": {"origin": "sql_68", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_48_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.12.1流失7天的回流用户数和流失30天的回流用户数\n输出：流失7天的回流用户数，流失30天的回流用户数\n【表】dws_jordass_login_df\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n    count(distinct case when is_backflow_7 then vplayerid end) as backflow_7_user,\n    count(distinct case when is_backflow_30 then vplayerid end) as backflow_30_user\nfrom (\n    select\n        vplayerid,\n        -- 检查是否满足流失7天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 7), '1') = 0) as is_backflow_7,\n        \n        -- 检查是否满足流失30天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 30), '1') = 0) as is_backflow_30\n    from\n        dws_jordass_login_df\n    where\n        dtstatdate = '20231202'\n        and platid = 255\n) as user_flags\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n    count(distinct case when is_backflow_7 then vplayerid end) as backflow_7_user,\n    count(distinct case when is_backflow_30 then vplayerid end) as backflow_30_user\nfrom (\n    select\n        vplayerid,\n        -- 检查是否满足流失7天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 7), '1') = 0) as is_backflow_7,\n        \n        -- 检查是否满足流失30天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 30), '1') = 0) as is_backflow_30\n    from\n        dws_jordass_login_df\n    where\n        dtstatdate = '20231202'\n        and platid = 255\n) as user_flags\n) AS final_query;", "meta": {"origin": "sql_48", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_3_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年1月勇者盟约端游活跃玩家交叉峡谷端游及手游活跃玩家。\n输出：玩家 gplayerid\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df, dws_mgamejp_login_user_activity_di\n【口径】勇者盟约端游活跃：dws_argothek_oss_login_di.statis_date\n账号映射：dim_argothek_gplayerid2qqwxid_df，字段 swxid_type 对应事实表 suseridtype\n峡谷活跃口径：\nsgamecode = \"initiatived\"\nsaccounttype = \"-100\"\nsuseridtype in (\"qq\",\"wxid\")\nsplattype in (\"-100\",\"PC\")\nsplat = \"-100\"\n所有日期使用字符串 YYYYMMDD"}, {"role": "assistant", "content": "WITH argothek_active AS (\n  SELECT DISTINCT iuserid AS gplayerid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN '20250106' AND '20250205'\n),\nlatest_map AS (\n  SELECT gplayerid,\n         suserid,\n         swxid_type AS suserid_type\n  FROM (\n    SELECT iuserid AS gplayerid,\n           suserid,\n           swxid_type,\n           ROW_NUMBER() OVER (PARTITION BY iuserid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid2qqwxid_df\n    WHERE dtstatdate <= '20250205'\n      AND suserid IS NOT NULL\n      AND swxid_type IN ('qq', 'wxid')\n  ) t\n  WHERE rn = 1\n),\nxinggu_active AS (\n  SELECT DISTINCT suserid, suseridtype\n  FROM dws_mgamejp_login_user_activity_di\n  WHERE dtstatdate BETWEEN '20250106' AND '20250205'\n    AND sgamecode = 'initiatived'\n    AND saccounttype = '-100'\n    AND suseridtype IN ('qq', 'wxid')\n    AND splattype IN ('-100', 'PC')\n    AND splat = '-100'\n)\nSELECT DISTINCT a.gplayerid\nFROM argothek_active a\nJOIN latest_map m\n  ON a.gplayerid = m.gplayerid\nJOIN xinggu_active x\n  ON m.suserid = x.suserid\n AND m.suserid_type = x.suseridtype\nORDER BY a.gplayerid;"}], "rejected": "WITH argothek_active AS (\n  SELECT DISTINCT iuserid AS gplayerid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date > '20250106'\n),\nlatest_map AS (\n  SELECT gplayerid,\n         suserid,\n         swxid_type AS suserid_type\n  FROM (\n    SELECT iuserid AS gplayerid,\n           suserid,\n           swxid_type,\n           ROW_NUMBER() OVER (PARTITION BY iuserid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid2qqwxid_df\n    WHERE dtstatdate <= '20250205'\n      AND suserid IS NOT NULL\n      AND swxid_type IN ('qq', 'wxid')\n  ) t\n  WHERE rn = 1\n),\nxinggu_active AS (\n  SELECT DISTINCT suserid, suseridtype\n  FROM dws_mgamejp_login_user_activity_di\n  WHERE dtstatdate BETWEEN '20250106' AND '20250205'\n    AND sgamecode = 'initiatived'\n    AND saccounttype = '-100'\n    AND suseridtype IN ('qq', 'wxid')\n    AND splattype IN ('-100', 'PC')\n    AND splat = '-100'\n)\nSELECT DISTINCT a.gplayerid\nFROM argothek_active a\nJOIN latest_map m\n  ON a.gplayerid = m.gplayerid\nJOIN xinggu_active x\n  ON m.suserid = x.suserid\n AND m.suserid_type = x.suseridtype\nORDER BY a.gplayerid;", "meta": {"origin": "sql_3", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_1_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.07.24的手游全量用户且标签为其他，在竞品业务下2025.05.30-2025.07.24的在线时长。\n输出：suserid、sgamecode、ionlinetime\n【表】dws_mgamejp_login_user_activity_di, dim_vplayerid_vies_df\n【口径】竞品业务：\nsgamecode in (\"initiatived\",\"jordass\",\"esports\",\"allianceforce\",\"strategy\",\"playzone\",\"su\")\nsaccounttype = \"-100\" -- 账号体系取汇总\nsuseridtype in (\"qq\",\"wxid\",\"guest\") -- 用户类型\nsplattype IN (\"-100\",\"PC\") -- 平台类型写死-100\nsplat IN (\"-100\",\"PC\") -- 平台写死-100\n\ndim_vplayerid_vies_df 字段：suserid、suserid_type（映射到事实表的 suserid / suseridtype）\n扩展业务：包含 pcArena。"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH base_user AS (\n  SELECT DISTINCT\n         suserid,\n         suserid_type\n  FROM dim_vplayerid_vies_df\n  WHERE dtstatdate = '20250725'\n    AND itag = '其他'\n    AND suserid IS NOT NULL\n    AND suserid_type IN ('qq', 'wxid')\n)\nSELECT\n    a.suserid,\n    a.sgamecode,\n    SUM(a.ionlinetime) AS ionlinetime\nFROM dws_mgamejp_login_user_activity_di a\nJOIN base_user b\n  ON a.suserid = b.suserid\n AND a.suseridtype = b.suserid_type\nWHERE a.dtstatdate BETWEEN '20250531' AND '20250725'\n  AND a.sgamecode IN ('pcarena','initiatived', 'jordass', 'esports', 'allianceforce', 'strategy', 'playzone', 'su')\n  AND a.saccounttype = '-100'\n  AND a.suseridtype IN ('qq', 'wxid')\n  AND a.splattype IN ('-100','PC')\n  AND a.splat IN ('-100','PC')\nGROUP BY a.suserid, a.sgamecode\nORDER BY a.suserid, a.sgamecode\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH base_user AS (\n  SELECT DISTINCT\n         suserid,\n         suserid_type\n  FROM dim_vplayerid_vies_df\n  WHERE dtstatdate = '20250725'\n    AND itag = '其他'\n    AND suserid IS NOT NULL\n    AND suserid_type IN ('qq', 'wxid')\n)\nSELECT\n    a.suserid,\n    a.sgamecode,\n    SUM(a.ionlinetime) AS ionlinetime\nFROM dws_mgamejp_login_user_activity_di a\nJOIN base_user b\n  ON a.suserid = b.suserid\n AND a.suseridtype = b.suserid_type\nWHERE a.dtstatdate BETWEEN '20250531' AND '20250725'\n  AND a.sgamecode IN ('pcarena','initiatived', 'jordass', 'esports', 'allianceforce', 'strategy', 'playzone', 'su')\n  AND a.suseridtype IN ('qq', 'wxid')\n  AND a.splattype IN ('-100','PC')\n  AND a.splat IN ('-100','PC')\nGROUP BY a.suserid, a.sgamecode\nORDER BY a.suserid, a.sgamecode\n) AS final_query;", "meta": {"origin": "sql_1", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_16_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：近一年（2023/7/12-2025/5/31）按段位统计所有竞技模式对局中，排除掉投降的对局情况。\n输出：日期（20230717-20250605）、段位（黑铁、...、无段位、全量段位）当日竞技模式非投降局对局数、当日竞技模式投降局对局数、当日竞技模式非投降局中 双方胜利回合差>=6和双方胜利回合差>=8的对局数\n【表】dwd_argothek_playermatchstats_hi\n【口径】段位筛选逻辑：\ncase\nwhen competitiveTier in (3, 4, 5) then \"黑铁\"\nwhen competitiveTier in (6, 7, 8) then \"黄铜\"\nwhen competitiveTier in (9, 10, 11) then \"白银\"\nwhen competitiveTier in (12, 13, 14) then \"黄金\"\nwhen competitiveTier in (15, 16, 17) then \"白金\"\nwhen competitiveTier in (18, 19, 20) then \"钻石\"\nwhen competitiveTier in (21, 22, 23) then \"超凡\"\nwhen competitiveTier >= 24 then \"神话及以上\"\nelse \"无段位\"\n竞技模式：模式id等于\"competitive\"\n对局筛选逻辑:\n使用completion_state筛选投降与非投降对局；使用roundsdiff筛选双方胜利回合差"}, {"role": "assistant", "content": "WITH base AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    matchid,\n    MAX(CASE WHEN LOWER(completionstate) = 'surrendered' THEN 1 ELSE 0 END) AS is_surrender,\n    MAX(roundswon) AS max_rounds_won,\n    MIN(roundswon) AS min_rounds_won,\n    MAX(competitivetier) AS max_tier\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE queueid = 'competitive'\n    AND DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') BETWEEN '20230717' AND '20250605'\n  GROUP BY DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d'), matchid\n), enriched AS (\n  SELECT\n    statis_date,\n    matchid,\n    CASE\n      WHEN max_tier IN (3, 4, 5) THEN '黑铁'\n      WHEN max_tier IN (6, 7, 8) THEN '黄铜'\n      WHEN max_tier IN (9, 10, 11) THEN '白银'\n      WHEN max_tier IN (12, 13, 14) THEN '黄金'\n      WHEN max_tier IN (15, 16, 17) THEN '白金'\n      WHEN max_tier IN (18, 19, 20) THEN '钻石'\n      WHEN max_tier IN (21, 22, 23) THEN '超凡'\n      WHEN max_tier >= 24 THEN '神话及以上'\n      ELSE '无段位'\n    END AS rank_bucket,\n    is_surrender,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 6 THEN 1 ELSE 0 END AS diff_ge_6,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 8 THEN 1 ELSE 0 END AS diff_ge_8\n  FROM base\n), daily_rank AS (\n  SELECT\n    statis_date,\n    rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date, rank_bucket\n), daily_all AS (\n  SELECT\n    statis_date,\n    '全量段位' AS rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date\n)\nSELECT\n  statis_date AS statis_date,\n  rank_bucket AS rank_name,\n  non_surrender_match_cnt AS non_surrender_match_cnt,\n  surrender_match_cnt AS surrender_match_cnt,\n  diff_ge6_match_cnt AS diff_ge6_match_cnt,\n  diff_ge8_match_cnt AS diff_ge8_match_cnt\nFROM daily_rank\nUNION ALL\nSELECT\n  statis_date,\n  rank_bucket,\n  non_surrender_match_cnt,\n  surrender_match_cnt,\n  diff_ge6_match_cnt,\n  diff_ge8_match_cnt\nFROM daily_all\nORDER BY statis_date, rank_name;"}], "rejected": "WITH base AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    matchid,\n    MAX(CASE WHEN LOWER(completionstate) = 'surrendered' THEN 1 ELSE 0 END) AS is_surrender,\n    MAX(roundswon) AS max_rounds_won,\n    MIN(roundswon) AS min_rounds_won,\n    MAX(competitivetier) AS max_tier\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE queueid = 'competitive'\n    AND DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') > '20230717'\n  GROUP BY DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d'), matchid\n), enriched AS (\n  SELECT\n    statis_date,\n    matchid,\n    CASE\n      WHEN max_tier IN (3, 4, 5) THEN '黑铁'\n      WHEN max_tier IN (6, 7, 8) THEN '黄铜'\n      WHEN max_tier IN (9, 10, 11) THEN '白银'\n      WHEN max_tier IN (12, 13, 14) THEN '黄金'\n      WHEN max_tier IN (15, 16, 17) THEN '白金'\n      WHEN max_tier IN (18, 19, 20) THEN '钻石'\n      WHEN max_tier IN (21, 22, 23) THEN '超凡'\n      WHEN max_tier >= 24 THEN '神话及以上'\n      ELSE '无段位'\n    END AS rank_bucket,\n    is_surrender,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 6 THEN 1 ELSE 0 END AS diff_ge_6,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 8 THEN 1 ELSE 0 END AS diff_ge_8\n  FROM base\n), daily_rank AS (\n  SELECT\n    statis_date,\n    rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date, rank_bucket\n), daily_all AS (\n  SELECT\n    statis_date,\n    '全量段位' AS rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date\n)\nSELECT\n  statis_date AS statis_date,\n  rank_bucket AS rank_name,\n  non_surrender_match_cnt AS non_surrender_match_cnt,\n  surrender_match_cnt AS surrender_match_cnt,\n  diff_ge6_match_cnt AS diff_ge6_match_cnt,\n  diff_ge8_match_cnt AS diff_ge8_match_cnt\nFROM daily_rank\nUNION ALL\nSELECT\n  statis_date,\n  rank_bucket,\n  non_surrender_match_cnt,\n  surrender_match_cnt,\n  diff_ge6_match_cnt,\n  diff_ge8_match_cnt\nFROM daily_all\nORDER BY statis_date, rank_name;", "meta": {"origin": "sql_16", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_62_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250226联盟前180日（包含当天）基础数据 说明：按照uid计算\n输出：统计日期（YYYYMMDD），角色DAU，联盟参与角色数，联盟完成特训任务角色数，联盟商店兑换次数\n【表】dwd_jordass_allianceshopbuy_hi, dwd_jordass_player_allianceactive_hi, dwd_jordass_alliancebootcamprecord_hi, dwd_jordass_playerlogout_hi, dwd_jordass_playerlogin_hi\n【口径】"}, {"role": "assistant", "content": "WITH login_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n),\nalliance_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n),\nbootcamp_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n),\nshop_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n),\nall_dates AS (\n  SELECT stat_date FROM login_dates\n  UNION\n  SELECT stat_date FROM alliance_dates\n  UNION\n  SELECT stat_date FROM bootcamp_dates\n  UNION\n  SELECT stat_date FROM shop_dates\n),\nrole_dau AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS dau_cnt\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n  GROUP BY stat_date\n),\nalliance_participate AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS participate_cnt\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n  GROUP BY stat_date\n),\nbootcamp_finish AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT memberuid) AS bootcamp_cnt\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n  GROUP BY stat_date\n),\nshop_exchange AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(*) AS exchange_cnt\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n  GROUP BY stat_date\n)\nSELECT\n  DATE_FORMAT(d.stat_date, '%Y%m%d') AS stat_date,\n  COALESCE(rd.dau_cnt, 0) AS role_dau,\n  COALESCE(ap.participate_cnt, 0) AS alliance_participate_cnt,\n  COALESCE(bf.bootcamp_cnt, 0) AS bootcamp_finish_role_cnt,\n  COALESCE(se.exchange_cnt, 0) AS alliance_shop_exchange_cnt\nFROM all_dates d\nLEFT JOIN role_dau rd ON d.stat_date = rd.stat_date\nLEFT JOIN alliance_participate ap ON d.stat_date = ap.stat_date\nLEFT JOIN bootcamp_finish bf ON d.stat_date = bf.stat_date\nLEFT JOIN shop_exchange se ON d.stat_date = se.stat_date\nORDER BY d.stat_date;"}], "rejected": "WITH login_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n),\nalliance_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n),\nbootcamp_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n),\nshop_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n),\nall_dates AS (\n  SELECT stat_date FROM login_dates\n  UNION\n  SELECT stat_date FROM alliance_dates\n  UNION\n  SELECT stat_date FROM bootcamp_dates\n  UNION\n  SELECT stat_date FROM shop_dates\n),\nrole_dau AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS dau_cnt\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n  GROUP BY stat_date\n),\nalliance_participate AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS participate_cnt\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n  GROUP BY stat_date\n),\nbootcamp_finish AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT memberuid) AS bootcamp_cnt\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n  GROUP BY stat_date\n),\nshop_exchange AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(*) AS exchange_cnt\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-03', INTERVAL 179 DAY) AND '2025-03-03'\n  GROUP BY stat_date\n)\nSELECT\n  DATE_FORMAT(d.stat_date, '%Y%m%d') AS stat_date,\n  COALESCE(rd.dau_cnt, 0) AS role_dau,\n  COALESCE(ap.participate_cnt, 0) AS alliance_participate_cnt,\n  COALESCE(bf.bootcamp_cnt, 0) AS bootcamp_finish_role_cnt,\n  COALESCE(se.exchange_cnt, 0) AS alliance_shop_exchange_cnt\nFROM all_dates d\nLEFT JOIN role_dau rd ON d.stat_date = rd.stat_date\nLEFT JOIN alliance_participate ap ON d.stat_date = ap.stat_date\nLEFT JOIN bootcamp_finish bf ON d.stat_date = bf.stat_date\nLEFT JOIN shop_exchange se ON d.stat_date = se.stat_date\nORDER BY d.stat_date;", "meta": {"origin": "sql_62", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_13_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20230712以来，历史累计活跃30天以上，但3月12日及以后未活跃过的用户且剔除掉历史充值 1500 元以上的用户后的玩家wxid\n输出：玩家wxid\n时间统计范围:20230717-20250617\n【表】dim_mgamejp_tbplayerid2wxid_nf, dws_argothek_oss_portaltransaction_di, dim_mgamejp_idconversion_wxid_qq_nf, dws_argothek_oss_login_di, dim_mgamejp_tbplayerid2qq_nf\n【口径】历史充值1500以上的用户：\nsum(ftranamt)/100 > 1500\n限制sappid in (\"qq\",\"wx\")"}, {"role": "assistant", "content": "WITH login_window AS (\n  SELECT\n    iuserid,\n    COUNT(DISTINCT statis_date) AS active_days,\n    MAX(statis_date) AS last_active_date\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20230717 AND 20250617\n  GROUP BY iuserid\n), qualified_login AS (\n  SELECT iuserid\n  FROM login_window\n  WHERE active_days >= 30\n    AND last_active_date < 20250317\n), pay_window AS (\n  SELECT\n    iuserid,\n    SUM(ftranamt) / 100.0 AS total_pay\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date BETWEEN '20230717' AND '20250617'\n  GROUP BY iuserid\n), filtered_user AS (\n  SELECT\n    q.iuserid,\n    COALESCE(p.total_pay, 0) AS total_pay\n  FROM qualified_login q\n  LEFT JOIN pay_window p\n    ON q.iuserid = p.iuserid\n  WHERE COALESCE(p.total_pay, 0) <= 1500\n), wxid_map AS (\n  SELECT\n    splayerid AS iuserid,\n    swxid\n  FROM dim_mgamejp_tbplayerid2wxid_nf\n  WHERE dtstatdate = 20250617\n    AND sappid IN ('qq', 'wx')\n    AND swxid IS NOT NULL\n)\nSELECT DISTINCT\n  m.swxid AS player_wxid\nFROM filtered_user f\nJOIN wxid_map m\n  ON f.iuserid = m.iuserid\nWHERE m.swxid <> ''\nORDER BY player_wxid;"}], "rejected": "WITH login_window AS (\n  SELECT\n    iuserid,\n    COUNT(DISTINCT statis_date) AS active_days,\n    MAX(statis_date) AS last_active_date\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20230717 AND 20250617\n  GROUP BY iuserid\n), qualified_login AS (\n  SELECT iuserid\n  FROM login_window\n  WHERE active_days >= 30\n    AND last_active_date < 20250317\n), pay_window AS (\n  SELECT\n    iuserid,\n    SUM(ftranamt) / 100.0 AS total_pay\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date > '20230717'\n  GROUP BY iuserid\n), filtered_user AS (\n  SELECT\n    q.iuserid,\n    COALESCE(p.total_pay, 0) AS total_pay\n  FROM qualified_login q\n  LEFT JOIN pay_window p\n    ON q.iuserid = p.iuserid\n  WHERE COALESCE(p.total_pay, 0) <= 1500\n), wxid_map AS (\n  SELECT\n    splayerid AS iuserid,\n    swxid\n  FROM dim_mgamejp_tbplayerid2wxid_nf\n  WHERE dtstatdate = 20250617\n    AND sappid IN ('qq', 'wx')\n    AND swxid IS NOT NULL\n)\nSELECT DISTINCT\n  m.swxid AS player_wxid\nFROM filtered_user f\nJOIN wxid_map m\n  ON f.iuserid = m.iuserid\nWHERE m.swxid <> ''\nORDER BY player_wxid;", "meta": {"origin": "sql_13", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_37_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计注册日期在2025.4.1-2025.5.30的模拟器新进用户在用户类型（模拟器、手机端、整体砺刃游戏内），次留、三留、七留、14留、30留情况\n输出:日期(20250428、...、20250626)、人数、用户类型（模拟器、手机端、游戏内、未知）、次留人数、三留人数、七留人数、14留人数、30留人数\n【表】dws_jordass_device_login_di, dws_jordass_emulator_df, dws_jordass_login_di\n【口径】模拟器新进用户从dws_jordass_emulator_df取，限制统计日期为20251001\n模拟器：device_type in (1,5)；\n手机端：device_type=0\n\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select \n    s1.ds as `ds`, -- 日期\n    count(distinct s1.vplayerid) as `user_cnt`, -- 人数\n    coalesce(user_type, '未知') as `user_type`, -- 用户类型\n    count(distinct case when s2.ds = date_add(s1.ds, 1) then s1.vplayerid else null end) as `next_day_retention`, -- 次留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 2) then s1.vplayerid else null end) as `three_day_retention`, -- 三留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 6) then s1.vplayerid else null end) as `seven_day_retention`, -- 七留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 13) then s1.vplayerid else null end) as `fourteen_day_retention`, -- 14留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 29) then s1.vplayerid else null end) as `thirty_day_retention` -- 30留人数\nfrom (\n    select \n        f1.dregdate as ds,  -- 日期\n        f1.vplayerid as vplayerid  -- 用户id\n    from  dws_jordass_emulator_df f1\n    where   f1.dtstatdate = '20251028'  \n        and f1.dregdate >= '20250428'  \n        and f1.dregdate <= '20250626'  \n        and f1.platid = 255  \n) s1\nleft join (\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '手机端' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type=0 -- 手机端\n    and f1.dtstatdate >= '20250428' and f1.dtstatdate <= date_add('20250626', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '模拟器' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type in (1,5) -- 模拟器\n    and f1.dtstatdate >= '20250428' and f1.dtstatdate <= date_add('20250626', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds,  -- 日期\n        f1.vplayerid as vplayerid,  -- 整体游戏内登录用户id\n        '游戏内' as user_type\n    from   dws_jordass_login_di f1  \n    where  f1.dtstatdate >= '20250428' and f1.dtstatdate <= date_add('20250626', 29)\n    and f1.platid = 255  -- 不区分系统平台\n) s2 \n    on   s1.vplayerid = s2.vplayerid\n    group by   s1.ds, user_type\n;"}], "rejected": "select \n    s1.ds as `ds`, -- 日期\n    count(distinct s1.vplayerid) as `user_cnt`, -- 人数\n    coalesce(user_type, '未知') as `user_type`, -- 用户类型\n    count(distinct case when s2.ds = date_add(s1.ds, 1) then s1.vplayerid else null end) as `next_day_retention`, -- 次留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 2) then s1.vplayerid else null end) as `three_day_retention`, -- 三留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 6) then s1.vplayerid else null end) as `seven_day_retention`, -- 七留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 13) then s1.vplayerid else null end) as `fourteen_day_retention`, -- 14留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 29) then s1.vplayerid else null end) as `thirty_day_retention` -- 30留人数\nfrom (\n    select \n        f1.dregdate as ds,  -- 日期\n        f1.vplayerid as vplayerid  -- 用户id\n    from  dws_jordass_emulator_df f1\n    where   f1.dtstatdate = '20251028'  \n        and f1.dregdate >= '20250428'  \n        and f1.dregdate <= '20250626'  \n        and f1.platid = 255  \n) s1\nleft join (\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '手机端' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type=0 -- 手机端\n    and f1.dtstatdate >= '20250428' and f1.dtstatdate <= date_add('20250626', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '模拟器' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type in (1,5) -- 模拟器\n    and f1.dtstatdate >= '20250428' and f1.dtstatdate <= date_add('20250626', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds,  -- 日期\n        f1.vplayerid as vplayerid,  -- 整体游戏内登录用户id\n        '游戏内' as user_type\n    from   dws_jordass_login_di f1  \n    where  f1.dtstatdate >= '20250428' and f1.dtstatdate <= date_add('20250626', 29)\n    and f1.platid = 255  -- 不区分系统平台\n) s2 \n    on   s1.vplayerid = s2.vplayerid\n    group by   s1.ds, user_type\n;", "meta": {"origin": "sql_37", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_87_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.07.02和2023.07.09 参与乐园各子玩法的用户里，砺刃新进、回流、留存用户数\n注：新进，回流，留存都按照7天为一个周期来计算\n输出：统计日期（YYYYMMDD），玩法，类型（新进、回流、留存），人数\n【表】dws_jordass_login_df, dim_jordass_leyuan_participate_cdf_nf\n【口径】乐园玩法子用户筛选条件：\ninstr(substr(cbitmap,1,7),'1')>0\n回流与留存计算：\ncase when datediff(dtstatdate,dregdate)<=6 then '新进'\nwhen instr(substr(cbitmap,8,7),'1')>0 then '留存'\nwhen instr(substr(cbitmap,8,7),'1')=0 then '回流'\n注意只需要统计上述三种类型\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "SELECT\n  dtstatdate AS stat_date,\n  matchsubmodegroup AS play_mode,\n  CASE\n    WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n    WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n    ELSE '回流'\n  END AS user_type,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM dim_jordass_leyuan_participate_cdf_nf\nWHERE dtstatdate IN ('20230728', '20230804')\n  AND INSTR(SUBSTR(cbitmap, 1, 7), '1') > 0\n  AND CASE\n        WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n        WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n        ELSE '回流'\n      END IN ('新进', '留存', '回流')\nGROUP BY dtstatdate, matchsubmodegroup,\n         CASE\n           WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n           WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n           ELSE '回流'\n         END\nORDER BY stat_date, play_mode, user_type;"}], "rejected": "SELECT\n  dtstatdate AS stat_date,\n  matchsubmodegroup AS play_mode,\n  CASE\n    WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n    WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n    ELSE '回流'\n  END AS user_type,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM dim_jordass_leyuan_participate_cdf_nf\nWHERE dtstatdate IN ('20230728', '20230804')\n  AND INSTR(SUBSTR(cbitmap, 1, 7), '1') > 0\n  AND CASE\n        WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n        WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n        ELSE '回流'\n      END IN ('新进', '留存', '回流')\nGROUP BY dtstatdate, matchsubmodegroup,\n         CASE\n           WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n           WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n           ELSE '回流'\n         END\nORDER BY stat_date, play_mode, user_type;", "meta": {"origin": "sql_87", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_19_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024年5月02日-2024年5月02日，日活跃用户的周边休闲模式情况。\n\n活跃日期区间：\"20250528-20250603\"\n\n输出：\n日活跃中仅玩QuickMatch模式的玩家数\n日活跃中仅玩RushMode模式的玩家数\n日活跃中仅玩CombatArena模式的玩家数\n日活跃中仅玩以上三个模式不玩其他模式的玩家数\n日活跃中仅玩以上三个模式不玩其他模式的玩家周活跃频次\n【表】dws_argothek_oss_login_di, dwd_argothek_playermatchstats_hi, dim_argothek_gplayerid_vroleid_df\n【口径】仅玩单一模式逻辑：\nhaving count(distinct queueid) = 1 -- 只玩一个模式\nand max(queueid) = \"xxx\" -- 模式ID为RushMode\n用户角色映射逻辑：\niareaid = \"101\"\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH active_login AS (\n  SELECT\n    statis_date,\n    iuserid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20250528 AND 20250603\n  GROUP BY statis_date, iuserid\n), role_map AS (\n  SELECT vroleid, iuserid\n  FROM (\n    SELECT\n      vroleid,\n      iuserid,\n      ROW_NUMBER() OVER (PARTITION BY vroleid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid_vroleid_df\n    WHERE iAreaID = '101'\n      AND dtstatdate <= '20250603'\n  ) t\n  WHERE rn = 1\n), match_log AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    vroleid,\n    LOWER(queueid) AS queueid\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') BETWEEN '20250528' AND '20250603'\n), match_player AS (\n  SELECT\n    m.statis_date,\n    r.iuserid,\n    m.queueid\n  FROM match_log m\n  JOIN role_map r\n    ON m.vroleid = r.vroleid\n), player_modes AS (\n  SELECT\n    a.statis_date,\n    a.iuserid,\n    COUNT(DISTINCT mp.queueid) AS total_modes_cnt,\n    MAX(CASE WHEN mp.queueid = 'quickmatch' THEN 1 ELSE 0 END) AS has_quick,\n    MAX(CASE WHEN mp.queueid = 'rushmode' THEN 1 ELSE 0 END) AS has_rush,\n    MAX(CASE WHEN mp.queueid = 'combatarena' THEN 1 ELSE 0 END) AS has_combat,\n    MAX(CASE WHEN mp.queueid IS NOT NULL AND mp.queueid NOT IN ('quickmatch', 'rushmode', 'combatarena') THEN 1 ELSE 0 END) AS has_other\n  FROM active_login a\n  LEFT JOIN match_player mp\n    ON a.statis_date = mp.statis_date\n   AND a.iuserid = mp.iuserid\n  GROUP BY a.statis_date, a.iuserid\n), player_day_flags AS (\n  SELECT\n    statis_date,\n    iuserid,\n    CASE WHEN total_modes_cnt = 1 AND has_quick = 1 THEN 1 ELSE 0 END AS only_quick_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_rush = 1 THEN 1 ELSE 0 END AS only_rush_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_combat = 1 THEN 1 ELSE 0 END AS only_combat_flag,\n    CASE WHEN total_modes_cnt > 0 AND COALESCE(has_other, 0) = 0 THEN 1 ELSE 0 END AS only_three_flag\n  FROM player_modes\n), daily_summary AS (\n  SELECT\n    statis_date,\n    SUM(only_quick_flag) AS only_quick_user_cnt,\n    SUM(only_rush_flag) AS only_rush_user_cnt,\n    SUM(only_combat_flag) AS only_combat_user_cnt,\n    SUM(only_three_flag) AS only_three_modes_user_cnt\n  FROM player_day_flags\n  GROUP BY statis_date\n), weekly_freq AS (\n  SELECT SUM(only_three_flag) AS only_three_modes_week_freq\n  FROM player_day_flags\n)\nSELECT\n  d.statis_date AS statis_date,\n  d.only_quick_user_cnt AS only_quick_user_cnt,\n  d.only_rush_user_cnt AS only_rush_user_cnt,\n  d.only_combat_user_cnt AS only_combat_user_cnt,\n  d.only_three_modes_user_cnt AS only_three_modes_user_cnt,\n  wf.only_three_modes_week_freq AS only_three_modes_week_freq\nFROM daily_summary d\nCROSS JOIN weekly_freq wf\nORDER BY statis_date;"}], "rejected": "WITH active_login AS (\n  SELECT\n    statis_date,\n    iuserid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20250528 AND 20250603\n  GROUP BY statis_date, iuserid\n), role_map AS (\n  SELECT vroleid, iuserid\n  FROM (\n    SELECT\n      vroleid,\n      iuserid,\n      ROW_NUMBER() OVER (PARTITION BY vroleid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid_vroleid_df\n    WHERE iAreaID = '101'\n      AND dtstatdate <= '20250603'\n  ) t\n  WHERE rn = 1\n), match_log AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    vroleid,\n    LOWER(queueid) AS queueid\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') > '20250528'\n), match_player AS (\n  SELECT\n    m.statis_date,\n    r.iuserid,\n    m.queueid\n  FROM match_log m\n  JOIN role_map r\n    ON m.vroleid = r.vroleid\n), player_modes AS (\n  SELECT\n    a.statis_date,\n    a.iuserid,\n    COUNT(DISTINCT mp.queueid) AS total_modes_cnt,\n    MAX(CASE WHEN mp.queueid = 'quickmatch' THEN 1 ELSE 0 END) AS has_quick,\n    MAX(CASE WHEN mp.queueid = 'rushmode' THEN 1 ELSE 0 END) AS has_rush,\n    MAX(CASE WHEN mp.queueid = 'combatarena' THEN 1 ELSE 0 END) AS has_combat,\n    MAX(CASE WHEN mp.queueid IS NOT NULL AND mp.queueid NOT IN ('quickmatch', 'rushmode', 'combatarena') THEN 1 ELSE 0 END) AS has_other\n  FROM active_login a\n  LEFT JOIN match_player mp\n    ON a.statis_date = mp.statis_date\n   AND a.iuserid = mp.iuserid\n  GROUP BY a.statis_date, a.iuserid\n), player_day_flags AS (\n  SELECT\n    statis_date,\n    iuserid,\n    CASE WHEN total_modes_cnt = 1 AND has_quick = 1 THEN 1 ELSE 0 END AS only_quick_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_rush = 1 THEN 1 ELSE 0 END AS only_rush_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_combat = 1 THEN 1 ELSE 0 END AS only_combat_flag,\n    CASE WHEN total_modes_cnt > 0 AND COALESCE(has_other, 0) = 0 THEN 1 ELSE 0 END AS only_three_flag\n  FROM player_modes\n), daily_summary AS (\n  SELECT\n    statis_date,\n    SUM(only_quick_flag) AS only_quick_user_cnt,\n    SUM(only_rush_flag) AS only_rush_user_cnt,\n    SUM(only_combat_flag) AS only_combat_user_cnt,\n    SUM(only_three_flag) AS only_three_modes_user_cnt\n  FROM player_day_flags\n  GROUP BY statis_date\n), weekly_freq AS (\n  SELECT SUM(only_three_flag) AS only_three_modes_week_freq\n  FROM player_day_flags\n)\nSELECT\n  d.statis_date AS statis_date,\n  d.only_quick_user_cnt AS only_quick_user_cnt,\n  d.only_rush_user_cnt AS only_rush_user_cnt,\n  d.only_combat_user_cnt AS only_combat_user_cnt,\n  d.only_three_modes_user_cnt AS only_three_modes_user_cnt,\n  wf.only_three_modes_week_freq AS only_three_modes_week_freq\nFROM daily_summary d\nCROSS JOIN weekly_freq wf\nORDER BY statis_date;", "meta": {"origin": "sql_19", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_22_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：近30天用户在渠道登录的天数为5到8天，取最多天数的用户，并将用户ID转为qq\n输出：QQ\n统计日期：20250331-20250429\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df\n【口径】渠道筛选条件：iloginway = 3\n用户ID筛选swxid_type = \"qq\" -- 筛选swxid_type为\"qq\"\ndim_argothek_gplayerid2qqwxid_df限定20250428"}, {"role": "assistant", "content": "with login_stat as (\n  select\n    iuserid,\n    count(distinct statis_date) as login_days\n  from dws_argothek_oss_login_di\n  where statis_date between 20250331 and 20250429\n    and iloginway = 3\n  group by iuserid\n  having login_days between 5 and 8\n),\nmax_days as (\n  select max(login_days) as max_login_days from login_stat\n),\nqq_map as (\n  select\n    iuserid,\n    suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250429'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom login_stat l\njoin max_days m on l.login_days = m.max_login_days\njoin qq_map q on l.iuserid = q.iuserid\norder by qq;"}], "rejected": "with login_stat as (\n  select\n    iuserid,\n    count(distinct statis_date) as login_days\n  from dws_argothek_oss_login_di\n  where statis_date between 20250331 and 20250429\n    and iloginway = 3\n  group by iuserid\n  having login_days between 5 and 8\n),\nmax_days as (\n  select max(login_days) as max_login_days from login_stat\n),\nqq_map as (\n  select\n    iuserid,\n    suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250429'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom login_stat l\njoin max_days m on l.login_days = m.max_login_days\njoin qq_map q on l.iuserid = q.iuserid\norder by qq;", "meta": {"origin": "sql_22", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_14_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年5月份活跃但2025年6月未活跃的qq号码包\n输出:用户suserid\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df\n【口径】限定dim_argothek_gplayerid2qqwxid_df的日期为\"20250612\""}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith may_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250503 and 20250602\n),\njune_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250603 and 20250702\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250612'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct m.suserid\nfrom may_active a\njoin qq_map m\n  on a.iuserid = m.iuserid\nleft join june_active j\n  on a.iuserid = j.iuserid\nwhere j.iuserid is null\norder by m.suserid\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith may_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250503 and 20250602\n),\njune_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250603 and 20250702\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250612'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct m.suserid\nfrom may_active a\njoin qq_map m\n  on a.iuserid = m.iuserid\nleft join june_active j\n  on a.iuserid = j.iuserid\nwhere j.iuserid is null\norder by m.suserid\n) AS final_query;", "meta": {"origin": "sql_14", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_15_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年5月勇者盟约流失用户中，流向峡谷PC的玩家gplayerid\n输出：玩家gplayerid\n【表】dws_argothek_oss_useractivity_df, dim_argothek_gplayerid2qqwxid_df, dws_mgamejp_login_user_activity_di\n【口径】sgamecode = \"initiatived\" -- 筛选峡谷游戏\nand itimes >= 1 -- 活跃用户条件\nand saccounttype = \"-100\" -- 账号体系，取-100表示汇总\nand suseridtype in (\"qq\", \"wxid\") -- 账号类型，取qq或wxid\n5月流失：限定INSTR(SUBSTR(REVERSE(RPAD(iactivity,128,'0')),1,31),'1') = 0 AND INSTR(SUBSTR(REVERSE(RPAD(iactivity,128,'0')),32,31),'1') > 0\n取20250608的数据做账号转换\n可选过滤：以上条件可按需勾选。\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with lost_may as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date = 20250705\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 1, 31), '1') = 0\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 32, 31), '1') > 0\n),\nmap_info as (\n  select\n    iuserid,\n    suserid,\n    swxid_type\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250705'\n    and suserid is not null\n    and swxid_type in ('qq', 'wx', 'wxid')\n),\npc_active as (\n  select distinct\n    suserid,\n    suseridtype\n  from dws_mgamejp_login_user_activity_di\n  where dtstatdate between '20250628' and '20250727'\n    and sgamecode = 'initiatived'\n    and itimes >= 1\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid', 'wx')\n    and splattype = 'PC'\n    and splat = '-100'\n)\nselect distinct l.iuserid as gplayerid\nfrom lost_may l\njoin map_info m\n  on l.iuserid = m.iuserid\njoin pc_active p\n  on p.suserid = m.suserid\n and p.suseridtype = case when m.swxid_type = 'wxid' then 'wx' else m.swxid_type end\norder by gplayerid;"}], "rejected": "with lost_may as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date = 20250705\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 1, 31), '1') = 0\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 32, 31), '1') > 0\n),\nmap_info as (\n  select\n    iuserid,\n    suserid,\n    swxid_type\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250705'\n    and suserid is not null\n    and swxid_type in ('qq', 'wx', 'wxid')\n),\npc_active as (\n  select distinct\n    suserid,\n    suseridtype\n  from dws_mgamejp_login_user_activity_di\n  where dtstatdate > '20250628'\n    and sgamecode = 'initiatived'\n    and itimes >= 1\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid', 'wx')\n    and splattype = 'PC'\n    and splat = '-100'\n)\nselect distinct l.iuserid as gplayerid\nfrom lost_may l\njoin map_info m\n  on l.iuserid = m.iuserid\njoin pc_active p\n  on p.suserid = m.suserid\n and p.suseridtype = case when m.swxid_type = 'wxid' then 'wx' else m.swxid_type end\norder by gplayerid;", "meta": {"origin": "sql_15", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_2_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】提取1个抽样号码包，2025.07.21-2025.07.23期间付费且不包含721号码包内的用户全量。\n输出：gplayerid\n【表】dim_extract_311381_conf, dws_argothek_ce1_login_di, dws_argothek_ce1_cbt2_vplayerid_suserid_di, dws_jordass_water_di, dwd_jordass_privpackagelog_hi\n【口径】抽样号码包来源：dim_extract_311381_conf（字段 vplayerid）\n付费筛选：dws_jordass_water_di.dtstatdate 在 20250721-20250727，imoney > 0\n排除721号码包：dwd_jordass_privpackagelog_hi.packageid = 721\n渠道映射：dws_argothek_ce1_cbt2_vplayerid_suserid_di、dws_argothek_ce1_login_di\n所有日期使用字符串格式 YYYYMMDD"}, {"role": "assistant", "content": "WITH sample_user AS (\n  SELECT DISTINCT vplayerid\n  FROM dim_extract_311381_conf\n),\npaid_user AS (\n  SELECT vplayerid\n  FROM dws_jordass_water_di\n  WHERE dtstatdate BETWEEN '20250721' AND '20250727'\n    AND imoney > 0\n  GROUP BY vplayerid\n),\nexclude_721 AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_privpackagelog_hi\n  WHERE packageid = 721\n),\ntarget_user AS (\n  SELECT s.vplayerid\n  FROM sample_user s\n  JOIN paid_user p ON s.vplayerid = p.vplayerid\n  WHERE NOT EXISTS (\n    SELECT 1\n    FROM exclude_721 e\n    WHERE e.vplayerid = s.vplayerid\n  )\n)\nSELECT DISTINCT u.vplayerid AS gplayerid\nFROM target_user u\nJOIN dws_argothek_ce1_cbt2_vplayerid_suserid_di m\n  ON u.vplayerid = m.vplayerid\n AND m.dtstatdate BETWEEN '20250721' AND '20250727'\nJOIN dws_argothek_ce1_login_di l\n  ON u.vplayerid = l.vplayerid\n AND l.dtstatdate BETWEEN '20250721' AND '20250727'\n AND l.platid = 255\nORDER BY gplayerid;"}], "rejected": "WITH sample_user AS (\n  SELECT DISTINCT vplayerid\n  FROM dim_extract_311381_conf\n),\npaid_user AS (\n  SELECT vplayerid\n  FROM dws_jordass_water_di\n  WHERE dtstatdate > '20250721'\n    AND imoney > 0\n  GROUP BY vplayerid\n),\nexclude_721 AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_privpackagelog_hi\n  WHERE packageid = 721\n),\ntarget_user AS (\n  SELECT s.vplayerid\n  FROM sample_user s\n  JOIN paid_user p ON s.vplayerid = p.vplayerid\n  WHERE NOT EXISTS (\n    SELECT 1\n    FROM exclude_721 e\n    WHERE e.vplayerid = s.vplayerid\n  )\n)\nSELECT DISTINCT u.vplayerid AS gplayerid\nFROM target_user u\nJOIN dws_argothek_ce1_cbt2_vplayerid_suserid_di m\n  ON u.vplayerid = m.vplayerid\n AND m.dtstatdate BETWEEN '20250721' AND '20250727'\nJOIN dws_argothek_ce1_login_di l\n  ON u.vplayerid = l.vplayerid\n AND l.dtstatdate BETWEEN '20250721' AND '20250727'\n AND l.platid = 255\nORDER BY gplayerid;", "meta": {"origin": "sql_2", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_18_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250506-20250512期间每日的指定网吧渠道内每个渠道活跃人数\n输出：日期（20250528、...、20250603）、渠道、玩家数\n其中：网吧渠道：iloginway in (1,10,11,12,35,20,28,29,30,31,32,33,34,36)\n【表】dws_argothek_oss_login_di\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  statis_date,\n  iloginway,\n  count(distinct iuserid) as player_cnt\nfrom dws_argothek_oss_login_di\nwhere statis_date between 20250528 and 20250603\n  and iloginway in (1,10,11,12,20,28,29,30,31,32,33,34,35,36)\ngroup by statis_date, iloginway\norder by statis_date, iloginway;"}], "rejected": "select\n  statis_date,\n  iloginway,\n  count(distinct iuserid) as player_cnt\nfrom dws_argothek_oss_login_di\nwhere statis_date between 20250528 and 20250603\n  and iloginway in (1,10,11,12,20,28,29,30,31,32,33,34,35,36)\ngroup by statis_date, iloginway\norder by statis_date, iloginway;", "meta": {"origin": "sql_18", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_113_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20220425-20220508组竞商店购买情况\n输出：统计日期（YYYYMMDD），商店id，人数，次数\n【表】dwd_jordass_vsteamshoplog_hi\n【口径】"}, {"role": "assistant", "content": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(shopid as string) as shop_id,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as buy_cnt\nfrom dwd_jordass_vsteamshoplog_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20220425' and '20220508'\ngroup by substr(tdbank_imp_date, 1, 8), shopid\norder by stat_date, shop_id;"}], "rejected": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(shopid as string) as shop_id,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as buy_cnt\nfrom dwd_jordass_vsteamshoplog_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20220425'\ngroup by substr(tdbank_imp_date, 1, 8), shopid\norder by stat_date, shop_id;", "meta": {"origin": "sql_113", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_82_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20220408-20220410第三人称四排用户中 玩法类型（群屿 山峦 假日群岛）赛季等级总积分的人数\n输出：玩法类型，赛季等级，总积分范围（[1,2) 、[2,3).. 左闭右开），人数\n【表】dwd_jordass_roundflow_hi\n【口径】总积分计算：群屿需要乘1.2，其他乘1\n群屿: submode in (1001, 1002, 1003, 1064, 1065, 1066, 1076, 1077, 1078, 1091, 1092, 1093, 1137, 1138, 1139, 1143, 1144, 1145, 1152, 1153, 1154, 1158, 1159, 1160, 2029, 2030, 2031, 2044, 2045, 2046, 2122, 2123, 2124, 2129, 2130, 2131, 2166, 2167, 2168, 2169, 2170, 2171, 2172, 2173, 2174, 2203, 2216, 2217, 2218, 2219, 2220, 2221, 2297, 2298, 2299, 2300, 2301, 2302, 2304, 2305, 2306, 2322, 2323, 2324, 2325, 2326, 2327, 2359, 2360, 2361, 2368, 2367, 2366, 2419, 2420, 2421, 2422, 2423, 2424, 2425, 2426, 2427, 2453, 2454, 2455, 2460, 2461, 2462, 2472, 2473, 2474, 2463, 2464, 2465, 2466, 2467, 2468), 山峦: submode in (2160, 2161, 2162, 2163, 2164, 2165, 2334, 2335, 2336, 2337, 2338, 2339), 假日群岛: submode in (2396, 2397, 2398, 2399, 2400, 2401)\n第三人称四排限定mode=103\n赛季积分逻辑：ChangedRatingValue/(SurvivalTime / 60)\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH base AS (\n  SELECT\n    vplayerid,\n    uid,\n    submode,\n    allianceforceterlevel,\n    CAST(dteventtime AS DATETIME) AS event_time,\n    changedratingvalue,\n    survivaltime\n  FROM dwd_jordass_roundflow_hi\n  WHERE mode = 103\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2022-04-28 00:00:00' AND '2022-04-30 23:59:59'\n    AND submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468,2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339,2396,2397,2398,2399,2400,2401)\n), categorized AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN '群屿'\n      WHEN submode IN (2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339) THEN '山峦'\n      WHEN submode IN (2396,2397,2398,2399,2400,2401) THEN '假日群岛'\n      ELSE '其他'\n    END AS play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN changedratingvalue * 1.2\n      ELSE changedratingvalue\n    END AS adjusted_rating,\n    survivaltime\n  FROM base\n), aggregated AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    vplayerid,\n    SUM(CASE WHEN survivaltime > 0 THEN adjusted_rating / (survivaltime / 60.0) ELSE 0 END) AS total_points\n  FROM categorized\n  GROUP BY play_type, allianceforceterlevel, vplayerid\n), bucketed AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN total_points IS NULL THEN '[0,1)'\n      ELSE CONCAT('[', CAST(FLOOR(GREATEST(total_points, 0)) AS STRING), ',', CAST(FLOOR(GREATEST(total_points, 0)) + 1 AS STRING), ')')\n    END AS points_range,\n    vplayerid\n  FROM aggregated\n)\nSELECT\n  play_type,\n  allianceforceterlevel AS season_level,\n  points_range,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM bucketed\nGROUP BY play_type, allianceforceterlevel, points_range\nORDER BY play_type, allianceforceterlevel, points_range;"}], "rejected": "WITH base AS (\n  SELECT\n    vplayerid,\n    uid,\n    submode,\n    allianceforceterlevel,\n    CAST(dteventtime AS DATETIME) AS event_time,\n    changedratingvalue,\n    survivaltime\n  FROM dwd_jordass_roundflow_hi\n  WHERE mode = 103\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2022-04-28 00:00:00' AND '2022-04-30 23:59:59'\n    AND submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468,2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339,2396,2397,2398,2399,2400,2401)\n), categorized AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN '群屿'\n      WHEN submode IN (2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339) THEN '山峦'\n      WHEN submode IN (2396,2397,2398,2399,2400,2401) THEN '假日群岛'\n      ELSE '其他'\n    END AS play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN changedratingvalue * 1.2\n      ELSE changedratingvalue\n    END AS adjusted_rating,\n    survivaltime\n  FROM base\n), aggregated AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    vplayerid,\n    SUM(CASE WHEN survivaltime > 0 THEN adjusted_rating / (survivaltime / 60.0) ELSE 0 END) AS total_points\n  FROM categorized\n  GROUP BY play_type, allianceforceterlevel, vplayerid\n), bucketed AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN total_points IS NULL THEN '[0,1)'\n      ELSE CONCAT('[', CAST(FLOOR(GREATEST(total_points, 0)) AS STRING), ',', CAST(FLOOR(GREATEST(total_points, 0)) + 1 AS STRING), ')')\n    END AS points_range,\n    vplayerid\n  FROM aggregated\n)\nSELECT\n  play_type,\n  allianceforceterlevel AS season_level,\n  points_range,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM bucketed\nGROUP BY play_type, allianceforceterlevel, points_range\nORDER BY play_type, allianceforceterlevel, points_range;", "meta": {"origin": "sql_82", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_44_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.01.01-2024.12.31期间，付费用户的付费区间对应的付费人数和付费金额\n输出：付费区间(小R、中R、大R、超R、未知)、付费人数、付费金额（元）\n\n付费区间：小R小于等于12，中R(12,60]，大R(60,180]，超R(180+)\n【表】dws_jordass_water_di\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with user_pay as (\n  select\n    vplayerid,\n    sum(imoney) / 100.0 as pay_amount\n  from dws_jordass_water_di\n  where dtstatdate between '20240128' and '20250127'\n  group by vplayerid\n),\nfiltered as (\n  select *\n  from user_pay\n  where pay_amount > 0\n)\nselect\n  case\n    when pay_amount <= 12 then '小R'\n    when pay_amount <= 60 then '中R'\n    when pay_amount <= 180 then '大R'\n    when pay_amount > 180 then '超R'\n    else '未知'\n  end as pay_segment,\n  count(*) as user_cnt,\n  round(sum(pay_amount), 2) as pay_amount\nfrom filtered\ngroup by pay_segment\norder by pay_segment;"}], "rejected": "with user_pay as (\n  select\n    vplayerid,\n    sum(imoney) / 100.0 as pay_amount\n  from dws_jordass_water_di\n  where dtstatdate > '20240128'\n  group by vplayerid\n),\nfiltered as (\n  select *\n  from user_pay\n  where pay_amount > 0\n)\nselect\n  case\n    when pay_amount <= 12 then '小R'\n    when pay_amount <= 60 then '中R'\n    when pay_amount <= 180 then '大R'\n    when pay_amount > 180 then '超R'\n    else '未知'\n  end as pay_segment,\n  count(*) as user_cnt,\n  round(sum(pay_amount), 2) as pay_amount\nfrom filtered\ngroup by pay_segment\norder by pay_segment;", "meta": {"origin": "sql_44", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_69_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.12.25——2025.1.5 ，不同信息类型的玩家数量\n\n信息类型:chattype in (20,25,26,16,27,8)\n\n输出 日期（20241228-20250108），信息类型，人数，次数\n【表】dwd_jordass_msgchatrecord_hi\n【口径】chattype in (20,25,26,16,27,8)\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(chattype as string) as chat_type,\n  count(distinct playerid) as user_cnt,\n  count(*) as msg_cnt\nfrom dwd_jordass_msgchatrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20241228' and '20250108'\n  and chattype in (20, 25, 26, 16, 27, 8)\ngroup by substr(tdbank_imp_date, 1, 8), chattype\norder by stat_date, chat_type;"}], "rejected": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(chattype as string) as chat_type,\n  count(distinct playerid) as user_cnt,\n  count(*) as msg_cnt\nfrom dwd_jordass_msgchatrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20241228'\n  and chattype in (20, 25, 26, 16, 27, 8)\ngroup by substr(tdbank_imp_date, 1, 8), chattype\norder by stat_date, chat_type;", "meta": {"origin": "sql_69", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_20_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20240101-20240505，网吧特权用户的指标数据。\n输出：\n月份（按月：202401、202402、202403、202404）\n人均对局时长（小时）\n网吧时间占当月游戏时间比例\n有对局的天数\n排位模式时长（小时）\n排位模式组队率\n月付费率\n月ARPA\n月ARPPA\n高校特权激活率\n【表】dws_argothek_oss_login_di, dwd_argothek_playerlogout_hi, dws_argothek_oss_portaltransaction_di, dwd_argothek_playermatchstats_hi\n【口径】排位模式：queueId=\"competitive\"\n网吧特权：inetbarlevel = 2\n高校特权：icampuslevel > 0\n网吧在线时长先筛选网吧渠道"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH netbar_users AS (\n  SELECT DISTINCT iuserid AS player_id\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-06' AND '2024-05-05'\n    AND inetbarlevel = '2'\n),\nlogin_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(CAST(statis_date AS VARCHAR), '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ionlinetime) AS total_online_time,\n    SUM(CASE WHEN iloginway IN (1,10,11,12,20,28,29,30,31,32,33,34,35,36) THEN ionlinetime ELSE 0 END) AS netbar_online_time,\n    COUNT(DISTINCT statis_date) AS active_days\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20240106 AND 20240505\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nmatch_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    vroleid AS player_id,\n    SUM(gamelengthmillis) / 1000.0 AS total_match_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN gamelengthmillis ELSE 0 END) / 1000.0 AS competitive_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN 1 ELSE 0 END) AS competitive_matches,\n    SUM(CASE WHEN queueid = 'competitive' AND partyid IS NOT NULL AND partyid <> '' THEN 1 ELSE 0 END) AS competitive_team_matches,\n    COUNT(DISTINCT CAST(dteventtime AS DATE)) AS match_days\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-06' AND '2024-05-05'\n    AND vroleid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, vroleid\n),\npay_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(statis_date, '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ftranamt) / 100.0 AS pay_amount\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date BETWEEN '20240106' AND '20240505'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\ncampus_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    MAX(CASE WHEN icampuslevel IS NOT NULL AND icampuslevel <> '0' THEN 1 ELSE 0 END) AS campus_active\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-06' AND '2024-05-05'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nplayer_month AS (\n  SELECT stat_month, player_id FROM login_agg\n  UNION\n  SELECT stat_month, player_id FROM match_agg\n  UNION\n  SELECT stat_month, player_id FROM pay_agg\n  UNION\n  SELECT stat_month, player_id FROM campus_agg\n),\nmonthly_union AS (\n  SELECT\n    pm.stat_month,\n    pm.player_id,\n    COALESCE(l.total_online_time, 0) AS total_online_time,\n    COALESCE(l.netbar_online_time, 0) AS netbar_online_time,\n    COALESCE(l.active_days, 0) AS active_days,\n    COALESCE(m.total_match_seconds, 0) AS total_match_seconds,\n    COALESCE(m.competitive_seconds, 0) AS competitive_seconds,\n    COALESCE(m.competitive_matches, 0) AS competitive_matches,\n    COALESCE(m.competitive_team_matches, 0) AS competitive_team_matches,\n    COALESCE(m.match_days, 0) AS match_days,\n    COALESCE(p.pay_amount, 0) AS pay_amount,\n    COALESCE(c.campus_active, 0) AS campus_active\n  FROM player_month pm\n  LEFT JOIN login_agg l ON pm.stat_month = l.stat_month AND pm.player_id = l.player_id\n  LEFT JOIN match_agg m ON pm.stat_month = m.stat_month AND pm.player_id = m.player_id\n  LEFT JOIN pay_agg p ON pm.stat_month = p.stat_month AND pm.player_id = p.player_id\n  LEFT JOIN campus_agg c ON pm.stat_month = c.stat_month AND pm.player_id = c.player_id\n),\nmonths AS (\n  SELECT '202401' AS stat_month UNION ALL\n  SELECT '202402' UNION ALL\n  SELECT '202403' UNION ALL\n  SELECT '202404'\n),\nfinal_stats AS (\n  SELECT\n    stat_month,\n    COUNT(DISTINCT player_id) AS player_cnt,\n    SUM(total_match_seconds) AS total_match_seconds,\n    SUM(netbar_online_time) AS total_netbar_online_time,\n    SUM(total_online_time) AS total_online_time,\n    SUM(match_days) AS match_days,\n    SUM(competitive_seconds) AS total_competitive_seconds,\n    SUM(competitive_team_matches) AS total_competitive_team_matches,\n    SUM(competitive_matches) AS total_competitive_matches,\n    SUM(pay_amount) AS total_pay_amount,\n    COUNT(DISTINCT CASE WHEN pay_amount > 0 THEN player_id END) AS pay_user_cnt,\n    SUM(campus_active) AS campus_active_sum\n  FROM monthly_union\n  GROUP BY stat_month\n)\nSELECT\n  m.stat_month,\n  COALESCE(ROUND(final_stats.total_match_seconds / 3600 / NULLIF(final_stats.player_cnt, 0), 4), 0) AS avg_match_hours,\n  COALESCE(ROUND(final_stats.total_netbar_online_time / NULLIF(final_stats.total_online_time, 0), 4), 0) AS netbar_time_ratio,\n  COALESCE(final_stats.match_days, 0) AS match_days_cnt,\n  COALESCE(ROUND(final_stats.total_competitive_seconds / 3600, 4), 0) AS competitive_hours,\n  COALESCE(ROUND(final_stats.total_competitive_team_matches / NULLIF(final_stats.total_competitive_matches, 0), 4), 0) AS competitive_team_rate,\n  COALESCE(ROUND(final_stats.pay_user_cnt / NULLIF(final_stats.player_cnt, 0), 4), 0) AS pay_rate,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.player_cnt, 0), 4), 0) AS arpa,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.pay_user_cnt, 0), 4), 0) AS arppa,\n  COALESCE(ROUND(final_stats.campus_active_sum / NULLIF(final_stats.player_cnt, 0), 4), 0) AS campus_active_rate\nFROM months m\nLEFT JOIN final_stats ON m.stat_month = final_stats.stat_month\nORDER BY m.stat_month\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH netbar_users AS (\n  SELECT DISTINCT iuserid AS player_id\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-06' AND '2024-05-05'\n    AND inetbarlevel = '2'\n),\nlogin_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(CAST(statis_date AS VARCHAR), '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ionlinetime) AS total_online_time,\n    SUM(CASE WHEN iloginway IN (1,10,11,12,20,28,29,30,31,32,33,34,35,36) THEN ionlinetime ELSE 0 END) AS netbar_online_time,\n    COUNT(DISTINCT statis_date) AS active_days\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20240106 AND 20240505\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nmatch_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    vroleid AS player_id,\n    SUM(gamelengthmillis) / 1000.0 AS total_match_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN gamelengthmillis ELSE 0 END) / 1000.0 AS competitive_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN 1 ELSE 0 END) AS competitive_matches,\n    SUM(CASE WHEN queueid = 'competitive' AND partyid IS NOT NULL AND partyid <> '' THEN 1 ELSE 0 END) AS competitive_team_matches,\n    COUNT(DISTINCT CAST(dteventtime AS DATE)) AS match_days\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-06' AND '2024-05-05'\n    AND vroleid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, vroleid\n),\npay_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(statis_date, '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ftranamt) / 100.0 AS pay_amount\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date > '20240106'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\ncampus_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    MAX(CASE WHEN icampuslevel IS NOT NULL AND icampuslevel <> '0' THEN 1 ELSE 0 END) AS campus_active\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-06' AND '2024-05-05'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nplayer_month AS (\n  SELECT stat_month, player_id FROM login_agg\n  UNION\n  SELECT stat_month, player_id FROM match_agg\n  UNION\n  SELECT stat_month, player_id FROM pay_agg\n  UNION\n  SELECT stat_month, player_id FROM campus_agg\n),\nmonthly_union AS (\n  SELECT\n    pm.stat_month,\n    pm.player_id,\n    COALESCE(l.total_online_time, 0) AS total_online_time,\n    COALESCE(l.netbar_online_time, 0) AS netbar_online_time,\n    COALESCE(l.active_days, 0) AS active_days,\n    COALESCE(m.total_match_seconds, 0) AS total_match_seconds,\n    COALESCE(m.competitive_seconds, 0) AS competitive_seconds,\n    COALESCE(m.competitive_matches, 0) AS competitive_matches,\n    COALESCE(m.competitive_team_matches, 0) AS competitive_team_matches,\n    COALESCE(m.match_days, 0) AS match_days,\n    COALESCE(p.pay_amount, 0) AS pay_amount,\n    COALESCE(c.campus_active, 0) AS campus_active\n  FROM player_month pm\n  LEFT JOIN login_agg l ON pm.stat_month = l.stat_month AND pm.player_id = l.player_id\n  LEFT JOIN match_agg m ON pm.stat_month = m.stat_month AND pm.player_id = m.player_id\n  LEFT JOIN pay_agg p ON pm.stat_month = p.stat_month AND pm.player_id = p.player_id\n  LEFT JOIN campus_agg c ON pm.stat_month = c.stat_month AND pm.player_id = c.player_id\n),\nmonths AS (\n  SELECT '202401' AS stat_month UNION ALL\n  SELECT '202402' UNION ALL\n  SELECT '202403' UNION ALL\n  SELECT '202404'\n),\nfinal_stats AS (\n  SELECT\n    stat_month,\n    COUNT(DISTINCT player_id) AS player_cnt,\n    SUM(total_match_seconds) AS total_match_seconds,\n    SUM(netbar_online_time) AS total_netbar_online_time,\n    SUM(total_online_time) AS total_online_time,\n    SUM(match_days) AS match_days,\n    SUM(competitive_seconds) AS total_competitive_seconds,\n    SUM(competitive_team_matches) AS total_competitive_team_matches,\n    SUM(competitive_matches) AS total_competitive_matches,\n    SUM(pay_amount) AS total_pay_amount,\n    COUNT(DISTINCT CASE WHEN pay_amount > 0 THEN player_id END) AS pay_user_cnt,\n    SUM(campus_active) AS campus_active_sum\n  FROM monthly_union\n  GROUP BY stat_month\n)\nSELECT\n  m.stat_month,\n  COALESCE(ROUND(final_stats.total_match_seconds / 3600 / NULLIF(final_stats.player_cnt, 0), 4), 0) AS avg_match_hours,\n  COALESCE(ROUND(final_stats.total_netbar_online_time / NULLIF(final_stats.total_online_time, 0), 4), 0) AS netbar_time_ratio,\n  COALESCE(final_stats.match_days, 0) AS match_days_cnt,\n  COALESCE(ROUND(final_stats.total_competitive_seconds / 3600, 4), 0) AS competitive_hours,\n  COALESCE(ROUND(final_stats.total_competitive_team_matches / NULLIF(final_stats.total_competitive_matches, 0), 4), 0) AS competitive_team_rate,\n  COALESCE(ROUND(final_stats.pay_user_cnt / NULLIF(final_stats.player_cnt, 0), 4), 0) AS pay_rate,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.player_cnt, 0), 4), 0) AS arpa,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.pay_user_cnt, 0), 4), 0) AS arppa,\n  COALESCE(ROUND(final_stats.campus_active_sum / NULLIF(final_stats.player_cnt, 0), 4), 0) AS campus_active_rate\nFROM months m\nLEFT JOIN final_stats ON m.stat_month = final_stats.stat_month\nORDER BY m.stat_month\n) AS final_query;", "meta": {"origin": "sql_20", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_59_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：20250113-20250124时间区间内，幻境使者活动抽奖用户第X次触发赠送后，这些用户的总抽奖次数\n输出：第X次触发,触发用户数,用户总抽奖次数\n【表】dwd_jordass_activityrecord_hi\n【口径】actid=2411070621 and acttype= 10062 表示幻境使者活动\narg1表示抽奖次数\nStrArg1<>0表示触发赠送"}, {"role": "assistant", "content": "select \n    s1.trigger_count as `trigger_count`, -- 第x次触发\n    count(distinct s1.vplayerid) as `trigger_user_cnt`, -- 触发用户数\n    sum(s2.draw_count) as `total_draw_count` -- 用户总抽奖次数\nfrom (\n    select\n        vplayerid,\n        dteventtime,\n        coalesce(lead(dteventtime) over (partition by vplayerid order by dteventtime), '9999-12-31 23:59:59')  as next_dteventtime,\n        row_number() over (partition by vplayerid order by dteventtime) as trigger_count\n    from (\n        select distinct\n            vplayerid,\n            dteventtime\n        from dwd_jordass_activityrecord_hi\n        where tdbank_imp_date >= '2025011100'\n        and tdbank_imp_date <= '2025012423'\n        and actid = 2411070621\n        and acttype = 10062\n        and recodtype in ('1', '2')\n        and strarg1 <> '0'\n    ) ff1\n) s1 \njoin (\n    select\n        vplayerid,\n        dteventtime,\n        sum(arg1) as draw_count\n    from dwd_jordass_activityrecord_hi  -- actgeneralflow表\n    where tdbank_imp_date >= \"2025011100\" and tdbank_imp_date <= \"2025012423\" -- 时间区间：20250113-20250126\n    and actid = 2411070621\n    and acttype = 10062\n    and recodtype in (\"1\", \"2\")\n    group by vplayerid, dteventtime\n\n    \n) s2 \non s1.vplayerid = s2.vplayerid and s2. dteventtime >= s1.dteventtime and s2.dteventtime < s1.next_dteventtime\ngroup by s1.trigger_count;"}], "rejected": "select \n    s1.trigger_count as `trigger_count`, -- 第x次触发\n    count(distinct s1.vplayerid) as `trigger_user_cnt`, -- 触发用户数\n    sum(s2.draw_count) as `total_draw_count` -- 用户总抽奖次数\nfrom (\n    select\n        vplayerid,\n        dteventtime,\n        coalesce(lead(dteventtime) over (partition by vplayerid order by dteventtime), '9999-12-31 23:59:59')  as next_dteventtime,\n        row_number() over (partition by vplayerid order by dteventtime) as trigger_count\n    from (\n        select distinct\n            vplayerid,\n            dteventtime\n        from dwd_jordass_activityrecord_hi\n        where tdbank_imp_date >= '2025011100'\n        and tdbank_imp_date <= '2025012423'\n        and actid = 2411070621\n        and acttype = 10062\n        and recodtype in ('1', '2')\n        and strarg1 <> '0'\n    ) ff1\n) s1 \njoin (\n    select\n        vplayerid,\n        dteventtime,\n        sum(arg1) as draw_count\n    from dwd_jordass_activityrecord_hi  -- actgeneralflow表\n    where tdbank_imp_date >= \"2025011100\" and tdbank_imp_date <= \"2025012423\" -- 时间区间：20250113-20250126\n    and actid = 2411070621\n    and acttype = 10062\n    and recodtype in (\"1\", \"2\")\n    group by vplayerid, dteventtime\n\n    \n) s2 \non s1.vplayerid = s2.vplayerid and s2. dteventtime >= s1.dteventtime and s2.dteventtime < s1.next_dteventtime\ngroup by s1.trigger_count;", "meta": {"origin": "sql_59", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_50_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.10.1-2024.10.31期间点击400211，点击400212，点击400211及400212的重合用户作为用户类型，看不同性别、砺刃活跃度和乐园活跃度情况\n\n输出：用户类型（400211、400212、400211&400212、other），游戏角色性别（male、female、other）、乐园活跃度（light、medium、heavy、other）、砺刃活跃度（light、medium、heavy、other），人数\n\n乐园跟砺刃的活跃度： 轻度1-4天；中度5-15天；重度>=16天\n【表】dws_jordass_matchlog_stat_di, dws_jordass_login_di, dwd_jordass_playerlogin_hi, dws_jordass_buttonpress_pre_di\n【口径】性别根据时间开窗取最新一条"}, {"role": "assistant", "content": "WITH base_players AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20241007' AND '20241106'\n    AND platid = 255\n), button_flags AS (\n  SELECT\n    vplayerid,\n    MAX(CASE WHEN buttontype = '400211' THEN 1 ELSE 0 END) AS clicked_400211,\n    MAX(CASE WHEN buttontype = '400212' THEN 1 ELSE 0 END) AS clicked_400212\n  FROM dws_jordass_buttonpress_pre_di\n  WHERE dtstatdate BETWEEN '20241007' AND '20241106'\n  GROUP BY vplayerid\n), user_type_base AS (\n  SELECT\n    b.vplayerid,\n    CASE\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400211&400212'\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 0 THEN '400211'\n      WHEN COALESCE(f.clicked_400211, 0) = 0 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400212'\n      ELSE 'other'\n    END AS user_type\n  FROM base_players b\n  LEFT JOIN button_flags f\n    ON b.vplayerid = f.vplayerid\n), gender_latest AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN gender = 1 THEN 'male'\n      WHEN gender = 2 THEN 'female'\n      ELSE 'other'\n    END AS gender_bucket\n  FROM (\n    SELECT\n      vplayerid,\n      gender,\n      ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n    FROM dwd_jordass_playerlogin_hi\n    WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y-%m-%d') <= '2024-11-06'\n  ) t\n  WHERE rn = 1\n), arena_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS arena_active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20241007' AND '20241106'\n    AND platid = 255\n  GROUP BY vplayerid\n), park_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS park_active_days\n  FROM dws_jordass_matchlog_stat_di\n  WHERE dtstatdate BETWEEN '20241007' AND '20241106'\n    AND platid = 255\n  GROUP BY vplayerid\n), enriched AS (\n  SELECT\n    u.vplayerid,\n    u.user_type,\n    COALESCE(g.gender_bucket, 'other') AS gender_bucket,\n    COALESCE(park_active_days, 0) AS park_days,\n    COALESCE(arena_active_days, 0) AS arena_days\n  FROM user_type_base u\n  LEFT JOIN gender_latest g\n    ON u.vplayerid = g.vplayerid\n  LEFT JOIN park_active p\n    ON u.vplayerid = p.vplayerid\n  LEFT JOIN arena_active a\n    ON u.vplayerid = a.vplayerid\n), final AS (\n  SELECT\n    user_type,\n    gender_bucket,\n    CASE\n      WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN park_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS park_active_level,\n    CASE\n      WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN arena_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS arena_active_level,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM enriched\n  GROUP BY user_type, gender_bucket,\n           CASE\n             WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN park_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END,\n           CASE\n             WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN arena_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END\n)\nSELECT\n  user_type,\n  gender_bucket,\n  park_active_level,\n  arena_active_level,\n  user_cnt\nFROM final\nORDER BY user_type, gender_bucket, park_active_level, arena_active_level;"}], "rejected": "WITH base_players AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate > '20241007'\n    AND platid = 255\n), button_flags AS (\n  SELECT\n    vplayerid,\n    MAX(CASE WHEN buttontype = '400211' THEN 1 ELSE 0 END) AS clicked_400211,\n    MAX(CASE WHEN buttontype = '400212' THEN 1 ELSE 0 END) AS clicked_400212\n  FROM dws_jordass_buttonpress_pre_di\n  WHERE dtstatdate BETWEEN '20241007' AND '20241106'\n  GROUP BY vplayerid\n), user_type_base AS (\n  SELECT\n    b.vplayerid,\n    CASE\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400211&400212'\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 0 THEN '400211'\n      WHEN COALESCE(f.clicked_400211, 0) = 0 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400212'\n      ELSE 'other'\n    END AS user_type\n  FROM base_players b\n  LEFT JOIN button_flags f\n    ON b.vplayerid = f.vplayerid\n), gender_latest AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN gender = 1 THEN 'male'\n      WHEN gender = 2 THEN 'female'\n      ELSE 'other'\n    END AS gender_bucket\n  FROM (\n    SELECT\n      vplayerid,\n      gender,\n      ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n    FROM dwd_jordass_playerlogin_hi\n    WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y-%m-%d') <= '2024-11-06'\n  ) t\n  WHERE rn = 1\n), arena_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS arena_active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20241007' AND '20241106'\n    AND platid = 255\n  GROUP BY vplayerid\n), park_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS park_active_days\n  FROM dws_jordass_matchlog_stat_di\n  WHERE dtstatdate BETWEEN '20241007' AND '20241106'\n    AND platid = 255\n  GROUP BY vplayerid\n), enriched AS (\n  SELECT\n    u.vplayerid,\n    u.user_type,\n    COALESCE(g.gender_bucket, 'other') AS gender_bucket,\n    COALESCE(park_active_days, 0) AS park_days,\n    COALESCE(arena_active_days, 0) AS arena_days\n  FROM user_type_base u\n  LEFT JOIN gender_latest g\n    ON u.vplayerid = g.vplayerid\n  LEFT JOIN park_active p\n    ON u.vplayerid = p.vplayerid\n  LEFT JOIN arena_active a\n    ON u.vplayerid = a.vplayerid\n), final AS (\n  SELECT\n    user_type,\n    gender_bucket,\n    CASE\n      WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN park_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS park_active_level,\n    CASE\n      WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN arena_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS arena_active_level,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM enriched\n  GROUP BY user_type, gender_bucket,\n           CASE\n             WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN park_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END,\n           CASE\n             WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN arena_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END\n)\nSELECT\n  user_type,\n  gender_bucket,\n  park_active_level,\n  arena_active_level,\n  user_cnt\nFROM final\nORDER BY user_type, gender_bucket, park_active_level, arena_active_level;", "meta": {"origin": "sql_50", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_38_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计不同玩法不同用户类型的参与情况\n\n输出：玩法、用户类型（砺刃新增、砺刃回流（流失60天以上）、砺刃回流（流失21-59天）、砺刃回流（流失14-20天）、砺刃回流（流失7-13天）、砺刃留存、平台盘内、平台盘外）、上线后3天参与用户数、上线后3天总用户数\n\n各玩法上线日期：\n\"广域战场\": \"20240726\",\n\"消灭战\": \"20230807\",\n\"幻想混战\": \"20241118\",\n\"荒野传说\": \"20240906\",\n\"策略载具\": \"20241013\",\n\"炎夏混战\": \"20240628\",\n\"单人装备\": \"20240520\",\n\"交叉堡垒\": \"20240415\"\n【表】dws_mgamejp_login_user_activity_di, dws_jordass_login_df, dim_jordass_playerid2suserid_nf, dws_jordass_mode_roundrecord_di\n【口径】从平台大盘表取数据固定逻辑：\nsAccountType ='-100' and sgamecode <>'-100' and splattype = '-100' and splat = '-100'\n\n- 用户类型的定义：\n砺刃新增：上线后3天(包含上线当天)砺刃新增用户，并且参与了玩法的用户\n砺刃留存：上线前一周在砺刃活跃过，并且在上线后3天参与了玩法的用户\n砺刃回流：上线前一周没有在砺刃活跃过，但是之前在砺刃注册过，并且上线后3天参与了玩法的用户，然后按上线日期前N天连续未活跃时长区分：流失(7-13]天，流失[14-20]天，流失[21-59]天，流失60天及以上\n平台盘内：上线前一周在平台大盘活跃过，并且没有在砺刃活跃过，并且上线后3天参与了玩法的用户\n平台盘外：上线前一周没有在平台大盘内活跃过的，并且上线后3天参与了玩法的用户；\n\n广域战场 （2024/7/23）submodename= '广域战场模式'，\n消灭战（2023/8/4） modename='组队竞技' and submodename like '%消灭战模式%'，\n幻想混战（2024/11/18）modename='创意创作间' and submodename='幻想混战'，\n荒野传说（2024-09-06）modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')，\n策略载具（2024-10-13）modename='休闲模式' and submodename like '%策略载具%'，\n炎夏混战（2024-06-28）modename='创意创作间' and submodename like '%炎夏混战%'，\n单人装备（2024.5.17）modename='组队竞技' and submodename like '%单人装备%'，\n交叉堡垒（2024.4.12） modename='组队竞技' and submodename like '%交叉堡垒%'\n\n\n注意：suserid 和 vplayerid是两套用户账号体系；平台大盘代表所有游戏的数据，sgamecode='jordass'代表砺刃使者"}, {"role": "assistant", "content": "with usertype as (\n    select '广域战场' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240726',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '消灭战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20230807',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '幻想混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241118',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '荒野传说' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240906',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '策略载具' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241013',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '炎夏混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240628',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '单人装备' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240520',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '交叉堡垒' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240415',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n),\ndapan as (\n    select '广域战场' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20240726',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20240726',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '消灭战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20230807',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20230807',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '幻想混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241118',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241118',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '荒野传说' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240906',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240906',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '策略载具' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241013',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241013',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '炎夏混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240628',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240628',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '单人装备' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240520',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240520',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '交叉堡垒' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240415',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240415',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n),\ndapan2jordass as (\n    select distinct itype, b.vplayerid, flag1\n    from dapan a\n    join (\n        select vplayerid,suserid from dim_jordass_playerid2suserid_nf\n    ) b on a.suserid = b.suserid\n),\nplayuser as (\n    select '广域战场' itype, min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240726' and dtstatdate <= date_add('20240726',2) and submodename= '广域战场模式'\n    group by vplayerid\n    union all\n    select '消灭战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20230807' and dtstatdate <= date_add('20230807',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by vplayerid\n    union all\n    select '幻想混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241118' and dtstatdate <= date_add('20241118',2) and modename='创意创作间' and submodename='幻想混战'\n    group by vplayerid\n    union all\n    select '荒野传说' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240906' and dtstatdate <= date_add('20240906',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by vplayerid\n    union all\n    select '策略载具' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241013' and dtstatdate <= date_add('20241013',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by vplayerid\n    union all\n    select '炎夏混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240628' and dtstatdate <= date_add('20240628',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by vplayerid\n    union all\n    select '单人装备' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240520' and dtstatdate <= date_add('20240520',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by vplayerid\n    union all\n    select '交叉堡垒' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240415' and dtstatdate <= date_add('20240415',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by vplayerid\n)\n\nselect \n    t.itype,\n    t.user_type,\n    t.iusernum1,\n    p.iusernum2\nfrom (\n    select \n        a.itype,\n        b.user_type,\n        count(distinct a.vplayerid) iusernum1\n    from playuser a\n    join (\n        select \n            itype, vplayerid,\n            case \n                when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n                when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n                when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n                when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n                when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n                when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n            end user_type\n        from usertype\n    ) b on a.itype = b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.user_type\n\n    union all\n    \n    select \n        a.itype, \n        case \n            when flag1=0 then '平台盘内' \n            when b.vplayerid is null then '平台盘外' \n        end user_type, \n    count(distinct a.vplayerid) iusernum1\n    from playuser a\n    left join dapan2jordass b \n    on a.itype = b.itype and a.vplayerid = b.vplayerid\n    where flag1=0 or b.vplayerid is null\n    group by a.itype, case when flag1=0 then '平台盘内' when b.vplayerid is null then '平台盘外' end\n) t\nleft join (\n    select itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end user_type,\n        count(distinct vplayerid) iusernum2\n    from usertype\n    group by itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end\n\n    union all\n\n    select itype,'平台盘内',count(distinct vplayerid) \n    from dapan2jordass \n    group by itype\n) p on t.itype=p.itype and t.user_type=p.user_type\n;"}], "rejected": "with usertype as (\n    select '广域战场' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240726',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '消灭战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20230807',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '幻想混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241118',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '荒野传说' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240906',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '策略载具' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241013',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '炎夏混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240628',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '单人装备' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240520',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '交叉堡垒' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240415',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n),\ndapan as (\n    select '广域战场' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20240726',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20240726',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '消灭战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20230807',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20230807',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '幻想混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241118',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241118',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '荒野传说' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240906',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240906',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '策略载具' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241013',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241013',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '炎夏混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240628',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240628',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '单人装备' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240520',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240520',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '交叉堡垒' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240415',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240415',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n),\ndapan2jordass as (\n    select distinct itype, b.vplayerid, flag1\n    from dapan a\n    join (\n        select vplayerid,suserid from dim_jordass_playerid2suserid_nf\n    ) b on a.suserid = b.suserid\n),\nplayuser as (\n    select '广域战场' itype, min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240726' and dtstatdate <= date_add('20240726',2) and submodename= '广域战场模式'\n    group by vplayerid\n    union all\n    select '消灭战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20230807' and dtstatdate <= date_add('20230807',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by vplayerid\n    union all\n    select '幻想混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241118' and dtstatdate <= date_add('20241118',2) and modename='创意创作间' and submodename='幻想混战'\n    group by vplayerid\n    union all\n    select '荒野传说' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240906' and dtstatdate <= date_add('20240906',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by vplayerid\n    union all\n    select '策略载具' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241013' and dtstatdate <= date_add('20241013',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by vplayerid\n    union all\n    select '炎夏混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240628' and dtstatdate <= date_add('20240628',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by vplayerid\n    union all\n    select '单人装备' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240520' and dtstatdate <= date_add('20240520',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by vplayerid\n    union all\n    select '交叉堡垒' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240415' and dtstatdate <= date_add('20240415',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by vplayerid\n)\n\nselect \n    t.itype,\n    t.user_type,\n    t.iusernum1,\n    p.iusernum2\nfrom (\n    select \n        a.itype,\n        b.user_type,\n        count(distinct a.vplayerid) iusernum1\n    from playuser a\n    join (\n        select \n            itype, vplayerid,\n            case \n                when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n                when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n                when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n                when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n                when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n                when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n            end user_type\n        from usertype\n    ) b on a.itype = b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.user_type\n\n    union all\n    \n    select \n        a.itype, \n        case \n            when flag1=0 then '平台盘内' \n            when b.vplayerid is null then '平台盘外' \n        end user_type, \n    count(distinct a.vplayerid) iusernum1\n    from playuser a\n    left join dapan2jordass b \n    on a.itype = b.itype and a.vplayerid = b.vplayerid\n    where flag1=0 or b.vplayerid is null\n    group by a.itype, case when flag1=0 then '平台盘内' when b.vplayerid is null then '平台盘外' end\n) t\nleft join (\n    select itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end user_type,\n        count(distinct vplayerid) iusernum2\n    from usertype\n    group by itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end\n\n    union all\n\n    select itype,'平台盘内',count(distinct vplayerid) \n    from dapan2jordass \n    group by itype\n) p on t.itype=p.itype and t.user_type=p.user_type\n;", "meta": {"origin": "sql_38", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_39_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计各个玩法参与用户其他玩法流入和双栖情况\n\n输出：流入玩法、流出玩法、上线后3天流入玩法参与用户数、上线后3天流出用户数、上线后3天双栖用户数、上线前一周流出玩法总参与用户数、流出占比、上线后3天流出玩法总参与用户数、双栖占比\n【表】dws_jordass_mode_roundrecord_di\n【口径】流入玩法上线日期和取数逻辑：\n广域战场 （2024/7/23）submodename= '广域战场模式'，\n消灭战（2023/8/4） modename='组队竞技' and submodename like '%消灭战模式%'，\n幻想混战（2024/11/18）modename='创意创作间' and submodename='幻想混战'，\n荒野传说（2024-09-06）modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')，\n策略载具（2024-10-13）modename='休闲模式' and submodename like '%策略载具%'，\n炎夏混战（2024-06-28）modename='创意创作间' and submodename like '%炎夏混战%'，\n单人装备（2024.5.17）modename='组队竞技' and submodename like '%单人装备%'，\n交叉堡垒（2024.4.12） modename='组队竞技' and submodename like '%交叉堡垒%'，\n庆典混战（2024/4/26）submode in (2611)，\nCG28战场进化（2024/9/3） modename='传统模式' and submodename ='CG28-动物丛林'，\nCG29流浪地球（2024/11/5） modename='传统模式' and submodename ='CG29-流浪地球'\n\n流出玩法：从上往下匹配，如果满足任一条件则返回对应的玩法名称，否则返回“其他子模式”。\n主题群屿：modename='传统模式' and submodename like 'CG%' and mapname='群屿'\n传统群屿：modename='传统模式' and mapname='群屿'\n假日群岛：modename='传统模式' and mapname='假日群岛'\n山峦：modename='传统模式' and mapname='山峦'\n极能形态模式：submodename='极能形态模式'\n隧道：modename='生存模式'\n广域战场：submodename='广域战场模式'\n休闲模式：modename='休闲模式'\n乐园：modename='乐园'\n领地：modename='领地'\n广阔天地：modename='广阔天地'\n组队竞技：modename='组队竞技'\n\n用户定义：\n流出用户：流入玩法上线前一周玩了流出玩法，并且流入玩法上线后3天没有玩流出玩法，但是有玩流入玩法\n双栖用户：流入玩法上线前一周 和 上线后3天都玩了流出玩法\n流出占比：流出用户除以上线前一周流出玩法总参与\n双栖占比：双栖用户除以上线首周流出玩法总参与"}, {"role": "assistant", "content": "with playuser as (\n    select '广域战场' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate= '20240726'  and  date_add('20240726',2) and submodename= '广域战场模式'\n    group by 1,2,3\n    union all\n    select '消灭战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20230807'  and  date_add('20230807',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by 1,2,3\n    union all\n    select '幻想混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241118' and  date_add('20241118',2) and modename='创意创作间' and submodename='幻想混战'\n    group by 1,2,3\n    union all\n    select '荒野传说' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240906'  and  date_add('20240906',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by 1,2,3\n    union all\n    select '策略载具' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241013'   and  date_add('20241013',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by 1,2,3\n    union all\n    select '炎夏混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240628'   and  date_add('20240628',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by 1,2,3\n    union all\n    select '单人装备' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240520'   and  date_add('20240520',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by 1,2,3\n    union all\n    select '交叉堡垒' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240415'   and  date_add('20240415',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by 1,2,3\n    union all\n    select '庆典混战' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240429'  and  date_add('20240429',2) and submode in (2611)\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG29-流浪地球' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240906' and  date_add('20240906',2)and submodename = 'CG29-流浪地球'\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG28-动物丛林' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241108' and  date_add('20241108',2)and submodename = 'CG28-动物丛林'\n    group by dtstatdate,vplayerid\n),\nallplayuser as (\n    select '广域战场' itype,\n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240726' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240726' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240726',7) and dtstatdate <= date_add('20240726',2)  \n    group by \n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end ,\n        vplayerid\n    union all\n    select '消灭战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20230807' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20230807' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20230807',7) and dtstatdate <= date_add('20230807',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '幻想混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241118' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241118' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241118',7) and dtstatdate <= date_add('20241118',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '荒野传说' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240906' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240906' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240906',7) and dtstatdate <= date_add('20240906',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '策略载具' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241013' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241013' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241013',7) and dtstatdate <= date_add('20241013',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '炎夏混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240628' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240628' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240628',7) and dtstatdate <= date_add('20240628',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '单人装备' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240520' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240520' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240520',7) and dtstatdate <= date_add('20240520',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '交叉堡垒' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240415' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240415' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240415',7) and dtstatdate <= date_add('20240415',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '庆典混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240429' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240429' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240429',7) and dtstatdate <= date_add('20240429',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG28-动物丛林' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240906' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240906' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240906',7) and dtstatdate <= date_add('20240906',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG29-流浪地球' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241108' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241108' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241108',7) and dtstatdate <= date_add('20241108',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n)\n\nselect  \n    t.itype, \n    t.playclass1, \n    iusernum1, -- 流入玩法参与用户数\n    iusernum2, -- 流出用户数\n    iusernum3, -- 双栖用户数\n    iusernum4, -- 前一周流出玩法用户数\n    coalesce(round(iusernum2/iusernum4, 2), 0) as ratio1, -- 流出占比\n    iusernum5, -- 后3天流出玩法用户数\n    coalesce(round(iusernum3/iusernum5, 2), 0) as ratio2 -- 双栖占比\nfrom (\n    select itype,count(distinct vplayerid) iusernum1 from playuser group by itype\n)p\nleft join (\n    select \n        a.itype,\n        b.playclass1,\n        count(distinct case when islast=1 and isthis =0 then a.vplayerid end) iusernum2,\n        count(distinct case when islast=1 and isthis =1 then a.vplayerid end) iusernum3\n    from playuser a\n    left join allplayuser b \n    on a.itype =b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.playclass1\n)t on p.itype = t.itype\nleft join (\n    select \n        itype, \n        playclass1,\n        count(distinct case when islast=1 then vplayerid end) iusernum4,\n        count(distinct case when isthis=1 then vplayerid end) iusernum5\n    from allplayuser\n    group by itype,playclass1\n) m on t.playclass1=m.playclass1 and t.itype=m.itype\n;"}], "rejected": "with playuser as (\n    select '广域战场' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate= '20240726'  and  date_add('20240726',2) and submodename= '广域战场模式'\n    group by 1,2,3\n    union all\n    select '消灭战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20230807'  and  date_add('20230807',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by 1,2,3\n    union all\n    select '幻想混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241118' and  date_add('20241118',2) and modename='创意创作间' and submodename='幻想混战'\n    group by 1,2,3\n    union all\n    select '荒野传说' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240906'  and  date_add('20240906',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by 1,2,3\n    union all\n    select '策略载具' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241013'   and  date_add('20241013',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by 1,2,3\n    union all\n    select '炎夏混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240628'   and  date_add('20240628',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by 1,2,3\n    union all\n    select '单人装备' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240520'   and  date_add('20240520',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by 1,2,3\n    union all\n    select '交叉堡垒' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240415'   and  date_add('20240415',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by 1,2,3\n    union all\n    select '庆典混战' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240429'  and  date_add('20240429',2) and submode in (2611)\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG29-流浪地球' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240906' and  date_add('20240906',2)and submodename = 'CG29-流浪地球'\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG28-动物丛林' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241108' and  date_add('20241108',2)and submodename = 'CG28-动物丛林'\n    group by dtstatdate,vplayerid\n),\nallplayuser as (\n    select '广域战场' itype,\n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240726' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240726' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240726',7) and dtstatdate <= date_add('20240726',2)  \n    group by \n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end ,\n        vplayerid\n    union all\n    select '消灭战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20230807' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20230807' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20230807',7) and dtstatdate <= date_add('20230807',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '幻想混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241118' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241118' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241118',7) and dtstatdate <= date_add('20241118',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '荒野传说' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240906' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240906' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240906',7) and dtstatdate <= date_add('20240906',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '策略载具' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241013' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241013' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241013',7) and dtstatdate <= date_add('20241013',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '炎夏混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240628' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240628' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240628',7) and dtstatdate <= date_add('20240628',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '单人装备' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240520' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240520' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240520',7) and dtstatdate <= date_add('20240520',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '交叉堡垒' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240415' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240415' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240415',7) and dtstatdate <= date_add('20240415',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '庆典混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240429' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240429' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240429',7) and dtstatdate <= date_add('20240429',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG28-动物丛林' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240906' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240906' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240906',7) and dtstatdate <= date_add('20240906',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG29-流浪地球' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241108' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241108' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241108',7) and dtstatdate <= date_add('20241108',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n)\n\nselect  \n    t.itype, \n    t.playclass1, \n    iusernum1, -- 流入玩法参与用户数\n    iusernum2, -- 流出用户数\n    iusernum3, -- 双栖用户数\n    iusernum4, -- 前一周流出玩法用户数\n    coalesce(round(iusernum2/iusernum4, 2), 0) as ratio1, -- 流出占比\n    iusernum5, -- 后3天流出玩法用户数\n    coalesce(round(iusernum3/iusernum5, 2), 0) as ratio2 -- 双栖占比\nfrom (\n    select itype,count(distinct vplayerid) iusernum1 from playuser group by itype\n)p\nleft join (\n    select \n        a.itype,\n        b.playclass1,\n        count(distinct case when islast=1 and isthis =0 then a.vplayerid end) iusernum2,\n        count(distinct case when islast=1 and isthis =1 then a.vplayerid end) iusernum3\n    from playuser a\n    left join allplayuser b \n    on a.itype =b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.playclass1\n)t on p.itype = t.itype\nleft join (\n    select \n        itype, \n        playclass1,\n        count(distinct case when islast=1 then vplayerid end) iusernum4,\n        count(distinct case when isthis=1 then vplayerid end) iusernum5\n    from allplayuser\n    group by itype,playclass1\n) m on t.playclass1=m.playclass1 and t.itype=m.itype\n;", "meta": {"origin": "sql_39", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_77_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：20230123开始7日内元素付费金额\n输出：日期（20230123-20230129），人数，元素付费金额\n【表】dwd_jordass_currencylog_hi\n【口径】限定：reason in (189, 190)\n元素付费类型：imoneytype = 1027\n元素付费金额：imoney"}, {"role": "assistant", "content": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt,\n  sum(coalesce(imoney, 0)) as element_amount\nfrom dwd_jordass_currencylog_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20230123' and '20230129'\n  and reason in (189, 190)\n  and imoneytype = 1027\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date;"}], "rejected": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt,\n  sum(coalesce(imoney, 0)) as element_amount\nfrom dwd_jordass_currencylog_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20230123'\n  and reason in (189, 190)\n  and imoneytype = 1027\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date;", "meta": {"origin": "sql_77", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_42_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2021.11.1-2021.11.30每天按extarg2中用\"_\"分割的第2位的值包含(8,16,17)看点击情况\n输出：日期，按extarg2中用\"_\"分割的第2位，人数，次数\n【表】dws_jordass_buttonpress_pre_di\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  dtstatdate,\n  split_part(extarg2, '_', 2) as second_value,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as click_cnt\nfrom dws_jordass_buttonpress_pre_di\nwhere dtstatdate between '20211128' and '20211227'\n  and split_part(extarg2, '_', 2) in ('8', '16', '17')\ngroup by dtstatdate, split_part(extarg2, '_', 2)\norder by dtstatdate, second_value;"}], "rejected": "select\n  dtstatdate,\n  split_part(extarg2, '_', 2) as second_value,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as click_cnt\nfrom dws_jordass_buttonpress_pre_di\nwhere dtstatdate > '20211128'\n  and split_part(extarg2, '_', 2) in ('8', '16', '17')\ngroup by dtstatdate, split_part(extarg2, '_', 2)\norder by dtstatdate, second_value;", "meta": {"origin": "sql_42", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_20_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20240101-20240527，网吧特权用户的指标数据。\n输出：\n月份（按月：202401、202402、202403、202404）\n人均对局时长（小时）\n网吧时间占当月游戏时间比例\n有对局的天数\n排位模式时长（小时）\n排位模式组队率\n月付费率\n月ARPA\n月ARPPA\n高校特权激活率\n【表】dws_argothek_oss_login_di, dwd_argothek_playerlogout_hi, dws_argothek_oss_portaltransaction_di, dwd_argothek_playermatchstats_hi\n【口径】排位模式：queueId=\"competitive\"\n网吧特权：inetbarlevel = 2\n高校特权：icampuslevel > 0\n网吧在线时长先筛选网吧渠道\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH netbar_users AS (\n  SELECT DISTINCT iuserid AS player_id\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-28' AND '2024-05-27'\n    AND inetbarlevel = '2'\n),\nlogin_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(CAST(statis_date AS VARCHAR), '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ionlinetime) AS total_online_time,\n    SUM(CASE WHEN iloginway IN (1,10,11,12,20,28,29,30,31,32,33,34,35,36) THEN ionlinetime ELSE 0 END) AS netbar_online_time,\n    COUNT(DISTINCT statis_date) AS active_days\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20240128 AND 20240527\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nmatch_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    vroleid AS player_id,\n    SUM(gamelengthmillis) / 1000.0 AS total_match_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN gamelengthmillis ELSE 0 END) / 1000.0 AS competitive_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN 1 ELSE 0 END) AS competitive_matches,\n    SUM(CASE WHEN queueid = 'competitive' AND partyid IS NOT NULL AND partyid <> '' THEN 1 ELSE 0 END) AS competitive_team_matches,\n    COUNT(DISTINCT CAST(dteventtime AS DATE)) AS match_days\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-28' AND '2024-05-27'\n    AND vroleid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, vroleid\n),\npay_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(statis_date, '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ftranamt) / 100.0 AS pay_amount\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date BETWEEN '20240128' AND '20240527'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\ncampus_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    MAX(CASE WHEN icampuslevel IS NOT NULL AND icampuslevel <> '0' THEN 1 ELSE 0 END) AS campus_active\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-28' AND '2024-05-27'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nplayer_month AS (\n  SELECT stat_month, player_id FROM login_agg\n  UNION\n  SELECT stat_month, player_id FROM match_agg\n  UNION\n  SELECT stat_month, player_id FROM pay_agg\n  UNION\n  SELECT stat_month, player_id FROM campus_agg\n),\nmonthly_union AS (\n  SELECT\n    pm.stat_month,\n    pm.player_id,\n    COALESCE(l.total_online_time, 0) AS total_online_time,\n    COALESCE(l.netbar_online_time, 0) AS netbar_online_time,\n    COALESCE(l.active_days, 0) AS active_days,\n    COALESCE(m.total_match_seconds, 0) AS total_match_seconds,\n    COALESCE(m.competitive_seconds, 0) AS competitive_seconds,\n    COALESCE(m.competitive_matches, 0) AS competitive_matches,\n    COALESCE(m.competitive_team_matches, 0) AS competitive_team_matches,\n    COALESCE(m.match_days, 0) AS match_days,\n    COALESCE(p.pay_amount, 0) AS pay_amount,\n    COALESCE(c.campus_active, 0) AS campus_active\n  FROM player_month pm\n  LEFT JOIN login_agg l ON pm.stat_month = l.stat_month AND pm.player_id = l.player_id\n  LEFT JOIN match_agg m ON pm.stat_month = m.stat_month AND pm.player_id = m.player_id\n  LEFT JOIN pay_agg p ON pm.stat_month = p.stat_month AND pm.player_id = p.player_id\n  LEFT JOIN campus_agg c ON pm.stat_month = c.stat_month AND pm.player_id = c.player_id\n),\nmonths AS (\n  SELECT '202401' AS stat_month UNION ALL\n  SELECT '202402' UNION ALL\n  SELECT '202403' UNION ALL\n  SELECT '202404'\n),\nfinal_stats AS (\n  SELECT\n    stat_month,\n    COUNT(DISTINCT player_id) AS player_cnt,\n    SUM(total_match_seconds) AS total_match_seconds,\n    SUM(netbar_online_time) AS total_netbar_online_time,\n    SUM(total_online_time) AS total_online_time,\n    SUM(match_days) AS match_days,\n    SUM(competitive_seconds) AS total_competitive_seconds,\n    SUM(competitive_team_matches) AS total_competitive_team_matches,\n    SUM(competitive_matches) AS total_competitive_matches,\n    SUM(pay_amount) AS total_pay_amount,\n    COUNT(DISTINCT CASE WHEN pay_amount > 0 THEN player_id END) AS pay_user_cnt,\n    SUM(campus_active) AS campus_active_sum\n  FROM monthly_union\n  GROUP BY stat_month\n)\nSELECT\n  m.stat_month,\n  COALESCE(ROUND(final_stats.total_match_seconds / 3600 / NULLIF(final_stats.player_cnt, 0), 4), 0) AS avg_match_hours,\n  COALESCE(ROUND(final_stats.total_netbar_online_time / NULLIF(final_stats.total_online_time, 0), 4), 0) AS netbar_time_ratio,\n  COALESCE(final_stats.match_days, 0) AS match_days_cnt,\n  COALESCE(ROUND(final_stats.total_competitive_seconds / 3600, 4), 0) AS competitive_hours,\n  COALESCE(ROUND(final_stats.total_competitive_team_matches / NULLIF(final_stats.total_competitive_matches, 0), 4), 0) AS competitive_team_rate,\n  COALESCE(ROUND(final_stats.pay_user_cnt / NULLIF(final_stats.player_cnt, 0), 4), 0) AS pay_rate,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.player_cnt, 0), 4), 0) AS arpa,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.pay_user_cnt, 0), 4), 0) AS arppa,\n  COALESCE(ROUND(final_stats.campus_active_sum / NULLIF(final_stats.player_cnt, 0), 4), 0) AS campus_active_rate\nFROM months m\nLEFT JOIN final_stats ON m.stat_month = final_stats.stat_month\nORDER BY m.stat_month;"}], "rejected": "WITH netbar_users AS (\n  SELECT DISTINCT iuserid AS player_id\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-28' AND '2024-05-27'\n    AND inetbarlevel = '2'\n),\nlogin_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(CAST(statis_date AS VARCHAR), '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ionlinetime) AS total_online_time,\n    SUM(CASE WHEN iloginway IN (1,10,11,12,20,28,29,30,31,32,33,34,35,36) THEN ionlinetime ELSE 0 END) AS netbar_online_time,\n    COUNT(DISTINCT statis_date) AS active_days\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20240128 AND 20240527\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nmatch_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    vroleid AS player_id,\n    SUM(gamelengthmillis) / 1000.0 AS total_match_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN gamelengthmillis ELSE 0 END) / 1000.0 AS competitive_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN 1 ELSE 0 END) AS competitive_matches,\n    SUM(CASE WHEN queueid = 'competitive' AND partyid IS NOT NULL AND partyid <> '' THEN 1 ELSE 0 END) AS competitive_team_matches,\n    COUNT(DISTINCT CAST(dteventtime AS DATE)) AS match_days\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-28' AND '2024-05-27'\n    AND vroleid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, vroleid\n),\npay_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(statis_date, '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ftranamt) / 100.0 AS pay_amount\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date > '20240128'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\ncampus_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    MAX(CASE WHEN icampuslevel IS NOT NULL AND icampuslevel <> '0' THEN 1 ELSE 0 END) AS campus_active\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-28' AND '2024-05-27'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nplayer_month AS (\n  SELECT stat_month, player_id FROM login_agg\n  UNION\n  SELECT stat_month, player_id FROM match_agg\n  UNION\n  SELECT stat_month, player_id FROM pay_agg\n  UNION\n  SELECT stat_month, player_id FROM campus_agg\n),\nmonthly_union AS (\n  SELECT\n    pm.stat_month,\n    pm.player_id,\n    COALESCE(l.total_online_time, 0) AS total_online_time,\n    COALESCE(l.netbar_online_time, 0) AS netbar_online_time,\n    COALESCE(l.active_days, 0) AS active_days,\n    COALESCE(m.total_match_seconds, 0) AS total_match_seconds,\n    COALESCE(m.competitive_seconds, 0) AS competitive_seconds,\n    COALESCE(m.competitive_matches, 0) AS competitive_matches,\n    COALESCE(m.competitive_team_matches, 0) AS competitive_team_matches,\n    COALESCE(m.match_days, 0) AS match_days,\n    COALESCE(p.pay_amount, 0) AS pay_amount,\n    COALESCE(c.campus_active, 0) AS campus_active\n  FROM player_month pm\n  LEFT JOIN login_agg l ON pm.stat_month = l.stat_month AND pm.player_id = l.player_id\n  LEFT JOIN match_agg m ON pm.stat_month = m.stat_month AND pm.player_id = m.player_id\n  LEFT JOIN pay_agg p ON pm.stat_month = p.stat_month AND pm.player_id = p.player_id\n  LEFT JOIN campus_agg c ON pm.stat_month = c.stat_month AND pm.player_id = c.player_id\n),\nmonths AS (\n  SELECT '202401' AS stat_month UNION ALL\n  SELECT '202402' UNION ALL\n  SELECT '202403' UNION ALL\n  SELECT '202404'\n),\nfinal_stats AS (\n  SELECT\n    stat_month,\n    COUNT(DISTINCT player_id) AS player_cnt,\n    SUM(total_match_seconds) AS total_match_seconds,\n    SUM(netbar_online_time) AS total_netbar_online_time,\n    SUM(total_online_time) AS total_online_time,\n    SUM(match_days) AS match_days,\n    SUM(competitive_seconds) AS total_competitive_seconds,\n    SUM(competitive_team_matches) AS total_competitive_team_matches,\n    SUM(competitive_matches) AS total_competitive_matches,\n    SUM(pay_amount) AS total_pay_amount,\n    COUNT(DISTINCT CASE WHEN pay_amount > 0 THEN player_id END) AS pay_user_cnt,\n    SUM(campus_active) AS campus_active_sum\n  FROM monthly_union\n  GROUP BY stat_month\n)\nSELECT\n  m.stat_month,\n  COALESCE(ROUND(final_stats.total_match_seconds / 3600 / NULLIF(final_stats.player_cnt, 0), 4), 0) AS avg_match_hours,\n  COALESCE(ROUND(final_stats.total_netbar_online_time / NULLIF(final_stats.total_online_time, 0), 4), 0) AS netbar_time_ratio,\n  COALESCE(final_stats.match_days, 0) AS match_days_cnt,\n  COALESCE(ROUND(final_stats.total_competitive_seconds / 3600, 4), 0) AS competitive_hours,\n  COALESCE(ROUND(final_stats.total_competitive_team_matches / NULLIF(final_stats.total_competitive_matches, 0), 4), 0) AS competitive_team_rate,\n  COALESCE(ROUND(final_stats.pay_user_cnt / NULLIF(final_stats.player_cnt, 0), 4), 0) AS pay_rate,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.player_cnt, 0), 4), 0) AS arpa,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.pay_user_cnt, 0), 4), 0) AS arppa,\n  COALESCE(ROUND(final_stats.campus_active_sum / NULLIF(final_stats.player_cnt, 0), 4), 0) AS campus_active_rate\nFROM months m\nLEFT JOIN final_stats ON m.stat_month = final_stats.stat_month\nORDER BY m.stat_month;", "meta": {"origin": "sql_20", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_23_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年3月24日至2025年3月30日，至少完成过一场对局，且渠道登录的用户qq\n输出:qq\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df, dwd_argothek_playermatchstats_hi, dim_argothek_gplayerid_vroleid_df\n【口径】渠道筛选条件：iloginway = 3\n用户ID筛选swxid_type = \"qq\" -- 筛选swxid_type为\"qq\""}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith channel_login as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250329 and 20250404\n    and iloginway = 3\n),\nrole_map as (\n  select\n    vroleid,\n    gplayerid\n  from (\n    select\n      vroleid,\n      iuserid as gplayerid,\n      row_number() over(partition by vroleid order by dtstatdate desc) as rn\n    from dim_argothek_gplayerid_vroleid_df\n    where dtstatdate <= '20250404'\n  ) t\n  where rn = 1\n),\nmatch_player as (\n  select distinct rm.gplayerid\n  from dwd_argothek_playermatchstats_hi s\n  join role_map rm on s.vroleid = rm.vroleid\n  where substr(s.tdbank_imp_date, 1, 8) between '20250329' and '20250404'\n    and coalesce(s.ismatchcompleted, 1) = 1\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250404'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom match_player mp\njoin channel_login cl on mp.gplayerid = cl.iuserid\njoin qq_map q on mp.gplayerid = q.iuserid\norder by qq\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith channel_login as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250329 and 20250404\n    and iloginway = 3\n),\nrole_map as (\n  select\n    vroleid,\n    gplayerid\n  from (\n    select\n      vroleid,\n      iuserid as gplayerid,\n      row_number() over(partition by vroleid order by dtstatdate desc) as rn\n    from dim_argothek_gplayerid_vroleid_df\n    where dtstatdate <= '20250404'\n  ) t\n  where rn = 1\n),\nmatch_player as (\n  select distinct rm.gplayerid\n  from dwd_argothek_playermatchstats_hi s\n  join role_map rm on s.vroleid = rm.vroleid\n  where substr(s.tdbank_imp_date, 1, 8) > '20250329'\n    and coalesce(s.ismatchcompleted, 1) = 1\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250404'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom match_player mp\njoin channel_login cl on mp.gplayerid = cl.iuserid\njoin qq_map q on mp.gplayerid = q.iuserid\norder by qq\n) AS final_query;", "meta": {"origin": "sql_23", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_68_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计时间范围：25.1.28-25.2.10，新春华服id：848，841 \n输出：日期（YYDDMM），人数\n【表】dwd_jordass_lotteryrecord_hi\n【口径】新春华服：\nactivitytype in (848, 841)"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom dwd_jordass_lotteryrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20250201' and '20250214'\n  and activitytype in (848, 841)\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom dwd_jordass_lotteryrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20250201'\n  and activitytype in (848, 841)\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date\n) AS final_query;", "meta": {"origin": "sql_68", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_1_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.07.24的手游全量用户且标签为其他，在竞品业务下2025.05.30-2025.07.24的在线时长。\n输出：suserid、sgamecode、ionlinetime\n【表】dws_mgamejp_login_user_activity_di, dim_vplayerid_vies_df\n【口径】竞品业务：\nsgamecode in (\"initiatived\",\"jordass\",\"esports\",\"allianceforce\",\"strategy\",\"playzone\",\"su\")\nsaccounttype = \"-100\" -- 账号体系取汇总\nsuseridtype in (\"qq\",\"wxid\") -- 用户类型\nsplattype = \"-100\" -- 平台类型写死-100\nsplat = \"-100\" -- 平台写死-100\n\ndim_vplayerid_vies_df 字段：suserid、suserid_type（映射到事实表的 suserid / suseridtype）"}, {"role": "assistant", "content": "WITH base_user AS (\n  SELECT DISTINCT\n         suserid,\n         suserid_type\n  FROM dim_vplayerid_vies_df\n  WHERE dtstatdate = '20250727'\n    AND itag = '其他'\n    AND suserid IS NOT NULL\n    AND suserid_type IN ('qq', 'wxid')\n)\nSELECT\n    a.suserid,\n    a.sgamecode,\n    SUM(a.ionlinetime) AS ionlinetime\nFROM dws_mgamejp_login_user_activity_di a\nJOIN base_user b\n  ON a.suserid = b.suserid\n AND a.suseridtype = b.suserid_type\nWHERE a.dtstatdate BETWEEN '20250602' AND '20250727'\n  AND a.sgamecode IN ('initiatived', 'jordass', 'esports', 'allianceforce', 'strategy', 'playzone', 'su')\n  AND a.saccounttype = '-100'\n  AND a.suseridtype IN ('qq', 'wxid')\n  AND a.splattype = '-100'\n  AND a.splat = '-100'\nGROUP BY a.suserid, a.sgamecode\nORDER BY a.suserid, a.sgamecode;"}], "rejected": "WITH base_user AS (\n  SELECT DISTINCT\n         suserid,\n         suserid_type\n  FROM dim_vplayerid_vies_df\n  WHERE dtstatdate = '20250727'\n    AND itag = '其他'\n    AND suserid IS NOT NULL\n    AND suserid_type IN ('qq', 'wxid')\n)\nSELECT\n    a.suserid,\n    a.sgamecode,\n    SUM(a.ionlinetime) AS ionlinetime\nFROM dws_mgamejp_login_user_activity_di a\nJOIN base_user b\n  ON a.suserid = b.suserid\n AND a.suseridtype = b.suserid_type\nWHERE a.dtstatdate BETWEEN '20250602' AND '20250727'\n  AND a.sgamecode IN ('initiatived', 'jordass', 'esports', 'allianceforce', 'strategy', 'playzone', 'su')\n  AND a.suseridtype IN ('qq', 'wxid')\n  AND a.splattype = '-100'\n  AND a.splat = '-100'\nGROUP BY a.suserid, a.sgamecode\nORDER BY a.suserid, a.sgamecode;", "meta": {"origin": "sql_1", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_40_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】sql_40时间段2024.3.1-2024.6.30分月看用户当月在砺刃的 新进、回流、轻度留存、中度留存、重度留存\n\n输出：月份(202403、...、202406)、新进人数、回流人数、轻度留存人数、中度留存人数、重度留存人数\n【表】dws_jordass_login_di, dws_jordass_login_df\n【口径】新进：当月新进 \n回流：上个月未活跃的历史注册用户，在当月活跃\n轻度留存：留存用户（上个月活跃，本月也活跃的用户）在本月的活跃度1-4天\n中度留存：留存用户（上个月活跃，本月也活跃的用户）在本月的活跃度5-15天\n重度留存：留存用户（上个月活跃，本月也活跃的用户）在本月的活跃度16天及以上\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH base AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(dtstatdate, '%Y%m%d'), '%Y%m') AS stat_month,\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20240328' AND '20240727'\n    AND platid = 255\n  GROUP BY stat_month, vplayerid\n),\nmonth_info AS (\n  SELECT\n    b.stat_month,\n    b.vplayerid,\n    b.active_days,\n    MIN(b.stat_month) OVER (PARTITION BY b.vplayerid) AS first_month\n  FROM base b\n),\nprev_month_map AS (\n  SELECT\n    stat_month,\n    DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(stat_month, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m') AS prev_month\n  FROM (SELECT DISTINCT stat_month FROM base) t\n),\nclassified AS (\n  SELECT\n    m.stat_month,\n    m.vplayerid,\n    m.active_days,\n    CASE\n      WHEN m.stat_month = m.first_month THEN 'new'\n      WHEN prev.vplayerid IS NOT NULL THEN 'retained'\n      WHEN m.stat_month > m.first_month THEN 'return'\n      ELSE 'other'\n    END AS user_type\n  FROM month_info m\n  LEFT JOIN prev_month_map pm ON m.stat_month = pm.stat_month\n  LEFT JOIN base prev ON prev.stat_month = pm.prev_month AND prev.vplayerid = m.vplayerid\n)\nSELECT\n  stat_month,\n  SUM(CASE WHEN user_type = 'new' THEN 1 ELSE 0 END) AS new_user_cnt,\n  SUM(CASE WHEN user_type = 'return' THEN 1 ELSE 0 END) AS return_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 1 AND 4 THEN 1 ELSE 0 END) AS light_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 5 AND 15 THEN 1 ELSE 0 END) AS medium_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days >= 16 THEN 1 ELSE 0 END) AS heavy_retained_user_cnt\nFROM classified\nGROUP BY stat_month\nORDER BY stat_month;"}], "rejected": "WITH base AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(dtstatdate, '%Y%m%d'), '%Y%m') AS stat_month,\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate > '20240328'\n    AND platid = 255\n  GROUP BY stat_month, vplayerid\n),\nmonth_info AS (\n  SELECT\n    b.stat_month,\n    b.vplayerid,\n    b.active_days,\n    MIN(b.stat_month) OVER (PARTITION BY b.vplayerid) AS first_month\n  FROM base b\n),\nprev_month_map AS (\n  SELECT\n    stat_month,\n    DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(stat_month, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m') AS prev_month\n  FROM (SELECT DISTINCT stat_month FROM base) t\n),\nclassified AS (\n  SELECT\n    m.stat_month,\n    m.vplayerid,\n    m.active_days,\n    CASE\n      WHEN m.stat_month = m.first_month THEN 'new'\n      WHEN prev.vplayerid IS NOT NULL THEN 'retained'\n      WHEN m.stat_month > m.first_month THEN 'return'\n      ELSE 'other'\n    END AS user_type\n  FROM month_info m\n  LEFT JOIN prev_month_map pm ON m.stat_month = pm.stat_month\n  LEFT JOIN base prev ON prev.stat_month = pm.prev_month AND prev.vplayerid = m.vplayerid\n)\nSELECT\n  stat_month,\n  SUM(CASE WHEN user_type = 'new' THEN 1 ELSE 0 END) AS new_user_cnt,\n  SUM(CASE WHEN user_type = 'return' THEN 1 ELSE 0 END) AS return_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 1 AND 4 THEN 1 ELSE 0 END) AS light_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 5 AND 15 THEN 1 ELSE 0 END) AS medium_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days >= 16 THEN 1 ELSE 0 END) AS heavy_retained_user_cnt\nFROM classified\nGROUP BY stat_month\nORDER BY stat_month;", "meta": {"origin": "sql_40", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_75_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2022080400-2024112400的研究所解锁语音数量\n输出：baseid,解锁语音数量\n【表】dwd_jordass_voicethemelog_hi\n【口径】研究所：baseid in (3336008, 3304024, 3336012, 3306028, 3304030, 3336016, 3336018, 3304038, 3336023, 3306033, 3349004, 3308014, 3336032, 3304043, 3306039, 3336041, 3301024, 3336045, 3306042)"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  cast(baseid as string) as base_id,\n  count(*) as unlock_cnt\nfrom dwd_jordass_voicethemelog_hi\nwhere tdbank_imp_date between '2022080400' and '2024112400'\n  and baseid in (3336008, 3304024, 3336012, 3306028, 3304030, 3336016, 3336018, 3304038, 3336023, 3306033, 3349004, 3308014, 3336032, 3304043, 3306039, 3336041, 3301024, 3336045, 3306042)\ngroup by baseid\norder by base_id\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  cast(baseid as string) as base_id,\n  count(*) as unlock_cnt\nfrom dwd_jordass_voicethemelog_hi\nwhere tdbank_imp_date between '2022080400' and '2024112400'\n  and baseid in (3336008, 3304024, 3336012, 3306028, 3304030, 3336016, 3336018, 3304038, 3336023, 3306033, 3349004, 3308014, 3336032, 3304043, 3306039, 3336041, 3301024, 3336045, 3306042)\ngroup by baseid\norder by base_id\n) AS final_query;", "meta": {"origin": "sql_75", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_45_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.01.01-2024.01.07参与乐园子玩法拼图狂欢在202401.08-2024.01.14没玩乐园子玩法拼图狂欢在2024.01.15-2024.01.21又玩了乐园子玩法拼图狂欢的用户\n输出：玩家数\n【表】dws_jordass_matchlog_stat_di\n【口径】imode为1287652322611036928代表乐园子玩法拼图狂欢\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select count(distinct a.vplayerid) as player_num\nfrom (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240128' and '20240203'\n    and imode = 1287652322611036928\n) a\nleft join (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240204' and '20240210'\n    and imode = 1287652322611036928\n) b on a.vplayerid = b.vplayerid\njoin (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240211' and '20240217'\n    and imode = 1287652322611036928\n) c on a.vplayerid = c.vplayerid\nwhere b.vplayerid is null;"}], "rejected": "select count(distinct a.vplayerid) as player_num\nfrom (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate > '20240128'\n    and imode = 1287652322611036928\n) a\nleft join (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240204' and '20240210'\n    and imode = 1287652322611036928\n) b on a.vplayerid = b.vplayerid\njoin (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240211' and '20240217'\n    and imode = 1287652322611036928\n) c on a.vplayerid = c.vplayerid\nwhere b.vplayerid is null;", "meta": {"origin": "sql_45", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_109_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计 20250428-20250512 期间 传统和休闲的胜利情况\n\n 胜利数分布层次：1,2-10,11-20,21-50,51-80,81-100，101-200,201-500,501以上\n 输出：胜利数分布层次，人数\n【表】dwd_jordass_roundlog_funnymode_hi, dwd_jordass_roundflow_hi\n【口径】传统模式： mode in(101,102,103,401,402,403)\n 休闲：mode in(201,202,203,601,602,603) \n 胜利：teamrank =1 \n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH combined AS (\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-28' AND '2025-05-12'\n  UNION ALL\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundlog_funnymode_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-28' AND '2025-05-12'\n), total_wins AS (\n  SELECT\n    vplayerid,\n    SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n    SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) AS win_cnt\n  FROM combined\n  GROUP BY vplayerid\n  HAVING SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n         SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) > 0\n), bucketed AS (\n  SELECT\n    CASE\n      WHEN win_cnt = 1 THEN '1'\n      WHEN win_cnt BETWEEN 2 AND 10 THEN '2-10'\n      WHEN win_cnt BETWEEN 11 AND 20 THEN '11-20'\n      WHEN win_cnt BETWEEN 21 AND 50 THEN '21-50'\n      WHEN win_cnt BETWEEN 51 AND 80 THEN '51-80'\n      WHEN win_cnt BETWEEN 81 AND 100 THEN '81-100'\n      WHEN win_cnt BETWEEN 101 AND 200 THEN '101-200'\n      WHEN win_cnt BETWEEN 201 AND 500 THEN '201-500'\n      ELSE '501+'\n    END AS win_bucket\n  FROM total_wins\n)\nSELECT\n  win_bucket,\n  COUNT(*) AS user_cnt\nFROM bucketed\nGROUP BY win_bucket\nORDER BY CASE win_bucket\n  WHEN '1' THEN 1\n  WHEN '2-10' THEN 2\n  WHEN '11-20' THEN 3\n  WHEN '21-50' THEN 4\n  WHEN '51-80' THEN 5\n  WHEN '81-100' THEN 6\n  WHEN '101-200' THEN 7\n  WHEN '201-500' THEN 8\n  ELSE 9\nEND;"}], "rejected": "WITH combined AS (\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-28' AND '2025-05-12'\n  UNION ALL\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundlog_funnymode_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-28' AND '2025-05-12'\n), total_wins AS (\n  SELECT\n    vplayerid,\n    SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n    SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) AS win_cnt\n  FROM combined\n  GROUP BY vplayerid\n  HAVING SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n         SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) > 0\n), bucketed AS (\n  SELECT\n    CASE\n      WHEN win_cnt = 1 THEN '1'\n      WHEN win_cnt BETWEEN 2 AND 10 THEN '2-10'\n      WHEN win_cnt BETWEEN 11 AND 20 THEN '11-20'\n      WHEN win_cnt BETWEEN 21 AND 50 THEN '21-50'\n      WHEN win_cnt BETWEEN 51 AND 80 THEN '51-80'\n      WHEN win_cnt BETWEEN 81 AND 100 THEN '81-100'\n      WHEN win_cnt BETWEEN 101 AND 200 THEN '101-200'\n      WHEN win_cnt BETWEEN 201 AND 500 THEN '201-500'\n      ELSE '501+'\n    END AS win_bucket\n  FROM total_wins\n)\nSELECT\n  win_bucket,\n  COUNT(*) AS user_cnt\nFROM bucketed\nGROUP BY win_bucket\nORDER BY CASE win_bucket\n  WHEN '1' THEN 1\n  WHEN '2-10' THEN 2\n  WHEN '11-20' THEN 3\n  WHEN '21-50' THEN 4\n  WHEN '51-80' THEN 5\n  WHEN '81-100' THEN 6\n  WHEN '101-200' THEN 7\n  WHEN '201-500' THEN 8\n  ELSE 9\nEND;", "meta": {"origin": "sql_109", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_59_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：20250118-20250124时间区间内，幻境使者活动抽奖用户第X次触发赠送后，这些用户的总抽奖次数\n输出：第X次触发,触发用户数,用户总抽奖次数\n【表】dwd_jordass_activityrecord_hi\n【口径】actid=2411070621 and acttype= 10062 表示幻境使者活动\narg1表示抽奖次数\nStrArg1<>0表示触发赠送"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect \n    s1.trigger_count as `trigger_count`, -- 第x次触发\n    count(distinct s1.vplayerid) as `trigger_user_cnt`, -- 触发用户数\n    sum(s2.draw_count) as `total_draw_count` -- 用户总抽奖次数\nfrom (\n    select\n        vplayerid,\n        dteventtime,\n        coalesce(lead(dteventtime) over (partition by vplayerid order by dteventtime), '9999-12-31 23:59:59')  as next_dteventtime,\n        row_number() over (partition by vplayerid order by dteventtime) as trigger_count\n    from (\n        select distinct\n            vplayerid,\n            dteventtime\n        from dwd_jordass_activityrecord_hi\n        where tdbank_imp_date >= '2025011100'\n        and tdbank_imp_date <= '2025012423'\n        and actid = 2411070621\n        and acttype = 10062\n        and recodtype in ('1', '2')\n        and strarg1 <> '0'\n    ) ff1\n) s1 \njoin (\n    select\n        vplayerid,\n        dteventtime,\n        sum(arg1) as draw_count\n    from dwd_jordass_activityrecord_hi  -- actgeneralflow表\n    where tdbank_imp_date >= \"2025011100\" and tdbank_imp_date <= \"2025012423\" -- 时间区间：20250118-20250131\n    and actid = 2411070621\n    and acttype = 10062\n    and recodtype in (\"1\", \"2\")\n    group by vplayerid, dteventtime\n\n    \n) s2 \non s1.vplayerid = s2.vplayerid and s2. dteventtime >= s1.dteventtime and s2.dteventtime < s1.next_dteventtime\ngroup by s1.trigger_count\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect \n    s1.trigger_count as `trigger_count`, -- 第x次触发\n    count(distinct s1.vplayerid) as `trigger_user_cnt`, -- 触发用户数\n    sum(s2.draw_count) as `total_draw_count` -- 用户总抽奖次数\nfrom (\n    select\n        vplayerid,\n        dteventtime,\n        coalesce(lead(dteventtime) over (partition by vplayerid order by dteventtime), '9999-12-31 23:59:59')  as next_dteventtime,\n        row_number() over (partition by vplayerid order by dteventtime) as trigger_count\n    from (\n        select distinct\n            vplayerid,\n            dteventtime\n        from dwd_jordass_activityrecord_hi\n        where tdbank_imp_date >= '2025011100'\n        and tdbank_imp_date <= '2025012423'\n        and actid = 2411070621\n        and acttype = 10062\n        and recodtype in ('1', '2')\n        and strarg1 <> '0'\n    ) ff1\n) s1 \njoin (\n    select\n        vplayerid,\n        dteventtime,\n        sum(arg1) as draw_count\n    from dwd_jordass_activityrecord_hi  -- actgeneralflow表\n    where tdbank_imp_date >= \"2025011100\" and tdbank_imp_date <= \"2025012423\" -- 时间区间：20250118-20250131\n    and actid = 2411070621\n    and acttype = 10062\n    and recodtype in (\"1\", \"2\")\n    group by vplayerid, dteventtime\n\n    \n) s2 \non s1.vplayerid = s2.vplayerid and s2. dteventtime >= s1.dteventtime and s2.dteventtime < s1.next_dteventtime\ngroup by s1.trigger_count\n) AS final_query;", "meta": {"origin": "sql_59", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_97_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】在2023.7.19-2023.7.25时间范围内，分别统计参与了隐匿的用户人数、既参与隐匿也参与了桥梁争夺的用户、既参与隐匿也参与了隐匿模式的用户\n输出：参与了隐匿的不重复的人的个数、参与隐匿并且参与了桥梁争夺的不重复的人的个数、参与隐匿并且参与了隐匿模式的不重复的人的个数\n【表】dws_jordass_matchlog_stat_di, dws_jordass_mode_roundrecord_di\n【口径】隐匿的用户：imode = 1307095884553538304  and platid <> 255\n桥梁争夺的用户：imode = 1310822585431254784  and platid <> 255\n隐匿模式的用户：mode=2370"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith hidden as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate between '20230722' and '20230728'\n    and imode = 1307095884553538304\n    and platid <> 255\n),\nbridge as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate between '20230722' and '20230728'\n    and imode = 1310822585431254784\n    and platid <> 255\n),\nhidden_mode as (\n  select distinct vplayerid\n  from dws_jordass_mode_roundrecord_di\n  where dtstatdate between '20230722' and '20230728'\n    and mode = 2370\n)\nselect\n  (select count(*) from hidden) as hidden_user_cnt,\n  (select count(*) from hidden h join bridge b on h.vplayerid = b.vplayerid) as hidden_and_bridge_cnt,\n  (select count(*) from hidden h join hidden_mode m on h.vplayerid = m.vplayerid) as hidden_and_mode_cnt\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith hidden as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate > '20230722'\n    and imode = 1307095884553538304\n    and platid <> 255\n),\nbridge as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate between '20230722' and '20230728'\n    and imode = 1310822585431254784\n    and platid <> 255\n),\nhidden_mode as (\n  select distinct vplayerid\n  from dws_jordass_mode_roundrecord_di\n  where dtstatdate between '20230722' and '20230728'\n    and mode = 2370\n)\nselect\n  (select count(*) from hidden) as hidden_user_cnt,\n  (select count(*) from hidden h join bridge b on h.vplayerid = b.vplayerid) as hidden_and_bridge_cnt,\n  (select count(*) from hidden h join hidden_mode m on h.vplayerid = m.vplayerid) as hidden_and_mode_cnt\n) AS final_query;", "meta": {"origin": "sql_97", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_71_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.11.29-2024.12.19期间，每七天统计一次阶梯活动相关用户数\n输出 日期范围（20241228-20250103、20250104-20250110、20250111-20250117），extarg1类型，用户数，次数\n【表】dwd_jordass_activitypress_hi\n【口径】阶梯活动：ireason = 2411291018 and buttontype = 10045 and extarg1 in (101,109,110)\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with tagged as (\n  select\n    case\n      when substr(tdbank_imp_date, 1, 8) between '20241228' and '20250103' then '20241228-20250103'\n      when substr(tdbank_imp_date, 1, 8) between '20250104' and '20250110' then '20250104-20250110'\n      when substr(tdbank_imp_date, 1, 8) between '20250111' and '20250117' then '20250111-20250117'\n      else null\n    end as range_flag,\n    extarg1,\n    vplayerid\n  from dwd_jordass_activitypress_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241228' and '20250117'\n    and ireason = 2411291018\n    and buttontype = 10045\n    and extarg1 in (101, 109, 110)\n)\nselect\n  range_flag as date_range,\n  cast(extarg1 as string) as extarg1_type,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as press_cnt\nfrom tagged\nwhere range_flag is not null\ngroup by range_flag, extarg1_type\norder by date_range, extarg1_type;"}], "rejected": "with tagged as (\n  select\n    case\n      when substr(tdbank_imp_date, 1, 8) > '20241228' then '20241228-20250103'\n      when substr(tdbank_imp_date, 1, 8) between '20250104' and '20250110' then '20250104-20250110'\n      when substr(tdbank_imp_date, 1, 8) between '20250111' and '20250117' then '20250111-20250117'\n      else null\n    end as range_flag,\n    extarg1,\n    vplayerid\n  from dwd_jordass_activitypress_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241228' and '20250117'\n    and ireason = 2411291018\n    and buttontype = 10045\n    and extarg1 in (101, 109, 110)\n)\nselect\n  range_flag as date_range,\n  cast(extarg1 as string) as extarg1_type,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as press_cnt\nfrom tagged\nwhere range_flag is not null\ngroup by range_flag, extarg1_type\norder by date_range, extarg1_type;", "meta": {"origin": "sql_71", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_49_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】2024年10月1-2024年10月7 用周期开始时间判断玩法上线时间在7天及以上，周期结束时间判断玩法上线时间在90天及以内的玩法，统计周期内这些玩法的参与和留存情况\n输出：周期(20241007-20241013)，日期(20241007、...、20241013)，参与人数，次留人数\n【表】dws_jordass_matchlog_stat_di, dim_jordass_submodeonline_nf\n【口径】"}, {"role": "assistant", "content": "with play_user as (\n    select distinct\n        p.dtstatdate as ds, --日期\n        p.vplayerid    --玩家id\n    from\n        dws_jordass_matchlog_stat_di p\n    join\n        dim_jordass_submodeonline_nf c\n    on\n        p.imode = c.matchsubmodegroup\n    where\n        p.dtstatdate between '20241007' and '20241014'\n        and datediff('20241007', c.onlinedate) >= 7\n        and datediff('20241013', c.onlinedate) <= 90\n)\nselect\n    '20241007-20241013' as period, --周期\n    a.ds,\n    count(distinct a.vplayerid) as play_user_num, --参与人数\n    count(distinct b.vplayerid) as retention_user_num --次留人数\nfrom\n    play_user a\nleft join\n    play_user b\non\n    a.vplayerid = b.vplayerid\n    and b.ds = date_add(a.ds, 1)  -- 次日留存条件\nwhere\n    a.ds between '20241007' and '20241013'\ngroup by\n    a.ds\norder by\n    a.ds;"}], "rejected": "with play_user as (\n    select distinct\n        p.dtstatdate as ds, --日期\n        p.vplayerid    --玩家id\n    from\n        dws_jordass_matchlog_stat_di p\n    join\n        dim_jordass_submodeonline_nf c\n    on\n        p.imode = c.matchsubmodegroup\n    where\n        p.dtstatdate > '20241007'\n        and datediff('20241007', c.onlinedate) >= 7\n        and datediff('20241013', c.onlinedate) <= 90\n)\nselect\n    '20241007-20241013' as period, --周期\n    a.ds,\n    count(distinct a.vplayerid) as play_user_num, --参与人数\n    count(distinct b.vplayerid) as retention_user_num --次留人数\nfrom\n    play_user a\nleft join\n    play_user b\non\n    a.vplayerid = b.vplayerid\n    and b.ds = date_add(a.ds, 1)  -- 次日留存条件\nwhere\n    a.ds between '20241007' and '20241013'\ngroup by\n    a.ds\norder by\n    a.ds;", "meta": {"origin": "sql_49", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_78_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：首日红装活动（20250220）返场抽奖的用户属性\n输出：初日华服回归抽奖&沙漠统治者有抽奖人数\n初日华服回归抽奖&境界双花有抽奖人数\t\t\n初日华服回归抽奖&玄龙凌霄有抽奖人数\t\t\n初日华服回归抽奖&沙漠统治者有抽奖&但没有其主套人数\t\t\n初日华服回归抽奖&境界双花有抽奖&但没有其主套人数\t\t\n初日华服回归抽奖&玄龙凌霄有抽奖&但没有其主套人数\t\t\n初日华服回归抽奖&【沙漠统治者和境界双花有主套】人数\t\t\n初日华服回归抽奖&【沙漠统治者和玄龙凌霄有主套】人数\t\t\t\t\n初日华服回归抽奖&【境界双花和玄龙凌霄有主套】人数\t\t\t\t\n初日华服回归抽奖但【沙漠统治者&境界双花&玄龙凌霄】没有抽奖人数\n【表】dwd_jordass_gearlog_hi, dwd_jordass_lotteryrecord_hi\n【口径】抽奖活动时间：\n沙漠统治者：20240528-20240708 \n镜域双华：20240709-20240826 \n玄龙凌霄：20240827-20240923\n抽奖活动筛选条件：\n初日华服回归抽奖 activitytype = 815\n沙漠统治者有抽奖 activitytype = 690\n境界双花有抽奖 activitytype = 748\n玄龙凌霄有抽奖 activitytype = 750\n主套提取逻辑：\n提取道具沙漠统治者-有主套的用户 igoodsid = 430179 and addorreduce = 0\n提取道具镜域双华-有主套的用户 igoodsid = 430265  and addorreduce = 0\n提取道具玄龙凌霄-有主套用户 igoodsid = 430225  and addorreduce = 0\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH base_users AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) = '2025-02-20'\n    AND activitytype = 815\n), sand_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 690\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-05-28' AND '2024-07-08'\n), floral_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 748\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-07-09' AND '2024-08-26'\n), dragon_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 750\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-08-27' AND '2024-09-23'\n), sand_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430179\n    AND addorreduce = 0\n), floral_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430265\n    AND addorreduce = 0\n), dragon_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430225\n    AND addorreduce = 0\n), enriched AS (\n  SELECT\n    b.vplayerid,\n    CASE WHEN s.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_lottery,\n    CASE WHEN f.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_lottery,\n    CASE WHEN d.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_lottery,\n    CASE WHEN ss.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_suit,\n    CASE WHEN fs.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_suit,\n    CASE WHEN ds.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_suit\n  FROM base_users b\n  LEFT JOIN sand_lottery s ON b.vplayerid = s.vplayerid\n  LEFT JOIN floral_lottery f ON b.vplayerid = f.vplayerid\n  LEFT JOIN dragon_lottery d ON b.vplayerid = d.vplayerid\n  LEFT JOIN sand_suit ss ON b.vplayerid = ss.vplayerid\n  LEFT JOIN floral_suit fs ON b.vplayerid = fs.vplayerid\n  LEFT JOIN dragon_suit ds ON b.vplayerid = ds.vplayerid\n)\nSELECT\n  SUM(CASE WHEN has_sand_lottery = 1 THEN 1 ELSE 0 END) AS base_sand_lottery_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 THEN 1 ELSE 0 END) AS base_floral_lottery_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 THEN 1 ELSE 0 END) AS base_dragon_lottery_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_sand_suit = 0 THEN 1 ELSE 0 END) AS base_sand_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_floral_suit = 0 THEN 1 ELSE 0 END) AS base_floral_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 AND has_dragon_suit = 0 THEN 1 ELSE 0 END) AS base_dragon_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_floral_lottery = 1 AND has_sand_suit = 1 AND has_floral_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_floral_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_dragon_lottery = 1 AND has_sand_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_dragon_lottery = 1 AND has_floral_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_floral_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 0 AND has_floral_lottery = 0 AND has_dragon_lottery = 0 THEN 1 ELSE 0 END) AS base_without_three_lottery_cnt\nFROM enriched;"}], "rejected": "WITH base_users AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) = '2025-02-20'\n    AND activitytype = 815\n), sand_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 690\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-05-28' AND '2024-07-08'\n), floral_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 748\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-07-09' AND '2024-08-26'\n), dragon_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 750\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-08-27' AND '2024-09-23'\n), sand_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430179\n    AND addorreduce = 0\n), floral_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430265\n    AND addorreduce = 0\n), dragon_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430225\n    AND addorreduce = 0\n), enriched AS (\n  SELECT\n    b.vplayerid,\n    CASE WHEN s.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_lottery,\n    CASE WHEN f.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_lottery,\n    CASE WHEN d.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_lottery,\n    CASE WHEN ss.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_suit,\n    CASE WHEN fs.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_suit,\n    CASE WHEN ds.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_suit\n  FROM base_users b\n  LEFT JOIN sand_lottery s ON b.vplayerid = s.vplayerid\n  LEFT JOIN floral_lottery f ON b.vplayerid = f.vplayerid\n  LEFT JOIN dragon_lottery d ON b.vplayerid = d.vplayerid\n  LEFT JOIN sand_suit ss ON b.vplayerid = ss.vplayerid\n  LEFT JOIN floral_suit fs ON b.vplayerid = fs.vplayerid\n  LEFT JOIN dragon_suit ds ON b.vplayerid = ds.vplayerid\n)\nSELECT\n  SUM(CASE WHEN has_sand_lottery = 1 THEN 1 ELSE 0 END) AS base_sand_lottery_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 THEN 1 ELSE 0 END) AS base_floral_lottery_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 THEN 1 ELSE 0 END) AS base_dragon_lottery_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_sand_suit = 0 THEN 1 ELSE 0 END) AS base_sand_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_floral_suit = 0 THEN 1 ELSE 0 END) AS base_floral_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 AND has_dragon_suit = 0 THEN 1 ELSE 0 END) AS base_dragon_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_floral_lottery = 1 AND has_sand_suit = 1 AND has_floral_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_floral_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_dragon_lottery = 1 AND has_sand_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_dragon_lottery = 1 AND has_floral_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_floral_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 0 AND has_floral_lottery = 0 AND has_dragon_lottery = 0 THEN 1 ELSE 0 END) AS base_without_three_lottery_cnt\nFROM enriched;", "meta": {"origin": "sql_78", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_87_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.07.02和2023.07.09 参与乐园各子玩法的用户里，砺刃新进、回流、留存用户数\n注：新进，回流，留存都按照7天为一个周期来计算\n输出：统计日期（YYYYMMDD），玩法，类型（新进、回流、留存），人数\n【表】dws_jordass_login_df, dim_jordass_leyuan_participate_cdf_nf\n【口径】乐园玩法子用户筛选条件：\ninstr(substr(cbitmap,1,7),'1')>0\n回流与留存计算：\ncase when datediff(dtstatdate,dregdate)<=6 then '新进'\nwhen instr(substr(cbitmap,8,7),'1')>0 then '留存'\nwhen instr(substr(cbitmap,8,7),'1')=0 then '回流'\n注意只需要统计上述三种类型"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nSELECT\n  dtstatdate AS stat_date,\n  matchsubmodegroup AS play_mode,\n  CASE\n    WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n    WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n    ELSE '回流'\n  END AS user_type,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM dim_jordass_leyuan_participate_cdf_nf\nWHERE dtstatdate IN ('20230708', '20230715')\n  AND INSTR(SUBSTR(cbitmap, 1, 7), '1') > 0\n  AND CASE\n        WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n        WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n        ELSE '回流'\n      END IN ('新进', '留存', '回流')\nGROUP BY dtstatdate, matchsubmodegroup,\n         CASE\n           WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n           WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n           ELSE '回流'\n         END\nORDER BY stat_date, play_mode, user_type\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nSELECT\n  dtstatdate AS stat_date,\n  matchsubmodegroup AS play_mode,\n  CASE\n    WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n    WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n    ELSE '回流'\n  END AS user_type,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM dim_jordass_leyuan_participate_cdf_nf\nWHERE dtstatdate IN ('20230708', '20230715')\n  AND INSTR(SUBSTR(cbitmap, 1, 7), '1') > 0\n  AND CASE\n        WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n        WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n        ELSE '回流'\n      END IN ('新进', '留存', '回流')\nGROUP BY dtstatdate, matchsubmodegroup,\n         CASE\n           WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n           WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n           ELSE '回流'\n         END\nORDER BY stat_date, play_mode, user_type\n) AS final_query;", "meta": {"origin": "sql_87", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_67_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.1.24-2025.2.6时间区间内，道具为430487,430485,602004025,602002011 的产出次数\t\n输出：道具id，产出次数\n【表】dwd_jordass_gearlog_hi\n【口径】addorreduce=0表示产出，1表示消耗"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  cast(igoodsid as string) as goods_id,\n  sum(coalesce(count, 0)) as produce_cnt\nfrom dwd_jordass_gearlog_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20250125' and '20250207'\n  and igoodsid in (430487, 430485, 602004025, 602002011)\n  and addorreduce = 0\ngroup by igoodsid\norder by goods_id\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  cast(igoodsid as string) as goods_id,\n  sum(coalesce(count, 0)) as produce_cnt\nfrom dwd_jordass_gearlog_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20250125'\n  and igoodsid in (430487, 430485, 602004025, 602002011)\n  and addorreduce = 0\ngroup by igoodsid\norder by goods_id\n) AS final_query;", "meta": {"origin": "sql_67", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_49_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】2024年10月1-2024年10月7 用周期开始时间判断玩法上线时间在7天及以上，周期结束时间判断玩法上线时间在90天及以内的玩法，统计周期内这些玩法的参与和留存情况\n输出：周期(20241028-20241103)，日期(20241028、...、20241103)，参与人数，次留人数\n【表】dws_jordass_matchlog_stat_di, dim_jordass_submodeonline_nf\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with play_user as (\n    select distinct\n        p.dtstatdate as ds, --日期\n        p.vplayerid    --玩家id\n    from\n        dws_jordass_matchlog_stat_di p\n    join\n        dim_jordass_submodeonline_nf c\n    on\n        p.imode = c.matchsubmodegroup\n    where\n        p.dtstatdate between '20241028' and '20241104'\n        and datediff('20241028', c.onlinedate) >= 7\n        and datediff('20241103', c.onlinedate) <= 90\n)\nselect\n    '20241028-20241103' as period, --周期\n    a.ds,\n    count(distinct a.vplayerid) as play_user_num, --参与人数\n    count(distinct b.vplayerid) as retention_user_num --次留人数\nfrom\n    play_user a\nleft join\n    play_user b\non\n    a.vplayerid = b.vplayerid\n    and b.ds = date_add(a.ds, 1)  -- 次日留存条件\nwhere\n    a.ds between '20241028' and '20241103'\ngroup by\n    a.ds\norder by\n    a.ds;"}], "rejected": "with play_user as (\n    select distinct\n        p.dtstatdate as ds, --日期\n        p.vplayerid    --玩家id\n    from\n        dws_jordass_matchlog_stat_di p\n    join\n        dim_jordass_submodeonline_nf c\n    on\n        p.imode = c.matchsubmodegroup\n    where\n        p.dtstatdate > '20241028'\n        and datediff('20241028', c.onlinedate) >= 7\n        and datediff('20241103', c.onlinedate) <= 90\n)\nselect\n    '20241028-20241103' as period, --周期\n    a.ds,\n    count(distinct a.vplayerid) as play_user_num, --参与人数\n    count(distinct b.vplayerid) as retention_user_num --次留人数\nfrom\n    play_user a\nleft join\n    play_user b\non\n    a.vplayerid = b.vplayerid\n    and b.ds = date_add(a.ds, 1)  -- 次日留存条件\nwhere\n    a.ds between '20241028' and '20241103'\ngroup by\n    a.ds\norder by\n    a.ds;", "meta": {"origin": "sql_49", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_32_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023/1/14-2023/1/28\n2024/2/2-2024/2/16\n2025/1/21-2025/2/4\n每天所有玩法的参与人数，总时长\n输出：日期（20230128、20230129、...、20230224、20240229、...、20250303），参与人数，时长（分钟）\n【表】dws_jordass_mode_roundrecord_di\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  dtstatdate,\n  count(distinct vplayerid) as player_cnt,\n  round(sum(coalesce(roundtime, 0)) / 60.0, 2) as total_minutes\nfrom dws_jordass_mode_roundrecord_di\nwhere (\n        dtstatdate between '20230210' and '20230224'\n     or dtstatdate between '20240229' and '20240314'\n     or dtstatdate between '20250217' and '20250303'\n)\ngroup by dtstatdate\norder by dtstatdate;"}], "rejected": "select\n  dtstatdate,\n  count(distinct vplayerid) as player_cnt,\n  round(sum(coalesce(roundtime, 0)) / 60.0, 2) as total_minutes\nfrom dws_jordass_mode_roundrecord_di\nwhere (\n        dtstatdate > '20230210'\n     or dtstatdate between '20240229' and '20240314'\n     or dtstatdate between '20250217' and '20250303'\n)\ngroup by dtstatdate\norder by dtstatdate;", "meta": {"origin": "sql_32", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_38_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计不同玩法不同用户类型的参与情况\n\n输出：玩法、用户类型（砺刃新增、砺刃回流（流失60天以上）、砺刃回流（流失21-59天）、砺刃回流（流失14-20天）、砺刃回流（流失7-13天）、砺刃留存、平台盘内、平台盘外）、上线后3天参与用户数、上线后3天总用户数\n\n各玩法上线日期：\n\"广域战场\": \"20240816\",\n\"消灭战\": \"20230828\",\n\"幻想混战\": \"20241209\",\n\"荒野传说\": \"20240927\",\n\"策略载具\": \"20241103\",\n\"炎夏混战\": \"20240719\",\n\"单人装备\": \"20240610\",\n\"交叉堡垒\": \"20240506\"\n【表】dws_mgamejp_login_user_activity_di, dws_jordass_login_df, dim_jordass_playerid2suserid_nf, dws_jordass_mode_roundrecord_di\n【口径】从平台大盘表取数据固定逻辑：\n\n- 用户类型的定义：\n砺刃新增：上线后3天(包含上线当天)砺刃新增用户，并且参与了玩法的用户\n砺刃留存：上线前一周在砺刃活跃过，并且在上线后3天参与了玩法的用户\n砺刃回流：上线前一周没有在砺刃活跃过，但是之前在砺刃注册过，并且上线后3天参与了玩法的用户，然后按上线日期前N天连续未活跃时长区分：流失(7-13]天，流失[14-20]天，流失[21-59]天，流失60天及以上\n平台盘内：上线前一周在平台大盘活跃过，并且没有在砺刃活跃过，并且上线后3天参与了玩法的用户\n平台盘外：上线前一周没有在平台大盘内活跃过的，并且上线后3天参与了玩法的用户；\n\n广域战场 （2024/7/23）submodename= '广域战场模式'，\n消灭战（2023/8/4） modename='组队竞技' and submodename like '%消灭战模式%'，\n幻想混战（2024/12/09）modename='创意创作间' and submodename='幻想混战'，\n荒野传说（2024-09-27）modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')，\n策略载具（2024-11-03）modename='休闲模式' and submodename like '%策略载具%'，\n炎夏混战（2024-07-19）modename='创意创作间' and submodename like '%炎夏混战%'，\n单人装备（2024.5.17）modename='组队竞技' and submodename like '%单人装备%'，\n交叉堡垒（2024.4.12） modename='组队竞技' and submodename like '%交叉堡垒%'\n\n\n注意：suserid 和 vplayerid是两套用户账号体系；平台大盘代表所有游戏的数据，sgamecode='jordass'代表砺刃使者\n可选过滤：以上条件可按需勾选。\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with usertype as (\n    select '广域战场' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240816',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '消灭战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20230828',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '幻想混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241209',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '荒野传说' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240927',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '策略载具' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241103',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '炎夏混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240719',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '单人装备' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240610',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '交叉堡垒' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240506',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n),\ndapan as (\n    select '广域战场' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20240816',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20240816',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '消灭战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20230828',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20230828',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '幻想混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241209',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241209',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '荒野传说' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240927',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240927',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '策略载具' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241103',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241103',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '炎夏混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240719',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240719',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '单人装备' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240610',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240610',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '交叉堡垒' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240506',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240506',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n),\ndapan2jordass as (\n    select distinct itype, b.vplayerid, flag1\n    from dapan a\n    join (\n        select vplayerid,suserid from dim_jordass_playerid2suserid_nf\n    ) b on a.suserid = b.suserid\n),\nplayuser as (\n    select '广域战场' itype, min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240816' and dtstatdate <= date_add('20240816',2) and submodename= '广域战场模式'\n    group by vplayerid\n    union all\n    select '消灭战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20230828' and dtstatdate <= date_add('20230828',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by vplayerid\n    union all\n    select '幻想混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241209' and dtstatdate <= date_add('20241209',2) and modename='创意创作间' and submodename='幻想混战'\n    group by vplayerid\n    union all\n    select '荒野传说' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240927' and dtstatdate <= date_add('20240927',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by vplayerid\n    union all\n    select '策略载具' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241103' and dtstatdate <= date_add('20241103',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by vplayerid\n    union all\n    select '炎夏混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240719' and dtstatdate <= date_add('20240719',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by vplayerid\n    union all\n    select '单人装备' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240610' and dtstatdate <= date_add('20240610',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by vplayerid\n    union all\n    select '交叉堡垒' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240506' and dtstatdate <= date_add('20240506',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by vplayerid\n)\n\nselect \n    t.itype,\n    t.user_type,\n    t.iusernum1,\n    p.iusernum2\nfrom (\n    select \n        a.itype,\n        b.user_type,\n        count(distinct a.vplayerid) iusernum1\n    from playuser a\n    join (\n        select \n            itype, vplayerid,\n            case \n                when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n                when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n                when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n                when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n                when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n                when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n            end user_type\n        from usertype\n    ) b on a.itype = b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.user_type\n\n    union all\n    \n    select \n        a.itype, \n        case \n            when flag1=0 then '平台盘内' \n            when b.vplayerid is null then '平台盘外' \n        end user_type, \n    count(distinct a.vplayerid) iusernum1\n    from playuser a\n    left join dapan2jordass b \n    on a.itype = b.itype and a.vplayerid = b.vplayerid\n    where flag1=0 or b.vplayerid is null\n    group by a.itype, case when flag1=0 then '平台盘内' when b.vplayerid is null then '平台盘外' end\n) t\nleft join (\n    select itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end user_type,\n        count(distinct vplayerid) iusernum2\n    from usertype\n    group by itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end\n\n    union all\n\n    select itype,'平台盘内',count(distinct vplayerid) \n    from dapan2jordass \n    group by itype\n) p on t.itype=p.itype and t.user_type=p.user_type\n;"}], "rejected": "with usertype as (\n    select '广域战场' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240816',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '消灭战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20230828',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '幻想混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241209',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '荒野传说' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240927',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '策略载具' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20241103',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '炎夏混战' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240719',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '单人装备' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240610',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n    union all\n    select '交叉堡垒' itype, dtstatdate, dregdate, vplayerid, cbitmap \n    from dws_jordass_login_df\n    where dtstatdate = date_add('20240506',2) and platid =255 and instr(substr(cbitmap,1,3),'1')>0\n),\ndapan as (\n    select '广域战场' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20240816',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20240816',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '消灭战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate >= cast(date_format(date_sub('20230828',7), '%Y%m%d') as bigint) and dtstatdate <= cast(date_format(date_sub('20230828',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '幻想混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241209',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241209',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '荒野传说' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240927',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240927',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '策略载具' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20241103',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20241103',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '炎夏混战' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240719',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240719',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '单人装备' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240610',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240610',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n    union all\n    select '交叉堡垒' itype, suserid, max(case when sgamecode='jordass' then 1 else 0 end) flag1\n    from dws_mgamejp_login_user_activity_di\n    where dtstatdate between cast(date_format(date_sub('20240506',7), '%Y%m%d') as bigint) and cast(date_format(date_sub('20240506',1), '%Y%m%d') as bigint)\n        and saccounttype ='-100'\n        and sgamecode <>'-100'\n        and splattype = '-100'\n        and splat = '-100'\n    group by suserid\n),\ndapan2jordass as (\n    select distinct itype, b.vplayerid, flag1\n    from dapan a\n    join (\n        select vplayerid,suserid from dim_jordass_playerid2suserid_nf\n    ) b on a.suserid = b.suserid\n),\nplayuser as (\n    select '广域战场' itype, min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240816' and dtstatdate <= date_add('20240816',2) and submodename= '广域战场模式'\n    group by vplayerid\n    union all\n    select '消灭战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20230828' and dtstatdate <= date_add('20230828',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by vplayerid\n    union all\n    select '幻想混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241209' and dtstatdate <= date_add('20241209',2) and modename='创意创作间' and submodename='幻想混战'\n    group by vplayerid\n    union all\n    select '荒野传说' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240927' and dtstatdate <= date_add('20240927',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by vplayerid\n    union all\n    select '策略载具' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20241103' and dtstatdate <= date_add('20241103',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by vplayerid\n    union all\n    select '炎夏混战' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240719' and dtstatdate <= date_add('20240719',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by vplayerid\n    union all\n    select '单人装备' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240610' and dtstatdate <= date_add('20240610',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by vplayerid\n    union all\n    select '交叉堡垒' itype,min(dtstatdate) dtstatdate, vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= '20240506' and dtstatdate <= date_add('20240506',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by vplayerid\n)\n\nselect \n    t.itype,\n    t.user_type,\n    t.iusernum1,\n    p.iusernum2\nfrom (\n    select \n        a.itype,\n        b.user_type,\n        count(distinct a.vplayerid) iusernum1\n    from playuser a\n    join (\n        select \n            itype, vplayerid,\n            case \n                when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n                when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n                when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n                when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n                when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n                when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n            end user_type\n        from usertype\n    ) b on a.itype = b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.user_type\n\n    union all\n    \n    select \n        a.itype, \n        case \n            when flag1=0 then '平台盘内' \n            when b.vplayerid is null then '平台盘外' \n        end user_type, \n    count(distinct a.vplayerid) iusernum1\n    from playuser a\n    left join dapan2jordass b \n    on a.itype = b.itype and a.vplayerid = b.vplayerid\n    where flag1=0 or b.vplayerid is null\n    group by a.itype, case when flag1=0 then '平台盘内' when b.vplayerid is null then '平台盘外' end\n) t\nleft join (\n    select itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end user_type,\n        count(distinct vplayerid) iusernum2\n    from usertype\n    group by itype,\n        case \n            when datediff(dtstatdate,dregdate)<=2 then '砺刃新增'\n            when instr(substr(cbitmap,4),'1')=0 or instr(substr(cbitmap,4),'1')>=60 then '砺刃回流（流失60天以上）'\n            when instr(substr(cbitmap,4),'1')>=21 then '砺刃回流（流失21-59天）'\n            when instr(substr(cbitmap,4),'1')>=14 then '砺刃回流（流失14-20天）'\n            when instr(substr(cbitmap,4),'1')>7 then '砺刃回流（流失7-13天）'\n            when instr(substr(cbitmap,4),'1')<=7 then '砺刃留存' \n        end\n\n    union all\n\n    select itype,'平台盘内',count(distinct vplayerid) \n    from dapan2jordass \n    group by itype\n) p on t.itype=p.itype and t.user_type=p.user_type\n;", "meta": {"origin": "sql_38", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_33_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024年12月14日-2024年12月20日参与建筑争夺玩法的玩家人数（去重）有多少，其中多少人是12月13日及以前有参与过建筑争夺的老玩家，有多少是新玩家\n输出: 玩家人数、老玩家人数、新玩家人数\n【表】dws_jordass_playermatchrecord_stat_df, dws_jordass_matchlog_stat_di\n【口径】建筑争夺玩法对应的imode为1344338933661592832"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n    count(distinct a.vplayerid) as total_players,\n    count(distinct case when b.vplayerid is not null then a.vplayerid end) as existing_players,\n    count(distinct case when b.vplayerid is null then a.vplayerid end) as new_players\nfrom (\n    select vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20241215' and '20241221'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) a\nleft join (\n    select vplayerid\n    from dws_jordass_playermatchrecord_stat_df\n    where dtstatdate = '20241214'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) b\non a.vplayerid = b.vplayerid\n\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n    count(distinct a.vplayerid) as total_players,\n    count(distinct case when b.vplayerid is not null then a.vplayerid end) as existing_players,\n    count(distinct case when b.vplayerid is null then a.vplayerid end) as new_players\nfrom (\n    select vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate > '20241215'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) a\nleft join (\n    select vplayerid\n    from dws_jordass_playermatchrecord_stat_df\n    where dtstatdate = '20241214'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) b\non a.vplayerid = b.vplayerid\n\n) AS final_query;", "meta": {"origin": "sql_33", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_31_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250217-20250318协作平台活跃但是没有在协作玩法活跃用户的主玩玩法分布\n输出：主玩玩法（传统模式、休闲模式、...、生存模式）、人数\n【表】dws_jordass_matchlog_stat_di, dwd_jordass_buttonpress_pre_di, dws_jordass_mode_roundrecord_di\n【口径】主玩定义：用户累计对局时长最多的玩法；\n玩法取 modename in ('传统模式','休闲模式','组队竞技','领地','乐园','广阔天地','创意创作间','生存模式')\n协作平台活跃：ugcmbuttonclick中的玩家；\n协作玩法活跃：vtemp1='协作'  的玩法记录"}, {"role": "assistant", "content": "WITH coop_platform AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_buttonpress_pre_di\n  WHERE dtstatdate BETWEEN '20250217' AND '20250318'\n    AND buttontype = 'ugcmbuttonclick'\n),\ncoop_game AS (\n  SELECT DISTINCT m.vplayerid\n  FROM dws_jordass_mode_roundrecord_di m\n  LEFT JOIN dim_jordass_submodeonlinedate_conf c\n    ON m.submode = c.matchsubmodegroup\n  WHERE m.dtstatdate BETWEEN '20250217' AND '20250318'\n    AND COALESCE(c.vtemp1, '') = '协作'\n),\ntarget_player AS (\n  SELECT vplayerid\n  FROM coop_platform\n  WHERE vplayerid NOT IN (SELECT vplayerid FROM coop_game)\n),\nmode_time AS (\n  SELECT\n    m.vplayerid,\n    CASE\n      WHEN modename = '传统模式' THEN '传统模式'\n      WHEN modename = '休闲模式' THEN '休闲模式'\n      WHEN modename = '组队竞技' THEN '组队竞技'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '生存模式'\n      ELSE '其他'\n    END AS main_mode_group,\n    SUM(roundtime) AS total_round_time\n  FROM dws_jordass_mode_roundrecord_di m\n  JOIN target_player t ON m.vplayerid = t.vplayerid\n  WHERE m.dtstatdate BETWEEN '20250217' AND '20250318'\n  GROUP BY m.vplayerid, main_mode_group\n),\nranked_mode AS (\n  SELECT\n    vplayerid,\n    main_mode_group,\n    total_round_time,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY total_round_time DESC) AS rn\n  FROM mode_time\n)\nSELECT\n  main_mode_group AS main_mode,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM ranked_mode\nWHERE rn = 1\nGROUP BY main_mode_group\nORDER BY user_cnt DESC;"}], "rejected": "WITH coop_platform AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_buttonpress_pre_di\n  WHERE dtstatdate > '20250217'\n    AND buttontype = 'ugcmbuttonclick'\n),\ncoop_game AS (\n  SELECT DISTINCT m.vplayerid\n  FROM dws_jordass_mode_roundrecord_di m\n  LEFT JOIN dim_jordass_submodeonlinedate_conf c\n    ON m.submode = c.matchsubmodegroup\n  WHERE m.dtstatdate BETWEEN '20250217' AND '20250318'\n    AND COALESCE(c.vtemp1, '') = '协作'\n),\ntarget_player AS (\n  SELECT vplayerid\n  FROM coop_platform\n  WHERE vplayerid NOT IN (SELECT vplayerid FROM coop_game)\n),\nmode_time AS (\n  SELECT\n    m.vplayerid,\n    CASE\n      WHEN modename = '传统模式' THEN '传统模式'\n      WHEN modename = '休闲模式' THEN '休闲模式'\n      WHEN modename = '组队竞技' THEN '组队竞技'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '生存模式'\n      ELSE '其他'\n    END AS main_mode_group,\n    SUM(roundtime) AS total_round_time\n  FROM dws_jordass_mode_roundrecord_di m\n  JOIN target_player t ON m.vplayerid = t.vplayerid\n  WHERE m.dtstatdate BETWEEN '20250217' AND '20250318'\n  GROUP BY m.vplayerid, main_mode_group\n),\nranked_mode AS (\n  SELECT\n    vplayerid,\n    main_mode_group,\n    total_round_time,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY total_round_time DESC) AS rn\n  FROM mode_time\n)\nSELECT\n  main_mode_group AS main_mode,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM ranked_mode\nWHERE rn = 1\nGROUP BY main_mode_group\nORDER BY user_cnt DESC;", "meta": {"origin": "sql_31", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_22_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：近30天用户在渠道登录的天数为5到8天，取最多天数的用户，并将用户ID转为qq\n输出：QQ\n统计日期：20250428-20250527\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df\n【口径】渠道筛选条件：iloginway = 3\n用户ID筛选swxid_type = \"qq\" -- 筛选swxid_type为\"qq\"\ndim_argothek_gplayerid2qqwxid_df限定20250428\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with login_stat as (\n  select\n    iuserid,\n    count(distinct statis_date) as login_days\n  from dws_argothek_oss_login_di\n  where statis_date between 20250428 and 20250527\n    and iloginway = 3\n  group by iuserid\n  having login_days between 5 and 8\n),\nmax_days as (\n  select max(login_days) as max_login_days from login_stat\n),\nqq_map as (\n  select\n    iuserid,\n    suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250527'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom login_stat l\njoin max_days m on l.login_days = m.max_login_days\njoin qq_map q on l.iuserid = q.iuserid\norder by qq;"}], "rejected": "with login_stat as (\n  select\n    iuserid,\n    count(distinct statis_date) as login_days\n  from dws_argothek_oss_login_di\n  where statis_date between 20250428 and 20250527\n    and iloginway = 3\n  group by iuserid\n  having login_days between 5 and 8\n),\nmax_days as (\n  select max(login_days) as max_login_days from login_stat\n),\nqq_map as (\n  select\n    iuserid,\n    suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250527'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom login_stat l\njoin max_days m on l.login_days = m.max_login_days\njoin qq_map q on l.iuserid = q.iuserid\norder by qq;", "meta": {"origin": "sql_22", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_32_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023/1/14-2023/1/28\n2024/2/2-2024/2/16\n2025/1/21-2025/2/4\n每天所有玩法的参与人数，总时长\n输出：日期（20230102、20230103、...、20230129、20240203、...、20250205），参与人数，时长（分钟）\n【表】dws_jordass_mode_roundrecord_di\n【口径】"}, {"role": "assistant", "content": "select\n  dtstatdate,\n  count(distinct vplayerid) as player_cnt,\n  round(sum(coalesce(roundtime, 0)) / 60.0, 2) as total_minutes\nfrom dws_jordass_mode_roundrecord_di\nwhere (\n        dtstatdate between '20230115' and '20230129'\n     or dtstatdate between '20240203' and '20240217'\n     or dtstatdate between '20250122' and '20250205'\n)\ngroup by dtstatdate\norder by dtstatdate;"}], "rejected": "select\n  dtstatdate,\n  count(distinct vplayerid) as player_cnt,\n  round(sum(coalesce(roundtime, 0)) / 60.0, 2) as total_minutes\nfrom dws_jordass_mode_roundrecord_di\nwhere (\n        dtstatdate > '20230115'\n     or dtstatdate between '20240203' and '20240217'\n     or dtstatdate between '20250122' and '20250205'\n)\ngroup by dtstatdate\norder by dtstatdate;", "meta": {"origin": "sql_32", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_56_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】时间：2024.01.01-2024.01.31\n每日新增用户的LTV，LTV1~LTV10\n输出：注册日期(20240101、20240102、...、20240131)、新进用户数、LTV1、LTV3、LTV7、LTV14、LTV30、LTV60、LTV90、LTV180\n【表】dws_jordass_water_di, dws_jordass_login_df\n【口径】LTV（Life Time Value，用户生命周期价值）\n从注册日起，到第 N-1 天为止，这批新用户累计产生的总流水 ÷ 这批新用户的总人数。\n单位：元/人，衡量“每个新注册用户在 N 天内平均贡献了多少收入”。"}, {"role": "assistant", "content": "select\n    register_date,\n    count(distinct vplayerid) as new_user_cnt,\n    round(sum(case when datediff_pay < 1 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv1,\n    round(sum(case when datediff_pay < 3 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv3,\n    round(sum(case when datediff_pay < 7 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv7,\n    round(sum(case when datediff_pay < 14 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv14,\n    round(sum(case when datediff_pay < 30 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv30,\n    round(sum(case when datediff_pay < 60 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv60,\n    round(sum(case when datediff_pay < 90 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv90,\n    round(sum(case when datediff_pay < 180 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv180\nfrom (\n    select\n        s1.register_date,\n        s1.vplayerid,\n        s2.pay_date,\n        datediff(s2.pay_date, s1.register_date) as datediff_pay,\n        sum(s2.pay_amount) as sum_pay_amount\n    from (\n        select\n            distinct dregdate as register_date,\n            vplayerid\n        from dws_jordass_login_df\n        where dtstatdate = '20240131'\n          and platid = 255\n          and dregdate >= '20240101' and dregdate <= '20240131'\n    ) s1\n    left join (\n        select\n            dtstatdate as pay_date,\n            vplayerid,\n            sum(imoney/100) as pay_amount\n        from dws_jordass_water_di\n        where dtstatdate >= '20240101' and dtstatdate <= date_add('20240131', 179)\n          and platid = 255\n        group by dtstatdate, vplayerid\n    ) s2 on s1.vplayerid = s2.vplayerid\n    group by s1.register_date, s1.vplayerid, s2.pay_date\n) base\ngroup by register_date;"}], "rejected": "select\n    register_date,\n    count(distinct vplayerid) as new_user_cnt,\n    round(sum(case when datediff_pay < 1 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv1,\n    round(sum(case when datediff_pay < 3 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv3,\n    round(sum(case when datediff_pay < 7 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv7,\n    round(sum(case when datediff_pay < 14 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv14,\n    round(sum(case when datediff_pay < 30 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv30,\n    round(sum(case when datediff_pay < 60 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv60,\n    round(sum(case when datediff_pay < 90 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv90,\n    round(sum(case when datediff_pay < 180 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv180\nfrom (\n    select\n        s1.register_date,\n        s1.vplayerid,\n        s2.pay_date,\n        datediff(s2.pay_date, s1.register_date) as datediff_pay,\n        sum(s2.pay_amount) as sum_pay_amount\n    from (\n        select\n            distinct dregdate as register_date,\n            vplayerid\n        from dws_jordass_login_df\n        where dtstatdate = '20240131'\n          and platid = 255\n          and dregdate >= '20240101' and dregdate <= '20240131'\n    ) s1\n    left join (\n        select\n            dtstatdate as pay_date,\n            vplayerid,\n            sum(imoney/100) as pay_amount\n        from dws_jordass_water_di\n        where dtstatdate >= '20240101' and dtstatdate <= date_add('20240131', 179)\n          and platid = 255\n        group by dtstatdate, vplayerid\n    ) s2 on s1.vplayerid = s2.vplayerid\n    group by s1.register_date, s1.vplayerid, s2.pay_date\n) base\ngroup by register_date;", "meta": {"origin": "sql_56", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_45_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.01.01-2024.01.07参与乐园子玩法拼图狂欢在202401.08-2024.01.14没玩乐园子玩法拼图狂欢在2024.01.15-2024.01.21又玩了乐园子玩法拼图狂欢的用户\n输出：玩家数\n【表】dws_jordass_matchlog_stat_di\n【口径】imode为1287652322611036928代表乐园子玩法拼图狂欢"}, {"role": "assistant", "content": "select count(distinct a.vplayerid) as player_num\nfrom (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240101' and '20240107'\n    and imode = 1287652322611036928\n) a\nleft join (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240108' and '20240114'\n    and imode = 1287652322611036928\n) b on a.vplayerid = b.vplayerid\njoin (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240115' and '20240121'\n    and imode = 1287652322611036928\n) c on a.vplayerid = c.vplayerid\nwhere b.vplayerid is null;"}], "rejected": "select count(distinct a.vplayerid) as player_num\nfrom (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate > '20240101'\n    and imode = 1287652322611036928\n) a\nleft join (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240108' and '20240114'\n    and imode = 1287652322611036928\n) b on a.vplayerid = b.vplayerid\njoin (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240115' and '20240121'\n    and imode = 1287652322611036928\n) c on a.vplayerid = c.vplayerid\nwhere b.vplayerid is null;", "meta": {"origin": "sql_45", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_4_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计开服至今使用频率最高的用户昵称。\n时间范围：2023.07.15 00:00:00 - 2025.07.18 23:59:59\n输出：昵称（唯一）、人数\n【表】dwd_argothek_playerlogin_hi\n【口径】昵称筛选逻辑：\nnickname 按照 # 进行划分，取 # 前半部分作为昵称\n示例：多喝热水#131234 -> 昵称：多喝热水\n若存在并列最高频率，按昵称字典序最小的记录返回"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH base AS (\n  SELECT\n    CASE\n      WHEN LOCATE('#', vrolename) > 0 THEN SUBSTR(vrolename, 1, LOCATE('#', vrolename) - 1)\n      ELSE vrolename\n    END AS nickname,\n    iuserid\n  FROM dwd_argothek_playerlogin_hi\n  WHERE dteventtime >= '2023-07-15 00:00:00'\n    AND dteventtime <= '2025-07-18 23:59:59'\n    AND IFNULL(vrolename, '') <> ''\n),\nagg AS (\n  SELECT\n    nickname,\n    COUNT(DISTINCT iuserid) AS user_cnt\n  FROM base\n  GROUP BY nickname\n)\nSELECT\n  nickname,\n  user_cnt AS user_num\nFROM agg\nORDER BY user_cnt DESC, nickname\nLIMIT 1\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH base AS (\n  SELECT\n    CASE\n      WHEN LOCATE('#', vrolename) > 0 THEN SUBSTR(vrolename, 1, LOCATE('#', vrolename) - 1)\n      ELSE vrolename\n    END AS nickname,\n    iuserid\n  FROM dwd_argothek_playerlogin_hi\n  WHERE dteventtime >= '2023-07-15 00:00:00'\n    AND dteventtime <= '2025-07-18 23:59:59'\n    AND IFNULL(vrolename, '') <> ''\n),\nagg AS (\n  SELECT\n    nickname,\n    COUNT(DISTINCT iuserid) AS user_cnt\n  FROM base\n  GROUP BY nickname\n)\nSELECT\n  nickname,\n  user_cnt AS user_num\nFROM agg\nORDER BY user_cnt DESC, nickname\nLIMIT 1\n) AS final_query;", "meta": {"origin": "sql_4", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_44_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.01.01-2024.12.31期间，付费用户的付费区间对应的付费人数和付费金额\n输出：付费区间(小R、中R、大R、超R、未知)、付费人数、付费金额（元）\n\n付费区间：小R小于等于12，中R(12,60]，大R(60,180]，超R(180+)\n【表】dws_jordass_water_di\n【口径】"}, {"role": "assistant", "content": "with user_pay as (\n  select\n    vplayerid,\n    sum(imoney) / 100.0 as pay_amount\n  from dws_jordass_water_di\n  where dtstatdate between '20240101' and '20241231'\n  group by vplayerid\n),\nfiltered as (\n  select *\n  from user_pay\n  where pay_amount > 0\n)\nselect\n  case\n    when pay_amount <= 12 then '小R'\n    when pay_amount <= 60 then '中R'\n    when pay_amount <= 180 then '大R'\n    when pay_amount > 180 then '超R'\n    else '未知'\n  end as pay_segment,\n  count(*) as user_cnt,\n  round(sum(pay_amount), 2) as pay_amount\nfrom filtered\ngroup by pay_segment\norder by pay_segment;"}], "rejected": "with user_pay as (\n  select\n    vplayerid,\n    sum(imoney) / 100.0 as pay_amount\n  from dws_jordass_water_di\n  where dtstatdate > '20240101'\n  group by vplayerid\n),\nfiltered as (\n  select *\n  from user_pay\n  where pay_amount > 0\n)\nselect\n  case\n    when pay_amount <= 12 then '小R'\n    when pay_amount <= 60 then '中R'\n    when pay_amount <= 180 then '大R'\n    when pay_amount > 180 then '超R'\n    else '未知'\n  end as pay_segment,\n  count(*) as user_cnt,\n  round(sum(pay_amount), 2) as pay_amount\nfrom filtered\ngroup by pay_segment\norder by pay_segment;", "meta": {"origin": "sql_44", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_42_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2021.11.1-2021.11.30每天按extarg2中用\"_\"分割的第2位的值包含(8,16,17)看点击情况\n输出：日期，按extarg2中用\"_\"分割的第2位，人数，次数\n【表】dws_jordass_buttonpress_pre_di\n【口径】"}, {"role": "assistant", "content": "select\n  dtstatdate,\n  split_part(extarg2, '_', 2) as second_value,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as click_cnt\nfrom dws_jordass_buttonpress_pre_di\nwhere dtstatdate between '20211101' and '20211130'\n  and split_part(extarg2, '_', 2) in ('8', '16', '17')\ngroup by dtstatdate, split_part(extarg2, '_', 2)\norder by dtstatdate, second_value;"}], "rejected": "select\n  dtstatdate,\n  split_part(extarg2, '_', 2) as second_value,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as click_cnt\nfrom dws_jordass_buttonpress_pre_di\nwhere dtstatdate > '20211101'\n  and split_part(extarg2, '_', 2) in ('8', '16', '17')\ngroup by dtstatdate, split_part(extarg2, '_', 2)\norder by dtstatdate, second_value;", "meta": {"origin": "sql_42", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_30_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2019.5.8至2025.3.30 分月的玩法主玩情况\n输出：月份(201905、201906、...、202503)、主玩玩法、主玩人数、总参与人数\n【表】dwd_jordass_playerexitgamerecord_hi, dws_jordass_mode_roundrecord_di\n【口径】主玩定义：用户累计对局时长最多的玩法；\n\n玩法：从dws_jordass_mode_roundrecord_di取\n从上往下匹配，如果满足以下任一条件，则返回对应的名称，否则返回“其他模式”。\n如果模式为“传统模式”，且子模式名称以“CG”开头，且地图为“群屿”，则返回“主题群屿”；\n如果模式为“传统模式”且地图为“群屿”，则返回“传统群屿”；\n如果模式为“传统模式”且地图为“假日群岛”，则返回“假日群岛”；\n如果模式为“传统模式”且地图为“荣耀之城”，则返回“荣耀之城”；\n如果子模式是“广域战场模式”，则返回“广域战场”；\n如果子模式是“极能形态模式”，则返回“极能形态”；\n如果模式是“组队竞技”，则返回“组竞”；\n如果模式是“休闲模式”，则返回“休闲”；\n如果模式是“乐园”，则返回“乐园”；\n如果模式是“领地”，则返回“领地”；\n如果模式是“广阔天地”，则返回“广阔天地”\n\n注意，参与隧道模式的用户数据从dwd_jordass_playerexitgamerecord_hi取，时间限制 2024.6.18-2025.3.30，mode in (3001, 3002, 3003)\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with main_user as (\n    select substr(dtstatdate, 1, 6) mons,\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end imodename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        sum(roundcnt) roundcnt\n   from dws_jordass_mode_roundrecord_di\n   where dtstatdate between '20190528' and '20250419'\n   group by vplayerid, substr(dtstatdate, 1, 6),\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end\n\n   union all\n   \n   select substr (tdbank_imp_date, 1, 6) mons,\n        '隧道' as modename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        count(distinct gameid) roundcnt\n   from dwd_jordass_playerexitgamerecord_hi\n   where tdbank_imp_date between '2024061800' and '2025033023'\n     and mode in (3001, 3002, 3003)\n   group by substr (tdbank_imp_date, 1, 6), vplayerid\n)\n\nselect a.mons,\n       a.imodename,\n       a.iusernum,\n       b.iusernumall\nfrom (\n    select mons,\n          imodename,\n          count(vplayerid) iusernum\n    from (\n        select mons, vplayerid, imodename\n        from (\n            select mons,\n                vplayerid,\n                imodename,\n                roundtime,\n                row_number() over (partition by mons, vplayerid order by roundtime desc) as rn\n            from main_user\n        )ff1\n        where rn = 1\n    )f1\n   group by mons, imodename\n) a\nleft join (\n    select mons,\n        imodename,\n        count(vplayerid) iusernumall\n   from main_user\n   group by mons, imodename\n) b \non a.imodename = b.imodename and a.mons = b.mons\norder by a.mons, a.imodename\n;"}], "rejected": "with main_user as (\n    select substr(dtstatdate, 1, 6) mons,\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end imodename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        sum(roundcnt) roundcnt\n   from dws_jordass_mode_roundrecord_di\n   where dtstatdate > '20190528'\n   group by vplayerid, substr(dtstatdate, 1, 6),\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end\n\n   union all\n   \n   select substr (tdbank_imp_date, 1, 6) mons,\n        '隧道' as modename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        count(distinct gameid) roundcnt\n   from dwd_jordass_playerexitgamerecord_hi\n   where tdbank_imp_date between '2024061800' and '2025033023'\n     and mode in (3001, 3002, 3003)\n   group by substr (tdbank_imp_date, 1, 6), vplayerid\n)\n\nselect a.mons,\n       a.imodename,\n       a.iusernum,\n       b.iusernumall\nfrom (\n    select mons,\n          imodename,\n          count(vplayerid) iusernum\n    from (\n        select mons, vplayerid, imodename\n        from (\n            select mons,\n                vplayerid,\n                imodename,\n                roundtime,\n                row_number() over (partition by mons, vplayerid order by roundtime desc) as rn\n            from main_user\n        )ff1\n        where rn = 1\n    )f1\n   group by mons, imodename\n) a\nleft join (\n    select mons,\n        imodename,\n        count(vplayerid) iusernumall\n   from main_user\n   group by mons, imodename\n) b \non a.imodename = b.imodename and a.mons = b.mons\norder by a.mons, a.imodename\n;", "meta": {"origin": "sql_30", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_103_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.9.1到9.10每天productid的参与直购购买人数，直购购买金额以及数量，当天注册人数\n输出：统计日期(yyyymmdd),productid,直购购买人数,直购购买金额,直购购买数量\n【表】dws_jordass_login_df, dwd_jordass_directpaycommflow_hi\n【口径】productid的参与直购：op='take' and opres='ok'\n\tand productid in ('package_6','package_18','outfit_pack','weapon_pack')\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH purchase AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    productid,\n    vplayerid,\n    goodsnum,\n    money\n  FROM dwd_jordass_directpaycommflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-09-28' AND '2025-10-07'\n    AND op = 'take'\n    AND opres = 'ok'\n    AND productid IN ('package_6','package_18','outfit_pack','weapon_pack')\n)\nSELECT\n  DATE_FORMAT(stat_date, '%Y%m%d') AS stat_date,\n  productid,\n  COUNT(DISTINCT vplayerid) AS purchase_user_cnt,\n  ROUND(SUM(money) / 100.0, 2) AS purchase_amount,\n  SUM(goodsnum) AS purchase_qty\nFROM purchase\nGROUP BY stat_date, productid\nORDER BY stat_date, productid;"}], "rejected": "WITH purchase AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    productid,\n    vplayerid,\n    goodsnum,\n    money\n  FROM dwd_jordass_directpaycommflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-09-28' AND '2025-10-07'\n    AND op = 'take'\n    AND opres = 'ok'\n    AND productid IN ('package_6','package_18','outfit_pack','weapon_pack')\n)\nSELECT\n  DATE_FORMAT(stat_date, '%Y%m%d') AS stat_date,\n  productid,\n  COUNT(DISTINCT vplayerid) AS purchase_user_cnt,\n  ROUND(SUM(money) / 100.0, 2) AS purchase_amount,\n  SUM(goodsnum) AS purchase_qty\nFROM purchase\nGROUP BY stat_date, productid\nORDER BY stat_date, productid;", "meta": {"origin": "sql_103", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_13_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20230712以来，历史累计活跃30天以上，但3月12日及以后未活跃过的用户且剔除掉历史充值 1500 元以上的用户后的玩家wxid\n输出：玩家wxid\n时间统计范围:20230728-20250628\n【表】dim_mgamejp_tbplayerid2wxid_nf, dws_argothek_oss_portaltransaction_di, dim_mgamejp_idconversion_wxid_qq_nf, dws_argothek_oss_login_di, dim_mgamejp_tbplayerid2qq_nf\n【口径】历史充值1500以上的用户：\nsum(ftranamt)/100 > 1500\n限制sappid in (\"qq\",\"wx\")\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH login_window AS (\n  SELECT\n    iuserid,\n    COUNT(DISTINCT statis_date) AS active_days,\n    MAX(statis_date) AS last_active_date\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20230728 AND 20250628\n  GROUP BY iuserid\n), qualified_login AS (\n  SELECT iuserid\n  FROM login_window\n  WHERE active_days >= 30\n    AND last_active_date < 20250328\n), pay_window AS (\n  SELECT\n    iuserid,\n    SUM(ftranamt) / 100.0 AS total_pay\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date BETWEEN '20230728' AND '20250628'\n  GROUP BY iuserid\n), filtered_user AS (\n  SELECT\n    q.iuserid,\n    COALESCE(p.total_pay, 0) AS total_pay\n  FROM qualified_login q\n  LEFT JOIN pay_window p\n    ON q.iuserid = p.iuserid\n  WHERE COALESCE(p.total_pay, 0) <= 1500\n), wxid_map AS (\n  SELECT\n    splayerid AS iuserid,\n    swxid\n  FROM dim_mgamejp_tbplayerid2wxid_nf\n  WHERE dtstatdate = 20250628\n    AND sappid IN ('qq', 'wx')\n    AND swxid IS NOT NULL\n)\nSELECT DISTINCT\n  m.swxid AS player_wxid\nFROM filtered_user f\nJOIN wxid_map m\n  ON f.iuserid = m.iuserid\nWHERE m.swxid <> ''\nORDER BY player_wxid;"}], "rejected": "WITH login_window AS (\n  SELECT\n    iuserid,\n    COUNT(DISTINCT statis_date) AS active_days,\n    MAX(statis_date) AS last_active_date\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20230728 AND 20250628\n  GROUP BY iuserid\n), qualified_login AS (\n  SELECT iuserid\n  FROM login_window\n  WHERE active_days >= 30\n    AND last_active_date < 20250328\n), pay_window AS (\n  SELECT\n    iuserid,\n    SUM(ftranamt) / 100.0 AS total_pay\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date > '20230728'\n  GROUP BY iuserid\n), filtered_user AS (\n  SELECT\n    q.iuserid,\n    COALESCE(p.total_pay, 0) AS total_pay\n  FROM qualified_login q\n  LEFT JOIN pay_window p\n    ON q.iuserid = p.iuserid\n  WHERE COALESCE(p.total_pay, 0) <= 1500\n), wxid_map AS (\n  SELECT\n    splayerid AS iuserid,\n    swxid\n  FROM dim_mgamejp_tbplayerid2wxid_nf\n  WHERE dtstatdate = 20250628\n    AND sappid IN ('qq', 'wx')\n    AND swxid IS NOT NULL\n)\nSELECT DISTINCT\n  m.swxid AS player_wxid\nFROM filtered_user f\nJOIN wxid_map m\n  ON f.iuserid = m.iuserid\nWHERE m.swxid <> ''\nORDER BY player_wxid;", "meta": {"origin": "sql_13", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_101_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计日(2024.9.2,2024.9.3,2025.9.8,2025.9.9) 全平台活跃用户的本赛季最高段位等信息\n输出：统计日，本赛季最高段位，活跃用户数，统计日参与主题群屿玩法用户数，参与率\n【表】dws_jordass_mode_roundrecord_di, dws_jordass_login_di, dwd_jordass_playerlogin_hi\n【口径】主题群屿玩法：modename='传统模式' and submodename like 'CG%'\n段位分布：case when substr(seasonmaxsegment, 1, 1) = '1' then '青铜'\n                          when substr(seasonmaxsegment, 1, 1) = '2' then '白银'\n                          when substr(seasonmaxsegment, 1, 1) = '3' then '黄金'\n                          when substr(seasonmaxsegment, 1, 1) = '4' then '铂金'\n                          when substr(seasonmaxsegment, 1, 1) = '5' then '星钻'\n                          when substr(seasonmaxsegment, 1, 1) = '6' then '王冠'\n                          when substr(seasonmaxsegment, 1, 1) >= '7' then '王牌'\n                          else '无段位'\n\t            end\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH target_dates AS (\n  SELECT '20240928' AS stat_date UNION ALL\n  SELECT '20240929' UNION ALL\n  SELECT '20251004' UNION ALL\n  SELECT '20251005'\n), active_users AS (\n  SELECT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n  GROUP BY dtstatdate, vplayerid\n), segment_latest AS (\n  SELECT\n    vplayerid,\n    seasonmaxsegment,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n  FROM dwd_jordass_playerlogin_hi\n  WHERE seasonmaxsegment IS NOT NULL AND seasonmaxsegment <> ''\n), segment_map AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '1' THEN '青铜'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '2' THEN '白银'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '3' THEN '黄金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '4' THEN '铂金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '5' THEN '星钻'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '6' THEN '王冠'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) >= '7' THEN '王牌'\n      ELSE '无段位'\n    END AS season_segment\n  FROM segment_latest\n  WHERE rn = 1\n), active_segment AS (\n  SELECT\n    a.stat_date,\n    a.vplayerid,\n    COALESCE(s.season_segment, '无段位') AS season_segment\n  FROM active_users a\n  LEFT JOIN segment_map s\n    ON a.vplayerid = s.vplayerid\n), qunyu_users AS (\n  SELECT DISTINCT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n    AND modename = '传统模式'\n    AND submodename LIKE 'CG%'\n), summary AS (\n  SELECT\n    a.stat_date,\n    a.season_segment,\n    COUNT(DISTINCT a.vplayerid) AS active_user_cnt,\n    COUNT(DISTINCT CASE WHEN q.vplayerid IS NOT NULL THEN a.vplayerid END) AS qunyu_user_cnt\n  FROM active_segment a\n  LEFT JOIN qunyu_users q\n    ON a.stat_date = q.stat_date\n   AND a.vplayerid = q.vplayerid\n  GROUP BY a.stat_date, a.season_segment\n)\nSELECT\n  stat_date,\n  season_segment,\n  active_user_cnt,\n  qunyu_user_cnt,\n  CASE WHEN active_user_cnt = 0 THEN 0 ELSE qunyu_user_cnt / active_user_cnt END AS participate_rate\nFROM summary\nORDER BY stat_date, season_segment;"}], "rejected": "WITH target_dates AS (\n  SELECT '20240928' AS stat_date UNION ALL\n  SELECT '20240929' UNION ALL\n  SELECT '20251004' UNION ALL\n  SELECT '20251005'\n), active_users AS (\n  SELECT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n  GROUP BY dtstatdate, vplayerid\n), segment_latest AS (\n  SELECT\n    vplayerid,\n    seasonmaxsegment,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n  FROM dwd_jordass_playerlogin_hi\n  WHERE seasonmaxsegment IS NOT NULL AND seasonmaxsegment <> ''\n), segment_map AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '1' THEN '青铜'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '2' THEN '白银'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '3' THEN '黄金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '4' THEN '铂金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '5' THEN '星钻'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '6' THEN '王冠'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) >= '7' THEN '王牌'\n      ELSE '无段位'\n    END AS season_segment\n  FROM segment_latest\n  WHERE rn = 1\n), active_segment AS (\n  SELECT\n    a.stat_date,\n    a.vplayerid,\n    COALESCE(s.season_segment, '无段位') AS season_segment\n  FROM active_users a\n  LEFT JOIN segment_map s\n    ON a.vplayerid = s.vplayerid\n), qunyu_users AS (\n  SELECT DISTINCT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n    AND modename = '传统模式'\n    AND submodename LIKE 'CG%'\n), summary AS (\n  SELECT\n    a.stat_date,\n    a.season_segment,\n    COUNT(DISTINCT a.vplayerid) AS active_user_cnt,\n    COUNT(DISTINCT CASE WHEN q.vplayerid IS NOT NULL THEN a.vplayerid END) AS qunyu_user_cnt\n  FROM active_segment a\n  LEFT JOIN qunyu_users q\n    ON a.stat_date = q.stat_date\n   AND a.vplayerid = q.vplayerid\n  GROUP BY a.stat_date, a.season_segment\n)\nSELECT\n  stat_date,\n  season_segment,\n  active_user_cnt,\n  qunyu_user_cnt,\n  CASE WHEN active_user_cnt = 0 THEN 0 ELSE qunyu_user_cnt / active_user_cnt END AS participate_rate\nFROM summary\nORDER BY stat_date, season_segment;", "meta": {"origin": "sql_101", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_15_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年5月勇者盟约流失用户中，流向峡谷PC的玩家gplayerid\n输出：玩家gplayerid\n【表】dws_argothek_oss_useractivity_df, dim_argothek_gplayerid2qqwxid_df, dws_mgamejp_login_user_activity_di\n【口径】sgamecode = \"initiatived\" -- 筛选峡谷游戏\nand itimes >= 1 -- 活跃用户条件\nand saccounttype = \"-100\" -- 账号体系，取-100表示汇总\nand suseridtype in (\"qq\", \"wxid\") -- 账号类型，取qq或wxid\nand splattype = \"PC\" -- 峡谷端游玩家\nand splat = \"-100\" -- 写死为-100\n5月流失：限定INSTR(SUBSTR(REVERSE(RPAD(iactivity,128,'0')),1,31),'1') = 0 AND INSTR(SUBSTR(REVERSE(RPAD(iactivity,128,'0')),32,31),'1') > 0\n取20250608的数据做账号转换"}, {"role": "assistant", "content": "with lost_may as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date = 20250609\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 1, 31), '1') = 0\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 32, 31), '1') > 0\n),\nmap_info as (\n  select\n    iuserid,\n    suserid,\n    swxid_type\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250609'\n    and suserid is not null\n    and swxid_type in ('qq', 'wx', 'wxid')\n),\npc_active as (\n  select distinct\n    suserid,\n    suseridtype\n  from dws_mgamejp_login_user_activity_di\n  where dtstatdate between '20250602' and '20250701'\n    and sgamecode = 'initiatived'\n    and itimes >= 1\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid', 'wx')\n    and splattype = 'PC'\n    and splat = '-100'\n)\nselect distinct l.iuserid as gplayerid\nfrom lost_may l\njoin map_info m\n  on l.iuserid = m.iuserid\njoin pc_active p\n  on p.suserid = m.suserid\n and p.suseridtype = case when m.swxid_type = 'wxid' then 'wx' else m.swxid_type end\norder by gplayerid;"}], "rejected": "with lost_may as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date = 20250609\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 1, 31), '1') = 0\n    and instr(substr(reverse(rpad(iactivity, 128, '0')), 32, 31), '1') > 0\n),\nmap_info as (\n  select\n    iuserid,\n    suserid,\n    swxid_type\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250609'\n    and suserid is not null\n    and swxid_type in ('qq', 'wx', 'wxid')\n),\npc_active as (\n  select distinct\n    suserid,\n    suseridtype\n  from dws_mgamejp_login_user_activity_di\n  where dtstatdate > '20250602'\n    and sgamecode = 'initiatived'\n    and itimes >= 1\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid', 'wx')\n    and splattype = 'PC'\n    and splat = '-100'\n)\nselect distinct l.iuserid as gplayerid\nfrom lost_may l\njoin map_info m\n  on l.iuserid = m.iuserid\njoin pc_active p\n  on p.suserid = m.suserid\n and p.suseridtype = case when m.swxid_type = 'wxid' then 'wx' else m.swxid_type end\norder by gplayerid;", "meta": {"origin": "sql_15", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_56_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】时间：2024.01.06-2024.02.05\n每日新增用户的LTV，LTV1~LTV10\n输出：注册日期(20240106、20240107、...、20240205)、新进用户数、LTV1、LTV3、LTV7、LTV14、LTV30、LTV60、LTV90、LTV180\n【表】dws_jordass_water_di, dws_jordass_login_df\n【口径】LTV（Life Time Value，用户生命周期价值）\n从注册日起，到第 N-1 天为止，这批新用户累计产生的总流水 ÷ 这批新用户的总人数。\n单位：元/人，衡量“每个新注册用户在 N 天内平均贡献了多少收入”。"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n    register_date,\n    count(distinct vplayerid) as new_user_cnt,\n    round(sum(case when datediff_pay < 1 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv1,\n    round(sum(case when datediff_pay < 3 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv3,\n    round(sum(case when datediff_pay < 7 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv7,\n    round(sum(case when datediff_pay < 14 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv14,\n    round(sum(case when datediff_pay < 30 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv30,\n    round(sum(case when datediff_pay < 60 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv60,\n    round(sum(case when datediff_pay < 90 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv90,\n    round(sum(case when datediff_pay < 180 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv180\nfrom (\n    select\n        s1.register_date,\n        s1.vplayerid,\n        s2.pay_date,\n        datediff(s2.pay_date, s1.register_date) as datediff_pay,\n        sum(s2.pay_amount) as sum_pay_amount\n    from (\n        select\n            distinct dregdate as register_date,\n            vplayerid\n        from dws_jordass_login_df\n        where dtstatdate = '20240205'\n          and platid = 255\n          and dregdate >= '20240106' and dregdate <= '20240205'\n    ) s1\n    left join (\n        select\n            dtstatdate as pay_date,\n            vplayerid,\n            sum(imoney/100) as pay_amount\n        from dws_jordass_water_di\n        where dtstatdate >= '20240106' and dtstatdate <= date_add('20240205', 179)\n          and platid = 255\n        group by dtstatdate, vplayerid\n    ) s2 on s1.vplayerid = s2.vplayerid\n    group by s1.register_date, s1.vplayerid, s2.pay_date\n) base\ngroup by register_date\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n    register_date,\n    count(distinct vplayerid) as new_user_cnt,\n    round(sum(case when datediff_pay < 1 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv1,\n    round(sum(case when datediff_pay < 3 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv3,\n    round(sum(case when datediff_pay < 7 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv7,\n    round(sum(case when datediff_pay < 14 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv14,\n    round(sum(case when datediff_pay < 30 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv30,\n    round(sum(case when datediff_pay < 60 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv60,\n    round(sum(case when datediff_pay < 90 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv90,\n    round(sum(case when datediff_pay < 180 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv180\nfrom (\n    select\n        s1.register_date,\n        s1.vplayerid,\n        s2.pay_date,\n        datediff(s2.pay_date, s1.register_date) as datediff_pay,\n        sum(s2.pay_amount) as sum_pay_amount\n    from (\n        select\n            distinct dregdate as register_date,\n            vplayerid\n        from dws_jordass_login_df\n        where dtstatdate = '20240205'\n          and platid = 255\n          and dregdate >= '20240106' and dregdate <= '20240205'\n    ) s1\n    left join (\n        select\n            dtstatdate as pay_date,\n            vplayerid,\n            sum(imoney/100) as pay_amount\n        from dws_jordass_water_di\n        where dtstatdate >= '20240106' and dtstatdate <= date_add('20240205', 179)\n          and platid = 255\n        group by dtstatdate, vplayerid\n    ) s2 on s1.vplayerid = s2.vplayerid\n    group by s1.register_date, s1.vplayerid, s2.pay_date\n) base\ngroup by register_date\n) AS final_query;", "meta": {"origin": "sql_56", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_31_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250217-20250318协作平台活跃但是没有在协作玩法活跃用户的主玩玩法分布\n输出：主玩玩法（传统模式、休闲模式、...、生存模式）、人数\n【表】dws_jordass_matchlog_stat_di, dwd_jordass_buttonpress_pre_di, dws_jordass_mode_roundrecord_di\n【口径】主玩定义：用户累计对局时长最多的玩法；\n玩法取 modename in ('传统模式','休闲模式','组队竞技','领地','乐园','广阔天地','创意创作间','生存模式')\n协作平台活跃：ugcmbuttonclick中的玩家；\n协作玩法活跃：vtemp1='协作'  的玩法记录\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH coop_platform AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_buttonpress_pre_di\n  WHERE dtstatdate BETWEEN '20250228' AND '20250329'\n    AND buttontype = 'ugcmbuttonclick'\n),\ncoop_game AS (\n  SELECT DISTINCT m.vplayerid\n  FROM dws_jordass_mode_roundrecord_di m\n  LEFT JOIN dim_jordass_submodeonlinedate_conf c\n    ON m.submode = c.matchsubmodegroup\n  WHERE m.dtstatdate BETWEEN '20250228' AND '20250329'\n    AND COALESCE(c.vtemp1, '') = '协作'\n),\ntarget_player AS (\n  SELECT vplayerid\n  FROM coop_platform\n  WHERE vplayerid NOT IN (SELECT vplayerid FROM coop_game)\n),\nmode_time AS (\n  SELECT\n    m.vplayerid,\n    CASE\n      WHEN modename = '传统模式' THEN '传统模式'\n      WHEN modename = '休闲模式' THEN '休闲模式'\n      WHEN modename = '组队竞技' THEN '组队竞技'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '生存模式'\n      ELSE '其他'\n    END AS main_mode_group,\n    SUM(roundtime) AS total_round_time\n  FROM dws_jordass_mode_roundrecord_di m\n  JOIN target_player t ON m.vplayerid = t.vplayerid\n  WHERE m.dtstatdate BETWEEN '20250228' AND '20250329'\n  GROUP BY m.vplayerid, main_mode_group\n),\nranked_mode AS (\n  SELECT\n    vplayerid,\n    main_mode_group,\n    total_round_time,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY total_round_time DESC) AS rn\n  FROM mode_time\n)\nSELECT\n  main_mode_group AS main_mode,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM ranked_mode\nWHERE rn = 1\nGROUP BY main_mode_group\nORDER BY user_cnt DESC;"}], "rejected": "WITH coop_platform AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_buttonpress_pre_di\n  WHERE dtstatdate > '20250228'\n    AND buttontype = 'ugcmbuttonclick'\n),\ncoop_game AS (\n  SELECT DISTINCT m.vplayerid\n  FROM dws_jordass_mode_roundrecord_di m\n  LEFT JOIN dim_jordass_submodeonlinedate_conf c\n    ON m.submode = c.matchsubmodegroup\n  WHERE m.dtstatdate BETWEEN '20250228' AND '20250329'\n    AND COALESCE(c.vtemp1, '') = '协作'\n),\ntarget_player AS (\n  SELECT vplayerid\n  FROM coop_platform\n  WHERE vplayerid NOT IN (SELECT vplayerid FROM coop_game)\n),\nmode_time AS (\n  SELECT\n    m.vplayerid,\n    CASE\n      WHEN modename = '传统模式' THEN '传统模式'\n      WHEN modename = '休闲模式' THEN '休闲模式'\n      WHEN modename = '组队竞技' THEN '组队竞技'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '生存模式'\n      ELSE '其他'\n    END AS main_mode_group,\n    SUM(roundtime) AS total_round_time\n  FROM dws_jordass_mode_roundrecord_di m\n  JOIN target_player t ON m.vplayerid = t.vplayerid\n  WHERE m.dtstatdate BETWEEN '20250228' AND '20250329'\n  GROUP BY m.vplayerid, main_mode_group\n),\nranked_mode AS (\n  SELECT\n    vplayerid,\n    main_mode_group,\n    total_round_time,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY total_round_time DESC) AS rn\n  FROM mode_time\n)\nSELECT\n  main_mode_group AS main_mode,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM ranked_mode\nWHERE rn = 1\nGROUP BY main_mode_group\nORDER BY user_cnt DESC;", "meta": {"origin": "sql_31", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_62_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250226联盟前180日（包含当天）基础数据 说明：按照uid计算\n输出：统计日期（YYYYMMDD），角色DAU，联盟参与角色数，联盟完成特训任务角色数，联盟商店兑换次数\n【表】dwd_jordass_allianceshopbuy_hi, dwd_jordass_player_allianceactive_hi, dwd_jordass_alliancebootcamprecord_hi, dwd_jordass_playerlogout_hi, dwd_jordass_playerlogin_hi\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH login_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n),\nalliance_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n),\nbootcamp_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n),\nshop_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n),\nall_dates AS (\n  SELECT stat_date FROM login_dates\n  UNION\n  SELECT stat_date FROM alliance_dates\n  UNION\n  SELECT stat_date FROM bootcamp_dates\n  UNION\n  SELECT stat_date FROM shop_dates\n),\nrole_dau AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS dau_cnt\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n  GROUP BY stat_date\n),\nalliance_participate AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS participate_cnt\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n  GROUP BY stat_date\n),\nbootcamp_finish AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT memberuid) AS bootcamp_cnt\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n  GROUP BY stat_date\n),\nshop_exchange AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(*) AS exchange_cnt\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n  GROUP BY stat_date\n)\nSELECT\n  DATE_FORMAT(d.stat_date, '%Y%m%d') AS stat_date,\n  COALESCE(rd.dau_cnt, 0) AS role_dau,\n  COALESCE(ap.participate_cnt, 0) AS alliance_participate_cnt,\n  COALESCE(bf.bootcamp_cnt, 0) AS bootcamp_finish_role_cnt,\n  COALESCE(se.exchange_cnt, 0) AS alliance_shop_exchange_cnt\nFROM all_dates d\nLEFT JOIN role_dau rd ON d.stat_date = rd.stat_date\nLEFT JOIN alliance_participate ap ON d.stat_date = ap.stat_date\nLEFT JOIN bootcamp_finish bf ON d.stat_date = bf.stat_date\nLEFT JOIN shop_exchange se ON d.stat_date = se.stat_date\nORDER BY d.stat_date\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH login_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n),\nalliance_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n),\nbootcamp_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n),\nshop_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n),\nall_dates AS (\n  SELECT stat_date FROM login_dates\n  UNION\n  SELECT stat_date FROM alliance_dates\n  UNION\n  SELECT stat_date FROM bootcamp_dates\n  UNION\n  SELECT stat_date FROM shop_dates\n),\nrole_dau AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS dau_cnt\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n  GROUP BY stat_date\n),\nalliance_participate AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS participate_cnt\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n  GROUP BY stat_date\n),\nbootcamp_finish AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT memberuid) AS bootcamp_cnt\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n  GROUP BY stat_date\n),\nshop_exchange AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(*) AS exchange_cnt\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-01', INTERVAL 179 DAY) AND '2025-03-01'\n  GROUP BY stat_date\n)\nSELECT\n  DATE_FORMAT(d.stat_date, '%Y%m%d') AS stat_date,\n  COALESCE(rd.dau_cnt, 0) AS role_dau,\n  COALESCE(ap.participate_cnt, 0) AS alliance_participate_cnt,\n  COALESCE(bf.bootcamp_cnt, 0) AS bootcamp_finish_role_cnt,\n  COALESCE(se.exchange_cnt, 0) AS alliance_shop_exchange_cnt\nFROM all_dates d\nLEFT JOIN role_dau rd ON d.stat_date = rd.stat_date\nLEFT JOIN alliance_participate ap ON d.stat_date = ap.stat_date\nLEFT JOIN bootcamp_finish bf ON d.stat_date = bf.stat_date\nLEFT JOIN shop_exchange se ON d.stat_date = se.stat_date\nORDER BY d.stat_date\n) AS final_query;", "meta": {"origin": "sql_62", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_60_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250226往前180天联盟用户，联盟用户的30天滚动付费人数\n输出：统计日期（YYYYMMDD），联盟并付费的人数\n【表】dws_jordass_water_di, dws_jordass_uid_login_df, dwd_jordass_player_allianceactive_hi\n【口径】联盟活跃用户统计日期：\nwhere tdbank_imp_date>=date_sub(\"20250303\",180) and tdbank_imp_date<\"20250303\"\n游戏付费流水统计日期：\nwhere dtstatdate>=date_sub(\"20250303\",210) and dtstatdate<\"20250303\" and platid=255"}, {"role": "assistant", "content": "WITH alliance_daily AS (\n  SELECT\n    tdbank_imp_date AS stat_date,\n    CAST(uid AS STRING) AS uid\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE tdbank_imp_date BETWEEN DATE_FORMAT(DATE_SUB('2025-03-03', INTERVAL 180 DAY), '%Y%m%d')\n                            AND DATE_FORMAT(DATE_SUB('2025-03-03', INTERVAL 1 DAY), '%Y%m%d')\n  GROUP BY tdbank_imp_date, uid\n), uid_map AS (\n  SELECT uid, vplayerid\n  FROM (\n    SELECT\n      CAST(uid AS STRING) AS uid,\n      vplayerid,\n      ROW_NUMBER() OVER (PARTITION BY uid ORDER BY dtstatdate DESC) AS rn\n    FROM dws_jordass_uid_login_df\n    WHERE dtstatdate <= '20250303'\n      AND platid = 255\n  ) t\n  WHERE rn = 1\n), rolling_pay AS (\n  SELECT\n    a.stat_date,\n    m.vplayerid\n  FROM alliance_daily a\n  JOIN uid_map m\n    ON a.uid = m.uid\n  WHERE EXISTS (\n    SELECT 1\n    FROM dws_jordass_water_di w\n    WHERE w.vplayerid = m.vplayerid\n      AND w.platid = 255\n      AND w.dtstatdate BETWEEN DATE_FORMAT(DATE_SUB(STR_TO_DATE(a.stat_date, '%Y%m%d'), INTERVAL 29 DAY), '%Y%m%d')\n                          AND a.stat_date\n  )\n)\nSELECT\n  stat_date,\n  COUNT(DISTINCT vplayerid) AS alliance_pay_user_cnt\nFROM rolling_pay\nGROUP BY stat_date\nORDER BY stat_date;"}], "rejected": "WITH alliance_daily AS (\n  SELECT\n    tdbank_imp_date AS stat_date,\n    CAST(uid AS STRING) AS uid\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE tdbank_imp_date BETWEEN DATE_FORMAT(DATE_SUB('2025-03-03', INTERVAL 180 DAY), '%Y%m%d')\n                            AND DATE_FORMAT(DATE_SUB('2025-03-03', INTERVAL 1 DAY), '%Y%m%d')\n  GROUP BY tdbank_imp_date, uid\n), uid_map AS (\n  SELECT uid, vplayerid\n  FROM (\n    SELECT\n      CAST(uid AS STRING) AS uid,\n      vplayerid,\n      ROW_NUMBER() OVER (PARTITION BY uid ORDER BY dtstatdate DESC) AS rn\n    FROM dws_jordass_uid_login_df\n    WHERE dtstatdate <= '20250303'\n      AND platid = 255\n  ) t\n  WHERE rn = 1\n), rolling_pay AS (\n  SELECT\n    a.stat_date,\n    m.vplayerid\n  FROM alliance_daily a\n  JOIN uid_map m\n    ON a.uid = m.uid\n  WHERE EXISTS (\n    SELECT 1\n    FROM dws_jordass_water_di w\n    WHERE w.vplayerid = m.vplayerid\n      AND w.platid = 255\n      AND w.dtstatdate BETWEEN DATE_FORMAT(DATE_SUB(STR_TO_DATE(a.stat_date, '%Y%m%d'), INTERVAL 29 DAY), '%Y%m%d')\n                          AND a.stat_date\n  )\n)\nSELECT\n  stat_date,\n  COUNT(DISTINCT vplayerid) AS alliance_pay_user_cnt\nFROM rolling_pay\nGROUP BY stat_date\nORDER BY stat_date;", "meta": {"origin": "sql_60", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_11_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计近30天活跃玩家数，近30天活跃且同时拥有奖池所有道具玩家数\n输出：近30天活跃玩家数、近30天活跃且同时拥有奖池所有道具玩家数\n补充说明：\n当前日期时间：'20250617'\n其中奖池道具id为：\n71d260ca-4bad-81f2-0298-44860341a7a6\n48601754-442d-98cb-2109-3fb2075500ec\na9126263-439c-7be6-d668-52a6c0c0a36f\n34ecc788-4034-71d2-a0ac-c398b8ecb2ae\n56f98991-43f8-dcc8-189e-08b7ae6c42ad\n8453f8ef-4c0b-46e2-8768-3e9e45c67a2c\n06d90274-435f-3e32-9d57-26bc228ae2e5\n8196dea4-4229-c951-13a9-088fb13b3512\n3abc330f-444a-6dfd-5863-81856ba62624\n041a43a4-46fe-dab7-c974-36bf91eab33d\n5b863cb9-4e41-ec89-69ee-49a223d05ff1\n【表】dwd_argothek_gearrecord_df, dws_argothek_oss_useractivity_df\n【口径】这张表的iworldid = 255代表玩家粒度， 奖池道具筛选逻辑：\niGoodsId in (\n\"71d260ca-4bad-81f2-0298-44860341a7a6\",\n\"48601754-442d-98cb-2109-3fb2075500ec\",\n\"a9126263-439c-7be6-d668-52a6c0c0a36f\",\n\"34ecc788-4034-71d2-a0ac-c398b8ecb2ae\",\n\"56f98991-43f8-dcc8-189e-08b7ae6c42ad\",\n\"8453f8ef-4c0b-46e2-8768-3e9e45c67a2c\",\n\"06d90274-435f-3e32-9d57-26bc228ae2e5\",\n\"8196dea4-4229-c951-13a9-088fb13b3512\",\n\"3abc330f-444a-6dfd-5863-81856ba62624\",\n\"041a43a4-46fe-dab7-c974-36bf91eab33d\",\n\"5b863cb9-4e41-ec89-69ee-49a223d05ff1\")"}, {"role": "assistant", "content": "with active_users as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date between 20250519 and 20250617\n    and iworldid = 255\n),\nall_prize_users as (\n  select iuserid\n  from dwd_argothek_gearrecord_df\n  where igoodsid in (\n    '71d260ca-4bad-81f2-0298-44860341a7a6',\n    '48601754-442d-98cb-2109-3fb2075500ec',\n    'a9126263-439c-7be6-d668-52a6c0c0a36f',\n    '34ecc788-4034-71d2-a0ac-c398b8ecb2ae',\n    '56f98991-43f8-dcc8-189e-08b7ae6c42ad',\n    '8453f8ef-4c0b-46e2-8768-3e9e45c67a2c',\n    '06d90274-435f-3e32-9d57-26bc228ae2e5',\n    '8196dea4-4229-c951-13a9-088fb13b3512',\n    '3abc330f-444a-6dfd-5863-81856ba62624',\n    '041a43a4-46fe-dab7-c974-36bf91eab33d',\n    '5b863cb9-4e41-ec89-69ee-49a223d05ff1'\n  )\n  group by iuserid\n  having count(distinct igoodsid) = 11\n),\nactive_cnt as (\n  select count(*) as active_user_cnt from active_users\n),\nactive_all_cnt as (\n  select count(*) as active_own_all_cnt\n  from active_users a\n  join all_prize_users g on a.iuserid = g.iuserid\n)\nselect\n  a.active_user_cnt as active_30d_user_cnt,\n  b.active_own_all_cnt as active_30d_own_all_cnt\nfrom active_cnt a\ncross join active_all_cnt b;"}], "rejected": "with active_users as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date between 20250519 and 20250617\n    and iworldid = 255\n),\nall_prize_users as (\n  select iuserid\n  from dwd_argothek_gearrecord_df\n  where igoodsid in (\n    '71d260ca-4bad-81f2-0298-44860341a7a6',\n    '48601754-442d-98cb-2109-3fb2075500ec',\n    'a9126263-439c-7be6-d668-52a6c0c0a36f',\n    '34ecc788-4034-71d2-a0ac-c398b8ecb2ae',\n    '56f98991-43f8-dcc8-189e-08b7ae6c42ad',\n    '8453f8ef-4c0b-46e2-8768-3e9e45c67a2c',\n    '06d90274-435f-3e32-9d57-26bc228ae2e5',\n    '8196dea4-4229-c951-13a9-088fb13b3512',\n    '3abc330f-444a-6dfd-5863-81856ba62624',\n    '041a43a4-46fe-dab7-c974-36bf91eab33d',\n    '5b863cb9-4e41-ec89-69ee-49a223d05ff1'\n  )\n  group by iuserid\n  having count(distinct igoodsid) = 11\n),\nactive_cnt as (\n  select count(*) as active_user_cnt from active_users\n),\nactive_all_cnt as (\n  select count(*) as active_own_all_cnt\n  from active_users a\n  join all_prize_users g on a.iuserid = g.iuserid\n)\nselect\n  a.active_user_cnt as active_30d_user_cnt,\n  b.active_own_all_cnt as active_30d_own_all_cnt\nfrom active_cnt a\ncross join active_all_cnt b;", "meta": {"origin": "sql_11", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_28_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计各个玩法上线首周留存情况\n输出：玩法、上线首周首次玩的日期、第几天留存（0,1,2...7)、玩法留存用户数\n\n各玩法首周上线日期：\n\"广域战场\": \"20240726\",\n\"消灭战\": \"20230807\",\n\"幻想混战\": \"20241118\",\n\"荒野传说\": \"20240906\",\n\"策略载具\": \"20241013\",\n\"炎夏混战\": \"20240628\",\n\"单人装备\": \"20240520\",\n\"交叉堡垒\": \"20240415\"\n【表】dws_jordass_mode_roundrecord_di\n【口径】说明：\n广域战场 （2024/7/23）submodename= '广域战场模式'，\n消灭战（2023/8/4） modename='组队竞技' and submodename like '%消灭战模式%'，\n幻想混战（2024/11/18）modename='创意创作间' and submodename='幻想混战'，\n荒野传说（2024-09-06）modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')，\n策略载具（2024-10-13）modename='休闲模式' and submodename like '%策略载具%'，\n炎夏混战（2024-06-28）modename='创意创作间' and submodename like '%炎夏混战%'，\n单人装备（2024.5.17）modename='组队竞技' and submodename like '%单人装备%'，\n交叉堡垒（2024.4.12） modename='组队竞技' and submodename like '%交叉堡垒%'\n\n第几天留存：0表示当天参与、1表示当天参与在第2天也参与、2表示当天参与在第3天也参与，依此类推"}, {"role": "assistant", "content": "select  a.itype,\n        a.dtstatdate,\n        datediff(b.dtstatdate,a.dtstatdate) as idaynum,\n        count(distinct a.vplayerid)           as iusernum\nfrom (                      \n    select\n        itype,\n        min(dtstatdate) as dtstatdate,\n        vplayerid\n    from  (\n        select '广域战场'      as itype,\n                min(dtstatdate) as dtstatdate,\n                vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240726' and dtstatdate <= date_add('20240726',6)\n        and submodename = '广域战场模式'\n        group by vplayerid\n\n        union all\n        select '消灭战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230807' and dtstatdate <= date_add('20230807',6)\n        and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by vplayerid\n\n        union all\n        select '幻想混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241118' and dtstatdate <= date_add('20241118',6)\n        and modename='创意创作间' and submodename='幻想混战'\n        group by vplayerid\n\n        union all\n        select '荒野传说', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240906' and dtstatdate <= date_add('20240906',6)\n        and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by vplayerid\n\n        union all\n        select '策略载具', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241013' and dtstatdate <= date_add('20241013',6)\n        and modename='休闲模式' and submodename like '%策略载具%'\n        group by vplayerid\n\n        union all\n        select '炎夏混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240628' and dtstatdate <= date_add('20240628',6)\n        and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by vplayerid\n\n        union all\n        select '单人装备', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240520' and dtstatdate <= date_add('20240520',6)\n        and modename='组队竞技' and submodename like '%单人装备%'\n        group by vplayerid\n\n        union all\n        select '交叉堡垒', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240415' and dtstatdate <= date_add('20240415',6)\n        and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by vplayerid\n    ) t\n    group by itype, vplayerid\n) a\nleft join (\n        select '广域战场' as itype, dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240726' and dtstatdate <= date_add('20240726',13)\n          and submodename = '广域战场模式'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '消灭战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230807' and dtstatdate <= date_add('20230807',13)\n          and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '幻想混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241118' and dtstatdate <= date_add('20241118',13)\n          and modename='创意创作间' and submodename='幻想混战'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '荒野传说', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240906' and dtstatdate <= date_add('20240906',13)\n          and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by dtstatdate, vplayerid\n\n        union all\n        select '策略载具', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241013' and dtstatdate <= date_add('20241013',13)\n          and modename='休闲模式' and submodename like '%策略载具%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '炎夏混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240628' and dtstatdate <= date_add('20240628',13)\n          and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '单人装备', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240520' and dtstatdate <= date_add('20240520',13)\n          and modename='组队竞技' and submodename like '%单人装备%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '交叉堡垒', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240415' and dtstatdate <= date_add('20240415',13)\n          and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by dtstatdate, vplayerid\n) b\n  on  a.itype      = b.itype\nand  a.vplayerid    = b.vplayerid\nwhere datediff(b.dtstatdate,a.dtstatdate) between 0 and 7\ngroup by a.itype, a.dtstatdate, datediff(b.dtstatdate,a.dtstatdate);"}], "rejected": "select  a.itype,\n        a.dtstatdate,\n        datediff(b.dtstatdate,a.dtstatdate) as idaynum,\n        count(distinct a.vplayerid)           as iusernum\nfrom (                      \n    select\n        itype,\n        min(dtstatdate) as dtstatdate,\n        vplayerid\n    from  (\n        select '广域战场'      as itype,\n                min(dtstatdate) as dtstatdate,\n                vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240726' and dtstatdate <= date_add('20240726',6)\n        and submodename = '广域战场模式'\n        group by vplayerid\n\n        union all\n        select '消灭战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230807' and dtstatdate <= date_add('20230807',6)\n        and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by vplayerid\n\n        union all\n        select '幻想混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241118' and dtstatdate <= date_add('20241118',6)\n        and modename='创意创作间' and submodename='幻想混战'\n        group by vplayerid\n\n        union all\n        select '荒野传说', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240906' and dtstatdate <= date_add('20240906',6)\n        and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by vplayerid\n\n        union all\n        select '策略载具', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241013' and dtstatdate <= date_add('20241013',6)\n        and modename='休闲模式' and submodename like '%策略载具%'\n        group by vplayerid\n\n        union all\n        select '炎夏混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240628' and dtstatdate <= date_add('20240628',6)\n        and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by vplayerid\n\n        union all\n        select '单人装备', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240520' and dtstatdate <= date_add('20240520',6)\n        and modename='组队竞技' and submodename like '%单人装备%'\n        group by vplayerid\n\n        union all\n        select '交叉堡垒', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240415' and dtstatdate <= date_add('20240415',6)\n        and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by vplayerid\n    ) t\n    group by itype, vplayerid\n) a\nleft join (\n        select '广域战场' as itype, dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240726' and dtstatdate <= date_add('20240726',13)\n          and submodename = '广域战场模式'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '消灭战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230807' and dtstatdate <= date_add('20230807',13)\n          and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '幻想混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241118' and dtstatdate <= date_add('20241118',13)\n          and modename='创意创作间' and submodename='幻想混战'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '荒野传说', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240906' and dtstatdate <= date_add('20240906',13)\n          and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by dtstatdate, vplayerid\n\n        union all\n        select '策略载具', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241013' and dtstatdate <= date_add('20241013',13)\n          and modename='休闲模式' and submodename like '%策略载具%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '炎夏混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240628' and dtstatdate <= date_add('20240628',13)\n          and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '单人装备', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240520' and dtstatdate <= date_add('20240520',13)\n          and modename='组队竞技' and submodename like '%单人装备%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '交叉堡垒', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240415' and dtstatdate <= date_add('20240415',13)\n          and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by dtstatdate, vplayerid\n) b\n  on  a.itype      = b.itype\nand  a.vplayerid    = b.vplayerid\nwhere datediff(b.dtstatdate,a.dtstatdate) between 0 and 7\ngroup by a.itype, a.dtstatdate, datediff(b.dtstatdate,a.dtstatdate);", "meta": {"origin": "sql_28", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_34_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.9.17-2024.9.23 和 2024.10.8-2024.10.25    每天点击按钮后加入玩法，再之后点击确认的人数，以及这些人加入玩法的次数                                                       \n输出：日期(20240928、...、20241004、20241019、...、20241025)，人数，人次\n【表】dws_jordass_buttonpress_pre_di\n【口径】buttontype为411111代表点击按钮，411120代表加入玩法，411123代表确认\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n    ds,\n    count(distinct vplayerid) as user_cnt,\n    count(distinct vplayerid, irank) as user_times\nfrom (\n    select\n        s2.ds,\n        s2.vplayerid,\n        s2.irank\n    from (\n        -- 获取411111事件（点击按钮）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411111\n        and  ((dtstatdate between '20240928' and '20241004') or (dtstatdate between '20241019' and '20241025'))\n    ) s1\n    join (\n        -- 获取411120事件（加入玩法）并编号\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime,\n            row_number() over (partition by vplayerid order by dteventtime) as irank\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411120\n        and ((dtstatdate between '20240928' and '20241004') or (dtstatdate between '20241019' and '20241025'))\n    ) s2 on s1.vplayerid = s2.vplayerid and s1.ds = s2.ds and s2.dteventtime > s1.dteventtime\n    join (\n        -- 获取411123事件（确认动作）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411123\n        and ((dtstatdate between '20240928' and '20241004') or (dtstatdate between '20241019' and '20241025'))\n    ) s3 on s2.vplayerid = s3.vplayerid and s2.ds = s3.ds and s3.dteventtime > s2.dteventtime\n)f \ngroup by ds\n;"}], "rejected": "select\n    ds,\n    count(distinct vplayerid) as user_cnt,\n    count(distinct vplayerid, irank) as user_times\nfrom (\n    select\n        s2.ds,\n        s2.vplayerid,\n        s2.irank\n    from (\n        -- 获取411111事件（点击按钮）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411111\n        and  ((dtstatdate > '20240928') or (dtstatdate between '20241019' and '20241025'))\n    ) s1\n    join (\n        -- 获取411120事件（加入玩法）并编号\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime,\n            row_number() over (partition by vplayerid order by dteventtime) as irank\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411120\n        and ((dtstatdate between '20240928' and '20241004') or (dtstatdate between '20241019' and '20241025'))\n    ) s2 on s1.vplayerid = s2.vplayerid and s1.ds = s2.ds and s2.dteventtime > s1.dteventtime\n    join (\n        -- 获取411123事件（确认动作）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411123\n        and ((dtstatdate between '20240928' and '20241004') or (dtstatdate between '20241019' and '20241025'))\n    ) s3 on s2.vplayerid = s3.vplayerid and s2.ds = s3.ds and s3.dteventtime > s2.dteventtime\n)f \ngroup by ds\n;", "meta": {"origin": "sql_34", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_1_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.07.24的手游全量用户且标签为其他，在竞品业务下2025.05.30-2025.07.24的在线时长。\n输出：suserid、sgamecode、ionlinetime\n【表】dws_mgamejp_login_user_activity_di, dim_vplayerid_vies_df\n【口径】竞品业务：\nsgamecode in (\"initiatived\",\"jordass\",\"esports\",\"allianceforce\",\"strategy\",\"playzone\",\"su\")\nsaccounttype = \"-100\" -- 账号体系取汇总\nsuseridtype in (\"qq\",\"wxid\") -- 用户类型\n\ndim_vplayerid_vies_df 字段：suserid、suserid_type（映射到事实表的 suserid / suseridtype）\n可选过滤：以上条件可按需勾选。\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH base_user AS (\n  SELECT DISTINCT\n         suserid,\n         suserid_type\n  FROM dim_vplayerid_vies_df\n  WHERE dtstatdate = '20250822'\n    AND itag = '其他'\n    AND suserid IS NOT NULL\n    AND suserid_type IN ('qq', 'wxid')\n)\nSELECT\n    a.suserid,\n    a.sgamecode,\n    SUM(a.ionlinetime) AS ionlinetime\nFROM dws_mgamejp_login_user_activity_di a\nJOIN base_user b\n  ON a.suserid = b.suserid\n AND a.suseridtype = b.suserid_type\nWHERE a.dtstatdate BETWEEN '20250628' AND '20250822'\n  AND a.sgamecode IN ('initiatived', 'jordass', 'esports', 'allianceforce', 'strategy', 'playzone', 'su')\n  AND a.saccounttype = '-100'\n  AND a.suseridtype IN ('qq', 'wxid')\n  AND a.splattype = '-100'\n  AND a.splat = '-100'\nGROUP BY a.suserid, a.sgamecode\nORDER BY a.suserid, a.sgamecode;"}], "rejected": "WITH base_user AS (\n  SELECT DISTINCT\n         suserid,\n         suserid_type\n  FROM dim_vplayerid_vies_df\n  WHERE dtstatdate = '20250822'\n    AND itag = '其他'\n    AND suserid IS NOT NULL\n    AND suserid_type IN ('qq', 'wxid')\n)\nSELECT\n    a.suserid,\n    a.sgamecode,\n    SUM(a.ionlinetime) AS ionlinetime\nFROM dws_mgamejp_login_user_activity_di a\nJOIN base_user b\n  ON a.suserid = b.suserid\n AND a.suseridtype = b.suserid_type\nWHERE a.dtstatdate BETWEEN '20250628' AND '20250822'\n  AND a.sgamecode IN ('initiatived', 'jordass', 'esports', 'allianceforce', 'strategy', 'playzone', 'su')\n  AND a.suseridtype IN ('qq', 'wxid')\n  AND a.splattype = '-100'\n  AND a.splat = '-100'\nGROUP BY a.suserid, a.sgamecode\nORDER BY a.suserid, a.sgamecode;", "meta": {"origin": "sql_1", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_65_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】查询2024.11.29-2024.12.19期间的任务领取数据，并按类型汇总（跨日期）\n输出 ：日期（YYYYMMDD、汇总），类型，人数，次数\n【表】dwd_jordass_activity_rewardrecord_hi\n【口径】任务领取：actid = 2411291018and acttype = 10045 and awardidx in (1, 2, 3)，一条记录代表领取一次\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241228' and '20250117'\n    and actid = 2411291018\n    and acttype = 10045\n    and awardidx in (1, 2, 3)\n),\nstat_detail as (\n  select\n    stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by stat_date, award_type\n),\nstat_summary as (\n  select\n    '汇总' as stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by award_type\n)\nselect\n  stat_date,\n  award_type,\n  user_cnt,\n  receive_cnt\nfrom (\n  select * from stat_detail\n  union all\n  select * from stat_summary\n) t\norder by case when stat_date = '汇总' then 1 else 0 end, stat_date, award_type;"}], "rejected": "with base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) > '20241228'\n    and actid = 2411291018\n    and acttype = 10045\n    and awardidx in (1, 2, 3)\n),\nstat_detail as (\n  select\n    stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by stat_date, award_type\n),\nstat_summary as (\n  select\n    '汇总' as stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by award_type\n)\nselect\n  stat_date,\n  award_type,\n  user_cnt,\n  receive_cnt\nfrom (\n  select * from stat_detail\n  union all\n  select * from stat_summary\n) t\norder by case when stat_date = '汇总' then 1 else 0 end, stat_date, award_type;", "meta": {"origin": "sql_65", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_113_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20220425-20220508组竞商店购买情况\n输出：统计日期（YYYYMMDD），商店id，人数，次数\n【表】dwd_jordass_vsteamshoplog_hi\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(shopid as string) as shop_id,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as buy_cnt\nfrom dwd_jordass_vsteamshoplog_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20220428' and '20220511'\ngroup by substr(tdbank_imp_date, 1, 8), shopid\norder by stat_date, shop_id;"}], "rejected": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(shopid as string) as shop_id,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as buy_cnt\nfrom dwd_jordass_vsteamshoplog_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20220428'\ngroup by substr(tdbank_imp_date, 1, 8), shopid\norder by stat_date, shop_id;", "meta": {"origin": "sql_113", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_30_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2019.5.8至2025.3.30 分月的玩法主玩情况\n输出：月份(201905、201906、...、202503)、主玩玩法、主玩人数、总参与人数\n【表】dwd_jordass_playerexitgamerecord_hi, dws_jordass_mode_roundrecord_di\n【口径】主玩定义：用户累计对局时长最多的玩法；\n\n玩法：从dws_jordass_mode_roundrecord_di取\n从上往下匹配，如果满足以下任一条件，则返回对应的名称，否则返回“其他模式”。\n如果模式为“传统模式”，且子模式名称以“CG”开头，且地图为“群屿”，则返回“主题群屿”；\n如果模式为“传统模式”且地图为“群屿”，则返回“传统群屿”；\n如果模式为“传统模式”且地图为“假日群岛”，则返回“假日群岛”；\n如果模式为“传统模式”且地图为“荣耀之城”，则返回“荣耀之城”；\n如果子模式是“广域战场模式”，则返回“广域战场”；\n如果子模式是“极能形态模式”，则返回“极能形态”；\n如果模式是“组队竞技”，则返回“组竞”；\n如果模式是“休闲模式”，则返回“休闲”；\n如果模式是“乐园”，则返回“乐园”；\n如果模式是“领地”，则返回“领地”；\n如果模式是“广阔天地”，则返回“广阔天地”\n\n注意，参与隧道模式的用户数据从dwd_jordass_playerexitgamerecord_hi取，时间限制 2024.6.18-2025.3.30，mode in (3001, 3002, 3003)"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith main_user as (\n    select substr(dtstatdate, 1, 6) mons,\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end imodename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        sum(roundcnt) roundcnt\n   from dws_jordass_mode_roundrecord_di\n   where dtstatdate between '20190511' and '20250402'\n   group by vplayerid, substr(dtstatdate, 1, 6),\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end\n\n   union all\n   \n   select substr (tdbank_imp_date, 1, 6) mons,\n        '隧道' as modename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        count(distinct gameid) roundcnt\n   from dwd_jordass_playerexitgamerecord_hi\n   where tdbank_imp_date between '2024061800' and '2025033023'\n     and mode in (3001, 3002, 3003)\n   group by substr (tdbank_imp_date, 1, 6), vplayerid\n)\n\nselect a.mons,\n       a.imodename,\n       a.iusernum,\n       b.iusernumall\nfrom (\n    select mons,\n          imodename,\n          count(vplayerid) iusernum\n    from (\n        select mons, vplayerid, imodename\n        from (\n            select mons,\n                vplayerid,\n                imodename,\n                roundtime,\n                row_number() over (partition by mons, vplayerid order by roundtime desc) as rn\n            from main_user\n        )ff1\n        where rn = 1\n    )f1\n   group by mons, imodename\n) a\nleft join (\n    select mons,\n        imodename,\n        count(vplayerid) iusernumall\n   from main_user\n   group by mons, imodename\n) b \non a.imodename = b.imodename and a.mons = b.mons\norder by a.mons, a.imodename\n\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith main_user as (\n    select substr(dtstatdate, 1, 6) mons,\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end imodename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        sum(roundcnt) roundcnt\n   from dws_jordass_mode_roundrecord_di\n   where dtstatdate > '20190511'\n   group by vplayerid, substr(dtstatdate, 1, 6),\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end\n\n   union all\n   \n   select substr (tdbank_imp_date, 1, 6) mons,\n        '隧道' as modename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        count(distinct gameid) roundcnt\n   from dwd_jordass_playerexitgamerecord_hi\n   where tdbank_imp_date between '2024061800' and '2025033023'\n     and mode in (3001, 3002, 3003)\n   group by substr (tdbank_imp_date, 1, 6), vplayerid\n)\n\nselect a.mons,\n       a.imodename,\n       a.iusernum,\n       b.iusernumall\nfrom (\n    select mons,\n          imodename,\n          count(vplayerid) iusernum\n    from (\n        select mons, vplayerid, imodename\n        from (\n            select mons,\n                vplayerid,\n                imodename,\n                roundtime,\n                row_number() over (partition by mons, vplayerid order by roundtime desc) as rn\n            from main_user\n        )ff1\n        where rn = 1\n    )f1\n   group by mons, imodename\n) a\nleft join (\n    select mons,\n        imodename,\n        count(vplayerid) iusernumall\n   from main_user\n   group by mons, imodename\n) b \non a.imodename = b.imodename and a.mons = b.mons\norder by a.mons, a.imodename\n\n) AS final_query;", "meta": {"origin": "sql_30", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_47_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.07.01-08.31期间，每天微信活跃用户在2023.09.1-09.21期间流失并且是2023.07.01-08.31有付费的用户\n输出：人数\n【表】dws_jordass_water_di, dws_jordass_login_di\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith pay_users as (\n  select distinct vplayerid\n  from dws_jordass_water_di\n  where dtstatdate between '20230708' and '20230907'\n),\nlater_active as (\n  select distinct vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230908' and '20230928'\n),\nearly_login as (\n  select\n    dtstatdate,\n    vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230708' and '20230907'\n    and vgameappid = 'wx'\n)\nselect\n  dtstatdate,\n  count(distinct vplayerid) as user_cnt\nfrom early_login l\nwhere exists (select 1 from pay_users p where p.vplayerid = l.vplayerid)\n  and not exists (select 1 from later_active a where a.vplayerid = l.vplayerid)\ngroup by dtstatdate\norder by dtstatdate\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith pay_users as (\n  select distinct vplayerid\n  from dws_jordass_water_di\n  where dtstatdate > '20230708'\n),\nlater_active as (\n  select distinct vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230908' and '20230928'\n),\nearly_login as (\n  select\n    dtstatdate,\n    vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230708' and '20230907'\n    and vgameappid = 'wx'\n)\nselect\n  dtstatdate,\n  count(distinct vplayerid) as user_cnt\nfrom early_login l\nwhere exists (select 1 from pay_users p where p.vplayerid = l.vplayerid)\n  and not exists (select 1 from later_active a where a.vplayerid = l.vplayerid)\ngroup by dtstatdate\norder by dtstatdate\n) AS final_query;", "meta": {"origin": "sql_47", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_74_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计 SS30赛季手册和SS29赛季手册的按钮人数\nSS30赛季:2024112305 - 2024112616\nSS29赛季:2024092405 - 2024092716\n输出：按钮类型，SS30赛季手册人数，SS29赛季手册人数\n【表】dwd_jordass_pressbutton_hi\n【口径】按钮：buttontypes等于411130或411200"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH ss30 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-27 05:00:00' AND '2024-11-30 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-27 05:00:00' AND '2024-11-30 16:00:00'\n), ss29 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-28 05:00:00' AND '2024-10-01 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-28 05:00:00' AND '2024-10-01 16:00:00'\n)\nSELECT\n  b.button_type,\n  COALESCE(s30.user_cnt, 0) AS ss30_user_cnt,\n  COALESCE(s29.user_cnt, 0) AS ss29_user_cnt\nFROM (\n  SELECT '411130' AS button_type\n  UNION ALL SELECT '411200'\n) b\nLEFT JOIN ss30 s30 ON b.button_type = s30.button_type\nLEFT JOIN ss29 s29 ON b.button_type = s29.button_type\nORDER BY b.button_type\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH ss30 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-27 05:00:00' AND '2024-11-30 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-27 05:00:00' AND '2024-11-30 16:00:00'\n), ss29 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-28 05:00:00' AND '2024-10-01 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-28 05:00:00' AND '2024-10-01 16:00:00'\n)\nSELECT\n  b.button_type,\n  COALESCE(s30.user_cnt, 0) AS ss30_user_cnt,\n  COALESCE(s29.user_cnt, 0) AS ss29_user_cnt\nFROM (\n  SELECT '411130' AS button_type\n  UNION ALL SELECT '411200'\n) b\nLEFT JOIN ss30 s30 ON b.button_type = s30.button_type\nLEFT JOIN ss29 s29 ON b.button_type = s29.button_type\nORDER BY b.button_type\n) AS final_query;", "meta": {"origin": "sql_74", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_103_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.9.1到9.10每天productid的参与直购购买人数，直购购买金额以及数量，当天注册人数\n输出：统计日期(yyyymmdd),productid,直购购买人数,直购购买金额,直购购买数量\n【表】dws_jordass_login_df, dwd_jordass_directpaycommflow_hi\n【口径】productid的参与直购：op='take' and opres='ok'\n\tand productid in ('package_6','package_18','outfit_pack','weapon_pack')"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH purchase AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    productid,\n    vplayerid,\n    goodsnum,\n    money\n  FROM dwd_jordass_directpaycommflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-09-06' AND '2025-09-15'\n    AND op = 'take'\n    AND opres = 'ok'\n    AND productid IN ('package_6','package_18','outfit_pack','weapon_pack')\n)\nSELECT\n  DATE_FORMAT(stat_date, '%Y%m%d') AS stat_date,\n  productid,\n  COUNT(DISTINCT vplayerid) AS purchase_user_cnt,\n  ROUND(SUM(money) / 100.0, 2) AS purchase_amount,\n  SUM(goodsnum) AS purchase_qty\nFROM purchase\nGROUP BY stat_date, productid\nORDER BY stat_date, productid\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH purchase AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    productid,\n    vplayerid,\n    goodsnum,\n    money\n  FROM dwd_jordass_directpaycommflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-09-06' AND '2025-09-15'\n    AND op = 'take'\n    AND opres = 'ok'\n    AND productid IN ('package_6','package_18','outfit_pack','weapon_pack')\n)\nSELECT\n  DATE_FORMAT(stat_date, '%Y%m%d') AS stat_date,\n  productid,\n  COUNT(DISTINCT vplayerid) AS purchase_user_cnt,\n  ROUND(SUM(money) / 100.0, 2) AS purchase_amount,\n  SUM(goodsnum) AS purchase_qty\nFROM purchase\nGROUP BY stat_date, productid\nORDER BY stat_date, productid\n) AS final_query;", "meta": {"origin": "sql_103", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_73_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20241123-20241222对决冠军，乐园其他，和乐园汇总 三类用户的组队和对局情况\n输出：乐园总参与人数，乐园总参与局数，乐园组队人数，乐园组队局数，对决冠军总参与人数，对决冠军总参与局数，对决冠军组队人数，对决冠军组队局数，乐园其他总参与人数，乐园其他总参与局数，乐园其他组队人数，乐园其他组队局数\n【表】dwd_jordass_player_matchrecord_hi\n【口径】对决冠军：matchmode=1003 and matchsubmodegroup=1345785623905087744\n乐园其他：matchmode=1003 and matchsubmodegroup<>1345785623905087744\n乐园汇总：matchmode=1003\n都需要限制 matchresult=\"ok\"\n组队：teamnum>1"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    vplayerid,\n    cast(coalesce(nullif(teamnum, ''), '1') as int) as team_num,\n    matchmode,\n    matchsubmodegroup\n  from dwd_jordass_player_matchrecord_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241130' and '20241229'\n    and matchresult = 'ok'\n),\nagg as (\n  select\n    '乐园' as category,\n    count(distinct vplayerid) as total_users,\n    count(*) as total_matches,\n    count(distinct case when team_num > 1 then vplayerid end) as team_users,\n    sum(case when team_num > 1 then 1 else 0 end) as team_matches\n  from base\n  where matchmode = 1003\n  union all\n  select\n    '对决冠军',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup = 1345785623905087744\n  union all\n  select\n    '乐园其他',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup <> 1345785623905087744\n)\nselect\n  max(case when category = '乐园' then total_users end) as leyuan_total_users,\n  max(case when category = '乐园' then total_matches end) as leyuan_total_matches,\n  max(case when category = '乐园' then team_users end) as leyuan_team_users,\n  max(case when category = '乐园' then team_matches end) as leyuan_team_matches,\n  max(case when category = '对决冠军' then total_users end) as duel_total_users,\n  max(case when category = '对决冠军' then total_matches end) as duel_total_matches,\n  max(case when category = '对决冠军' then team_users end) as duel_team_users,\n  max(case when category = '对决冠军' then team_matches end) as duel_team_matches,\n  max(case when category = '乐园其他' then total_users end) as leyuan_other_total_users,\n  max(case when category = '乐园其他' then total_matches end) as leyuan_other_total_matches,\n  max(case when category = '乐园其他' then team_users end) as leyuan_other_team_users,\n  max(case when category = '乐园其他' then team_matches end) as leyuan_other_team_matches\nfrom agg\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    vplayerid,\n    cast(coalesce(nullif(teamnum, ''), '1') as int) as team_num,\n    matchmode,\n    matchsubmodegroup\n  from dwd_jordass_player_matchrecord_hi\n  where substr(tdbank_imp_date, 1, 8) > '20241130'\n    and matchresult = 'ok'\n),\nagg as (\n  select\n    '乐园' as category,\n    count(distinct vplayerid) as total_users,\n    count(*) as total_matches,\n    count(distinct case when team_num > 1 then vplayerid end) as team_users,\n    sum(case when team_num > 1 then 1 else 0 end) as team_matches\n  from base\n  where matchmode = 1003\n  union all\n  select\n    '对决冠军',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup = 1345785623905087744\n  union all\n  select\n    '乐园其他',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup <> 1345785623905087744\n)\nselect\n  max(case when category = '乐园' then total_users end) as leyuan_total_users,\n  max(case when category = '乐园' then total_matches end) as leyuan_total_matches,\n  max(case when category = '乐园' then team_users end) as leyuan_team_users,\n  max(case when category = '乐园' then team_matches end) as leyuan_team_matches,\n  max(case when category = '对决冠军' then total_users end) as duel_total_users,\n  max(case when category = '对决冠军' then total_matches end) as duel_total_matches,\n  max(case when category = '对决冠军' then team_users end) as duel_team_users,\n  max(case when category = '对决冠军' then team_matches end) as duel_team_matches,\n  max(case when category = '乐园其他' then total_users end) as leyuan_other_total_users,\n  max(case when category = '乐园其他' then total_matches end) as leyuan_other_total_matches,\n  max(case when category = '乐园其他' then team_users end) as leyuan_other_team_users,\n  max(case when category = '乐园其他' then team_matches end) as leyuan_other_team_matches\nfrom agg\n) AS final_query;", "meta": {"origin": "sql_73", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_69_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.12.25——2025.1.5 ，不同信息类型的玩家数量\n\n信息类型:chattype in (20,25,26,16,27,8)\n\n输出 日期（20241230-20250110），信息类型，人数，次数\n【表】dwd_jordass_msgchatrecord_hi\n【口径】chattype in (20,25,26,16,27,8)"}, {"role": "assistant", "content": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(chattype as string) as chat_type,\n  count(distinct playerid) as user_cnt,\n  count(*) as msg_cnt\nfrom dwd_jordass_msgchatrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20241230' and '20250110'\n  and chattype in (20, 25, 26, 16, 27, 8)\ngroup by substr(tdbank_imp_date, 1, 8), chattype\norder by stat_date, chat_type;"}], "rejected": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  cast(chattype as string) as chat_type,\n  count(distinct playerid) as user_cnt,\n  count(*) as msg_cnt\nfrom dwd_jordass_msgchatrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20241230'\n  and chattype in (20, 25, 26, 16, 27, 8)\ngroup by substr(tdbank_imp_date, 1, 8), chattype\norder by stat_date, chat_type;", "meta": {"origin": "sql_69", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_58_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计以下时间对应玩法id下的不同对局时长人数分布\n'20230729'-'20230804'  1310822585431254784    \n'20221128'-'20221204' 1282371711108385024    \n'20221205'-'20221211' 1287652322611036928    \n'20230313'-'20230319' 1294211358396518400    \n'20230619''20230625' 1297394991875754752     \n\n对局时长按照 [0-10min)，[10-30min)，[30min-1h)，[1h,2h)，[2h,3h)，[3h,4h)， [4h,5h)，\n[5h,6h)，[6h,7h)，[7h,8h)，[8h,9h)，[9h,10h)，[10h,∞)\t\t\n输出字段：玩法id、对局时长、人数\n【表】dws_jordass_matchlog_stat_di\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH ranges AS (\n  SELECT '20230729' AS start_dt, '20230804' AS end_dt, '1310822585431254784' AS imode_id UNION ALL\n  SELECT '20221128', '20221204', '1282371711108385024' UNION ALL\n  SELECT '20221205', '20221211', '1287652322611036928' UNION ALL\n  SELECT '20230313', '20230319', '1294211358396518400' UNION ALL\n  SELECT '20230619', '20230625', '1297394991875754752'\n),\nbase AS (\n  SELECT\n    r.imode_id AS gameplay_id,\n    CASE\n      WHEN m.itemp1 < 600 THEN '[0-10min)'\n      WHEN m.itemp1 < 1800 THEN '[10-30min)'\n      WHEN m.itemp1 < 3600 THEN '[30min-1h)'\n      WHEN m.itemp1 < 7200 THEN '[1h,2h)'\n      WHEN m.itemp1 < 10800 THEN '[2h,3h)'\n      WHEN m.itemp1 < 14400 THEN '[3h,4h)'\n      WHEN m.itemp1 < 18000 THEN '[4h,5h)'\n      WHEN m.itemp1 < 21600 THEN '[5h,6h)'\n      WHEN m.itemp1 < 25200 THEN '[6h,7h)'\n      WHEN m.itemp1 < 28800 THEN '[7h,8h)'\n      WHEN m.itemp1 < 32400 THEN '[8h,9h)'\n      WHEN m.itemp1 < 36000 THEN '[9h,10h)'\n      ELSE '[10h,∞)'\n    END AS duration_bucket,\n    m.vplayerid\n  FROM dws_jordass_matchlog_stat_di m\n  JOIN ranges r\n    ON m.imode = r.imode_id\n   AND m.dtstatdate BETWEEN r.start_dt AND r.end_dt\n)\nSELECT\n  gameplay_id AS gameplayid,\n  duration_bucket,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM base\nGROUP BY gameplay_id, duration_bucket\nORDER BY gameplay_id, duration_bucket;"}], "rejected": "WITH ranges AS (\n  SELECT '20230729' AS start_dt, '20230804' AS end_dt, '1310822585431254784' AS imode_id UNION ALL\n  SELECT '20221128', '20221204', '1282371711108385024' UNION ALL\n  SELECT '20221205', '20221211', '1287652322611036928' UNION ALL\n  SELECT '20230313', '20230319', '1294211358396518400' UNION ALL\n  SELECT '20230619', '20230625', '1297394991875754752'\n),\nbase AS (\n  SELECT\n    r.imode_id AS gameplay_id,\n    CASE\n      WHEN m.itemp1 < 600 THEN '[0-10min)'\n      WHEN m.itemp1 < 1800 THEN '[10-30min)'\n      WHEN m.itemp1 < 3600 THEN '[30min-1h)'\n      WHEN m.itemp1 < 7200 THEN '[1h,2h)'\n      WHEN m.itemp1 < 10800 THEN '[2h,3h)'\n      WHEN m.itemp1 < 14400 THEN '[3h,4h)'\n      WHEN m.itemp1 < 18000 THEN '[4h,5h)'\n      WHEN m.itemp1 < 21600 THEN '[5h,6h)'\n      WHEN m.itemp1 < 25200 THEN '[6h,7h)'\n      WHEN m.itemp1 < 28800 THEN '[7h,8h)'\n      WHEN m.itemp1 < 32400 THEN '[8h,9h)'\n      WHEN m.itemp1 < 36000 THEN '[9h,10h)'\n      ELSE '[10h,∞)'\n    END AS duration_bucket,\n    m.vplayerid\n  FROM dws_jordass_matchlog_stat_di m\n  JOIN ranges r\n    ON m.imode = r.imode_id\n   AND m.dtstatdate BETWEEN r.start_dt AND r.end_dt\n)\nSELECT\n  gameplay_id AS gameplayid,\n  duration_bucket,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM base\nGROUP BY gameplay_id, duration_bucket\nORDER BY gameplay_id, duration_bucket;", "meta": {"origin": "sql_58", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_26_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2024-01-01到2024-12-16，闪了敌人x次、闪了队友x次，除自定义模式、新手、训练场外所有模式。\n输出：闪了敌人x次、闪了队友x次\n【表】dwd_argothek_matchdetails_hi, dwd_argothek_abilityinfo_effects_hi\n【口径】provisioningflowid = \"Matchmaking\" -- 除自定义模式、新手、训练场外所有模式\n\n闪光弹区分逻辑：\n闪到敌人：tag = \"EnemiesBlinded\"\n闪到队友：tag = \"AlliesBlinded\""}, {"role": "assistant", "content": "with valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240101' and '20241216'\n    and provisioningflowid = 'Matchmaking'\n),\nflash_effect as (\n  select\n    tag,\n    sum(coalesce(amount, 0)) as total_cnt\n  from dwd_argothek_abilityinfo_effects_hi e\n  join valid_matches m on e.matchinfomatchid = m.matchid\n  where substr(e.tdbank_imp_date, 1, 8) between '20240101' and '20241216'\n    and tag in ('EnemiesBlinded', 'AlliesBlinded')\n  group by tag\n)\nselect\n  coalesce(max(case when tag = 'EnemiesBlinded' then total_cnt end), 0) as enemies_blinded_cnt,\n  coalesce(max(case when tag = 'AlliesBlinded' then total_cnt end), 0) as allies_blinded_cnt\nfrom flash_effect;"}], "rejected": "with valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) > '20240101'\n    and provisioningflowid = 'Matchmaking'\n),\nflash_effect as (\n  select\n    tag,\n    sum(coalesce(amount, 0)) as total_cnt\n  from dwd_argothek_abilityinfo_effects_hi e\n  join valid_matches m on e.matchinfomatchid = m.matchid\n  where substr(e.tdbank_imp_date, 1, 8) between '20240101' and '20241216'\n    and tag in ('EnemiesBlinded', 'AlliesBlinded')\n  group by tag\n)\nselect\n  coalesce(max(case when tag = 'EnemiesBlinded' then total_cnt end), 0) as enemies_blinded_cnt,\n  coalesce(max(case when tag = 'AlliesBlinded' then total_cnt end), 0) as allies_blinded_cnt\nfrom flash_effect;", "meta": {"origin": "sql_26", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_57_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计限定抽取阶梯活动每天的pv和角色数\n活动日期\t2024.11.30-12.19\t\n输出：日期(20241130、...、20241220、汇总)、pv、uv\n【表】dwd_jordass_activitypress_hi\n【口径】限定抽取阶梯活动：ireason = 2411291018 and buttontype = 10045 and  extarg1 in (117, 115)"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\n-- 查询限定抽取阶梯活动相关数据\nselect\n    dtstatdate,\n    pv,\n    uv\nfrom (\n    -- 按天统计\n    select\n        substr(tdbank_imp_date, 1, 8) as dtstatdate,\n        count(*)                       as pv,\n        count(distinct uid)            as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n    group by substr(tdbank_imp_date, 1, 8)\n\n    union all\n\n    -- 汇总\n    select\n        '汇总' as dtstatdate,\n        count(*)            as pv,\n        count(distinct uid) as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n) f \n\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\n-- 查询限定抽取阶梯活动相关数据\nselect\n    dtstatdate,\n    pv,\n    uv\nfrom (\n    -- 按天统计\n    select\n        substr(tdbank_imp_date, 1, 8) as dtstatdate,\n        count(*)                       as pv,\n        count(distinct uid)            as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n    group by substr(tdbank_imp_date, 1, 8)\n\n    union all\n\n    -- 汇总\n    select\n        '汇总' as dtstatdate,\n        count(*)            as pv,\n        count(distinct uid) as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n) f \n\n) AS final_query;", "meta": {"origin": "sql_57", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_24_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计下列英雄和对应上线日期，新英雄上线首周的持续选择情况。限定除自定义模式，新手、训练场外所有模式\n输出：英雄id、首周选择新英雄次数超过3次的玩家、首周选择新英雄次数超过10次的玩家、首周选择过新英雄的玩家、超过3次的玩家占比、超过10次的玩家占比\n【表】dwd_argothek_playermatchdetail_hi\n【口径】英雄筛选逻辑：\n英雄1上线日期：2023/07/31\n英雄2上线日期：2023/11/06\n英雄3上线日期：2024/04/01\n英雄4上线日期：2024/09/03\n英雄5上线日期：2025/01/14\n英雄6上线日期：2025/03/11\n英雄1对应id:\"e370fa57-4757-3604-3648-499e1f642d3f\",\"cc8b64c8-4b25-4ff9-6e7f-37b4da43d235\"\n英雄2对应id:\"0e38b510-41a8-5780-5e8f-568b2a4f2d6c\"\n英雄3对应id:\"1dbf2edd-4729-0984-3115-daa5eed44993\"\n英雄4对应id:\"efba5359-4016-a1e5-7626-b1ae76895940\"\n英雄5对应id:\"b444168c-4e35-8076-db47-ef9bf368f384\"\n英雄6对应id:\"df1cb487-4902-002e-5c17-d28e83e78588\"\n\n对局筛选逻辑：\nprovisioningflowid = \"Matchmaking\" -- 除自定义模式、新手、训练场外所有模式"}, {"role": "assistant", "content": "WITH heroes AS (\n  SELECT 'e370fa57-4757-3604-3648-499e1f642d3f' AS hero_id, DATE '2023-07-31' AS start_date UNION ALL\n  SELECT 'cc8b64c8-4b25-4ff9-6e7f-37b4da43d235', DATE '2023-07-31' UNION ALL\n  SELECT '0e38b510-41a8-5780-5e8f-568b2a4f2d6c', DATE '2023-11-06' UNION ALL\n  SELECT '1dbf2edd-4729-0984-3115-daa5eed44993', DATE '2024-04-01' UNION ALL\n  SELECT 'efba5359-4016-a1e5-7626-b1ae76895940', DATE '2024-09-03' UNION ALL\n  SELECT 'b444168c-4e35-8076-db47-ef9bf368f384', DATE '2025-01-14' UNION ALL\n  SELECT 'df1cb487-4902-002e-5c17-d28e83e78588', DATE '2025-03-11'\n),\nfirst_week_matches AS (\n  SELECT\n    h.hero_id,\n    md.subject AS player_id,\n    COUNT(*) AS pick_cnt\n  FROM dwd_argothek_playermatchdetail_hi md\n  JOIN heroes h\n    ON md.characterid = h.hero_id\n  WHERE md.provisioningflowid = 'Matchmaking'\n    AND CAST(md.dteventtime AS DATE) BETWEEN h.start_date AND DATE_ADD(h.start_date, INTERVAL 6 DAY)\n  GROUP BY h.hero_id, md.subject\n),\nhero_summary AS (\n  SELECT\n    hero_id,\n    COUNT(*) AS total_players,\n    SUM(CASE WHEN pick_cnt > 3 THEN 1 ELSE 0 END) AS players_over_3,\n    SUM(CASE WHEN pick_cnt > 10 THEN 1 ELSE 0 END) AS players_over_10\n  FROM first_week_matches\n  GROUP BY hero_id\n)\nSELECT\n  hero_id,\n  players_over_3,\n  players_over_10,\n  total_players AS players_over_0,\n  IF(total_players = 0, 0, ROUND(players_over_3 / total_players, 4)) AS ratio_over_3,\n  IF(total_players = 0, 0, ROUND(players_over_10 / total_players, 4)) AS ratio_over_10\nFROM hero_summary\nORDER BY hero_id;"}], "rejected": "WITH heroes AS (\n  SELECT 'e370fa57-4757-3604-3648-499e1f642d3f' AS hero_id, DATE '2023-07-31' AS start_date UNION ALL\n  SELECT 'cc8b64c8-4b25-4ff9-6e7f-37b4da43d235', DATE '2023-07-31' UNION ALL\n  SELECT '0e38b510-41a8-5780-5e8f-568b2a4f2d6c', DATE '2023-11-06' UNION ALL\n  SELECT '1dbf2edd-4729-0984-3115-daa5eed44993', DATE '2024-04-01' UNION ALL\n  SELECT 'efba5359-4016-a1e5-7626-b1ae76895940', DATE '2024-09-03' UNION ALL\n  SELECT 'b444168c-4e35-8076-db47-ef9bf368f384', DATE '2025-01-14' UNION ALL\n  SELECT 'df1cb487-4902-002e-5c17-d28e83e78588', DATE '2025-03-11'\n),\nfirst_week_matches AS (\n  SELECT\n    h.hero_id,\n    md.subject AS player_id,\n    COUNT(*) AS pick_cnt\n  FROM dwd_argothek_playermatchdetail_hi md\n  JOIN heroes h\n    ON md.characterid = h.hero_id\n  WHERE md.provisioningflowid = 'Matchmaking'\n    AND CAST(md.dteventtime AS DATE) BETWEEN h.start_date AND DATE_ADD(h.start_date, INTERVAL 6 DAY)\n  GROUP BY h.hero_id, md.subject\n),\nhero_summary AS (\n  SELECT\n    hero_id,\n    COUNT(*) AS total_players,\n    SUM(CASE WHEN pick_cnt > 3 THEN 1 ELSE 0 END) AS players_over_3,\n    SUM(CASE WHEN pick_cnt > 10 THEN 1 ELSE 0 END) AS players_over_10\n  FROM first_week_matches\n  GROUP BY hero_id\n)\nSELECT\n  hero_id,\n  players_over_3,\n  players_over_10,\n  total_players AS players_over_0,\n  IF(total_players = 0, 0, ROUND(players_over_3 / total_players, 4)) AS ratio_over_3,\n  IF(total_players = 0, 0, ROUND(players_over_10 / total_players, 4)) AS ratio_over_10\nFROM hero_summary\nORDER BY hero_id;", "meta": {"origin": "sql_24", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_3_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年1月勇者盟约端游活跃玩家交叉峡谷端游及手游活跃玩家。\n输出：玩家 gplayerid\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df, dws_mgamejp_login_user_activity_di\n【口径】勇者盟约端游活跃：dws_argothek_oss_login_di.statis_date\n账号映射：dim_argothek_gplayerid2qqwxid_df，字段 swxid_type 对应事实表 suseridtype\n峡谷活跃口径：\nsgamecode = \"initiatived\"\nsaccounttype = \"-100\"\nsuseridtype in (\"qq\",\"wxid\",\"guest\")\nsplattype in (\"-100\",\"PC\")\nsplat IN (\"-100\",\"PC\")\n所有日期使用字符串 YYYYMMDD"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH argothek_active AS (\n  SELECT DISTINCT iuserid AS gplayerid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN '20250104' AND '20250203'\n),\nlatest_map AS (\n  SELECT gplayerid,\n         suserid,\n         swxid_type AS suserid_type\n  FROM (\n    SELECT iuserid AS gplayerid,\n           suserid,\n           swxid_type,\n           ROW_NUMBER() OVER (PARTITION BY iuserid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid2qqwxid_df\n    WHERE dtstatdate <= '20250203'\n      AND suserid IS NOT NULL\n      AND swxid_type IN ('qq', 'wxid')\n  ) t\n  WHERE rn = 1\n),\nxinggu_active AS (\n  SELECT DISTINCT suserid, suseridtype\n  FROM dws_mgamejp_login_user_activity_di\n  WHERE dtstatdate BETWEEN '20250104' AND '20250203'\n    AND sgamecode = 'initiatived'\n    AND saccounttype = '-100'\n    AND suseridtype IN ('qq', 'wxid')\n    AND splattype IN ('-100', 'PC')\n    AND splat IN ('-100','PC')\n)\nSELECT DISTINCT a.gplayerid\nFROM argothek_active a\nJOIN latest_map m\n  ON a.gplayerid = m.gplayerid\nJOIN xinggu_active x\n  ON m.suserid = x.suserid\n AND m.suserid_type = x.suseridtype\nORDER BY a.gplayerid\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH argothek_active AS (\n  SELECT DISTINCT iuserid AS gplayerid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date > '20250104'\n),\nlatest_map AS (\n  SELECT gplayerid,\n         suserid,\n         swxid_type AS suserid_type\n  FROM (\n    SELECT iuserid AS gplayerid,\n           suserid,\n           swxid_type,\n           ROW_NUMBER() OVER (PARTITION BY iuserid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid2qqwxid_df\n    WHERE dtstatdate <= '20250203'\n      AND suserid IS NOT NULL\n      AND swxid_type IN ('qq', 'wxid')\n  ) t\n  WHERE rn = 1\n),\nxinggu_active AS (\n  SELECT DISTINCT suserid, suseridtype\n  FROM dws_mgamejp_login_user_activity_di\n  WHERE dtstatdate BETWEEN '20250104' AND '20250203'\n    AND sgamecode = 'initiatived'\n    AND saccounttype = '-100'\n    AND suseridtype IN ('qq', 'wxid')\n    AND splattype IN ('-100', 'PC')\n    AND splat IN ('-100','PC')\n)\nSELECT DISTINCT a.gplayerid\nFROM argothek_active a\nJOIN latest_map m\n  ON a.gplayerid = m.gplayerid\nJOIN xinggu_active x\n  ON m.suserid = x.suserid\n AND m.suserid_type = x.suseridtype\nORDER BY a.gplayerid\n) AS final_query;", "meta": {"origin": "sql_3", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_10_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.7.12-2025.6.15，赛季bp道具皮肤的使用情况。\n输出：道具id、赛季名称、当前赛季使用人数、当前赛季购买人数\n【表】dwd_argothek_playerloadout_expressions_hi, dwd_argothek_playerloadout_hi, dwd_argothek_playerloadout_sprayslots_hi, dwd_argothek_commercialization_gearid_df, dim_argothek_seasondate_df\n【口径】bp枪皮购买逻辑:\nand purchaseSource = \"BATTLEPASS_PROGRESS\" -- 筛选来源为BATTLEPASS_PROGRESS\nand itemtype = \"d5f120f8-ff8c-4aac-92ea-f2b5acbe9475\" -- 筛选itemtype为指定值\n枪皮使用逻辑：\nexpressionassetid is not null and expressiontypeid = \"d5f120f8-ff8c-4aac-92ea-f2b5acbe9475\""}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH season_calendar AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    MIN(STR_TO_DATE(idate, '%Y%m%d')) AS season_start,\n    MAX(STR_TO_DATE(idate, '%Y%m%d')) AS season_end\n  FROM dim_argothek_seasondate_df\n  WHERE STR_TO_DATE(idate, '%Y%m%d') BETWEEN '2023-07-15' AND '2025-06-18'\n  GROUP BY seasonid, seasonidname\n), usage_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    e.expressionassetid AS item_id,\n    l.subject AS user_id\n  FROM dwd_argothek_playerloadout_expressions_hi e\n  JOIN dwd_argothek_playerloadout_hi l\n    ON e.apeventid = l.apeventid\n  JOIN season_calendar sc\n    ON STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN '2023-07-15' AND '2025-06-18'\n    AND e.expressionassetid IS NOT NULL\n    AND e.expressiontypeid = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n), usage_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT user_id) AS season_use_user_cnt\n  FROM usage_base\n  GROUP BY seasonid, seasonidname, item_id\n), purchase_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    g.purchaseditemid AS item_id,\n    g.vtemp1 AS buyer_id\n  FROM dwd_argothek_commercialization_gearid_df g\n  JOIN season_calendar sc\n    ON STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN '2023-07-15' AND '2025-06-18'\n    AND g.purchasesource = 'BATTLEPASS_PROGRESS'\n    AND g.itemtype = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n    AND g.vtemp1 IS NOT NULL\n), purchase_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT buyer_id) AS season_buy_user_cnt\n  FROM purchase_base\n  GROUP BY seasonid, seasonidname, item_id\n)\nSELECT\n  item_id,\n  season_name,\n  SUM(season_use_user_cnt) AS season_use_user_cnt,\n  SUM(season_buy_user_cnt) AS season_buy_user_cnt\nFROM (\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    season_use_user_cnt,\n    0 AS season_buy_user_cnt\n  FROM usage_agg\n  UNION ALL\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    0 AS season_use_user_cnt,\n    season_buy_user_cnt\n  FROM purchase_agg\n) merged\nGROUP BY item_id, season_name\nORDER BY season_name, item_id\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH season_calendar AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    MIN(STR_TO_DATE(idate, '%Y%m%d')) AS season_start,\n    MAX(STR_TO_DATE(idate, '%Y%m%d')) AS season_end\n  FROM dim_argothek_seasondate_df\n  WHERE STR_TO_DATE(idate, '%Y%m%d') BETWEEN '2023-07-15' AND '2025-06-18'\n  GROUP BY seasonid, seasonidname\n), usage_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    e.expressionassetid AS item_id,\n    l.subject AS user_id\n  FROM dwd_argothek_playerloadout_expressions_hi e\n  JOIN dwd_argothek_playerloadout_hi l\n    ON e.apeventid = l.apeventid\n  JOIN season_calendar sc\n    ON STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN '2023-07-15' AND '2025-06-18'\n    AND e.expressionassetid IS NOT NULL\n    AND e.expressiontypeid = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n), usage_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT user_id) AS season_use_user_cnt\n  FROM usage_base\n  GROUP BY seasonid, seasonidname, item_id\n), purchase_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    g.purchaseditemid AS item_id,\n    g.vtemp1 AS buyer_id\n  FROM dwd_argothek_commercialization_gearid_df g\n  JOIN season_calendar sc\n    ON STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN '2023-07-15' AND '2025-06-18'\n    AND g.purchasesource = 'BATTLEPASS_PROGRESS'\n    AND g.itemtype = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n    AND g.vtemp1 IS NOT NULL\n), purchase_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT buyer_id) AS season_buy_user_cnt\n  FROM purchase_base\n  GROUP BY seasonid, seasonidname, item_id\n)\nSELECT\n  item_id,\n  season_name,\n  SUM(season_use_user_cnt) AS season_use_user_cnt,\n  SUM(season_buy_user_cnt) AS season_buy_user_cnt\nFROM (\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    season_use_user_cnt,\n    0 AS season_buy_user_cnt\n  FROM usage_agg\n  UNION ALL\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    0 AS season_use_user_cnt,\n    season_buy_user_cnt\n  FROM purchase_agg\n) merged\nGROUP BY item_id, season_name\nORDER BY season_name, item_id\n) AS final_query;", "meta": {"origin": "sql_10", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_70_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.11.29-2024.12.19期间，不同抽奖档位的对应人数\n输出 抽奖档位（含汇总档位），人数\n【表】dwd_jordass_activity_rewardrecord_hi\n【口径】抽奖活动：actid = 2411291018\n汇总：额外计算一个全档位统计组"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241130' and '20241220'\n    and actid = 2411291018\n)\nselect\n  award_type,\n  user_cnt\nfrom (\n  select\n    award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n  group by award_type\n  union all\n  select\n    '汇总' as award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n) t\norder by case when award_type = '汇总' then 1 else 0 end, award_type\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) > '20241130'\n    and actid = 2411291018\n)\nselect\n  award_type,\n  user_cnt\nfrom (\n  select\n    award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n  group by award_type\n  union all\n  select\n    '汇总' as award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n) t\norder by case when award_type = '汇总' then 1 else 0 end, award_type\n) AS final_query;", "meta": {"origin": "sql_70", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_46_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.1.1-2024.2.2期间，每个自然周不同周活跃天数玩家数\n输出：统计周(1、2、3...、5)、周活跃天数、玩家数\n【表】dws_jordass_login_di\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n    week, -- 统计周\n    active_days, -- 活跃天数\n    count(distinct vplayerid) as user_num -- 玩家数\nfrom (\n    select\n        vplayerid, -- 玩家playerid\n        weekofyear(dtstatdate) as week, -- 统计周\n        count(distinct dtstatdate) as active_days -- 活跃天数\n    from dws_jordass_login_di\n    where dtstatdate >= '20240128' and dtstatdate <= '20240229' and platid=255\n    group by\n        vplayerid,\n        weekofyear(dtstatdate)\n)f\ngroup by\n    week,\n    active_days;"}], "rejected": "select\n    week, -- 统计周\n    active_days, -- 活跃天数\n    count(distinct vplayerid) as user_num -- 玩家数\nfrom (\n    select\n        vplayerid, -- 玩家playerid\n        weekofyear(dtstatdate) as week, -- 统计周\n        count(distinct dtstatdate) as active_days -- 活跃天数\n    from dws_jordass_login_di\n    where dtstatdate >= '20240128' and dtstatdate <= '20240229' and platid=255\n    group by\n        vplayerid,\n        weekofyear(dtstatdate)\n)f\ngroup by\n    week,\n    active_days;", "meta": {"origin": "sql_46", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_35_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024年3月26日~4月3日\n2024年5月28日~6月5日\n不同对局类型的游戏和玩法留存情况\n输出：统计日期(20240401、...、20240409、20240603、...、20240611)、对局类型（第一人称、单排、双排、四排），每日对局人数、次数、对局总时长(秒)、游戏次留人数、游戏7留人数，玩法次留人数、玩法7留人数\n【表】dws_jordass_login_di, dws_jordass_mode_roundrecord_di\n【口径】第一人称：mode 的取值在 401、402 或 403；\n单排： mode 等于 101；\n双排： mode 等于 102；\n四排： mode 等于 103 或 603。\n\n玩法次留：当天参与玩法且第二天同样参与玩法\n游戏次留：当天在游戏活跃且第2天也在游戏活跃"}, {"role": "assistant", "content": "with round_user as (\n    select dtstatdate,\n        case \n            when mode in (401,402,403) then '第一人称'\n            when mode =101 then '单排'\n            when mode =102 then '双排'\n            when mode in (103,603) then '四排'\n        end modename,\n        vplayerid,\n        sum(roundcnt) roundcnt,\n        sum(roundtime) roundtime\n    from dws_jordass_mode_roundrecord_di\n    where ((dtstatdate between '20240401' and '20240415')\n    or (dtstatdate between '20240603' and '20240617'))\n    and mode in (401,402,403,101,102,103,603)\n    group by dtstatdate,\n    case when mode in (401,402,403) then '第一人称'\n        when mode =101 then '单排'\n        when mode =102 then '双排'\n        when mode in (103,603) then '四排'\n    end,\n    vplayerid\n)\n\nselect \n    a.dtstatdate,\n    a.modename,\n    count(distinct a.vplayerid) iusernum,\n    sum(a.roundcnt) roundcnt,\n    sum(a.roundtime) roundtime,\n    count(distinct b1.vplayerid) stay2,\n    count(distinct b2.vplayerid) stay7,\n    count(distinct c1.vplayerid) playstay2,\n    count(distinct c2.vplayerid) playstay7\nfrom (\n    select * from round_user \n    where((dtstatdate between '20240401' and '20240409') or (dtstatdate between '20240603' and '20240611'))\n) a\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240401' and '20240410') or (dtstatdate between '20240603' and '20240612')) \n    and platid =255\n    group by dtstatdate,vplayerid\n) b1 \non a.vplayerid = b1.vplayerid and date_add(a.dtstatdate,1) = b1.dtstatdate\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240401' and '20240415') or (dtstatdate between '20240603' and '20240617')) and platid =255\n    group by dtstatdate,vplayerid\n) b2 \non a.vplayerid = b2.vplayerid and date_add(a.dtstatdate,6) = b2.dtstatdate\nleft join round_user c1 \non a.vplayerid = c1.vplayerid and date_add(a.dtstatdate,1) = c1.dtstatdate and a.modename= c1.modename\nleft join round_user c2 \non a.vplayerid = c2.vplayerid and date_add(a.dtstatdate,6) = c2.dtstatdate and a.modename= c2.modename\ngroup by a.dtstatdate,a.modename\n;"}], "rejected": "with round_user as (\n    select dtstatdate,\n        case \n            when mode in (401,402,403) then '第一人称'\n            when mode =101 then '单排'\n            when mode =102 then '双排'\n            when mode in (103,603) then '四排'\n        end modename,\n        vplayerid,\n        sum(roundcnt) roundcnt,\n        sum(roundtime) roundtime\n    from dws_jordass_mode_roundrecord_di\n    where ((dtstatdate > '20240401')\n    or (dtstatdate between '20240603' and '20240617'))\n    and mode in (401,402,403,101,102,103,603)\n    group by dtstatdate,\n    case when mode in (401,402,403) then '第一人称'\n        when mode =101 then '单排'\n        when mode =102 then '双排'\n        when mode in (103,603) then '四排'\n    end,\n    vplayerid\n)\n\nselect \n    a.dtstatdate,\n    a.modename,\n    count(distinct a.vplayerid) iusernum,\n    sum(a.roundcnt) roundcnt,\n    sum(a.roundtime) roundtime,\n    count(distinct b1.vplayerid) stay2,\n    count(distinct b2.vplayerid) stay7,\n    count(distinct c1.vplayerid) playstay2,\n    count(distinct c2.vplayerid) playstay7\nfrom (\n    select * from round_user \n    where((dtstatdate between '20240401' and '20240409') or (dtstatdate between '20240603' and '20240611'))\n) a\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240401' and '20240410') or (dtstatdate between '20240603' and '20240612')) \n    and platid =255\n    group by dtstatdate,vplayerid\n) b1 \non a.vplayerid = b1.vplayerid and date_add(a.dtstatdate,1) = b1.dtstatdate\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240401' and '20240415') or (dtstatdate between '20240603' and '20240617')) and platid =255\n    group by dtstatdate,vplayerid\n) b2 \non a.vplayerid = b2.vplayerid and date_add(a.dtstatdate,6) = b2.dtstatdate\nleft join round_user c1 \non a.vplayerid = c1.vplayerid and date_add(a.dtstatdate,1) = c1.dtstatdate and a.modename= c1.modename\nleft join round_user c2 \non a.vplayerid = c2.vplayerid and date_add(a.dtstatdate,6) = c2.dtstatdate and a.modename= c2.modename\ngroup by a.dtstatdate,a.modename\n;", "meta": {"origin": "sql_35", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_82_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20220408-20220410第三人称四排用户中 玩法类型（群屿 山峦 假日群岛）赛季等级总积分的人数\n输出：玩法类型，赛季等级，总积分范围（[1,2) 、[2,3).. 左闭右开），人数\n【表】dwd_jordass_roundflow_hi\n【口径】总积分计算：群屿需要乘1.2，其他乘1\n群屿: submode in (1001, 1002, 1003, 1064, 1065, 1066, 1076, 1077, 1078, 1091, 1092, 1093, 1137, 1138, 1139, 1143, 1144, 1145, 1152, 1153, 1154, 1158, 1159, 1160, 2029, 2030, 2031, 2044, 2045, 2046, 2122, 2123, 2124, 2129, 2130, 2131, 2166, 2167, 2168, 2169, 2170, 2171, 2172, 2173, 2174, 2203, 2216, 2217, 2218, 2219, 2220, 2221, 2297, 2298, 2299, 2300, 2301, 2302, 2304, 2305, 2306, 2322, 2323, 2324, 2325, 2326, 2327, 2359, 2360, 2361, 2368, 2367, 2366, 2419, 2420, 2421, 2422, 2423, 2424, 2425, 2426, 2427, 2453, 2454, 2455, 2460, 2461, 2462, 2472, 2473, 2474, 2463, 2464, 2465, 2466, 2467, 2468), 山峦: submode in (2160, 2161, 2162, 2163, 2164, 2165, 2334, 2335, 2336, 2337, 2338, 2339), 假日群岛: submode in (2396, 2397, 2398, 2399, 2400, 2401)\n第三人称四排限定mode=103\n赛季积分逻辑：ChangedRatingValue/(SurvivalTime / 60)"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH base AS (\n  SELECT\n    vplayerid,\n    uid,\n    submode,\n    allianceforceterlevel,\n    CAST(dteventtime AS DATETIME) AS event_time,\n    changedratingvalue,\n    survivaltime\n  FROM dwd_jordass_roundflow_hi\n  WHERE mode = 103\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2022-04-09 00:00:00' AND '2022-04-11 23:59:59'\n    AND submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468,2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339,2396,2397,2398,2399,2400,2401)\n), categorized AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN '群屿'\n      WHEN submode IN (2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339) THEN '山峦'\n      WHEN submode IN (2396,2397,2398,2399,2400,2401) THEN '假日群岛'\n      ELSE '其他'\n    END AS play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN changedratingvalue * 1.2\n      ELSE changedratingvalue\n    END AS adjusted_rating,\n    survivaltime\n  FROM base\n), aggregated AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    vplayerid,\n    SUM(CASE WHEN survivaltime > 0 THEN adjusted_rating / (survivaltime / 60.0) ELSE 0 END) AS total_points\n  FROM categorized\n  GROUP BY play_type, allianceforceterlevel, vplayerid\n), bucketed AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN total_points IS NULL THEN '[0,1)'\n      ELSE CONCAT('[', CAST(FLOOR(GREATEST(total_points, 0)) AS STRING), ',', CAST(FLOOR(GREATEST(total_points, 0)) + 1 AS STRING), ')')\n    END AS points_range,\n    vplayerid\n  FROM aggregated\n)\nSELECT\n  play_type,\n  allianceforceterlevel AS season_level,\n  points_range,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM bucketed\nGROUP BY play_type, allianceforceterlevel, points_range\nORDER BY play_type, allianceforceterlevel, points_range\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH base AS (\n  SELECT\n    vplayerid,\n    uid,\n    submode,\n    allianceforceterlevel,\n    CAST(dteventtime AS DATETIME) AS event_time,\n    changedratingvalue,\n    survivaltime\n  FROM dwd_jordass_roundflow_hi\n  WHERE mode = 103\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2022-04-09 00:00:00' AND '2022-04-11 23:59:59'\n    AND submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468,2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339,2396,2397,2398,2399,2400,2401)\n), categorized AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN '群屿'\n      WHEN submode IN (2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339) THEN '山峦'\n      WHEN submode IN (2396,2397,2398,2399,2400,2401) THEN '假日群岛'\n      ELSE '其他'\n    END AS play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN changedratingvalue * 1.2\n      ELSE changedratingvalue\n    END AS adjusted_rating,\n    survivaltime\n  FROM base\n), aggregated AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    vplayerid,\n    SUM(CASE WHEN survivaltime > 0 THEN adjusted_rating / (survivaltime / 60.0) ELSE 0 END) AS total_points\n  FROM categorized\n  GROUP BY play_type, allianceforceterlevel, vplayerid\n), bucketed AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN total_points IS NULL THEN '[0,1)'\n      ELSE CONCAT('[', CAST(FLOOR(GREATEST(total_points, 0)) AS STRING), ',', CAST(FLOOR(GREATEST(total_points, 0)) + 1 AS STRING), ')')\n    END AS points_range,\n    vplayerid\n  FROM aggregated\n)\nSELECT\n  play_type,\n  allianceforceterlevel AS season_level,\n  points_range,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM bucketed\nGROUP BY play_type, allianceforceterlevel, points_range\nORDER BY play_type, allianceforceterlevel, points_range\n) AS final_query;", "meta": {"origin": "sql_82", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_87_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.07.02和2023.07.09 参与乐园各子玩法的用户里，砺刃新进、回流、留存用户数\n注：新进，回流，留存都按照7天为一个周期来计算\n输出：统计日期（YYYYMMDD），玩法，类型（新进、回流、留存），人数\n【表】dws_jordass_login_df, dim_jordass_leyuan_participate_cdf_nf\n【口径】乐园玩法子用户筛选条件：\ninstr(substr(cbitmap,1,7),'1')>0\n回流与留存计算：\ncase when datediff(dtstatdate,dregdate)<=6 then '新进'\nwhen instr(substr(cbitmap,8,7),'1')>0 then '留存'\nwhen instr(substr(cbitmap,8,7),'1')=0 then '回流'\n注意只需要统计上述三种类型"}, {"role": "assistant", "content": "SELECT\n  dtstatdate AS stat_date,\n  matchsubmodegroup AS play_mode,\n  CASE\n    WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n    WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n    ELSE '回流'\n  END AS user_type,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM dim_jordass_leyuan_participate_cdf_nf\nWHERE dtstatdate IN ('20230703', '20230710')\n  AND INSTR(SUBSTR(cbitmap, 1, 7), '1') > 0\n  AND CASE\n        WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n        WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n        ELSE '回流'\n      END IN ('新进', '留存', '回流')\nGROUP BY dtstatdate, matchsubmodegroup,\n         CASE\n           WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n           WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n           ELSE '回流'\n         END\nORDER BY stat_date, play_mode, user_type;"}], "rejected": "SELECT\n  dtstatdate AS stat_date,\n  matchsubmodegroup AS play_mode,\n  CASE\n    WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n    WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n    ELSE '回流'\n  END AS user_type,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM dim_jordass_leyuan_participate_cdf_nf\nWHERE dtstatdate IN ('20230703', '20230710')\n  AND INSTR(SUBSTR(cbitmap, 1, 7), '1') > 0\n  AND CASE\n        WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n        WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n        ELSE '回流'\n      END IN ('新进', '留存', '回流')\nGROUP BY dtstatdate, matchsubmodegroup,\n         CASE\n           WHEN DATEDIFF(STR_TO_DATE(dtstatdate, '%Y%m%d'), STR_TO_DATE(dregdate, '%Y%m%d')) <= 6 THEN '新进'\n           WHEN INSTR(SUBSTR(cbitmap, 8, 7), '1') > 0 THEN '留存'\n           ELSE '回流'\n         END\nORDER BY stat_date, play_mode, user_type;", "meta": {"origin": "sql_87", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_3_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年1月勇者盟约端游活跃玩家交叉峡谷端游及手游活跃玩家。\n输出：玩家 gplayerid\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df, dws_mgamejp_login_user_activity_di\n【口径】勇者盟约端游活跃：dws_argothek_oss_login_di.statis_date\n账号映射：dim_argothek_gplayerid2qqwxid_df，字段 swxid_type 对应事实表 suseridtype\n峡谷活跃口径：\nsgamecode = \"initiatived\"\nsaccounttype = \"-100\"\nsuseridtype in (\"qq\",\"wxid\")\n所有日期使用字符串 YYYYMMDD\n可选过滤：以上条件可按需勾选。\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH argothek_active AS (\n  SELECT DISTINCT iuserid AS gplayerid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN '20250128' AND '20250227'\n),\nlatest_map AS (\n  SELECT gplayerid,\n         suserid,\n         swxid_type AS suserid_type\n  FROM (\n    SELECT iuserid AS gplayerid,\n           suserid,\n           swxid_type,\n           ROW_NUMBER() OVER (PARTITION BY iuserid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid2qqwxid_df\n    WHERE dtstatdate <= '20250227'\n      AND suserid IS NOT NULL\n      AND swxid_type IN ('qq', 'wxid')\n  ) t\n  WHERE rn = 1\n),\nxinggu_active AS (\n  SELECT DISTINCT suserid, suseridtype\n  FROM dws_mgamejp_login_user_activity_di\n  WHERE dtstatdate BETWEEN '20250128' AND '20250227'\n    AND sgamecode = 'initiatived'\n    AND saccounttype = '-100'\n    AND suseridtype IN ('qq', 'wxid')\n    AND splattype IN ('-100', 'PC')\n    AND splat = '-100'\n)\nSELECT DISTINCT a.gplayerid\nFROM argothek_active a\nJOIN latest_map m\n  ON a.gplayerid = m.gplayerid\nJOIN xinggu_active x\n  ON m.suserid = x.suserid\n AND m.suserid_type = x.suseridtype\nORDER BY a.gplayerid;"}], "rejected": "WITH argothek_active AS (\n  SELECT DISTINCT iuserid AS gplayerid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date > '20250128'\n),\nlatest_map AS (\n  SELECT gplayerid,\n         suserid,\n         swxid_type AS suserid_type\n  FROM (\n    SELECT iuserid AS gplayerid,\n           suserid,\n           swxid_type,\n           ROW_NUMBER() OVER (PARTITION BY iuserid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid2qqwxid_df\n    WHERE dtstatdate <= '20250227'\n      AND suserid IS NOT NULL\n      AND swxid_type IN ('qq', 'wxid')\n  ) t\n  WHERE rn = 1\n),\nxinggu_active AS (\n  SELECT DISTINCT suserid, suseridtype\n  FROM dws_mgamejp_login_user_activity_di\n  WHERE dtstatdate BETWEEN '20250128' AND '20250227'\n    AND sgamecode = 'initiatived'\n    AND saccounttype = '-100'\n    AND suseridtype IN ('qq', 'wxid')\n    AND splattype IN ('-100', 'PC')\n    AND splat = '-100'\n)\nSELECT DISTINCT a.gplayerid\nFROM argothek_active a\nJOIN latest_map m\n  ON a.gplayerid = m.gplayerid\nJOIN xinggu_active x\n  ON m.suserid = x.suserid\n AND m.suserid_type = x.suseridtype\nORDER BY a.gplayerid;", "meta": {"origin": "sql_3", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_34_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.9.17-2024.9.23 和 2024.10.8-2024.10.18    每天点击按钮后加入玩法，再之后点击确认的人数，以及这些人加入玩法的次数                                                       \n输出：日期(20240921、...、20240927、20241012、...、20241018)，人数，人次\n【表】dws_jordass_buttonpress_pre_di\n【口径】buttontype为411111代表点击按钮，411120代表加入玩法，411123代表确认"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n    ds,\n    count(distinct vplayerid) as user_cnt,\n    count(distinct vplayerid, irank) as user_times\nfrom (\n    select\n        s2.ds,\n        s2.vplayerid,\n        s2.irank\n    from (\n        -- 获取411111事件（点击按钮）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411111\n        and  ((dtstatdate between '20240921' and '20240927') or (dtstatdate between '20241012' and '20241018'))\n    ) s1\n    join (\n        -- 获取411120事件（加入玩法）并编号\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime,\n            row_number() over (partition by vplayerid order by dteventtime) as irank\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411120\n        and ((dtstatdate between '20240921' and '20240927') or (dtstatdate between '20241012' and '20241018'))\n    ) s2 on s1.vplayerid = s2.vplayerid and s1.ds = s2.ds and s2.dteventtime > s1.dteventtime\n    join (\n        -- 获取411123事件（确认动作）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411123\n        and ((dtstatdate between '20240921' and '20240927') or (dtstatdate between '20241012' and '20241018'))\n    ) s3 on s2.vplayerid = s3.vplayerid and s2.ds = s3.ds and s3.dteventtime > s2.dteventtime\n)f \ngroup by ds\n\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n    ds,\n    count(distinct vplayerid) as user_cnt,\n    count(distinct vplayerid, irank) as user_times\nfrom (\n    select\n        s2.ds,\n        s2.vplayerid,\n        s2.irank\n    from (\n        -- 获取411111事件（点击按钮）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411111\n        and  ((dtstatdate > '20240921') or (dtstatdate between '20241012' and '20241018'))\n    ) s1\n    join (\n        -- 获取411120事件（加入玩法）并编号\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime,\n            row_number() over (partition by vplayerid order by dteventtime) as irank\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411120\n        and ((dtstatdate between '20240921' and '20240927') or (dtstatdate between '20241012' and '20241018'))\n    ) s2 on s1.vplayerid = s2.vplayerid and s1.ds = s2.ds and s2.dteventtime > s1.dteventtime\n    join (\n        -- 获取411123事件（确认动作）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411123\n        and ((dtstatdate between '20240921' and '20240927') or (dtstatdate between '20241012' and '20241018'))\n    ) s3 on s2.vplayerid = s3.vplayerid and s2.ds = s3.ds and s3.dteventtime > s2.dteventtime\n)f \ngroup by ds\n\n) AS final_query;", "meta": {"origin": "sql_34", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_57_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计限定抽取阶梯活动每天的pv和角色数\n活动日期\t2024.12.02-12.19\t\n输出：日期(20241202、...、20241222、汇总)、pv、uv\n【表】dwd_jordass_activitypress_hi\n【口径】限定抽取阶梯活动：ireason = 2411291018 and buttontype = 10045 and  extarg1 in (117, 115)"}, {"role": "assistant", "content": "-- 查询限定抽取阶梯活动相关数据\nselect\n    dtstatdate,\n    pv,\n    uv\nfrom (\n    -- 按天统计\n    select\n        substr(tdbank_imp_date, 1, 8) as dtstatdate,\n        count(*)                       as pv,\n        count(distinct uid)            as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n    group by substr(tdbank_imp_date, 1, 8)\n\n    union all\n\n    -- 汇总\n    select\n        '汇总' as dtstatdate,\n        count(*)            as pv,\n        count(distinct uid) as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n) f \n;"}], "rejected": "-- 查询限定抽取阶梯活动相关数据\nselect\n    dtstatdate,\n    pv,\n    uv\nfrom (\n    -- 按天统计\n    select\n        substr(tdbank_imp_date, 1, 8) as dtstatdate,\n        count(*)                       as pv,\n        count(distinct uid)            as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n    group by substr(tdbank_imp_date, 1, 8)\n\n    union all\n\n    -- 汇总\n    select\n        '汇总' as dtstatdate,\n        count(*)            as pv,\n        count(distinct uid) as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n) f \n;", "meta": {"origin": "sql_57", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_82_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20220408-20220410第三人称四排用户中 玩法类型（群屿 山峦 假日群岛）赛季等级总积分的人数\n输出：玩法类型，赛季等级，总积分范围（[1,2) 、[2,3).. 左闭右开），人数\n【表】dwd_jordass_roundflow_hi\n【口径】总积分计算：群屿需要乘1.2，其他乘1\n群屿: submode in (1001, 1002, 1003, 1064, 1065, 1066, 1076, 1077, 1078, 1091, 1092, 1093, 1137, 1138, 1139, 1143, 1144, 1145, 1152, 1153, 1154, 1158, 1159, 1160, 2029, 2030, 2031, 2044, 2045, 2046, 2122, 2123, 2124, 2129, 2130, 2131, 2166, 2167, 2168, 2169, 2170, 2171, 2172, 2173, 2174, 2203, 2216, 2217, 2218, 2219, 2220, 2221, 2297, 2298, 2299, 2300, 2301, 2302, 2304, 2305, 2306, 2322, 2323, 2324, 2325, 2326, 2327, 2359, 2360, 2361, 2368, 2367, 2366, 2419, 2420, 2421, 2422, 2423, 2424, 2425, 2426, 2427, 2453, 2454, 2455, 2460, 2461, 2462, 2472, 2473, 2474, 2463, 2464, 2465, 2466, 2467, 2468), 山峦: submode in (2160, 2161, 2162, 2163, 2164, 2165, 2334, 2335, 2336, 2337, 2338, 2339), 假日群岛: submode in (2396, 2397, 2398, 2399, 2400, 2401)\n第三人称四排限定mode=103\n赛季积分逻辑：ChangedRatingValue/(SurvivalTime / 60)"}, {"role": "assistant", "content": "WITH base AS (\n  SELECT\n    vplayerid,\n    uid,\n    submode,\n    allianceforceterlevel,\n    CAST(dteventtime AS DATETIME) AS event_time,\n    changedratingvalue,\n    survivaltime\n  FROM dwd_jordass_roundflow_hi\n  WHERE mode = 103\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2022-04-11 00:00:00' AND '2022-04-13 23:59:59'\n    AND submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468,2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339,2396,2397,2398,2399,2400,2401)\n), categorized AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN '群屿'\n      WHEN submode IN (2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339) THEN '山峦'\n      WHEN submode IN (2396,2397,2398,2399,2400,2401) THEN '假日群岛'\n      ELSE '其他'\n    END AS play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN changedratingvalue * 1.2\n      ELSE changedratingvalue\n    END AS adjusted_rating,\n    survivaltime\n  FROM base\n), aggregated AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    vplayerid,\n    SUM(CASE WHEN survivaltime > 0 THEN adjusted_rating / (survivaltime / 60.0) ELSE 0 END) AS total_points\n  FROM categorized\n  GROUP BY play_type, allianceforceterlevel, vplayerid\n), bucketed AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN total_points IS NULL THEN '[0,1)'\n      ELSE CONCAT('[', CAST(FLOOR(GREATEST(total_points, 0)) AS STRING), ',', CAST(FLOOR(GREATEST(total_points, 0)) + 1 AS STRING), ')')\n    END AS points_range,\n    vplayerid\n  FROM aggregated\n)\nSELECT\n  play_type,\n  allianceforceterlevel AS season_level,\n  points_range,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM bucketed\nGROUP BY play_type, allianceforceterlevel, points_range\nORDER BY play_type, allianceforceterlevel, points_range;"}], "rejected": "WITH base AS (\n  SELECT\n    vplayerid,\n    uid,\n    submode,\n    allianceforceterlevel,\n    CAST(dteventtime AS DATETIME) AS event_time,\n    changedratingvalue,\n    survivaltime\n  FROM dwd_jordass_roundflow_hi\n  WHERE mode = 103\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2022-04-11 00:00:00' AND '2022-04-13 23:59:59'\n    AND submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468,2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339,2396,2397,2398,2399,2400,2401)\n), categorized AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN '群屿'\n      WHEN submode IN (2160,2161,2162,2163,2164,2165,2334,2335,2336,2337,2338,2339) THEN '山峦'\n      WHEN submode IN (2396,2397,2398,2399,2400,2401) THEN '假日群岛'\n      ELSE '其他'\n    END AS play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN submode IN (1001,1002,1003,1064,1065,1066,1076,1077,1078,1091,1092,1093,1137,1138,1139,1143,1144,1145,1152,1153,1154,1158,1159,1160,2029,2030,2031,2044,2045,2046,2122,2123,2124,2129,2130,2131,2166,2167,2168,2169,2170,2171,2172,2173,2174,2203,2216,2217,2218,2219,2220,2221,2297,2298,2299,2300,2301,2302,2304,2305,2306,2322,2323,2324,2325,2326,2327,2359,2360,2361,2368,2367,2366,2419,2420,2421,2422,2423,2424,2425,2426,2427,2453,2454,2455,2460,2461,2462,2472,2473,2474,2463,2464,2465,2466,2467,2468) THEN changedratingvalue * 1.2\n      ELSE changedratingvalue\n    END AS adjusted_rating,\n    survivaltime\n  FROM base\n), aggregated AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    vplayerid,\n    SUM(CASE WHEN survivaltime > 0 THEN adjusted_rating / (survivaltime / 60.0) ELSE 0 END) AS total_points\n  FROM categorized\n  GROUP BY play_type, allianceforceterlevel, vplayerid\n), bucketed AS (\n  SELECT\n    play_type,\n    allianceforceterlevel,\n    CASE\n      WHEN total_points IS NULL THEN '[0,1)'\n      ELSE CONCAT('[', CAST(FLOOR(GREATEST(total_points, 0)) AS STRING), ',', CAST(FLOOR(GREATEST(total_points, 0)) + 1 AS STRING), ')')\n    END AS points_range,\n    vplayerid\n  FROM aggregated\n)\nSELECT\n  play_type,\n  allianceforceterlevel AS season_level,\n  points_range,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM bucketed\nGROUP BY play_type, allianceforceterlevel, points_range\nORDER BY play_type, allianceforceterlevel, points_range;", "meta": {"origin": "sql_82", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_107_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2022.1.18-1.24与2021.10.19-12.20这两个时间段\n buttontype =99123并且 ireason=3的人数，以及两个时间段都满足条件的交叉人数\n输出：2022.1.18-1.24人数，2021.10.23-12.20人数，两个时间段交叉的人数\n【表】dwd_jordass_activitypress_hi\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith period_a as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2022011800' and '2022012423'\n    and buttontype = 99123\n    and ireason = 3\n),\nperiod_b as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2021101900' and '2021122023'\n    and buttontype = 99123\n    and ireason = 3\n)\nselect\n  (select count(*) from period_a) as cnt_period_a,\n  (select count(*) from period_b) as cnt_period_b,\n  (select count(*) from period_a a join period_b b on a.uid = b.uid) as cnt_overlap\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith period_a as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2022011800' and '2022012423'\n    and buttontype = 99123\n    and ireason = 3\n),\nperiod_b as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2021101900' and '2021122023'\n    and buttontype = 99123\n    and ireason = 3\n)\nselect\n  (select count(*) from period_a) as cnt_period_a,\n  (select count(*) from period_b) as cnt_period_b,\n  (select count(*) from period_a a join period_b b on a.uid = b.uid) as cnt_overlap\n) AS final_query;", "meta": {"origin": "sql_107", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_20_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20240101-20240430，网吧特权用户的指标数据。\n输出：\n月份（按月：202401、202402、202403、202404）\n人均对局时长（小时）\n网吧时间占当月游戏时间比例\n有对局的天数\n排位模式时长（小时）\n排位模式组队率\n月付费率\n月ARPA\n月ARPPA\n高校特权激活率\n【表】dws_argothek_oss_login_di, dwd_argothek_playerlogout_hi, dws_argothek_oss_portaltransaction_di, dwd_argothek_playermatchstats_hi\n【口径】排位模式：queueId=\"competitive\"\n网吧特权：inetbarlevel = 2\n高校特权：icampuslevel > 0\n网吧在线时长先筛选网吧渠道"}, {"role": "assistant", "content": "WITH netbar_users AS (\n  SELECT DISTINCT iuserid AS player_id\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-01' AND '2024-04-30'\n    AND inetbarlevel = '2'\n),\nlogin_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(CAST(statis_date AS VARCHAR), '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ionlinetime) AS total_online_time,\n    SUM(CASE WHEN iloginway IN (1,10,11,12,20,28,29,30,31,32,33,34,35,36) THEN ionlinetime ELSE 0 END) AS netbar_online_time,\n    COUNT(DISTINCT statis_date) AS active_days\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20240101 AND 20240430\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nmatch_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    vroleid AS player_id,\n    SUM(gamelengthmillis) / 1000.0 AS total_match_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN gamelengthmillis ELSE 0 END) / 1000.0 AS competitive_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN 1 ELSE 0 END) AS competitive_matches,\n    SUM(CASE WHEN queueid = 'competitive' AND partyid IS NOT NULL AND partyid <> '' THEN 1 ELSE 0 END) AS competitive_team_matches,\n    COUNT(DISTINCT CAST(dteventtime AS DATE)) AS match_days\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-01' AND '2024-04-30'\n    AND vroleid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, vroleid\n),\npay_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(statis_date, '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ftranamt) / 100.0 AS pay_amount\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date BETWEEN '20240101' AND '20240430'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\ncampus_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    MAX(CASE WHEN icampuslevel IS NOT NULL AND icampuslevel <> '0' THEN 1 ELSE 0 END) AS campus_active\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-01' AND '2024-04-30'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nplayer_month AS (\n  SELECT stat_month, player_id FROM login_agg\n  UNION\n  SELECT stat_month, player_id FROM match_agg\n  UNION\n  SELECT stat_month, player_id FROM pay_agg\n  UNION\n  SELECT stat_month, player_id FROM campus_agg\n),\nmonthly_union AS (\n  SELECT\n    pm.stat_month,\n    pm.player_id,\n    COALESCE(l.total_online_time, 0) AS total_online_time,\n    COALESCE(l.netbar_online_time, 0) AS netbar_online_time,\n    COALESCE(l.active_days, 0) AS active_days,\n    COALESCE(m.total_match_seconds, 0) AS total_match_seconds,\n    COALESCE(m.competitive_seconds, 0) AS competitive_seconds,\n    COALESCE(m.competitive_matches, 0) AS competitive_matches,\n    COALESCE(m.competitive_team_matches, 0) AS competitive_team_matches,\n    COALESCE(m.match_days, 0) AS match_days,\n    COALESCE(p.pay_amount, 0) AS pay_amount,\n    COALESCE(c.campus_active, 0) AS campus_active\n  FROM player_month pm\n  LEFT JOIN login_agg l ON pm.stat_month = l.stat_month AND pm.player_id = l.player_id\n  LEFT JOIN match_agg m ON pm.stat_month = m.stat_month AND pm.player_id = m.player_id\n  LEFT JOIN pay_agg p ON pm.stat_month = p.stat_month AND pm.player_id = p.player_id\n  LEFT JOIN campus_agg c ON pm.stat_month = c.stat_month AND pm.player_id = c.player_id\n),\nmonths AS (\n  SELECT '202401' AS stat_month UNION ALL\n  SELECT '202402' UNION ALL\n  SELECT '202403' UNION ALL\n  SELECT '202404'\n),\nfinal_stats AS (\n  SELECT\n    stat_month,\n    COUNT(DISTINCT player_id) AS player_cnt,\n    SUM(total_match_seconds) AS total_match_seconds,\n    SUM(netbar_online_time) AS total_netbar_online_time,\n    SUM(total_online_time) AS total_online_time,\n    SUM(match_days) AS match_days,\n    SUM(competitive_seconds) AS total_competitive_seconds,\n    SUM(competitive_team_matches) AS total_competitive_team_matches,\n    SUM(competitive_matches) AS total_competitive_matches,\n    SUM(pay_amount) AS total_pay_amount,\n    COUNT(DISTINCT CASE WHEN pay_amount > 0 THEN player_id END) AS pay_user_cnt,\n    SUM(campus_active) AS campus_active_sum\n  FROM monthly_union\n  GROUP BY stat_month\n)\nSELECT\n  m.stat_month,\n  COALESCE(ROUND(final_stats.total_match_seconds / 3600 / NULLIF(final_stats.player_cnt, 0), 4), 0) AS avg_match_hours,\n  COALESCE(ROUND(final_stats.total_netbar_online_time / NULLIF(final_stats.total_online_time, 0), 4), 0) AS netbar_time_ratio,\n  COALESCE(final_stats.match_days, 0) AS match_days_cnt,\n  COALESCE(ROUND(final_stats.total_competitive_seconds / 3600, 4), 0) AS competitive_hours,\n  COALESCE(ROUND(final_stats.total_competitive_team_matches / NULLIF(final_stats.total_competitive_matches, 0), 4), 0) AS competitive_team_rate,\n  COALESCE(ROUND(final_stats.pay_user_cnt / NULLIF(final_stats.player_cnt, 0), 4), 0) AS pay_rate,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.player_cnt, 0), 4), 0) AS arpa,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.pay_user_cnt, 0), 4), 0) AS arppa,\n  COALESCE(ROUND(final_stats.campus_active_sum / NULLIF(final_stats.player_cnt, 0), 4), 0) AS campus_active_rate\nFROM months m\nLEFT JOIN final_stats ON m.stat_month = final_stats.stat_month\nORDER BY m.stat_month;"}], "rejected": "WITH netbar_users AS (\n  SELECT DISTINCT iuserid AS player_id\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-01' AND '2024-04-30'\n    AND inetbarlevel = '2'\n),\nlogin_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(CAST(statis_date AS VARCHAR), '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ionlinetime) AS total_online_time,\n    SUM(CASE WHEN iloginway IN (1,10,11,12,20,28,29,30,31,32,33,34,35,36) THEN ionlinetime ELSE 0 END) AS netbar_online_time,\n    COUNT(DISTINCT statis_date) AS active_days\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20240101 AND 20240430\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nmatch_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    vroleid AS player_id,\n    SUM(gamelengthmillis) / 1000.0 AS total_match_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN gamelengthmillis ELSE 0 END) / 1000.0 AS competitive_seconds,\n    SUM(CASE WHEN queueid = 'competitive' THEN 1 ELSE 0 END) AS competitive_matches,\n    SUM(CASE WHEN queueid = 'competitive' AND partyid IS NOT NULL AND partyid <> '' THEN 1 ELSE 0 END) AS competitive_team_matches,\n    COUNT(DISTINCT CAST(dteventtime AS DATE)) AS match_days\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-01' AND '2024-04-30'\n    AND vroleid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, vroleid\n),\npay_agg AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(statis_date, '%Y%m%d'), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    SUM(ftranamt) / 100.0 AS pay_amount\n  FROM dws_argothek_oss_portaltransaction_di\n  WHERE statis_date > '20240101'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\ncampus_agg AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATE), '%Y%m') AS stat_month,\n    iuserid AS player_id,\n    MAX(CASE WHEN icampuslevel IS NOT NULL AND icampuslevel <> '0' THEN 1 ELSE 0 END) AS campus_active\n  FROM dwd_argothek_playerlogout_hi\n  WHERE CAST(dteventtime AS DATE) BETWEEN '2024-01-01' AND '2024-04-30'\n    AND iuserid IN (SELECT player_id FROM netbar_users)\n  GROUP BY stat_month, iuserid\n),\nplayer_month AS (\n  SELECT stat_month, player_id FROM login_agg\n  UNION\n  SELECT stat_month, player_id FROM match_agg\n  UNION\n  SELECT stat_month, player_id FROM pay_agg\n  UNION\n  SELECT stat_month, player_id FROM campus_agg\n),\nmonthly_union AS (\n  SELECT\n    pm.stat_month,\n    pm.player_id,\n    COALESCE(l.total_online_time, 0) AS total_online_time,\n    COALESCE(l.netbar_online_time, 0) AS netbar_online_time,\n    COALESCE(l.active_days, 0) AS active_days,\n    COALESCE(m.total_match_seconds, 0) AS total_match_seconds,\n    COALESCE(m.competitive_seconds, 0) AS competitive_seconds,\n    COALESCE(m.competitive_matches, 0) AS competitive_matches,\n    COALESCE(m.competitive_team_matches, 0) AS competitive_team_matches,\n    COALESCE(m.match_days, 0) AS match_days,\n    COALESCE(p.pay_amount, 0) AS pay_amount,\n    COALESCE(c.campus_active, 0) AS campus_active\n  FROM player_month pm\n  LEFT JOIN login_agg l ON pm.stat_month = l.stat_month AND pm.player_id = l.player_id\n  LEFT JOIN match_agg m ON pm.stat_month = m.stat_month AND pm.player_id = m.player_id\n  LEFT JOIN pay_agg p ON pm.stat_month = p.stat_month AND pm.player_id = p.player_id\n  LEFT JOIN campus_agg c ON pm.stat_month = c.stat_month AND pm.player_id = c.player_id\n),\nmonths AS (\n  SELECT '202401' AS stat_month UNION ALL\n  SELECT '202402' UNION ALL\n  SELECT '202403' UNION ALL\n  SELECT '202404'\n),\nfinal_stats AS (\n  SELECT\n    stat_month,\n    COUNT(DISTINCT player_id) AS player_cnt,\n    SUM(total_match_seconds) AS total_match_seconds,\n    SUM(netbar_online_time) AS total_netbar_online_time,\n    SUM(total_online_time) AS total_online_time,\n    SUM(match_days) AS match_days,\n    SUM(competitive_seconds) AS total_competitive_seconds,\n    SUM(competitive_team_matches) AS total_competitive_team_matches,\n    SUM(competitive_matches) AS total_competitive_matches,\n    SUM(pay_amount) AS total_pay_amount,\n    COUNT(DISTINCT CASE WHEN pay_amount > 0 THEN player_id END) AS pay_user_cnt,\n    SUM(campus_active) AS campus_active_sum\n  FROM monthly_union\n  GROUP BY stat_month\n)\nSELECT\n  m.stat_month,\n  COALESCE(ROUND(final_stats.total_match_seconds / 3600 / NULLIF(final_stats.player_cnt, 0), 4), 0) AS avg_match_hours,\n  COALESCE(ROUND(final_stats.total_netbar_online_time / NULLIF(final_stats.total_online_time, 0), 4), 0) AS netbar_time_ratio,\n  COALESCE(final_stats.match_days, 0) AS match_days_cnt,\n  COALESCE(ROUND(final_stats.total_competitive_seconds / 3600, 4), 0) AS competitive_hours,\n  COALESCE(ROUND(final_stats.total_competitive_team_matches / NULLIF(final_stats.total_competitive_matches, 0), 4), 0) AS competitive_team_rate,\n  COALESCE(ROUND(final_stats.pay_user_cnt / NULLIF(final_stats.player_cnt, 0), 4), 0) AS pay_rate,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.player_cnt, 0), 4), 0) AS arpa,\n  COALESCE(ROUND(final_stats.total_pay_amount / NULLIF(final_stats.pay_user_cnt, 0), 4), 0) AS arppa,\n  COALESCE(ROUND(final_stats.campus_active_sum / NULLIF(final_stats.player_cnt, 0), 4), 0) AS campus_active_rate\nFROM months m\nLEFT JOIN final_stats ON m.stat_month = final_stats.stat_month\nORDER BY m.stat_month;", "meta": {"origin": "sql_20", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_27_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2024-01-01到2024-12-16，购买阶段出现了x次武器代买，除自定义模式、新手、训练场外所有模式。\n输出：武器代买次数\n【表】dwd_argothek_matchdetails_hi, dwd_argothek_apinventorymovementlog_hi\n【口径】provisioningflowid = \"Matchmaking\" -- 除自定义模式、新手、训练场外所有模式\n\n对局代买筛选逻辑：\nTransactionType = \"FulfillRequest\"\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240128' and '20250112'\n    and provisioningflowid = 'Matchmaking'\n),\nproxy_buy as (\n  select\n    count(*) as buy_cnt\n  from dwd_argothek_apinventorymovementlog_hi l\n  join valid_matches m on l.matchinfomatchid = m.matchid\n  where substr(l.tdbank_imp_date, 1, 8) between '20240128' and '20250112'\n    and transactiontype = 'FulfillRequest'\n)\nselect buy_cnt as weapon_proxy_cnt from proxy_buy;"}], "rejected": "with valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) > '20240128'\n    and provisioningflowid = 'Matchmaking'\n),\nproxy_buy as (\n  select\n    count(*) as buy_cnt\n  from dwd_argothek_apinventorymovementlog_hi l\n  join valid_matches m on l.matchinfomatchid = m.matchid\n  where substr(l.tdbank_imp_date, 1, 8) between '20240128' and '20250112'\n    and transactiontype = 'FulfillRequest'\n)\nselect buy_cnt as weapon_proxy_cnt from proxy_buy;", "meta": {"origin": "sql_27", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_46_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.1.1-2024.2.2期间，每个自然周不同周活跃天数玩家数\n输出：统计周(1、2、3...、5)、周活跃天数、玩家数\n【表】dws_jordass_login_di\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n    week, -- 统计周\n    active_days, -- 活跃天数\n    count(distinct vplayerid) as user_num -- 玩家数\nfrom (\n    select\n        vplayerid, -- 玩家playerid\n        weekofyear(dtstatdate) as week, -- 统计周\n        count(distinct dtstatdate) as active_days -- 活跃天数\n    from dws_jordass_login_di\n    where dtstatdate >= '20240106' and dtstatdate <= '20240207' and platid=255\n    group by\n        vplayerid,\n        weekofyear(dtstatdate)\n)f\ngroup by\n    week,\n    active_days\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n    week, -- 统计周\n    active_days, -- 活跃天数\n    count(distinct vplayerid) as user_num -- 玩家数\nfrom (\n    select\n        vplayerid, -- 玩家playerid\n        weekofyear(dtstatdate) as week, -- 统计周\n        count(distinct dtstatdate) as active_days -- 活跃天数\n    from dws_jordass_login_di\n    where dtstatdate >= '20240106' and dtstatdate <= '20240207' and platid=255\n    group by\n        vplayerid,\n        weekofyear(dtstatdate)\n)f\ngroup by\n    week,\n    active_days\n) AS final_query;", "meta": {"origin": "sql_46", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_27_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2024-01-01到2024-12-16，购买阶段出现了x次武器代买，除自定义模式、新手、训练场外所有模式。\n输出：武器代买次数\n【表】dwd_argothek_matchdetails_hi, dwd_argothek_apinventorymovementlog_hi\n【口径】provisioningflowid = \"Matchmaking\" -- 除自定义模式、新手、训练场外所有模式\n\n对局代买筛选逻辑：\nTransactionType = \"FulfillRequest\""}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240106' and '20241221'\n    and provisioningflowid = 'Matchmaking'\n),\nproxy_buy as (\n  select\n    count(*) as buy_cnt\n  from dwd_argothek_apinventorymovementlog_hi l\n  join valid_matches m on l.matchinfomatchid = m.matchid\n  where substr(l.tdbank_imp_date, 1, 8) between '20240106' and '20241221'\n    and transactiontype = 'FulfillRequest'\n)\nselect buy_cnt as weapon_proxy_cnt from proxy_buy\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) > '20240106'\n    and provisioningflowid = 'Matchmaking'\n),\nproxy_buy as (\n  select\n    count(*) as buy_cnt\n  from dwd_argothek_apinventorymovementlog_hi l\n  join valid_matches m on l.matchinfomatchid = m.matchid\n  where substr(l.tdbank_imp_date, 1, 8) between '20240106' and '20241221'\n    and transactiontype = 'FulfillRequest'\n)\nselect buy_cnt as weapon_proxy_cnt from proxy_buy\n) AS final_query;", "meta": {"origin": "sql_27", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_26_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2024-01-01到2024-12-16，闪了敌人x次、闪了队友x次，除自定义模式、新手、训练场外所有模式。\n输出：闪了敌人x次、闪了队友x次\n【表】dwd_argothek_matchdetails_hi, dwd_argothek_abilityinfo_effects_hi\n【口径】provisioningflowid = \"Matchmaking\" -- 除自定义模式、新手、训练场外所有模式\n\n闪光弹区分逻辑：\n闪到敌人：tag = \"EnemiesBlinded\"\n闪到队友：tag = \"AlliesBlinded\""}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240106' and '20241221'\n    and provisioningflowid = 'Matchmaking'\n),\nflash_effect as (\n  select\n    tag,\n    sum(coalesce(amount, 0)) as total_cnt\n  from dwd_argothek_abilityinfo_effects_hi e\n  join valid_matches m on e.matchinfomatchid = m.matchid\n  where substr(e.tdbank_imp_date, 1, 8) between '20240106' and '20241221'\n    and tag in ('EnemiesBlinded', 'AlliesBlinded')\n  group by tag\n)\nselect\n  coalesce(max(case when tag = 'EnemiesBlinded' then total_cnt end), 0) as enemies_blinded_cnt,\n  coalesce(max(case when tag = 'AlliesBlinded' then total_cnt end), 0) as allies_blinded_cnt\nfrom flash_effect\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) > '20240106'\n    and provisioningflowid = 'Matchmaking'\n),\nflash_effect as (\n  select\n    tag,\n    sum(coalesce(amount, 0)) as total_cnt\n  from dwd_argothek_abilityinfo_effects_hi e\n  join valid_matches m on e.matchinfomatchid = m.matchid\n  where substr(e.tdbank_imp_date, 1, 8) between '20240106' and '20241221'\n    and tag in ('EnemiesBlinded', 'AlliesBlinded')\n  group by tag\n)\nselect\n  coalesce(max(case when tag = 'EnemiesBlinded' then total_cnt end), 0) as enemies_blinded_cnt,\n  coalesce(max(case when tag = 'AlliesBlinded' then total_cnt end), 0) as allies_blinded_cnt\nfrom flash_effect\n) AS final_query;", "meta": {"origin": "sql_26", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_57_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计限定抽取阶梯活动每天的pv和角色数\n活动日期\t2024.12.28-12.19\t\n输出：日期(20241228、...、20250117、汇总)、pv、uv\n【表】dwd_jordass_activitypress_hi\n【口径】限定抽取阶梯活动：ireason = 2411291018 and buttontype = 10045 and  extarg1 in (117, 115)\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "-- 查询限定抽取阶梯活动相关数据\nselect\n    dtstatdate,\n    pv,\n    uv\nfrom (\n    -- 按天统计\n    select\n        substr(tdbank_imp_date, 1, 8) as dtstatdate,\n        count(*)                       as pv,\n        count(distinct uid)            as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n    group by substr(tdbank_imp_date, 1, 8)\n\n    union all\n\n    -- 汇总\n    select\n        '汇总' as dtstatdate,\n        count(*)            as pv,\n        count(distinct uid) as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n) f \n;"}], "rejected": "-- 查询限定抽取阶梯活动相关数据\nselect\n    dtstatdate,\n    pv,\n    uv\nfrom (\n    -- 按天统计\n    select\n        substr(tdbank_imp_date, 1, 8) as dtstatdate,\n        count(*)                       as pv,\n        count(distinct uid)            as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n    group by substr(tdbank_imp_date, 1, 8)\n\n    union all\n\n    -- 汇总\n    select\n        '汇总' as dtstatdate,\n        count(*)            as pv,\n        count(distinct uid) as uv\n    from dwd_jordass_activitypress_hi\n    where tdbank_imp_date between '2024112900' and '2024121923'\n      and ireason   = 2411291018\n      and buttontype = 10045\n      and extarg1   in (117, 115)\n) f \n;", "meta": {"origin": "sql_57", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_65_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】查询2024.11.29-2024.12.19期间的任务领取数据，并按类型汇总（跨日期）\n输出 ：日期（YYYYMMDD、汇总），类型，人数，次数\n【表】dwd_jordass_activity_rewardrecord_hi\n【口径】任务领取：actid = 2411291018and acttype = 10045 and awardidx in (1, 2, 3)，一条记录代表领取一次"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241130' and '20241220'\n    and actid = 2411291018\n    and acttype = 10045\n    and awardidx in (1, 2, 3)\n),\nstat_detail as (\n  select\n    stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by stat_date, award_type\n),\nstat_summary as (\n  select\n    '汇总' as stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by award_type\n)\nselect\n  stat_date,\n  award_type,\n  user_cnt,\n  receive_cnt\nfrom (\n  select * from stat_detail\n  union all\n  select * from stat_summary\n) t\norder by case when stat_date = '汇总' then 1 else 0 end, stat_date, award_type\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) > '20241130'\n    and actid = 2411291018\n    and acttype = 10045\n    and awardidx in (1, 2, 3)\n),\nstat_detail as (\n  select\n    stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by stat_date, award_type\n),\nstat_summary as (\n  select\n    '汇总' as stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by award_type\n)\nselect\n  stat_date,\n  award_type,\n  user_cnt,\n  receive_cnt\nfrom (\n  select * from stat_detail\n  union all\n  select * from stat_summary\n) t\norder by case when stat_date = '汇总' then 1 else 0 end, stat_date, award_type\n) AS final_query;", "meta": {"origin": "sql_65", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_101_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计日(2024.9.2,2024.9.3,2025.9.8,2025.9.9) 全平台活跃用户的本赛季最高段位等信息\n输出：统计日，本赛季最高段位，活跃用户数，统计日参与主题群屿玩法用户数，参与率\n【表】dws_jordass_mode_roundrecord_di, dws_jordass_login_di, dwd_jordass_playerlogin_hi\n【口径】主题群屿玩法：modename='传统模式' and submodename like 'CG%'\n段位分布：case when substr(seasonmaxsegment, 1, 1) = '1' then '青铜'\n                          when substr(seasonmaxsegment, 1, 1) = '2' then '白银'\n                          when substr(seasonmaxsegment, 1, 1) = '3' then '黄金'\n                          when substr(seasonmaxsegment, 1, 1) = '4' then '铂金'\n                          when substr(seasonmaxsegment, 1, 1) = '5' then '星钻'\n                          when substr(seasonmaxsegment, 1, 1) = '6' then '王冠'\n                          when substr(seasonmaxsegment, 1, 1) >= '7' then '王牌'\n                          else '无段位'\n\t            end"}, {"role": "assistant", "content": "WITH target_dates AS (\n  SELECT '20240902' AS stat_date UNION ALL\n  SELECT '20240903' UNION ALL\n  SELECT '20250908' UNION ALL\n  SELECT '20250909'\n), active_users AS (\n  SELECT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n  GROUP BY dtstatdate, vplayerid\n), segment_latest AS (\n  SELECT\n    vplayerid,\n    seasonmaxsegment,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n  FROM dwd_jordass_playerlogin_hi\n  WHERE seasonmaxsegment IS NOT NULL AND seasonmaxsegment <> ''\n), segment_map AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '1' THEN '青铜'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '2' THEN '白银'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '3' THEN '黄金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '4' THEN '铂金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '5' THEN '星钻'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '6' THEN '王冠'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) >= '7' THEN '王牌'\n      ELSE '无段位'\n    END AS season_segment\n  FROM segment_latest\n  WHERE rn = 1\n), active_segment AS (\n  SELECT\n    a.stat_date,\n    a.vplayerid,\n    COALESCE(s.season_segment, '无段位') AS season_segment\n  FROM active_users a\n  LEFT JOIN segment_map s\n    ON a.vplayerid = s.vplayerid\n), qunyu_users AS (\n  SELECT DISTINCT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n    AND modename = '传统模式'\n    AND submodename LIKE 'CG%'\n), summary AS (\n  SELECT\n    a.stat_date,\n    a.season_segment,\n    COUNT(DISTINCT a.vplayerid) AS active_user_cnt,\n    COUNT(DISTINCT CASE WHEN q.vplayerid IS NOT NULL THEN a.vplayerid END) AS qunyu_user_cnt\n  FROM active_segment a\n  LEFT JOIN qunyu_users q\n    ON a.stat_date = q.stat_date\n   AND a.vplayerid = q.vplayerid\n  GROUP BY a.stat_date, a.season_segment\n)\nSELECT\n  stat_date,\n  season_segment,\n  active_user_cnt,\n  qunyu_user_cnt,\n  CASE WHEN active_user_cnt = 0 THEN 0 ELSE qunyu_user_cnt / active_user_cnt END AS participate_rate\nFROM summary\nORDER BY stat_date, season_segment;"}], "rejected": "WITH target_dates AS (\n  SELECT '20240902' AS stat_date UNION ALL\n  SELECT '20240903' UNION ALL\n  SELECT '20250908' UNION ALL\n  SELECT '20250909'\n), active_users AS (\n  SELECT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n  GROUP BY dtstatdate, vplayerid\n), segment_latest AS (\n  SELECT\n    vplayerid,\n    seasonmaxsegment,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n  FROM dwd_jordass_playerlogin_hi\n  WHERE seasonmaxsegment IS NOT NULL AND seasonmaxsegment <> ''\n), segment_map AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '1' THEN '青铜'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '2' THEN '白银'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '3' THEN '黄金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '4' THEN '铂金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '5' THEN '星钻'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '6' THEN '王冠'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) >= '7' THEN '王牌'\n      ELSE '无段位'\n    END AS season_segment\n  FROM segment_latest\n  WHERE rn = 1\n), active_segment AS (\n  SELECT\n    a.stat_date,\n    a.vplayerid,\n    COALESCE(s.season_segment, '无段位') AS season_segment\n  FROM active_users a\n  LEFT JOIN segment_map s\n    ON a.vplayerid = s.vplayerid\n), qunyu_users AS (\n  SELECT DISTINCT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n    AND modename = '传统模式'\n    AND submodename LIKE 'CG%'\n), summary AS (\n  SELECT\n    a.stat_date,\n    a.season_segment,\n    COUNT(DISTINCT a.vplayerid) AS active_user_cnt,\n    COUNT(DISTINCT CASE WHEN q.vplayerid IS NOT NULL THEN a.vplayerid END) AS qunyu_user_cnt\n  FROM active_segment a\n  LEFT JOIN qunyu_users q\n    ON a.stat_date = q.stat_date\n   AND a.vplayerid = q.vplayerid\n  GROUP BY a.stat_date, a.season_segment\n)\nSELECT\n  stat_date,\n  season_segment,\n  active_user_cnt,\n  qunyu_user_cnt,\n  CASE WHEN active_user_cnt = 0 THEN 0 ELSE qunyu_user_cnt / active_user_cnt END AS participate_rate\nFROM summary\nORDER BY stat_date, season_segment;", "meta": {"origin": "sql_101", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_10_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.7.12-2025.6.15，赛季bp道具皮肤的使用情况。\n输出：道具id、赛季名称、当前赛季使用人数、当前赛季购买人数\n【表】dwd_argothek_playerloadout_expressions_hi, dwd_argothek_playerloadout_hi, dwd_argothek_playerloadout_sprayslots_hi, dwd_argothek_commercialization_gearid_df, dim_argothek_seasondate_df\n【口径】bp枪皮购买逻辑:\nand purchaseSource = \"BATTLEPASS_PROGRESS\" -- 筛选来源为BATTLEPASS_PROGRESS\nand itemtype = \"d5f120f8-ff8c-4aac-92ea-f2b5acbe9475\" -- 筛选itemtype为指定值\n枪皮使用逻辑：\nexpressionassetid is not null and expressiontypeid = \"d5f120f8-ff8c-4aac-92ea-f2b5acbe9475\""}, {"role": "assistant", "content": "WITH season_calendar AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    MIN(STR_TO_DATE(idate, '%Y%m%d')) AS season_start,\n    MAX(STR_TO_DATE(idate, '%Y%m%d')) AS season_end\n  FROM dim_argothek_seasondate_df\n  WHERE STR_TO_DATE(idate, '%Y%m%d') BETWEEN '2023-07-17' AND '2025-06-20'\n  GROUP BY seasonid, seasonidname\n), usage_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    e.expressionassetid AS item_id,\n    l.subject AS user_id\n  FROM dwd_argothek_playerloadout_expressions_hi e\n  JOIN dwd_argothek_playerloadout_hi l\n    ON e.apeventid = l.apeventid\n  JOIN season_calendar sc\n    ON STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN '2023-07-17' AND '2025-06-20'\n    AND e.expressionassetid IS NOT NULL\n    AND e.expressiontypeid = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n), usage_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT user_id) AS season_use_user_cnt\n  FROM usage_base\n  GROUP BY seasonid, seasonidname, item_id\n), purchase_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    g.purchaseditemid AS item_id,\n    g.vtemp1 AS buyer_id\n  FROM dwd_argothek_commercialization_gearid_df g\n  JOIN season_calendar sc\n    ON STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN '2023-07-17' AND '2025-06-20'\n    AND g.purchasesource = 'BATTLEPASS_PROGRESS'\n    AND g.itemtype = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n    AND g.vtemp1 IS NOT NULL\n), purchase_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT buyer_id) AS season_buy_user_cnt\n  FROM purchase_base\n  GROUP BY seasonid, seasonidname, item_id\n)\nSELECT\n  item_id,\n  season_name,\n  SUM(season_use_user_cnt) AS season_use_user_cnt,\n  SUM(season_buy_user_cnt) AS season_buy_user_cnt\nFROM (\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    season_use_user_cnt,\n    0 AS season_buy_user_cnt\n  FROM usage_agg\n  UNION ALL\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    0 AS season_use_user_cnt,\n    season_buy_user_cnt\n  FROM purchase_agg\n) merged\nGROUP BY item_id, season_name\nORDER BY season_name, item_id;"}], "rejected": "WITH season_calendar AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    MIN(STR_TO_DATE(idate, '%Y%m%d')) AS season_start,\n    MAX(STR_TO_DATE(idate, '%Y%m%d')) AS season_end\n  FROM dim_argothek_seasondate_df\n  WHERE STR_TO_DATE(idate, '%Y%m%d') BETWEEN '2023-07-17' AND '2025-06-20'\n  GROUP BY seasonid, seasonidname\n), usage_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    e.expressionassetid AS item_id,\n    l.subject AS user_id\n  FROM dwd_argothek_playerloadout_expressions_hi e\n  JOIN dwd_argothek_playerloadout_hi l\n    ON e.apeventid = l.apeventid\n  JOIN season_calendar sc\n    ON STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(SUBSTR(e.dteventtime, 1, 10), '%Y-%m-%d') BETWEEN '2023-07-17' AND '2025-06-20'\n    AND e.expressionassetid IS NOT NULL\n    AND e.expressiontypeid = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n), usage_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT user_id) AS season_use_user_cnt\n  FROM usage_base\n  GROUP BY seasonid, seasonidname, item_id\n), purchase_base AS (\n  SELECT\n    sc.seasonid,\n    sc.seasonidname,\n    g.purchaseditemid AS item_id,\n    g.vtemp1 AS buyer_id\n  FROM dwd_argothek_commercialization_gearid_df g\n  JOIN season_calendar sc\n    ON STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN sc.season_start AND sc.season_end\n  WHERE STR_TO_DATE(g.idate, '%Y%m%d') BETWEEN '2023-07-17' AND '2025-06-20'\n    AND g.purchasesource = 'BATTLEPASS_PROGRESS'\n    AND g.itemtype = 'd5f120f8-ff8c-4aac-92ea-f2b5acbe9475'\n    AND g.vtemp1 IS NOT NULL\n), purchase_agg AS (\n  SELECT\n    seasonid,\n    seasonidname,\n    item_id,\n    COUNT(DISTINCT buyer_id) AS season_buy_user_cnt\n  FROM purchase_base\n  GROUP BY seasonid, seasonidname, item_id\n)\nSELECT\n  item_id,\n  season_name,\n  SUM(season_use_user_cnt) AS season_use_user_cnt,\n  SUM(season_buy_user_cnt) AS season_buy_user_cnt\nFROM (\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    season_use_user_cnt,\n    0 AS season_buy_user_cnt\n  FROM usage_agg\n  UNION ALL\n  SELECT\n    item_id,\n    seasonidname AS season_name,\n    0 AS season_use_user_cnt,\n    season_buy_user_cnt\n  FROM purchase_agg\n) merged\nGROUP BY item_id, season_name\nORDER BY season_name, item_id;", "meta": {"origin": "sql_10", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_39_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计各个玩法参与用户其他玩法流入和双栖情况\n\n输出：流入玩法、流出玩法、上线后3天流入玩法参与用户数、上线后3天流出用户数、上线后3天双栖用户数、上线前一周流出玩法总参与用户数、流出占比、上线后3天流出玩法总参与用户数、双栖占比\n【表】dws_jordass_mode_roundrecord_di\n【口径】流入玩法上线日期和取数逻辑：\n广域战场 （2024/7/23）submodename= '广域战场模式'，\n消灭战（2023/8/4） modename='组队竞技' and submodename like '%消灭战模式%'，\n幻想混战（2024/12/09）modename='创意创作间' and submodename='幻想混战'，\n荒野传说（2024-09-27）modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')，\n策略载具（2024-11-03）modename='休闲模式' and submodename like '%策略载具%'，\n炎夏混战（2024-07-19）modename='创意创作间' and submodename like '%炎夏混战%'，\n单人装备（2024.5.17）modename='组队竞技' and submodename like '%单人装备%'，\n交叉堡垒（2024.4.12） modename='组队竞技' and submodename like '%交叉堡垒%'，\n庆典混战（2024/4/26）submode in (2611)，\nCG28战场进化（2024/9/3） modename='传统模式' and submodename ='CG28-动物丛林'，\nCG29流浪地球（2024/11/5） modename='传统模式' and submodename ='CG29-流浪地球'\n\n流出玩法：从上往下匹配，如果满足任一条件则返回对应的玩法名称，否则返回“其他子模式”。\n主题群屿：modename='传统模式' and submodename like 'CG%' and mapname='群屿'\n传统群屿：modename='传统模式' and mapname='群屿'\n假日群岛：modename='传统模式' and mapname='假日群岛'\n山峦：modename='传统模式' and mapname='山峦'\n极能形态模式：submodename='极能形态模式'\n隧道：modename='生存模式'\n广域战场：submodename='广域战场模式'\n休闲模式：modename='休闲模式'\n乐园：modename='乐园'\n领地：modename='领地'\n广阔天地：modename='广阔天地'\n组队竞技：modename='组队竞技'\n\n用户定义：\n流出用户：流入玩法上线前一周玩了流出玩法，并且流入玩法上线后3天没有玩流出玩法，但是有玩流入玩法\n双栖用户：流入玩法上线前一周 和 上线后3天都玩了流出玩法\n流出占比：流出用户除以上线前一周流出玩法总参与\n双栖占比：双栖用户除以上线首周流出玩法总参与\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with playuser as (\n    select '广域战场' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate= '20240816'  and  date_add('20240816',2) and submodename= '广域战场模式'\n    group by 1,2,3\n    union all\n    select '消灭战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20230828'  and  date_add('20230828',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by 1,2,3\n    union all\n    select '幻想混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241209' and  date_add('20241209',2) and modename='创意创作间' and submodename='幻想混战'\n    group by 1,2,3\n    union all\n    select '荒野传说' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240927'  and  date_add('20240927',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by 1,2,3\n    union all\n    select '策略载具' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241103'   and  date_add('20241103',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by 1,2,3\n    union all\n    select '炎夏混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240719'   and  date_add('20240719',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by 1,2,3\n    union all\n    select '单人装备' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240610'   and  date_add('20240610',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by 1,2,3\n    union all\n    select '交叉堡垒' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240506'   and  date_add('20240506',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by 1,2,3\n    union all\n    select '庆典混战' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240520'  and  date_add('20240520',2) and submode in (2611)\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG29-流浪地球' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240927' and  date_add('20240927',2)and submodename = 'CG29-流浪地球'\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG28-动物丛林' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241129' and  date_add('20241129',2)and submodename = 'CG28-动物丛林'\n    group by dtstatdate,vplayerid\n),\nallplayuser as (\n    select '广域战场' itype,\n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240816' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240816' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240816',7) and dtstatdate <= date_add('20240816',2)  \n    group by \n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end ,\n        vplayerid\n    union all\n    select '消灭战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20230828' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20230828' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20230828',7) and dtstatdate <= date_add('20230828',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '幻想混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241209' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241209' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241209',7) and dtstatdate <= date_add('20241209',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '荒野传说' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240927' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240927' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240927',7) and dtstatdate <= date_add('20240927',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '策略载具' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241103' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241103' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241103',7) and dtstatdate <= date_add('20241103',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '炎夏混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240719' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240719' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240719',7) and dtstatdate <= date_add('20240719',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '单人装备' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240610' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240610' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240610',7) and dtstatdate <= date_add('20240610',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '交叉堡垒' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240506' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240506' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240506',7) and dtstatdate <= date_add('20240506',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '庆典混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240520' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240520' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240520',7) and dtstatdate <= date_add('20240520',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG28-动物丛林' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240927' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240927' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240927',7) and dtstatdate <= date_add('20240927',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG29-流浪地球' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241129' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241129' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241129',7) and dtstatdate <= date_add('20241129',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n)\n\nselect  \n    t.itype, \n    t.playclass1, \n    iusernum1, -- 流入玩法参与用户数\n    iusernum2, -- 流出用户数\n    iusernum3, -- 双栖用户数\n    iusernum4, -- 前一周流出玩法用户数\n    coalesce(round(iusernum2/iusernum4, 2), 0) as ratio1, -- 流出占比\n    iusernum5, -- 后3天流出玩法用户数\n    coalesce(round(iusernum3/iusernum5, 2), 0) as ratio2 -- 双栖占比\nfrom (\n    select itype,count(distinct vplayerid) iusernum1 from playuser group by itype\n)p\nleft join (\n    select \n        a.itype,\n        b.playclass1,\n        count(distinct case when islast=1 and isthis =0 then a.vplayerid end) iusernum2,\n        count(distinct case when islast=1 and isthis =1 then a.vplayerid end) iusernum3\n    from playuser a\n    left join allplayuser b \n    on a.itype =b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.playclass1\n)t on p.itype = t.itype\nleft join (\n    select \n        itype, \n        playclass1,\n        count(distinct case when islast=1 then vplayerid end) iusernum4,\n        count(distinct case when isthis=1 then vplayerid end) iusernum5\n    from allplayuser\n    group by itype,playclass1\n) m on t.playclass1=m.playclass1 and t.itype=m.itype\n;"}], "rejected": "with playuser as (\n    select '广域战场' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate= '20240816'  and  date_add('20240816',2) and submodename= '广域战场模式'\n    group by 1,2,3\n    union all\n    select '消灭战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20230828'  and  date_add('20230828',2) and modename='组队竞技' and submodename like '%消灭战模式%'\n    group by 1,2,3\n    union all\n    select '幻想混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241209' and  date_add('20241209',2) and modename='创意创作间' and submodename='幻想混战'\n    group by 1,2,3\n    union all\n    select '荒野传说' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240927'  and  date_add('20240927',2) and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n    group by 1,2,3\n    union all\n    select '策略载具' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241103'   and  date_add('20241103',2) and modename='休闲模式' and submodename like '%策略载具%'\n    group by 1,2,3\n    union all\n    select '炎夏混战' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240719'   and  date_add('20240719',2) and modename='创意创作间' and submodename like '%炎夏混战%'\n    group by 1,2,3\n    union all\n    select '单人装备' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240610'   and  date_add('20240610',2) and modename='组队竞技' and submodename like '%单人装备%'\n    group by 1,2,3\n    union all\n    select '交叉堡垒' itype,dtstatdate,vplayerid\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240506'   and  date_add('20240506',2) and modename='组队竞技' and submodename like '%交叉堡垒%'\n    group by 1,2,3\n    union all\n    select '庆典混战' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240520'  and  date_add('20240520',2) and submode in (2611)\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG29-流浪地球' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20240927' and  date_add('20240927',2)and submodename = 'CG29-流浪地球'\n    group by dtstatdate,vplayerid\n    union all\n    select 'CG28-动物丛林' as itype,dtstatdate,vplayerid\n    from  dws_jordass_mode_roundrecord_di\n    where dtstatdate = '20241129' and  date_add('20241129',2)and submodename = 'CG28-动物丛林'\n    group by dtstatdate,vplayerid\n),\nallplayuser as (\n    select '广域战场' itype,\n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240816' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240816' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240816',7) and dtstatdate <= date_add('20240816',2)  \n    group by \n        case \n            when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n        end ,\n        vplayerid\n    union all\n    select '消灭战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20230828' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20230828' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20230828',7) and dtstatdate <= date_add('20230828',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '幻想混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241209' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241209' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241209',7) and dtstatdate <= date_add('20241209',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '荒野传说' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240927' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240927' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240927',7) and dtstatdate <= date_add('20240927',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '策略载具' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241103' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241103' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241103',7) and dtstatdate <= date_add('20241103',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '炎夏混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240719' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240719' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240719',7) and dtstatdate <= date_add('20240719',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '单人装备' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240610' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240610' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240610',7) and dtstatdate <= date_add('20240610',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '交叉堡垒' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240506' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240506' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240506',7) and dtstatdate <= date_add('20240506',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select '庆典混战' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240520' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240520' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240520',7) and dtstatdate <= date_add('20240520',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG28-动物丛林' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20240927' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20240927' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20240927',7) and dtstatdate <= date_add('20240927',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n    union all\n    select 'CG29-流浪地球' itype,\n        case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end playclass1,\n        vplayerid,\n        max(case when dtstatdate<'20241129' then 1 else 0 end) islast,\n        max(case when dtstatdate>='20241129' then 1 else 0 end) isthis\n    from dws_jordass_mode_roundrecord_di\n    where dtstatdate >= date_sub('20241129',7) and dtstatdate <= date_add('20241129',2)  \n    group by case when modename='传统模式' and submodename like 'CG%' and mapname='群屿' then '主题群屿'\n            when modename='传统模式' and mapname='群屿' then '传统群屿'\n            when modename='传统模式' and mapname='假日群岛' then '假日群岛'\n            when modename='传统模式' and mapname='山峦' then '山峦'\n            when submodename='极能形态模式' then '极能形态模式'\n            when modename='生存模式' then '隧道'\n            when submodename='广域战场模式' then '广域战场'\n            when modename in ('休闲模式','乐园','领地','广阔天地','组队竞技') then modename\n            else '其他子模式'\n            end ,\n        vplayerid\n)\n\nselect  \n    t.itype, \n    t.playclass1, \n    iusernum1, -- 流入玩法参与用户数\n    iusernum2, -- 流出用户数\n    iusernum3, -- 双栖用户数\n    iusernum4, -- 前一周流出玩法用户数\n    coalesce(round(iusernum2/iusernum4, 2), 0) as ratio1, -- 流出占比\n    iusernum5, -- 后3天流出玩法用户数\n    coalesce(round(iusernum3/iusernum5, 2), 0) as ratio2 -- 双栖占比\nfrom (\n    select itype,count(distinct vplayerid) iusernum1 from playuser group by itype\n)p\nleft join (\n    select \n        a.itype,\n        b.playclass1,\n        count(distinct case when islast=1 and isthis =0 then a.vplayerid end) iusernum2,\n        count(distinct case when islast=1 and isthis =1 then a.vplayerid end) iusernum3\n    from playuser a\n    left join allplayuser b \n    on a.itype =b.itype and a.vplayerid = b.vplayerid\n    group by a.itype,b.playclass1\n)t on p.itype = t.itype\nleft join (\n    select \n        itype, \n        playclass1,\n        count(distinct case when islast=1 then vplayerid end) iusernum4,\n        count(distinct case when isthis=1 then vplayerid end) iusernum5\n    from allplayuser\n    group by itype,playclass1\n) m on t.playclass1=m.playclass1 and t.itype=m.itype\n;", "meta": {"origin": "sql_39", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_49_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】2024年10月1-2024年10月7 用周期开始时间判断玩法上线时间在7天及以上，周期结束时间判断玩法上线时间在90天及以内的玩法，统计周期内这些玩法的参与和留存情况\n输出：周期(20241005-20241011)，日期(20241005、...、20241011)，参与人数，次留人数\n【表】dws_jordass_matchlog_stat_di, dim_jordass_submodeonline_nf\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith play_user as (\n    select distinct\n        p.dtstatdate as ds, --日期\n        p.vplayerid    --玩家id\n    from\n        dws_jordass_matchlog_stat_di p\n    join\n        dim_jordass_submodeonline_nf c\n    on\n        p.imode = c.matchsubmodegroup\n    where\n        p.dtstatdate between '20241005' and '20241012'\n        and datediff('20241005', c.onlinedate) >= 7\n        and datediff('20241011', c.onlinedate) <= 90\n)\nselect\n    '20241005-20241011' as period, --周期\n    a.ds,\n    count(distinct a.vplayerid) as play_user_num, --参与人数\n    count(distinct b.vplayerid) as retention_user_num --次留人数\nfrom\n    play_user a\nleft join\n    play_user b\non\n    a.vplayerid = b.vplayerid\n    and b.ds = date_add(a.ds, 1)  -- 次日留存条件\nwhere\n    a.ds between '20241005' and '20241011'\ngroup by\n    a.ds\norder by\n    a.ds\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith play_user as (\n    select distinct\n        p.dtstatdate as ds, --日期\n        p.vplayerid    --玩家id\n    from\n        dws_jordass_matchlog_stat_di p\n    join\n        dim_jordass_submodeonline_nf c\n    on\n        p.imode = c.matchsubmodegroup\n    where\n        p.dtstatdate > '20241005'\n        and datediff('20241005', c.onlinedate) >= 7\n        and datediff('20241011', c.onlinedate) <= 90\n)\nselect\n    '20241005-20241011' as period, --周期\n    a.ds,\n    count(distinct a.vplayerid) as play_user_num, --参与人数\n    count(distinct b.vplayerid) as retention_user_num --次留人数\nfrom\n    play_user a\nleft join\n    play_user b\non\n    a.vplayerid = b.vplayerid\n    and b.ds = date_add(a.ds, 1)  -- 次日留存条件\nwhere\n    a.ds between '20241005' and '20241011'\ngroup by\n    a.ds\norder by\n    a.ds\n) AS final_query;", "meta": {"origin": "sql_49", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_40_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】sql_40时间段2024.3.1-2024.6.30分月看用户当月在砺刃的 新进、回流、轻度留存、中度留存、重度留存\n\n输出：月份(202403、...、202406)、新进人数、回流人数、轻度留存人数、中度留存人数、重度留存人数\n【表】dws_jordass_login_di, dws_jordass_login_df\n【口径】新进：当月新进 \n回流：上个月未活跃的历史注册用户，在当月活跃\n轻度留存：留存用户（上个月活跃，本月也活跃的用户）在本月的活跃度1-4天\n中度留存：留存用户（上个月活跃，本月也活跃的用户）在本月的活跃度5-15天\n重度留存：留存用户（上个月活跃，本月也活跃的用户）在本月的活跃度16天及以上"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH base AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(dtstatdate, '%Y%m%d'), '%Y%m') AS stat_month,\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20240302' AND '20240701'\n    AND platid = 255\n  GROUP BY stat_month, vplayerid\n),\nmonth_info AS (\n  SELECT\n    b.stat_month,\n    b.vplayerid,\n    b.active_days,\n    MIN(b.stat_month) OVER (PARTITION BY b.vplayerid) AS first_month\n  FROM base b\n),\nprev_month_map AS (\n  SELECT\n    stat_month,\n    DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(stat_month, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m') AS prev_month\n  FROM (SELECT DISTINCT stat_month FROM base) t\n),\nclassified AS (\n  SELECT\n    m.stat_month,\n    m.vplayerid,\n    m.active_days,\n    CASE\n      WHEN m.stat_month = m.first_month THEN 'new'\n      WHEN prev.vplayerid IS NOT NULL THEN 'retained'\n      WHEN m.stat_month > m.first_month THEN 'return'\n      ELSE 'other'\n    END AS user_type\n  FROM month_info m\n  LEFT JOIN prev_month_map pm ON m.stat_month = pm.stat_month\n  LEFT JOIN base prev ON prev.stat_month = pm.prev_month AND prev.vplayerid = m.vplayerid\n)\nSELECT\n  stat_month,\n  SUM(CASE WHEN user_type = 'new' THEN 1 ELSE 0 END) AS new_user_cnt,\n  SUM(CASE WHEN user_type = 'return' THEN 1 ELSE 0 END) AS return_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 1 AND 4 THEN 1 ELSE 0 END) AS light_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 5 AND 15 THEN 1 ELSE 0 END) AS medium_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days >= 16 THEN 1 ELSE 0 END) AS heavy_retained_user_cnt\nFROM classified\nGROUP BY stat_month\nORDER BY stat_month\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH base AS (\n  SELECT\n    DATE_FORMAT(STR_TO_DATE(dtstatdate, '%Y%m%d'), '%Y%m') AS stat_month,\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate > '20240302'\n    AND platid = 255\n  GROUP BY stat_month, vplayerid\n),\nmonth_info AS (\n  SELECT\n    b.stat_month,\n    b.vplayerid,\n    b.active_days,\n    MIN(b.stat_month) OVER (PARTITION BY b.vplayerid) AS first_month\n  FROM base b\n),\nprev_month_map AS (\n  SELECT\n    stat_month,\n    DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(stat_month, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m') AS prev_month\n  FROM (SELECT DISTINCT stat_month FROM base) t\n),\nclassified AS (\n  SELECT\n    m.stat_month,\n    m.vplayerid,\n    m.active_days,\n    CASE\n      WHEN m.stat_month = m.first_month THEN 'new'\n      WHEN prev.vplayerid IS NOT NULL THEN 'retained'\n      WHEN m.stat_month > m.first_month THEN 'return'\n      ELSE 'other'\n    END AS user_type\n  FROM month_info m\n  LEFT JOIN prev_month_map pm ON m.stat_month = pm.stat_month\n  LEFT JOIN base prev ON prev.stat_month = pm.prev_month AND prev.vplayerid = m.vplayerid\n)\nSELECT\n  stat_month,\n  SUM(CASE WHEN user_type = 'new' THEN 1 ELSE 0 END) AS new_user_cnt,\n  SUM(CASE WHEN user_type = 'return' THEN 1 ELSE 0 END) AS return_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 1 AND 4 THEN 1 ELSE 0 END) AS light_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days BETWEEN 5 AND 15 THEN 1 ELSE 0 END) AS medium_retained_user_cnt,\n  SUM(CASE WHEN user_type = 'retained' AND active_days >= 16 THEN 1 ELSE 0 END) AS heavy_retained_user_cnt\nFROM classified\nGROUP BY stat_month\nORDER BY stat_month\n) AS final_query;", "meta": {"origin": "sql_40", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_45_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.01.01-2024.01.07参与乐园子玩法拼图狂欢在202401.08-2024.01.14没玩乐园子玩法拼图狂欢在2024.01.15-2024.01.21又玩了乐园子玩法拼图狂欢的用户\n输出：玩家数\n【表】dws_jordass_matchlog_stat_di\n【口径】imode为1287652322611036928代表乐园子玩法拼图狂欢"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect count(distinct a.vplayerid) as player_num\nfrom (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240106' and '20240112'\n    and imode = 1287652322611036928\n) a\nleft join (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240113' and '20240119'\n    and imode = 1287652322611036928\n) b on a.vplayerid = b.vplayerid\njoin (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240120' and '20240126'\n    and imode = 1287652322611036928\n) c on a.vplayerid = c.vplayerid\nwhere b.vplayerid is null\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect count(distinct a.vplayerid) as player_num\nfrom (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate > '20240106'\n    and imode = 1287652322611036928\n) a\nleft join (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240113' and '20240119'\n    and imode = 1287652322611036928\n) b on a.vplayerid = b.vplayerid\njoin (\n    select distinct vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20240120' and '20240126'\n    and imode = 1287652322611036928\n) c on a.vplayerid = c.vplayerid\nwhere b.vplayerid is null\n) AS final_query;", "meta": {"origin": "sql_45", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_70_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.11.29-2024.12.19期间，不同抽奖档位的对应人数\n输出 抽奖档位（含汇总档位），人数\n【表】dwd_jordass_activity_rewardrecord_hi\n【口径】抽奖活动：actid = 2411291018\n汇总：额外计算一个全档位统计组"}, {"role": "assistant", "content": "with base as (\n  select\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241202' and '20241222'\n    and actid = 2411291018\n)\nselect\n  award_type,\n  user_cnt\nfrom (\n  select\n    award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n  group by award_type\n  union all\n  select\n    '汇总' as award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n) t\norder by case when award_type = '汇总' then 1 else 0 end, award_type;"}], "rejected": "with base as (\n  select\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) > '20241202'\n    and actid = 2411291018\n)\nselect\n  award_type,\n  user_cnt\nfrom (\n  select\n    award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n  group by award_type\n  union all\n  select\n    '汇总' as award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n) t\norder by case when award_type = '汇总' then 1 else 0 end, award_type;", "meta": {"origin": "sql_70", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_2_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】提取1个抽样号码包，2025.07.28-2025.07.23期间付费且不包含721号码包内的用户全量。\n输出：gplayerid\n【表】dim_extract_311381_conf, dws_argothek_ce1_login_di, dws_argothek_ce1_cbt2_vplayerid_suserid_di, dws_jordass_water_di, dwd_jordass_privpackagelog_hi\n【口径】抽样号码包来源：dim_extract_311381_conf（字段 vplayerid）\n付费筛选：dws_jordass_water_di.dtstatdate 在 20250728-20250803，imoney > 0\n排除721号码包：dwd_jordass_privpackagelog_hi.packageid = 721\n渠道映射：dws_argothek_ce1_cbt2_vplayerid_suserid_di、dws_argothek_ce1_login_di\n所有日期使用字符串格式 YYYYMMDD\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH sample_user AS (\n  SELECT DISTINCT vplayerid\n  FROM dim_extract_311381_conf\n),\npaid_user AS (\n  SELECT vplayerid\n  FROM dws_jordass_water_di\n  WHERE dtstatdate BETWEEN '20250728' AND '20250803'\n    AND imoney > 0\n  GROUP BY vplayerid\n),\nexclude_721 AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_privpackagelog_hi\n  WHERE packageid = 721\n),\ntarget_user AS (\n  SELECT s.vplayerid\n  FROM sample_user s\n  JOIN paid_user p ON s.vplayerid = p.vplayerid\n  WHERE NOT EXISTS (\n    SELECT 1\n    FROM exclude_721 e\n    WHERE e.vplayerid = s.vplayerid\n  )\n)\nSELECT DISTINCT u.vplayerid AS gplayerid\nFROM target_user u\nJOIN dws_argothek_ce1_cbt2_vplayerid_suserid_di m\n  ON u.vplayerid = m.vplayerid\n AND m.dtstatdate BETWEEN '20250728' AND '20250803'\nJOIN dws_argothek_ce1_login_di l\n  ON u.vplayerid = l.vplayerid\n AND l.dtstatdate BETWEEN '20250728' AND '20250803'\n AND l.platid = 255\nORDER BY gplayerid;"}], "rejected": "WITH sample_user AS (\n  SELECT DISTINCT vplayerid\n  FROM dim_extract_311381_conf\n),\npaid_user AS (\n  SELECT vplayerid\n  FROM dws_jordass_water_di\n  WHERE dtstatdate > '20250728'\n    AND imoney > 0\n  GROUP BY vplayerid\n),\nexclude_721 AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_privpackagelog_hi\n  WHERE packageid = 721\n),\ntarget_user AS (\n  SELECT s.vplayerid\n  FROM sample_user s\n  JOIN paid_user p ON s.vplayerid = p.vplayerid\n  WHERE NOT EXISTS (\n    SELECT 1\n    FROM exclude_721 e\n    WHERE e.vplayerid = s.vplayerid\n  )\n)\nSELECT DISTINCT u.vplayerid AS gplayerid\nFROM target_user u\nJOIN dws_argothek_ce1_cbt2_vplayerid_suserid_di m\n  ON u.vplayerid = m.vplayerid\n AND m.dtstatdate BETWEEN '20250728' AND '20250803'\nJOIN dws_argothek_ce1_login_di l\n  ON u.vplayerid = l.vplayerid\n AND l.dtstatdate BETWEEN '20250728' AND '20250803'\n AND l.platid = 255\nORDER BY gplayerid;", "meta": {"origin": "sql_2", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_75_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2022080400-2024112400的研究所解锁语音数量\n输出：baseid,解锁语音数量\n【表】dwd_jordass_voicethemelog_hi\n【口径】研究所：baseid in (3336008, 3304024, 3336012, 3306028, 3304030, 3336016, 3336018, 3304038, 3336023, 3306033, 3349004, 3308014, 3336032, 3304043, 3306039, 3336041, 3301024, 3336045, 3306042)"}, {"role": "assistant", "content": "select\n  cast(baseid as string) as base_id,\n  count(*) as unlock_cnt\nfrom dwd_jordass_voicethemelog_hi\nwhere tdbank_imp_date between '2022080400' and '2024112400'\n  and baseid in (3336008, 3304024, 3336012, 3306028, 3304030, 3336016, 3336018, 3304038, 3336023, 3306033, 3349004, 3308014, 3336032, 3304043, 3306039, 3336041, 3301024, 3336045, 3306042)\ngroup by baseid\norder by base_id;"}], "rejected": "select\n  cast(baseid as string) as base_id,\n  count(*) as unlock_cnt\nfrom dwd_jordass_voicethemelog_hi\nwhere tdbank_imp_date between '2022080400' and '2024112400'\n  and baseid in (3336008, 3304024, 3336012, 3306028, 3304030, 3336016, 3336018, 3304038, 3336023, 3306033, 3349004, 3308014, 3336032, 3304043, 3306039, 3336041, 3301024, 3336045, 3306042)\ngroup by baseid\norder by base_id;", "meta": {"origin": "sql_75", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_70_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.11.29-2024.12.19期间，不同抽奖档位的对应人数\n输出 抽奖档位（含汇总档位），人数\n【表】dwd_jordass_activity_rewardrecord_hi\n【口径】抽奖活动：actid = 2411291018\n汇总：额外计算一个全档位统计组\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with base as (\n  select\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241228' and '20250117'\n    and actid = 2411291018\n)\nselect\n  award_type,\n  user_cnt\nfrom (\n  select\n    award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n  group by award_type\n  union all\n  select\n    '汇总' as award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n) t\norder by case when award_type = '汇总' then 1 else 0 end, award_type;"}], "rejected": "with base as (\n  select\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) > '20241228'\n    and actid = 2411291018\n)\nselect\n  award_type,\n  user_cnt\nfrom (\n  select\n    award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n  group by award_type\n  union all\n  select\n    '汇总' as award_type,\n    count(distinct vplayerid) as user_cnt\n  from base\n) t\norder by case when award_type = '汇总' then 1 else 0 end, award_type;", "meta": {"origin": "sql_70", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_58_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计以下时间对应玩法id下的不同对局时长人数分布\n'20230720'-'20230726'  1310822585431254784    \n'20221119'-'20221125' 1282371711108385024    \n'20221126'-'20221202' 1287652322611036928    \n'20230304'-'20230310' 1294211358396518400    \n'20230610''20230616' 1297394991875754752     \n\n对局时长按照 [0-10min)，[10-30min)，[30min-1h)，[1h,2h)，[2h,3h)，[3h,4h)， [4h,5h)，\n[5h,6h)，[6h,7h)，[7h,8h)，[8h,9h)，[9h,10h)，[10h,∞)\t\t\n输出字段：玩法id、对局时长、人数\n【表】dws_jordass_matchlog_stat_di\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH ranges AS (\n  SELECT '20230720' AS start_dt, '20230726' AS end_dt, '1310822585431254784' AS imode_id UNION ALL\n  SELECT '20221119', '20221125', '1282371711108385024' UNION ALL\n  SELECT '20221126', '20221202', '1287652322611036928' UNION ALL\n  SELECT '20230304', '20230310', '1294211358396518400' UNION ALL\n  SELECT '20230610', '20230616', '1297394991875754752'\n),\nbase AS (\n  SELECT\n    r.imode_id AS gameplay_id,\n    CASE\n      WHEN m.itemp1 < 600 THEN '[0-10min)'\n      WHEN m.itemp1 < 1800 THEN '[10-30min)'\n      WHEN m.itemp1 < 3600 THEN '[30min-1h)'\n      WHEN m.itemp1 < 7200 THEN '[1h,2h)'\n      WHEN m.itemp1 < 10800 THEN '[2h,3h)'\n      WHEN m.itemp1 < 14400 THEN '[3h,4h)'\n      WHEN m.itemp1 < 18000 THEN '[4h,5h)'\n      WHEN m.itemp1 < 21600 THEN '[5h,6h)'\n      WHEN m.itemp1 < 25200 THEN '[6h,7h)'\n      WHEN m.itemp1 < 28800 THEN '[7h,8h)'\n      WHEN m.itemp1 < 32400 THEN '[8h,9h)'\n      WHEN m.itemp1 < 36000 THEN '[9h,10h)'\n      ELSE '[10h,∞)'\n    END AS duration_bucket,\n    m.vplayerid\n  FROM dws_jordass_matchlog_stat_di m\n  JOIN ranges r\n    ON m.imode = r.imode_id\n   AND m.dtstatdate BETWEEN r.start_dt AND r.end_dt\n)\nSELECT\n  gameplay_id AS gameplayid,\n  duration_bucket,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM base\nGROUP BY gameplay_id, duration_bucket\nORDER BY gameplay_id, duration_bucket\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH ranges AS (\n  SELECT '20230720' AS start_dt, '20230726' AS end_dt, '1310822585431254784' AS imode_id UNION ALL\n  SELECT '20221119', '20221125', '1282371711108385024' UNION ALL\n  SELECT '20221126', '20221202', '1287652322611036928' UNION ALL\n  SELECT '20230304', '20230310', '1294211358396518400' UNION ALL\n  SELECT '20230610', '20230616', '1297394991875754752'\n),\nbase AS (\n  SELECT\n    r.imode_id AS gameplay_id,\n    CASE\n      WHEN m.itemp1 < 600 THEN '[0-10min)'\n      WHEN m.itemp1 < 1800 THEN '[10-30min)'\n      WHEN m.itemp1 < 3600 THEN '[30min-1h)'\n      WHEN m.itemp1 < 7200 THEN '[1h,2h)'\n      WHEN m.itemp1 < 10800 THEN '[2h,3h)'\n      WHEN m.itemp1 < 14400 THEN '[3h,4h)'\n      WHEN m.itemp1 < 18000 THEN '[4h,5h)'\n      WHEN m.itemp1 < 21600 THEN '[5h,6h)'\n      WHEN m.itemp1 < 25200 THEN '[6h,7h)'\n      WHEN m.itemp1 < 28800 THEN '[7h,8h)'\n      WHEN m.itemp1 < 32400 THEN '[8h,9h)'\n      WHEN m.itemp1 < 36000 THEN '[9h,10h)'\n      ELSE '[10h,∞)'\n    END AS duration_bucket,\n    m.vplayerid\n  FROM dws_jordass_matchlog_stat_di m\n  JOIN ranges r\n    ON m.imode = r.imode_id\n   AND m.dtstatdate BETWEEN r.start_dt AND r.end_dt\n)\nSELECT\n  gameplay_id AS gameplayid,\n  duration_bucket,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM base\nGROUP BY gameplay_id, duration_bucket\nORDER BY gameplay_id, duration_bucket\n) AS final_query;", "meta": {"origin": "sql_58", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_74_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计 SS30赛季手册和SS29赛季手册的按钮人数\nSS30赛季:2024112305 - 2024112616\nSS29赛季:2024092405 - 2024092716\n输出：按钮类型，SS30赛季手册人数，SS29赛季手册人数\n【表】dwd_jordass_pressbutton_hi\n【口径】按钮：buttontypes等于411130或411200"}, {"role": "assistant", "content": "WITH ss30 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-29 05:00:00' AND '2024-12-02 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-29 05:00:00' AND '2024-12-02 16:00:00'\n), ss29 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-30 05:00:00' AND '2024-10-03 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-30 05:00:00' AND '2024-10-03 16:00:00'\n)\nSELECT\n  b.button_type,\n  COALESCE(s30.user_cnt, 0) AS ss30_user_cnt,\n  COALESCE(s29.user_cnt, 0) AS ss29_user_cnt\nFROM (\n  SELECT '411130' AS button_type\n  UNION ALL SELECT '411200'\n) b\nLEFT JOIN ss30 s30 ON b.button_type = s30.button_type\nLEFT JOIN ss29 s29 ON b.button_type = s29.button_type\nORDER BY b.button_type;"}], "rejected": "WITH ss30 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-29 05:00:00' AND '2024-12-02 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-29 05:00:00' AND '2024-12-02 16:00:00'\n), ss29 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-30 05:00:00' AND '2024-10-03 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-30 05:00:00' AND '2024-10-03 16:00:00'\n)\nSELECT\n  b.button_type,\n  COALESCE(s30.user_cnt, 0) AS ss30_user_cnt,\n  COALESCE(s29.user_cnt, 0) AS ss29_user_cnt\nFROM (\n  SELECT '411130' AS button_type\n  UNION ALL SELECT '411200'\n) b\nLEFT JOIN ss30 s30 ON b.button_type = s30.button_type\nLEFT JOIN ss29 s29 ON b.button_type = s29.button_type\nORDER BY b.button_type;", "meta": {"origin": "sql_74", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_27_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2024-01-01到2024-12-16，购买阶段出现了x次武器代买，除自定义模式、新手、训练场外所有模式。\n输出：武器代买次数\n【表】dwd_argothek_matchdetails_hi, dwd_argothek_apinventorymovementlog_hi\n【口径】provisioningflowid = \"Matchmaking\" -- 除自定义模式、新手、训练场外所有模式\n\n对局代买筛选逻辑：\nTransactionType = \"FulfillRequest\""}, {"role": "assistant", "content": "with valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240101' and '20241216'\n    and provisioningflowid = 'Matchmaking'\n),\nproxy_buy as (\n  select\n    count(*) as buy_cnt\n  from dwd_argothek_apinventorymovementlog_hi l\n  join valid_matches m on l.matchinfomatchid = m.matchid\n  where substr(l.tdbank_imp_date, 1, 8) between '20240101' and '20241216'\n    and transactiontype = 'FulfillRequest'\n)\nselect buy_cnt as weapon_proxy_cnt from proxy_buy;"}], "rejected": "with valid_matches as (\n  select distinct matchid\n  from dwd_argothek_matchdetails_hi\n  where substr(tdbank_imp_date, 1, 8) > '20240101'\n    and provisioningflowid = 'Matchmaking'\n),\nproxy_buy as (\n  select\n    count(*) as buy_cnt\n  from dwd_argothek_apinventorymovementlog_hi l\n  join valid_matches m on l.matchinfomatchid = m.matchid\n  where substr(l.tdbank_imp_date, 1, 8) between '20240101' and '20241216'\n    and transactiontype = 'FulfillRequest'\n)\nselect buy_cnt as weapon_proxy_cnt from proxy_buy;", "meta": {"origin": "sql_27", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_74_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计 SS30赛季手册和SS29赛季手册的按钮人数\nSS30赛季:2024112305 - 2024112616\nSS29赛季:2024092405 - 2024092716\n输出：按钮类型，SS30赛季手册人数，SS29赛季手册人数\n【表】dwd_jordass_pressbutton_hi\n【口径】按钮：buttontypes等于411130或411200\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH ss30 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-27 05:00:00' AND '2024-11-30 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-27 05:00:00' AND '2024-11-30 16:00:00'\n), ss29 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-28 05:00:00' AND '2024-10-01 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-28 05:00:00' AND '2024-10-01 16:00:00'\n)\nSELECT\n  b.button_type,\n  COALESCE(s30.user_cnt, 0) AS ss30_user_cnt,\n  COALESCE(s29.user_cnt, 0) AS ss29_user_cnt\nFROM (\n  SELECT '411130' AS button_type\n  UNION ALL SELECT '411200'\n) b\nLEFT JOIN ss30 s30 ON b.button_type = s30.button_type\nLEFT JOIN ss29 s29 ON b.button_type = s29.button_type\nORDER BY b.button_type;"}], "rejected": "WITH ss30 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-27 05:00:00' AND '2024-11-30 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-11-27 05:00:00' AND '2024-11-30 16:00:00'\n), ss29 AS (\n  SELECT\n    '411130' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411130(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-28 05:00:00' AND '2024-10-01 16:00:00'\n  UNION ALL\n  SELECT\n    '411200' AS button_type,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM dwd_jordass_pressbutton_hi\n  WHERE buttontypes IS NOT NULL\n    AND REGEXP(buttontypes, '(^|;)411200(;|$)') = 1\n    AND CAST(dteventtime AS DATETIME) BETWEEN '2024-09-28 05:00:00' AND '2024-10-01 16:00:00'\n)\nSELECT\n  b.button_type,\n  COALESCE(s30.user_cnt, 0) AS ss30_user_cnt,\n  COALESCE(s29.user_cnt, 0) AS ss29_user_cnt\nFROM (\n  SELECT '411130' AS button_type\n  UNION ALL SELECT '411200'\n) b\nLEFT JOIN ss30 s30 ON b.button_type = s30.button_type\nLEFT JOIN ss29 s29 ON b.button_type = s29.button_type\nORDER BY b.button_type;", "meta": {"origin": "sql_74", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_73_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20241123-20241222对决冠军，乐园其他，和乐园汇总 三类用户的组队和对局情况\n输出：乐园总参与人数，乐园总参与局数，乐园组队人数，乐园组队局数，对决冠军总参与人数，对决冠军总参与局数，对决冠军组队人数，对决冠军组队局数，乐园其他总参与人数，乐园其他总参与局数，乐园其他组队人数，乐园其他组队局数\n【表】dwd_jordass_player_matchrecord_hi\n【口径】对决冠军：matchmode=1003 and matchsubmodegroup=1345785623905087744\n乐园其他：matchmode=1003 and matchsubmodegroup<>1345785623905087744\n乐园汇总：matchmode=1003\n都需要限制 matchresult=\"ok\"\n组队：teamnum>1\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with base as (\n  select\n    vplayerid,\n    cast(coalesce(nullif(teamnum, ''), '1') as int) as team_num,\n    matchmode,\n    matchsubmodegroup\n  from dwd_jordass_player_matchrecord_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241128' and '20241227'\n    and matchresult = 'ok'\n),\nagg as (\n  select\n    '乐园' as category,\n    count(distinct vplayerid) as total_users,\n    count(*) as total_matches,\n    count(distinct case when team_num > 1 then vplayerid end) as team_users,\n    sum(case when team_num > 1 then 1 else 0 end) as team_matches\n  from base\n  where matchmode = 1003\n  union all\n  select\n    '对决冠军',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup = 1345785623905087744\n  union all\n  select\n    '乐园其他',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup <> 1345785623905087744\n)\nselect\n  max(case when category = '乐园' then total_users end) as leyuan_total_users,\n  max(case when category = '乐园' then total_matches end) as leyuan_total_matches,\n  max(case when category = '乐园' then team_users end) as leyuan_team_users,\n  max(case when category = '乐园' then team_matches end) as leyuan_team_matches,\n  max(case when category = '对决冠军' then total_users end) as duel_total_users,\n  max(case when category = '对决冠军' then total_matches end) as duel_total_matches,\n  max(case when category = '对决冠军' then team_users end) as duel_team_users,\n  max(case when category = '对决冠军' then team_matches end) as duel_team_matches,\n  max(case when category = '乐园其他' then total_users end) as leyuan_other_total_users,\n  max(case when category = '乐园其他' then total_matches end) as leyuan_other_total_matches,\n  max(case when category = '乐园其他' then team_users end) as leyuan_other_team_users,\n  max(case when category = '乐园其他' then team_matches end) as leyuan_other_team_matches\nfrom agg;"}], "rejected": "with base as (\n  select\n    vplayerid,\n    cast(coalesce(nullif(teamnum, ''), '1') as int) as team_num,\n    matchmode,\n    matchsubmodegroup\n  from dwd_jordass_player_matchrecord_hi\n  where substr(tdbank_imp_date, 1, 8) > '20241128'\n    and matchresult = 'ok'\n),\nagg as (\n  select\n    '乐园' as category,\n    count(distinct vplayerid) as total_users,\n    count(*) as total_matches,\n    count(distinct case when team_num > 1 then vplayerid end) as team_users,\n    sum(case when team_num > 1 then 1 else 0 end) as team_matches\n  from base\n  where matchmode = 1003\n  union all\n  select\n    '对决冠军',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup = 1345785623905087744\n  union all\n  select\n    '乐园其他',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup <> 1345785623905087744\n)\nselect\n  max(case when category = '乐园' then total_users end) as leyuan_total_users,\n  max(case when category = '乐园' then total_matches end) as leyuan_total_matches,\n  max(case when category = '乐园' then team_users end) as leyuan_team_users,\n  max(case when category = '乐园' then team_matches end) as leyuan_team_matches,\n  max(case when category = '对决冠军' then total_users end) as duel_total_users,\n  max(case when category = '对决冠军' then total_matches end) as duel_total_matches,\n  max(case when category = '对决冠军' then team_users end) as duel_team_users,\n  max(case when category = '对决冠军' then team_matches end) as duel_team_matches,\n  max(case when category = '乐园其他' then total_users end) as leyuan_other_total_users,\n  max(case when category = '乐园其他' then total_matches end) as leyuan_other_total_matches,\n  max(case when category = '乐园其他' then team_users end) as leyuan_other_team_users,\n  max(case when category = '乐园其他' then team_matches end) as leyuan_other_team_matches\nfrom agg;", "meta": {"origin": "sql_73", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_60_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250226往前180天联盟用户，联盟用户的30天滚动付费人数\n输出：统计日期（YYYYMMDD），联盟并付费的人数\n【表】dws_jordass_water_di, dws_jordass_uid_login_df, dwd_jordass_player_allianceactive_hi\n【口径】联盟活跃用户统计日期：\nwhere tdbank_imp_date>=date_sub(\"20250328\",180) and tdbank_imp_date<\"20250328\"\n游戏付费流水统计日期：\nwhere dtstatdate>=date_sub(\"20250328\",210) and dtstatdate<\"20250328\" and platid=255\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH alliance_daily AS (\n  SELECT\n    tdbank_imp_date AS stat_date,\n    CAST(uid AS STRING) AS uid\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE tdbank_imp_date BETWEEN DATE_FORMAT(DATE_SUB('2025-03-28', INTERVAL 180 DAY), '%Y%m%d')\n                            AND DATE_FORMAT(DATE_SUB('2025-03-28', INTERVAL 1 DAY), '%Y%m%d')\n  GROUP BY tdbank_imp_date, uid\n), uid_map AS (\n  SELECT uid, vplayerid\n  FROM (\n    SELECT\n      CAST(uid AS STRING) AS uid,\n      vplayerid,\n      ROW_NUMBER() OVER (PARTITION BY uid ORDER BY dtstatdate DESC) AS rn\n    FROM dws_jordass_uid_login_df\n    WHERE dtstatdate <= '20250328'\n      AND platid = 255\n  ) t\n  WHERE rn = 1\n), rolling_pay AS (\n  SELECT\n    a.stat_date,\n    m.vplayerid\n  FROM alliance_daily a\n  JOIN uid_map m\n    ON a.uid = m.uid\n  WHERE EXISTS (\n    SELECT 1\n    FROM dws_jordass_water_di w\n    WHERE w.vplayerid = m.vplayerid\n      AND w.platid = 255\n      AND w.dtstatdate BETWEEN DATE_FORMAT(DATE_SUB(STR_TO_DATE(a.stat_date, '%Y%m%d'), INTERVAL 29 DAY), '%Y%m%d')\n                          AND a.stat_date\n  )\n)\nSELECT\n  stat_date,\n  COUNT(DISTINCT vplayerid) AS alliance_pay_user_cnt\nFROM rolling_pay\nGROUP BY stat_date\nORDER BY stat_date;"}], "rejected": "WITH alliance_daily AS (\n  SELECT\n    tdbank_imp_date AS stat_date,\n    CAST(uid AS STRING) AS uid\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE tdbank_imp_date BETWEEN DATE_FORMAT(DATE_SUB('2025-03-28', INTERVAL 180 DAY), '%Y%m%d')\n                            AND DATE_FORMAT(DATE_SUB('2025-03-28', INTERVAL 1 DAY), '%Y%m%d')\n  GROUP BY tdbank_imp_date, uid\n), uid_map AS (\n  SELECT uid, vplayerid\n  FROM (\n    SELECT\n      CAST(uid AS STRING) AS uid,\n      vplayerid,\n      ROW_NUMBER() OVER (PARTITION BY uid ORDER BY dtstatdate DESC) AS rn\n    FROM dws_jordass_uid_login_df\n    WHERE dtstatdate <= '20250328'\n      AND platid = 255\n  ) t\n  WHERE rn = 1\n), rolling_pay AS (\n  SELECT\n    a.stat_date,\n    m.vplayerid\n  FROM alliance_daily a\n  JOIN uid_map m\n    ON a.uid = m.uid\n  WHERE EXISTS (\n    SELECT 1\n    FROM dws_jordass_water_di w\n    WHERE w.vplayerid = m.vplayerid\n      AND w.platid = 255\n      AND w.dtstatdate BETWEEN DATE_FORMAT(DATE_SUB(STR_TO_DATE(a.stat_date, '%Y%m%d'), INTERVAL 29 DAY), '%Y%m%d')\n                          AND a.stat_date\n  )\n)\nSELECT\n  stat_date,\n  COUNT(DISTINCT vplayerid) AS alliance_pay_user_cnt\nFROM rolling_pay\nGROUP BY stat_date\nORDER BY stat_date;", "meta": {"origin": "sql_60", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_29_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计周期：2024.6.18至2025年3月30日\n输出：自然周（20240617、20240624、...、20250324），玩法名称，周平均日均参与用户数，周平均日均参与率，周平均日均参与场次\n\n参与率：玩法参与用户数 / 活跃用户数\n周平均日均参与场次：每天不同玩法平均对局数再按周求平均\n【表】dws_jordass_login_di, dws_jordass_mode_roundrecord_di\n【口径】自然周指周一到周日的完整周期，通常以周一作为起始日\n\n玩法：从上往下匹配，如果满足任一条件则返回对应的玩法名称，否则返回“其他模式”。\n如果模式为“传统模式”，且子模式名称以“CG”开头，且地图为“群屿”，则返回“主题群屿”；\n如果模式为“传统模式”且地图为“群屿”，则返回“传统群屿”；\n如果模式为“传统模式”且地图为“假日群岛”，则返回“假日群岛”；\n如果模式为“传统模式”且地图为“荣耀之城”，则返回“荣耀之城”；\n如果子模式是“广域战场模式”，则返回“广域战场”；\n如果子模式是“极能形态模式”，则返回“极能形态”；\n如果模式是“组队竞技”，则返回“组竞”；\n如果模式是“休闲模式”，则返回“休闲”；\n如果模式是“乐园”，则返回“乐园”；\n如果模式是“领地”，则返回“领地”；\n如果模式是“广阔天地”，则返回“广阔天地”\n如果模式是“生存模式”，则返回“隧道”。"}, {"role": "assistant", "content": "WITH daily_play AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS play_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    CASE\n      WHEN modename = '传统模式' AND submodename LIKE 'CG%' AND mapname = '群屿' THEN '主题群屿'\n      WHEN modename = '传统模式' AND mapname = '群屿' THEN '传统群屿'\n      WHEN modename = '传统模式' AND mapname = '假日群岛' THEN '假日群岛'\n      WHEN modename = '传统模式' AND mapname = '荣耀之城' THEN '荣耀之城'\n      WHEN submodename = '广域战场模式' THEN '广域战场'\n      WHEN submodename = '极能形态模式' THEN '极能形态'\n      WHEN modename = '组队竞技' THEN '组竞'\n      WHEN modename = '休闲模式' THEN '休闲'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '隧道'\n      ELSE '其他模式'\n    END AS gameplay,\n    COUNT(DISTINCT vplayerid) AS participants,\n    SUM(roundcnt) AS match_cnt\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate BETWEEN '20240618' AND '20250330'\n  GROUP BY play_date, week_start, gameplay\n),\ndaily_active AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS act_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    COUNT(DISTINCT vplayerid) AS active_cnt\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20240618' AND '20250330'\n  GROUP BY act_date, week_start\n),\nmerged AS (\n  SELECT\n    p.week_start,\n    p.play_date,\n    p.gameplay,\n    p.participants,\n    p.match_cnt,\n    COALESCE(a.active_cnt, 0) AS active_cnt,\n    CASE WHEN COALESCE(a.active_cnt, 0) = 0 THEN 0 ELSE p.participants / a.active_cnt END AS daily_rate,\n    CASE WHEN p.participants = 0 THEN 0 ELSE p.match_cnt / p.participants END AS daily_avg_match\n  FROM daily_play p\n  LEFT JOIN daily_active a\n    ON p.play_date = a.act_date\n   AND p.week_start = a.week_start\n),\nweekly_stats AS (\n  SELECT\n    week_start,\n    gameplay,\n    COUNT(DISTINCT play_date) AS days_in_week,\n    SUM(participants) AS total_participants,\n    SUM(active_cnt) AS total_active,\n    SUM(match_cnt) AS total_matches,\n    AVG(participants) AS avg_daily_participants,\n    AVG(daily_rate) AS avg_daily_rate,\n    AVG(daily_avg_match) AS avg_daily_matches\n  FROM merged\n  GROUP BY week_start, gameplay\n)\nSELECT\n  DATE_FORMAT(week_start, '%Y%m%d') AS week_start_label,\n  gameplay,\n  ROUND(avg_daily_participants, 2) AS avg_daily_participants,\n  ROUND(avg_daily_rate, 4) AS avg_daily_participation_rate,\n  ROUND(avg_daily_matches, 4) AS avg_daily_matches\nFROM weekly_stats\nWHERE week_start BETWEEN DATE '2024-06-17' AND DATE '2025-03-24'\nORDER BY week_start, gameplay;"}], "rejected": "WITH daily_play AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS play_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    CASE\n      WHEN modename = '传统模式' AND submodename LIKE 'CG%' AND mapname = '群屿' THEN '主题群屿'\n      WHEN modename = '传统模式' AND mapname = '群屿' THEN '传统群屿'\n      WHEN modename = '传统模式' AND mapname = '假日群岛' THEN '假日群岛'\n      WHEN modename = '传统模式' AND mapname = '荣耀之城' THEN '荣耀之城'\n      WHEN submodename = '广域战场模式' THEN '广域战场'\n      WHEN submodename = '极能形态模式' THEN '极能形态'\n      WHEN modename = '组队竞技' THEN '组竞'\n      WHEN modename = '休闲模式' THEN '休闲'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '隧道'\n      ELSE '其他模式'\n    END AS gameplay,\n    COUNT(DISTINCT vplayerid) AS participants,\n    SUM(roundcnt) AS match_cnt\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate > '20240618'\n  GROUP BY play_date, week_start, gameplay\n),\ndaily_active AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS act_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    COUNT(DISTINCT vplayerid) AS active_cnt\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20240618' AND '20250330'\n  GROUP BY act_date, week_start\n),\nmerged AS (\n  SELECT\n    p.week_start,\n    p.play_date,\n    p.gameplay,\n    p.participants,\n    p.match_cnt,\n    COALESCE(a.active_cnt, 0) AS active_cnt,\n    CASE WHEN COALESCE(a.active_cnt, 0) = 0 THEN 0 ELSE p.participants / a.active_cnt END AS daily_rate,\n    CASE WHEN p.participants = 0 THEN 0 ELSE p.match_cnt / p.participants END AS daily_avg_match\n  FROM daily_play p\n  LEFT JOIN daily_active a\n    ON p.play_date = a.act_date\n   AND p.week_start = a.week_start\n),\nweekly_stats AS (\n  SELECT\n    week_start,\n    gameplay,\n    COUNT(DISTINCT play_date) AS days_in_week,\n    SUM(participants) AS total_participants,\n    SUM(active_cnt) AS total_active,\n    SUM(match_cnt) AS total_matches,\n    AVG(participants) AS avg_daily_participants,\n    AVG(daily_rate) AS avg_daily_rate,\n    AVG(daily_avg_match) AS avg_daily_matches\n  FROM merged\n  GROUP BY week_start, gameplay\n)\nSELECT\n  DATE_FORMAT(week_start, '%Y%m%d') AS week_start_label,\n  gameplay,\n  ROUND(avg_daily_participants, 2) AS avg_daily_participants,\n  ROUND(avg_daily_rate, 4) AS avg_daily_participation_rate,\n  ROUND(avg_daily_matches, 4) AS avg_daily_matches\nFROM weekly_stats\nWHERE week_start BETWEEN DATE '2024-06-17' AND DATE '2025-03-24'\nORDER BY week_start, gameplay;", "meta": {"origin": "sql_29", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_41_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.1.1～1.3，每天活跃玩家数\n输出：统计日期(20240106、20240107、20240108)、玩家数\n【表】dws_jordass_login_di\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  dtstatdate as stat_date,\n  count(distinct vplayerid) as player_cnt\nfrom dws_jordass_login_di\nwhere dtstatdate between '20240106' and '20240108'\ngroup by dtstatdate\norder by dtstatdate\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  dtstatdate as stat_date,\n  count(distinct vplayerid) as player_cnt\nfrom dws_jordass_login_di\nwhere dtstatdate > '20240106'\ngroup by dtstatdate\norder by dtstatdate\n) AS final_query;", "meta": {"origin": "sql_41", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_67_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.1.24-2025.2.6时间区间内，道具为430487,430485,602004025,602002011 的产出次数\t\n输出：道具id，产出次数\n【表】dwd_jordass_gearlog_hi\n【口径】addorreduce=0表示产出，1表示消耗"}, {"role": "assistant", "content": "select\n  cast(igoodsid as string) as goods_id,\n  sum(coalesce(count, 0)) as produce_cnt\nfrom dwd_jordass_gearlog_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20250127' and '20250209'\n  and igoodsid in (430487, 430485, 602004025, 602002011)\n  and addorreduce = 0\ngroup by igoodsid\norder by goods_id;"}], "rejected": "select\n  cast(igoodsid as string) as goods_id,\n  sum(coalesce(count, 0)) as produce_cnt\nfrom dwd_jordass_gearlog_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20250127'\n  and igoodsid in (430487, 430485, 602004025, 602002011)\n  and addorreduce = 0\ngroup by igoodsid\norder by goods_id;", "meta": {"origin": "sql_67", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_46_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.1.1-2024.2.2期间，每个自然周不同周活跃天数玩家数\n输出：统计周(1、2、3...、5)、周活跃天数、玩家数\n【表】dws_jordass_login_di\n【口径】"}, {"role": "assistant", "content": "select\n    week, -- 统计周\n    active_days, -- 活跃天数\n    count(distinct vplayerid) as user_num -- 玩家数\nfrom (\n    select\n        vplayerid, -- 玩家playerid\n        weekofyear(dtstatdate) as week, -- 统计周\n        count(distinct dtstatdate) as active_days -- 活跃天数\n    from dws_jordass_login_di\n    where dtstatdate >= '20240101' and dtstatdate <= '20240202' and platid=255\n    group by\n        vplayerid,\n        weekofyear(dtstatdate)\n)f\ngroup by\n    week,\n    active_days;"}], "rejected": "select\n    week, -- 统计周\n    active_days, -- 活跃天数\n    count(distinct vplayerid) as user_num -- 玩家数\nfrom (\n    select\n        vplayerid, -- 玩家playerid\n        weekofyear(dtstatdate) as week, -- 统计周\n        count(distinct dtstatdate) as active_days -- 活跃天数\n    from dws_jordass_login_di\n    where dtstatdate >= '20240101' and dtstatdate <= '20240202' and platid=255\n    group by\n        vplayerid,\n        weekofyear(dtstatdate)\n)f\ngroup by\n    week,\n    active_days;", "meta": {"origin": "sql_46", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_71_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.11.29-2024.12.19期间，每七天统计一次阶梯活动相关用户数\n输出 日期范围（20241202-20241208、20241209-20241215、20241216-20241222），extarg1类型，用户数，次数\n【表】dwd_jordass_activitypress_hi\n【口径】阶梯活动：ireason = 2411291018 and buttontype = 10045 and extarg1 in (101,109,110)"}, {"role": "assistant", "content": "with tagged as (\n  select\n    case\n      when substr(tdbank_imp_date, 1, 8) between '20241202' and '20241208' then '20241202-20241208'\n      when substr(tdbank_imp_date, 1, 8) between '20241209' and '20241215' then '20241209-20241215'\n      when substr(tdbank_imp_date, 1, 8) between '20241216' and '20241222' then '20241216-20241222'\n      else null\n    end as range_flag,\n    extarg1,\n    vplayerid\n  from dwd_jordass_activitypress_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241202' and '20241222'\n    and ireason = 2411291018\n    and buttontype = 10045\n    and extarg1 in (101, 109, 110)\n)\nselect\n  range_flag as date_range,\n  cast(extarg1 as string) as extarg1_type,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as press_cnt\nfrom tagged\nwhere range_flag is not null\ngroup by range_flag, extarg1_type\norder by date_range, extarg1_type;"}], "rejected": "with tagged as (\n  select\n    case\n      when substr(tdbank_imp_date, 1, 8) > '20241202' then '20241202-20241208'\n      when substr(tdbank_imp_date, 1, 8) between '20241209' and '20241215' then '20241209-20241215'\n      when substr(tdbank_imp_date, 1, 8) between '20241216' and '20241222' then '20241216-20241222'\n      else null\n    end as range_flag,\n    extarg1,\n    vplayerid\n  from dwd_jordass_activitypress_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241202' and '20241222'\n    and ireason = 2411291018\n    and buttontype = 10045\n    and extarg1 in (101, 109, 110)\n)\nselect\n  range_flag as date_range,\n  cast(extarg1 as string) as extarg1_type,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as press_cnt\nfrom tagged\nwhere range_flag is not null\ngroup by range_flag, extarg1_type\norder by date_range, extarg1_type;", "meta": {"origin": "sql_71", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_75_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2022080400-2024112400的研究所解锁语音数量\n输出：baseid,解锁语音数量\n【表】dwd_jordass_voicethemelog_hi\n【口径】研究所：baseid in (3336008, 3304024, 3336012, 3306028, 3304030, 3336016, 3336018, 3304038, 3336023, 3306033, 3349004, 3308014, 3336032, 3304043, 3306039, 3336041, 3301024, 3336045, 3306042)\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  cast(baseid as string) as base_id,\n  count(*) as unlock_cnt\nfrom dwd_jordass_voicethemelog_hi\nwhere tdbank_imp_date between '2022080400' and '2024112400'\n  and baseid in (3336008, 3304024, 3336012, 3306028, 3304030, 3336016, 3336018, 3304038, 3336023, 3306033, 3349004, 3308014, 3336032, 3304043, 3306039, 3336041, 3301024, 3336045, 3306042)\ngroup by baseid\norder by base_id;"}], "rejected": "select\n  cast(baseid as string) as base_id,\n  count(*) as unlock_cnt\nfrom dwd_jordass_voicethemelog_hi\nwhere tdbank_imp_date between '2022080400' and '2024112400'\n  and baseid in (3336008, 3304024, 3336012, 3306028, 3304030, 3336016, 3336018, 3304038, 3336023, 3306033, 3349004, 3308014, 3336032, 3304043, 3306039, 3336041, 3301024, 3336045, 3306042)\ngroup by baseid\norder by base_id;", "meta": {"origin": "sql_75", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_19_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024年5月02日-2024年5月02日，日活跃用户的周边休闲模式情况。\n\n活跃日期区间：\"20250503-20250509\"\n\n输出：\n日活跃中仅玩QuickMatch模式的玩家数\n日活跃中仅玩RushMode模式的玩家数\n日活跃中仅玩CombatArena模式的玩家数\n日活跃中仅玩以上三个模式不玩其他模式的玩家数\n日活跃中仅玩以上三个模式不玩其他模式的玩家周活跃频次\n【表】dws_argothek_oss_login_di, dwd_argothek_playermatchstats_hi, dim_argothek_gplayerid_vroleid_df\n【口径】仅玩单一模式逻辑：\nhaving count(distinct queueid) = 1 -- 只玩一个模式\nand max(queueid) = \"xxx\" -- 模式ID为RushMode\n用户角色映射逻辑：\niareaid = \"101\""}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH active_login AS (\n  SELECT\n    statis_date,\n    iuserid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20250503 AND 20250509\n  GROUP BY statis_date, iuserid\n), role_map AS (\n  SELECT vroleid, iuserid\n  FROM (\n    SELECT\n      vroleid,\n      iuserid,\n      ROW_NUMBER() OVER (PARTITION BY vroleid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid_vroleid_df\n    WHERE iAreaID = '101'\n      AND dtstatdate <= '20250509'\n  ) t\n  WHERE rn = 1\n), match_log AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    vroleid,\n    LOWER(queueid) AS queueid\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') BETWEEN '20250503' AND '20250509'\n), match_player AS (\n  SELECT\n    m.statis_date,\n    r.iuserid,\n    m.queueid\n  FROM match_log m\n  JOIN role_map r\n    ON m.vroleid = r.vroleid\n), player_modes AS (\n  SELECT\n    a.statis_date,\n    a.iuserid,\n    COUNT(DISTINCT mp.queueid) AS total_modes_cnt,\n    MAX(CASE WHEN mp.queueid = 'quickmatch' THEN 1 ELSE 0 END) AS has_quick,\n    MAX(CASE WHEN mp.queueid = 'rushmode' THEN 1 ELSE 0 END) AS has_rush,\n    MAX(CASE WHEN mp.queueid = 'combatarena' THEN 1 ELSE 0 END) AS has_combat,\n    MAX(CASE WHEN mp.queueid IS NOT NULL AND mp.queueid NOT IN ('quickmatch', 'rushmode', 'combatarena') THEN 1 ELSE 0 END) AS has_other\n  FROM active_login a\n  LEFT JOIN match_player mp\n    ON a.statis_date = mp.statis_date\n   AND a.iuserid = mp.iuserid\n  GROUP BY a.statis_date, a.iuserid\n), player_day_flags AS (\n  SELECT\n    statis_date,\n    iuserid,\n    CASE WHEN total_modes_cnt = 1 AND has_quick = 1 THEN 1 ELSE 0 END AS only_quick_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_rush = 1 THEN 1 ELSE 0 END AS only_rush_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_combat = 1 THEN 1 ELSE 0 END AS only_combat_flag,\n    CASE WHEN total_modes_cnt > 0 AND COALESCE(has_other, 0) = 0 THEN 1 ELSE 0 END AS only_three_flag\n  FROM player_modes\n), daily_summary AS (\n  SELECT\n    statis_date,\n    SUM(only_quick_flag) AS only_quick_user_cnt,\n    SUM(only_rush_flag) AS only_rush_user_cnt,\n    SUM(only_combat_flag) AS only_combat_user_cnt,\n    SUM(only_three_flag) AS only_three_modes_user_cnt\n  FROM player_day_flags\n  GROUP BY statis_date\n), weekly_freq AS (\n  SELECT SUM(only_three_flag) AS only_three_modes_week_freq\n  FROM player_day_flags\n)\nSELECT\n  d.statis_date AS statis_date,\n  d.only_quick_user_cnt AS only_quick_user_cnt,\n  d.only_rush_user_cnt AS only_rush_user_cnt,\n  d.only_combat_user_cnt AS only_combat_user_cnt,\n  d.only_three_modes_user_cnt AS only_three_modes_user_cnt,\n  wf.only_three_modes_week_freq AS only_three_modes_week_freq\nFROM daily_summary d\nCROSS JOIN weekly_freq wf\nORDER BY statis_date\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH active_login AS (\n  SELECT\n    statis_date,\n    iuserid\n  FROM dws_argothek_oss_login_di\n  WHERE statis_date BETWEEN 20250503 AND 20250509\n  GROUP BY statis_date, iuserid\n), role_map AS (\n  SELECT vroleid, iuserid\n  FROM (\n    SELECT\n      vroleid,\n      iuserid,\n      ROW_NUMBER() OVER (PARTITION BY vroleid ORDER BY dtstatdate DESC) AS rn\n    FROM dim_argothek_gplayerid_vroleid_df\n    WHERE iAreaID = '101'\n      AND dtstatdate <= '20250509'\n  ) t\n  WHERE rn = 1\n), match_log AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    vroleid,\n    LOWER(queueid) AS queueid\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') > '20250503'\n), match_player AS (\n  SELECT\n    m.statis_date,\n    r.iuserid,\n    m.queueid\n  FROM match_log m\n  JOIN role_map r\n    ON m.vroleid = r.vroleid\n), player_modes AS (\n  SELECT\n    a.statis_date,\n    a.iuserid,\n    COUNT(DISTINCT mp.queueid) AS total_modes_cnt,\n    MAX(CASE WHEN mp.queueid = 'quickmatch' THEN 1 ELSE 0 END) AS has_quick,\n    MAX(CASE WHEN mp.queueid = 'rushmode' THEN 1 ELSE 0 END) AS has_rush,\n    MAX(CASE WHEN mp.queueid = 'combatarena' THEN 1 ELSE 0 END) AS has_combat,\n    MAX(CASE WHEN mp.queueid IS NOT NULL AND mp.queueid NOT IN ('quickmatch', 'rushmode', 'combatarena') THEN 1 ELSE 0 END) AS has_other\n  FROM active_login a\n  LEFT JOIN match_player mp\n    ON a.statis_date = mp.statis_date\n   AND a.iuserid = mp.iuserid\n  GROUP BY a.statis_date, a.iuserid\n), player_day_flags AS (\n  SELECT\n    statis_date,\n    iuserid,\n    CASE WHEN total_modes_cnt = 1 AND has_quick = 1 THEN 1 ELSE 0 END AS only_quick_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_rush = 1 THEN 1 ELSE 0 END AS only_rush_flag,\n    CASE WHEN total_modes_cnt = 1 AND has_combat = 1 THEN 1 ELSE 0 END AS only_combat_flag,\n    CASE WHEN total_modes_cnt > 0 AND COALESCE(has_other, 0) = 0 THEN 1 ELSE 0 END AS only_three_flag\n  FROM player_modes\n), daily_summary AS (\n  SELECT\n    statis_date,\n    SUM(only_quick_flag) AS only_quick_user_cnt,\n    SUM(only_rush_flag) AS only_rush_user_cnt,\n    SUM(only_combat_flag) AS only_combat_user_cnt,\n    SUM(only_three_flag) AS only_three_modes_user_cnt\n  FROM player_day_flags\n  GROUP BY statis_date\n), weekly_freq AS (\n  SELECT SUM(only_three_flag) AS only_three_modes_week_freq\n  FROM player_day_flags\n)\nSELECT\n  d.statis_date AS statis_date,\n  d.only_quick_user_cnt AS only_quick_user_cnt,\n  d.only_rush_user_cnt AS only_rush_user_cnt,\n  d.only_combat_user_cnt AS only_combat_user_cnt,\n  d.only_three_modes_user_cnt AS only_three_modes_user_cnt,\n  wf.only_three_modes_week_freq AS only_three_modes_week_freq\nFROM daily_summary d\nCROSS JOIN weekly_freq wf\nORDER BY statis_date\n) AS final_query;", "meta": {"origin": "sql_19", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_9_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250702手游fps最后活跃日期为近半年的用户的城市等级分布。\n输出：城市等级，用户人数\n【表】dim_mgamejp_account_allinfo_nf, dim_uf_player_gameinfo_mf\n【口径】用户固定筛选逻辑:\nand saccounttype = \"-100\" -- 账户类型为-100\nand suseridtype in (\"qq\",\"wxid\") -- 用户类型为qq或wxid\nand sgamecode in (\"esports\",\"mobile_live\",\"initiatived\",\"allianceforce\",\"strategy\",\"jordass\",\"su\",\"playzone\",\"battlezone\",\"battlearena\",\"weapon\",\"playhub\",\"manager\",\"apgame\") -- 游戏代码为指定的手游fps\n活跃日期逻辑:\n基于当前统计时间20250702向前计算6个月的登陆日期，即ilastactdate >= \"20250128\"\n城市等级分布：\n当前时间为20250702，城市等级分布的相关表是月表，所以需要取kp_imp_date = \"202506\"的数据作为关联数据\n可选过滤：以上条件可按需勾选。\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with base as (\n  select\n    suserid,\n    suseridtype\n  from dim_mgamejp_account_allinfo_nf\n  where dtstatdate = 20250726\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid')\n    and sgamecode in ('esports','mobile_live','initiatived','allianceforce','strategy','jordass','su','playzone','battlezone','battlearena','weapon','playhub','manager','apgame')\n    and splattype = '-100'\n    and splat = '-100'\n    and ilastactdate >= 20250128\n),\njoined as (\n  select\n    b.suserid,\n    coalesce(u.city_level, '未知') as city_level\n  from base b\n  left join dim_uf_player_gameinfo_mf u\n    on u.kp_imp_date = '202506'\n   and u.userid = b.suserid\n   and u.id_type = case when b.suseridtype = 'wxid' then 'wx' else b.suseridtype end\n)\nselect\n  city_level,\n  count(distinct suserid) as user_cnt\nfrom joined\ngroup by city_level\norder by city_level;"}], "rejected": "with base as (\n  select\n    suserid,\n    suseridtype\n  from dim_mgamejp_account_allinfo_nf\n  where dtstatdate = 20250726\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid')\n    and sgamecode in ('esports','mobile_live','initiatived','allianceforce','strategy','jordass','su','playzone','battlezone','battlearena','weapon','playhub','manager','apgame')\n    and splattype = '-100'\n    and splat = '-100'\n    and ilastactdate >= 20250128\n),\njoined as (\n  select\n    b.suserid,\n    coalesce(u.city_level, '未知') as city_level\n  from base b\n  left join dim_uf_player_gameinfo_mf u\n    on u.kp_imp_date = '202506'\n   and u.userid = b.suserid\n   and u.id_type = case when b.suseridtype = 'wxid' then 'wx' else b.suseridtype end\n)\nselect\n  city_level,\n  count(distinct suserid) as user_cnt\nfrom joined\ngroup by city_level\norder by city_level;", "meta": {"origin": "sql_9", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_35_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024年3月26日~4月3日\n2024年5月28日~6月5日\n不同对局类型的游戏和玩法留存情况\n输出：统计日期(20240428、...、20240506、20240630、...、20240708)、对局类型（第一人称、单排、双排、四排），每日对局人数、次数、对局总时长(秒)、游戏次留人数、游戏7留人数，玩法次留人数、玩法7留人数\n【表】dws_jordass_login_di, dws_jordass_mode_roundrecord_di\n【口径】第一人称：mode 的取值在 401、402 或 403；\n单排： mode 等于 101；\n双排： mode 等于 102；\n四排： mode 等于 103 或 603。\n\n玩法次留：当天参与玩法且第二天同样参与玩法\n游戏次留：当天在游戏活跃且第2天也在游戏活跃\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with round_user as (\n    select dtstatdate,\n        case \n            when mode in (401,402,403) then '第一人称'\n            when mode =101 then '单排'\n            when mode =102 then '双排'\n            when mode in (103,603) then '四排'\n        end modename,\n        vplayerid,\n        sum(roundcnt) roundcnt,\n        sum(roundtime) roundtime\n    from dws_jordass_mode_roundrecord_di\n    where ((dtstatdate between '20240428' and '20240512')\n    or (dtstatdate between '20240630' and '20240714'))\n    and mode in (401,402,403,101,102,103,603)\n    group by dtstatdate,\n    case when mode in (401,402,403) then '第一人称'\n        when mode =101 then '单排'\n        when mode =102 then '双排'\n        when mode in (103,603) then '四排'\n    end,\n    vplayerid\n)\n\nselect \n    a.dtstatdate,\n    a.modename,\n    count(distinct a.vplayerid) iusernum,\n    sum(a.roundcnt) roundcnt,\n    sum(a.roundtime) roundtime,\n    count(distinct b1.vplayerid) stay2,\n    count(distinct b2.vplayerid) stay7,\n    count(distinct c1.vplayerid) playstay2,\n    count(distinct c2.vplayerid) playstay7\nfrom (\n    select * from round_user \n    where((dtstatdate between '20240428' and '20240506') or (dtstatdate between '20240630' and '20240708'))\n) a\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240428' and '20240507') or (dtstatdate between '20240630' and '20240709')) \n    and platid =255\n    group by dtstatdate,vplayerid\n) b1 \non a.vplayerid = b1.vplayerid and date_add(a.dtstatdate,1) = b1.dtstatdate\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240428' and '20240512') or (dtstatdate between '20240630' and '20240714')) and platid =255\n    group by dtstatdate,vplayerid\n) b2 \non a.vplayerid = b2.vplayerid and date_add(a.dtstatdate,6) = b2.dtstatdate\nleft join round_user c1 \non a.vplayerid = c1.vplayerid and date_add(a.dtstatdate,1) = c1.dtstatdate and a.modename= c1.modename\nleft join round_user c2 \non a.vplayerid = c2.vplayerid and date_add(a.dtstatdate,6) = c2.dtstatdate and a.modename= c2.modename\ngroup by a.dtstatdate,a.modename\n;"}], "rejected": "with round_user as (\n    select dtstatdate,\n        case \n            when mode in (401,402,403) then '第一人称'\n            when mode =101 then '单排'\n            when mode =102 then '双排'\n            when mode in (103,603) then '四排'\n        end modename,\n        vplayerid,\n        sum(roundcnt) roundcnt,\n        sum(roundtime) roundtime\n    from dws_jordass_mode_roundrecord_di\n    where ((dtstatdate > '20240428')\n    or (dtstatdate between '20240630' and '20240714'))\n    and mode in (401,402,403,101,102,103,603)\n    group by dtstatdate,\n    case when mode in (401,402,403) then '第一人称'\n        when mode =101 then '单排'\n        when mode =102 then '双排'\n        when mode in (103,603) then '四排'\n    end,\n    vplayerid\n)\n\nselect \n    a.dtstatdate,\n    a.modename,\n    count(distinct a.vplayerid) iusernum,\n    sum(a.roundcnt) roundcnt,\n    sum(a.roundtime) roundtime,\n    count(distinct b1.vplayerid) stay2,\n    count(distinct b2.vplayerid) stay7,\n    count(distinct c1.vplayerid) playstay2,\n    count(distinct c2.vplayerid) playstay7\nfrom (\n    select * from round_user \n    where((dtstatdate between '20240428' and '20240506') or (dtstatdate between '20240630' and '20240708'))\n) a\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240428' and '20240507') or (dtstatdate between '20240630' and '20240709')) \n    and platid =255\n    group by dtstatdate,vplayerid\n) b1 \non a.vplayerid = b1.vplayerid and date_add(a.dtstatdate,1) = b1.dtstatdate\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240428' and '20240512') or (dtstatdate between '20240630' and '20240714')) and platid =255\n    group by dtstatdate,vplayerid\n) b2 \non a.vplayerid = b2.vplayerid and date_add(a.dtstatdate,6) = b2.dtstatdate\nleft join round_user c1 \non a.vplayerid = c1.vplayerid and date_add(a.dtstatdate,1) = c1.dtstatdate and a.modename= c1.modename\nleft join round_user c2 \non a.vplayerid = c2.vplayerid and date_add(a.dtstatdate,6) = c2.dtstatdate and a.modename= c2.modename\ngroup by a.dtstatdate,a.modename\n;", "meta": {"origin": "sql_35", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_29_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计周期：2024.6.18至2025年3月30日\n输出：自然周（20240628、20240705、...、20250404），玩法名称，周平均日均参与用户数，周平均日均参与率，周平均日均参与场次\n\n参与率：玩法参与用户数 / 活跃用户数\n周平均日均参与场次：每天不同玩法平均对局数再按周求平均\n【表】dws_jordass_login_di, dws_jordass_mode_roundrecord_di\n【口径】自然周指周一到周日的完整周期，通常以周一作为起始日\n\n玩法：从上往下匹配，如果满足任一条件则返回对应的玩法名称，否则返回“其他模式”。\n如果模式为“传统模式”，且子模式名称以“CG”开头，且地图为“群屿”，则返回“主题群屿”；\n如果模式为“传统模式”且地图为“群屿”，则返回“传统群屿”；\n如果模式为“传统模式”且地图为“假日群岛”，则返回“假日群岛”；\n如果模式为“传统模式”且地图为“荣耀之城”，则返回“荣耀之城”；\n如果子模式是“广域战场模式”，则返回“广域战场”；\n如果子模式是“极能形态模式”，则返回“极能形态”；\n如果模式是“组队竞技”，则返回“组竞”；\n如果模式是“休闲模式”，则返回“休闲”；\n如果模式是“乐园”，则返回“乐园”；\n如果模式是“领地”，则返回“领地”；\n如果模式是“广阔天地”，则返回“广阔天地”\n如果模式是“生存模式”，则返回“隧道”。\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH daily_play AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS play_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    CASE\n      WHEN modename = '传统模式' AND submodename LIKE 'CG%' AND mapname = '群屿' THEN '主题群屿'\n      WHEN modename = '传统模式' AND mapname = '群屿' THEN '传统群屿'\n      WHEN modename = '传统模式' AND mapname = '假日群岛' THEN '假日群岛'\n      WHEN modename = '传统模式' AND mapname = '荣耀之城' THEN '荣耀之城'\n      WHEN submodename = '广域战场模式' THEN '广域战场'\n      WHEN submodename = '极能形态模式' THEN '极能形态'\n      WHEN modename = '组队竞技' THEN '组竞'\n      WHEN modename = '休闲模式' THEN '休闲'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '隧道'\n      ELSE '其他模式'\n    END AS gameplay,\n    COUNT(DISTINCT vplayerid) AS participants,\n    SUM(roundcnt) AS match_cnt\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate BETWEEN '20240629' AND '20250410'\n  GROUP BY play_date, week_start, gameplay\n),\ndaily_active AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS act_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    COUNT(DISTINCT vplayerid) AS active_cnt\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20240629' AND '20250410'\n  GROUP BY act_date, week_start\n),\nmerged AS (\n  SELECT\n    p.week_start,\n    p.play_date,\n    p.gameplay,\n    p.participants,\n    p.match_cnt,\n    COALESCE(a.active_cnt, 0) AS active_cnt,\n    CASE WHEN COALESCE(a.active_cnt, 0) = 0 THEN 0 ELSE p.participants / a.active_cnt END AS daily_rate,\n    CASE WHEN p.participants = 0 THEN 0 ELSE p.match_cnt / p.participants END AS daily_avg_match\n  FROM daily_play p\n  LEFT JOIN daily_active a\n    ON p.play_date = a.act_date\n   AND p.week_start = a.week_start\n),\nweekly_stats AS (\n  SELECT\n    week_start,\n    gameplay,\n    COUNT(DISTINCT play_date) AS days_in_week,\n    SUM(participants) AS total_participants,\n    SUM(active_cnt) AS total_active,\n    SUM(match_cnt) AS total_matches,\n    AVG(participants) AS avg_daily_participants,\n    AVG(daily_rate) AS avg_daily_rate,\n    AVG(daily_avg_match) AS avg_daily_matches\n  FROM merged\n  GROUP BY week_start, gameplay\n)\nSELECT\n  DATE_FORMAT(week_start, '%Y%m%d') AS week_start_label,\n  gameplay,\n  ROUND(avg_daily_participants, 2) AS avg_daily_participants,\n  ROUND(avg_daily_rate, 4) AS avg_daily_participation_rate,\n  ROUND(avg_daily_matches, 4) AS avg_daily_matches\nFROM weekly_stats\nWHERE week_start BETWEEN DATE '2024-06-28' AND DATE '2025-04-04'\nORDER BY week_start, gameplay;"}], "rejected": "WITH daily_play AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS play_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    CASE\n      WHEN modename = '传统模式' AND submodename LIKE 'CG%' AND mapname = '群屿' THEN '主题群屿'\n      WHEN modename = '传统模式' AND mapname = '群屿' THEN '传统群屿'\n      WHEN modename = '传统模式' AND mapname = '假日群岛' THEN '假日群岛'\n      WHEN modename = '传统模式' AND mapname = '荣耀之城' THEN '荣耀之城'\n      WHEN submodename = '广域战场模式' THEN '广域战场'\n      WHEN submodename = '极能形态模式' THEN '极能形态'\n      WHEN modename = '组队竞技' THEN '组竞'\n      WHEN modename = '休闲模式' THEN '休闲'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '隧道'\n      ELSE '其他模式'\n    END AS gameplay,\n    COUNT(DISTINCT vplayerid) AS participants,\n    SUM(roundcnt) AS match_cnt\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate > '20240629'\n  GROUP BY play_date, week_start, gameplay\n),\ndaily_active AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS act_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    COUNT(DISTINCT vplayerid) AS active_cnt\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20240629' AND '20250410'\n  GROUP BY act_date, week_start\n),\nmerged AS (\n  SELECT\n    p.week_start,\n    p.play_date,\n    p.gameplay,\n    p.participants,\n    p.match_cnt,\n    COALESCE(a.active_cnt, 0) AS active_cnt,\n    CASE WHEN COALESCE(a.active_cnt, 0) = 0 THEN 0 ELSE p.participants / a.active_cnt END AS daily_rate,\n    CASE WHEN p.participants = 0 THEN 0 ELSE p.match_cnt / p.participants END AS daily_avg_match\n  FROM daily_play p\n  LEFT JOIN daily_active a\n    ON p.play_date = a.act_date\n   AND p.week_start = a.week_start\n),\nweekly_stats AS (\n  SELECT\n    week_start,\n    gameplay,\n    COUNT(DISTINCT play_date) AS days_in_week,\n    SUM(participants) AS total_participants,\n    SUM(active_cnt) AS total_active,\n    SUM(match_cnt) AS total_matches,\n    AVG(participants) AS avg_daily_participants,\n    AVG(daily_rate) AS avg_daily_rate,\n    AVG(daily_avg_match) AS avg_daily_matches\n  FROM merged\n  GROUP BY week_start, gameplay\n)\nSELECT\n  DATE_FORMAT(week_start, '%Y%m%d') AS week_start_label,\n  gameplay,\n  ROUND(avg_daily_participants, 2) AS avg_daily_participants,\n  ROUND(avg_daily_rate, 4) AS avg_daily_participation_rate,\n  ROUND(avg_daily_matches, 4) AS avg_daily_matches\nFROM weekly_stats\nWHERE week_start BETWEEN DATE '2024-06-28' AND DATE '2025-04-04'\nORDER BY week_start, gameplay;", "meta": {"origin": "sql_29", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_37_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计注册日期在2025.4.1-2025.5.30的模拟器新进用户在用户类型（模拟器、手机端、整体砺刃游戏内），次留、三留、七留、14留、30留情况\n输出:日期(20250407、...、20250605)、人数、用户类型（模拟器、手机端、游戏内、未知）、次留人数、三留人数、七留人数、14留人数、30留人数\n【表】dws_jordass_device_login_di, dws_jordass_emulator_df, dws_jordass_login_di\n【口径】模拟器新进用户从dws_jordass_emulator_df取，限制统计日期为20251001\n模拟器：device_type in (1,5)；\n手机端：device_type=0"}, {"role": "assistant", "content": "select \n    s1.ds as `ds`, -- 日期\n    count(distinct s1.vplayerid) as `user_cnt`, -- 人数\n    coalesce(user_type, '未知') as `user_type`, -- 用户类型\n    count(distinct case when s2.ds = date_add(s1.ds, 1) then s1.vplayerid else null end) as `next_day_retention`, -- 次留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 2) then s1.vplayerid else null end) as `three_day_retention`, -- 三留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 6) then s1.vplayerid else null end) as `seven_day_retention`, -- 七留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 13) then s1.vplayerid else null end) as `fourteen_day_retention`, -- 14留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 29) then s1.vplayerid else null end) as `thirty_day_retention` -- 30留人数\nfrom (\n    select \n        f1.dregdate as ds,  -- 日期\n        f1.vplayerid as vplayerid  -- 用户id\n    from  dws_jordass_emulator_df f1\n    where   f1.dtstatdate = '20251007'  \n        and f1.dregdate >= '20250407'  \n        and f1.dregdate <= '20250605'  \n        and f1.platid = 255  \n) s1\nleft join (\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '手机端' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type=0 -- 手机端\n    and f1.dtstatdate >= '20250407' and f1.dtstatdate <= date_add('20250605', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '模拟器' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type in (1,5) -- 模拟器\n    and f1.dtstatdate >= '20250407' and f1.dtstatdate <= date_add('20250605', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds,  -- 日期\n        f1.vplayerid as vplayerid,  -- 整体游戏内登录用户id\n        '游戏内' as user_type\n    from   dws_jordass_login_di f1  \n    where  f1.dtstatdate >= '20250407' and f1.dtstatdate <= date_add('20250605', 29)\n    and f1.platid = 255  -- 不区分系统平台\n) s2 \n    on   s1.vplayerid = s2.vplayerid\n    group by   s1.ds, user_type\n;"}], "rejected": "select \n    s1.ds as `ds`, -- 日期\n    count(distinct s1.vplayerid) as `user_cnt`, -- 人数\n    coalesce(user_type, '未知') as `user_type`, -- 用户类型\n    count(distinct case when s2.ds = date_add(s1.ds, 1) then s1.vplayerid else null end) as `next_day_retention`, -- 次留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 2) then s1.vplayerid else null end) as `three_day_retention`, -- 三留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 6) then s1.vplayerid else null end) as `seven_day_retention`, -- 七留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 13) then s1.vplayerid else null end) as `fourteen_day_retention`, -- 14留人数\n    count(distinct case when s2.ds = date_add(s1.ds, 29) then s1.vplayerid else null end) as `thirty_day_retention` -- 30留人数\nfrom (\n    select \n        f1.dregdate as ds,  -- 日期\n        f1.vplayerid as vplayerid  -- 用户id\n    from  dws_jordass_emulator_df f1\n    where   f1.dtstatdate = '20251007'  \n        and f1.dregdate >= '20250407'  \n        and f1.dregdate <= '20250605'  \n        and f1.platid = 255  \n) s1\nleft join (\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '手机端' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type=0 -- 手机端\n    and f1.dtstatdate >= '20250407' and f1.dtstatdate <= date_add('20250605', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds, -- 统计日期\n        f1.vplayerid as vplayerid, -- 手机端登录用户id\n        '模拟器' as user_type\n    from  dws_jordass_device_login_di f1\n    where  f1.device_type in (1,5) -- 模拟器\n    and f1.dtstatdate >= '20250407' and f1.dtstatdate <= date_add('20250605', 29)\n\n    union all\n\n    select \n        f1.dtstatdate as ds,  -- 日期\n        f1.vplayerid as vplayerid,  -- 整体游戏内登录用户id\n        '游戏内' as user_type\n    from   dws_jordass_login_di f1  \n    where  f1.dtstatdate >= '20250407' and f1.dtstatdate <= date_add('20250605', 29)\n    and f1.platid = 255  -- 不区分系统平台\n) s2 \n    on   s1.vplayerid = s2.vplayerid\n    group by   s1.ds, user_type\n;", "meta": {"origin": "sql_37", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_42_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2021.11.1-2021.11.30每天按extarg2中用\"_\"分割的第2位的值包含(8,16,17)看点击情况\n输出：日期，按extarg2中用\"_\"分割的第2位，人数，次数\n【表】dws_jordass_buttonpress_pre_di\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  dtstatdate,\n  split_part(extarg2, '_', 2) as second_value,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as click_cnt\nfrom dws_jordass_buttonpress_pre_di\nwhere dtstatdate between '20211106' and '20211205'\n  and split_part(extarg2, '_', 2) in ('8', '16', '17')\ngroup by dtstatdate, split_part(extarg2, '_', 2)\norder by dtstatdate, second_value\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  dtstatdate,\n  split_part(extarg2, '_', 2) as second_value,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as click_cnt\nfrom dws_jordass_buttonpress_pre_di\nwhere dtstatdate > '20211106'\n  and split_part(extarg2, '_', 2) in ('8', '16', '17')\ngroup by dtstatdate, split_part(extarg2, '_', 2)\norder by dtstatdate, second_value\n) AS final_query;", "meta": {"origin": "sql_42", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_47_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.07.01-08.31期间，每天微信活跃用户在2023.09.1-09.21期间流失并且是2023.07.01-08.31有付费的用户\n输出：人数\n【表】dws_jordass_water_di, dws_jordass_login_di\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with pay_users as (\n  select distinct vplayerid\n  from dws_jordass_water_di\n  where dtstatdate between '20230728' and '20230927'\n),\nlater_active as (\n  select distinct vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230928' and '20231018'\n),\nearly_login as (\n  select\n    dtstatdate,\n    vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230728' and '20230927'\n    and vgameappid = 'wx'\n)\nselect\n  dtstatdate,\n  count(distinct vplayerid) as user_cnt\nfrom early_login l\nwhere exists (select 1 from pay_users p where p.vplayerid = l.vplayerid)\n  and not exists (select 1 from later_active a where a.vplayerid = l.vplayerid)\ngroup by dtstatdate\norder by dtstatdate;"}], "rejected": "with pay_users as (\n  select distinct vplayerid\n  from dws_jordass_water_di\n  where dtstatdate > '20230728'\n),\nlater_active as (\n  select distinct vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230928' and '20231018'\n),\nearly_login as (\n  select\n    dtstatdate,\n    vplayerid\n  from dws_jordass_login_di\n  where dtstatdate between '20230728' and '20230927'\n    and vgameappid = 'wx'\n)\nselect\n  dtstatdate,\n  count(distinct vplayerid) as user_cnt\nfrom early_login l\nwhere exists (select 1 from pay_users p where p.vplayerid = l.vplayerid)\n  and not exists (select 1 from later_active a where a.vplayerid = l.vplayerid)\ngroup by dtstatdate\norder by dtstatdate;", "meta": {"origin": "sql_47", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_67_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.1.24-2025.2.6时间区间内，道具为430487,430485,602004025,602002011 的产出次数\t\n输出：道具id，产出次数\n【表】dwd_jordass_gearlog_hi\n【口径】addorreduce=0表示产出，1表示消耗\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  cast(igoodsid as string) as goods_id,\n  sum(coalesce(count, 0)) as produce_cnt\nfrom dwd_jordass_gearlog_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20250128' and '20250210'\n  and igoodsid in (430487, 430485, 602004025, 602002011)\n  and addorreduce = 0\ngroup by igoodsid\norder by goods_id;"}], "rejected": "select\n  cast(igoodsid as string) as goods_id,\n  sum(coalesce(count, 0)) as produce_cnt\nfrom dwd_jordass_gearlog_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20250128'\n  and igoodsid in (430487, 430485, 602004025, 602002011)\n  and addorreduce = 0\ngroup by igoodsid\norder by goods_id;", "meta": {"origin": "sql_67", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_101_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计日(2024.9.2,2024.9.3,2025.9.8,2025.9.9) 全平台活跃用户的本赛季最高段位等信息\n输出：统计日，本赛季最高段位，活跃用户数，统计日参与主题群屿玩法用户数，参与率\n【表】dws_jordass_mode_roundrecord_di, dws_jordass_login_di, dwd_jordass_playerlogin_hi\n【口径】主题群屿玩法：modename='传统模式' and submodename like 'CG%'\n段位分布：case when substr(seasonmaxsegment, 1, 1) = '1' then '青铜'\n                          when substr(seasonmaxsegment, 1, 1) = '2' then '白银'\n                          when substr(seasonmaxsegment, 1, 1) = '3' then '黄金'\n                          when substr(seasonmaxsegment, 1, 1) = '4' then '铂金'\n                          when substr(seasonmaxsegment, 1, 1) = '5' then '星钻'\n                          when substr(seasonmaxsegment, 1, 1) = '6' then '王冠'\n                          when substr(seasonmaxsegment, 1, 1) >= '7' then '王牌'\n                          else '无段位'\n\t            end"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH target_dates AS (\n  SELECT '20240907' AS stat_date UNION ALL\n  SELECT '20240908' UNION ALL\n  SELECT '20250913' UNION ALL\n  SELECT '20250914'\n), active_users AS (\n  SELECT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n  GROUP BY dtstatdate, vplayerid\n), segment_latest AS (\n  SELECT\n    vplayerid,\n    seasonmaxsegment,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n  FROM dwd_jordass_playerlogin_hi\n  WHERE seasonmaxsegment IS NOT NULL AND seasonmaxsegment <> ''\n), segment_map AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '1' THEN '青铜'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '2' THEN '白银'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '3' THEN '黄金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '4' THEN '铂金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '5' THEN '星钻'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '6' THEN '王冠'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) >= '7' THEN '王牌'\n      ELSE '无段位'\n    END AS season_segment\n  FROM segment_latest\n  WHERE rn = 1\n), active_segment AS (\n  SELECT\n    a.stat_date,\n    a.vplayerid,\n    COALESCE(s.season_segment, '无段位') AS season_segment\n  FROM active_users a\n  LEFT JOIN segment_map s\n    ON a.vplayerid = s.vplayerid\n), qunyu_users AS (\n  SELECT DISTINCT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n    AND modename = '传统模式'\n    AND submodename LIKE 'CG%'\n), summary AS (\n  SELECT\n    a.stat_date,\n    a.season_segment,\n    COUNT(DISTINCT a.vplayerid) AS active_user_cnt,\n    COUNT(DISTINCT CASE WHEN q.vplayerid IS NOT NULL THEN a.vplayerid END) AS qunyu_user_cnt\n  FROM active_segment a\n  LEFT JOIN qunyu_users q\n    ON a.stat_date = q.stat_date\n   AND a.vplayerid = q.vplayerid\n  GROUP BY a.stat_date, a.season_segment\n)\nSELECT\n  stat_date,\n  season_segment,\n  active_user_cnt,\n  qunyu_user_cnt,\n  CASE WHEN active_user_cnt = 0 THEN 0 ELSE qunyu_user_cnt / active_user_cnt END AS participate_rate\nFROM summary\nORDER BY stat_date, season_segment\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH target_dates AS (\n  SELECT '20240907' AS stat_date UNION ALL\n  SELECT '20240908' UNION ALL\n  SELECT '20250913' UNION ALL\n  SELECT '20250914'\n), active_users AS (\n  SELECT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n  GROUP BY dtstatdate, vplayerid\n), segment_latest AS (\n  SELECT\n    vplayerid,\n    seasonmaxsegment,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n  FROM dwd_jordass_playerlogin_hi\n  WHERE seasonmaxsegment IS NOT NULL AND seasonmaxsegment <> ''\n), segment_map AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '1' THEN '青铜'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '2' THEN '白银'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '3' THEN '黄金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '4' THEN '铂金'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '5' THEN '星钻'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) = '6' THEN '王冠'\n      WHEN SUBSTR(seasonmaxsegment, 1, 1) >= '7' THEN '王牌'\n      ELSE '无段位'\n    END AS season_segment\n  FROM segment_latest\n  WHERE rn = 1\n), active_segment AS (\n  SELECT\n    a.stat_date,\n    a.vplayerid,\n    COALESCE(s.season_segment, '无段位') AS season_segment\n  FROM active_users a\n  LEFT JOIN segment_map s\n    ON a.vplayerid = s.vplayerid\n), qunyu_users AS (\n  SELECT DISTINCT\n    dtstatdate AS stat_date,\n    vplayerid\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate IN (SELECT stat_date FROM target_dates)\n    AND platid = 255\n    AND modename = '传统模式'\n    AND submodename LIKE 'CG%'\n), summary AS (\n  SELECT\n    a.stat_date,\n    a.season_segment,\n    COUNT(DISTINCT a.vplayerid) AS active_user_cnt,\n    COUNT(DISTINCT CASE WHEN q.vplayerid IS NOT NULL THEN a.vplayerid END) AS qunyu_user_cnt\n  FROM active_segment a\n  LEFT JOIN qunyu_users q\n    ON a.stat_date = q.stat_date\n   AND a.vplayerid = q.vplayerid\n  GROUP BY a.stat_date, a.season_segment\n)\nSELECT\n  stat_date,\n  season_segment,\n  active_user_cnt,\n  qunyu_user_cnt,\n  CASE WHEN active_user_cnt = 0 THEN 0 ELSE qunyu_user_cnt / active_user_cnt END AS participate_rate\nFROM summary\nORDER BY stat_date, season_segment\n) AS final_query;", "meta": {"origin": "sql_101", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_68_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计时间范围：25.1.28-25.2.10，新春华服id：848，841 \n输出：日期（YYDDMM），人数\n【表】dwd_jordass_lotteryrecord_hi\n【口径】新春华服：\nactivitytype in (848, 841)\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom dwd_jordass_lotteryrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20250228' and '20250313'\n  and activitytype in (848, 841)\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date;"}], "rejected": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom dwd_jordass_lotteryrecord_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20250228'\n  and activitytype in (848, 841)\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date;", "meta": {"origin": "sql_68", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_43_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.1.1-2025.1.31期间活跃度分布\n输出：活跃度（轻度、中度、重度）、玩家数\n\n活跃度：轻度1-5天，中度6-15天，重度大于16天\n【表】dws_jordass_login_di\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with jan_active as (\n  select\n    vplayerid,\n    count(distinct dtstatdate) as active_days\n  from dws_jordass_login_di\n  where dtstatdate between '20250128' and '20250227'\n  group by vplayerid\n)\nselect\n  case\n    when active_days between 1 and 5 then '轻度'\n    when active_days between 6 and 15 then '中度'\n    when active_days >= 16 then '重度'\n    else '未知'\n  end as actv_level,\n  count(*) as player_cnt\nfrom jan_active\nwhere active_days > 0\ngroup by actv_level\norder by actv_level;"}], "rejected": "with jan_active as (\n  select\n    vplayerid,\n    count(distinct dtstatdate) as active_days\n  from dws_jordass_login_di\n  where dtstatdate > '20250128'\n  group by vplayerid\n)\nselect\n  case\n    when active_days between 1 and 5 then '轻度'\n    when active_days between 6 and 15 then '中度'\n    when active_days >= 16 then '重度'\n    else '未知'\n  end as actv_level,\n  count(*) as player_cnt\nfrom jan_active\nwhere active_days > 0\ngroup by actv_level\norder by actv_level;", "meta": {"origin": "sql_43", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_64_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2024.10.26-2024.11.23、2024.11.26-2024.12.23、2024.10.26-10.27、2024.11.01-11.03、2024.11.08-11.10、2024.11.15-11.17、2024.11.22-11.19、2024.11.26-11.24、2024.11.29-12.01、2024.12.06-12.08、2024.12.13-12.15、2024.12.20-12.19几个时间段的最近上新的曝光用户数（UV）、曝光次数（PV）\n输出：统计日期（例:20241027）、UV、PV\n【表】dws_jordass_buttonpress_pre_di\n【口径】buttontype=\"410012\"表示曝光，一条记录代表一次"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  dtstatdate,\n  count(distinct vplayerid) as uv,\n  count(*) as pv\nfrom dws_jordass_buttonpress_pre_di\nwhere buttontype = '410012'\n  and (\n        dtstatdate between '20241026' and '20241123'\n     or dtstatdate between '20241126' and '20241223'\n     or dtstatdate between '20241026' and '20241031'\n     or dtstatdate between '20241101' and '20241107'\n     or dtstatdate between '20241108' and '20241114'\n     or dtstatdate between '20241115' and '20241121'\n     or dtstatdate between '20241122' and '20241123'\n     or dtstatdate between '20241126' and '20241128'\n     or dtstatdate between '20241129' and '20241205'\n     or dtstatdate between '20241206' and '20241212'\n     or dtstatdate between '20241213' and '20241219'\n     or dtstatdate between '20241220' and '20241223'\n  )\ngroup by dtstatdate\norder by dtstatdate\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  dtstatdate,\n  count(distinct vplayerid) as uv,\n  count(*) as pv\nfrom dws_jordass_buttonpress_pre_di\nwhere buttontype = '410012'\n  and (\n        dtstatdate > '20241026'\n     or dtstatdate between '20241126' and '20241223'\n     or dtstatdate between '20241026' and '20241031'\n     or dtstatdate between '20241101' and '20241107'\n     or dtstatdate between '20241108' and '20241114'\n     or dtstatdate between '20241115' and '20241121'\n     or dtstatdate between '20241122' and '20241123'\n     or dtstatdate between '20241126' and '20241128'\n     or dtstatdate between '20241129' and '20241205'\n     or dtstatdate between '20241206' and '20241212'\n     or dtstatdate between '20241213' and '20241219'\n     or dtstatdate between '20241220' and '20241223'\n  )\ngroup by dtstatdate\norder by dtstatdate\n) AS final_query;", "meta": {"origin": "sql_64", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_77_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：20230123开始7日内元素付费金额\n输出：日期（20230128-20230203），人数，元素付费金额\n【表】dwd_jordass_currencylog_hi\n【口径】限定：reason in (189, 190)\n元素付费类型：imoneytype = 1027\n元素付费金额：imoney"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt,\n  sum(coalesce(imoney, 0)) as element_amount\nfrom dwd_jordass_currencylog_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20230128' and '20230203'\n  and reason in (189, 190)\n  and imoneytype = 1027\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt,\n  sum(coalesce(imoney, 0)) as element_amount\nfrom dwd_jordass_currencylog_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20230128'\n  and reason in (189, 190)\n  and imoneytype = 1027\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date\n) AS final_query;", "meta": {"origin": "sql_77", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_71_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.11.29-2024.12.19期间，每七天统计一次阶梯活动相关用户数\n输出 日期范围（20241130-20241206、20241207-20241213、20241214-20241220），extarg1类型，用户数，次数\n【表】dwd_jordass_activitypress_hi\n【口径】阶梯活动：ireason = 2411291018 and buttontype = 10045 and extarg1 in (101,109,110)"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith tagged as (\n  select\n    case\n      when substr(tdbank_imp_date, 1, 8) between '20241130' and '20241206' then '20241130-20241206'\n      when substr(tdbank_imp_date, 1, 8) between '20241207' and '20241213' then '20241207-20241213'\n      when substr(tdbank_imp_date, 1, 8) between '20241214' and '20241220' then '20241214-20241220'\n      else null\n    end as range_flag,\n    extarg1,\n    vplayerid\n  from dwd_jordass_activitypress_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241130' and '20241220'\n    and ireason = 2411291018\n    and buttontype = 10045\n    and extarg1 in (101, 109, 110)\n)\nselect\n  range_flag as date_range,\n  cast(extarg1 as string) as extarg1_type,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as press_cnt\nfrom tagged\nwhere range_flag is not null\ngroup by range_flag, extarg1_type\norder by date_range, extarg1_type\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith tagged as (\n  select\n    case\n      when substr(tdbank_imp_date, 1, 8) > '20241130' then '20241130-20241206'\n      when substr(tdbank_imp_date, 1, 8) between '20241207' and '20241213' then '20241207-20241213'\n      when substr(tdbank_imp_date, 1, 8) between '20241214' and '20241220' then '20241214-20241220'\n      else null\n    end as range_flag,\n    extarg1,\n    vplayerid\n  from dwd_jordass_activitypress_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241130' and '20241220'\n    and ireason = 2411291018\n    and buttontype = 10045\n    and extarg1 in (101, 109, 110)\n)\nselect\n  range_flag as date_range,\n  cast(extarg1 as string) as extarg1_type,\n  count(distinct vplayerid) as user_cnt,\n  count(*) as press_cnt\nfrom tagged\nwhere range_flag is not null\ngroup by range_flag, extarg1_type\norder by date_range, extarg1_type\n) AS final_query;", "meta": {"origin": "sql_71", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_32_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023/1/14-2023/1/28\n2024/2/2-2024/2/16\n2025/1/21-2025/2/4\n每天所有玩法的参与人数，总时长\n输出：日期（20230107、20230108、...、20230203、20240208、...、20250210），参与人数，时长（分钟）\n【表】dws_jordass_mode_roundrecord_di\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  dtstatdate,\n  count(distinct vplayerid) as player_cnt,\n  round(sum(coalesce(roundtime, 0)) / 60.0, 2) as total_minutes\nfrom dws_jordass_mode_roundrecord_di\nwhere (\n        dtstatdate between '20230120' and '20230203'\n     or dtstatdate between '20240208' and '20240222'\n     or dtstatdate between '20250127' and '20250210'\n)\ngroup by dtstatdate\norder by dtstatdate\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  dtstatdate,\n  count(distinct vplayerid) as player_cnt,\n  round(sum(coalesce(roundtime, 0)) / 60.0, 2) as total_minutes\nfrom dws_jordass_mode_roundrecord_di\nwhere (\n        dtstatdate > '20230120'\n     or dtstatdate between '20240208' and '20240222'\n     or dtstatdate between '20250127' and '20250210'\n)\ngroup by dtstatdate\norder by dtstatdate\n) AS final_query;", "meta": {"origin": "sql_32", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_78_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：首日红装活动（20250122）返场抽奖的用户属性\n输出：初日华服回归抽奖&沙漠统治者有抽奖人数\n初日华服回归抽奖&境界双花有抽奖人数\t\t\n初日华服回归抽奖&玄龙凌霄有抽奖人数\t\t\n初日华服回归抽奖&沙漠统治者有抽奖&但没有其主套人数\t\t\n初日华服回归抽奖&境界双花有抽奖&但没有其主套人数\t\t\n初日华服回归抽奖&玄龙凌霄有抽奖&但没有其主套人数\t\t\n初日华服回归抽奖&【沙漠统治者和境界双花有主套】人数\t\t\n初日华服回归抽奖&【沙漠统治者和玄龙凌霄有主套】人数\t\t\t\t\n初日华服回归抽奖&【境界双花和玄龙凌霄有主套】人数\t\t\t\t\n初日华服回归抽奖但【沙漠统治者&境界双花&玄龙凌霄】没有抽奖人数\n【表】dwd_jordass_gearlog_hi, dwd_jordass_lotteryrecord_hi\n【口径】抽奖活动时间：\n沙漠统治者：20240429-20240609 \n镜域双华：20240610-20240728 \n玄龙凌霄：20240729-20240825\n抽奖活动筛选条件：\n初日华服回归抽奖 activitytype = 815\n沙漠统治者有抽奖 activitytype = 690\n境界双花有抽奖 activitytype = 748\n玄龙凌霄有抽奖 activitytype = 750\n主套提取逻辑：\n提取道具沙漠统治者-有主套的用户 igoodsid = 430179 and addorreduce = 0\n提取道具镜域双华-有主套的用户 igoodsid = 430265  and addorreduce = 0\n提取道具玄龙凌霄-有主套用户 igoodsid = 430225  and addorreduce = 0"}, {"role": "assistant", "content": "WITH base_users AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) = '2025-01-22'\n    AND activitytype = 815\n), sand_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 690\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-04-29' AND '2024-06-09'\n), floral_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 748\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-06-10' AND '2024-07-28'\n), dragon_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 750\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-07-29' AND '2024-08-25'\n), sand_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430179\n    AND addorreduce = 0\n), floral_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430265\n    AND addorreduce = 0\n), dragon_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430225\n    AND addorreduce = 0\n), enriched AS (\n  SELECT\n    b.vplayerid,\n    CASE WHEN s.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_lottery,\n    CASE WHEN f.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_lottery,\n    CASE WHEN d.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_lottery,\n    CASE WHEN ss.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_suit,\n    CASE WHEN fs.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_suit,\n    CASE WHEN ds.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_suit\n  FROM base_users b\n  LEFT JOIN sand_lottery s ON b.vplayerid = s.vplayerid\n  LEFT JOIN floral_lottery f ON b.vplayerid = f.vplayerid\n  LEFT JOIN dragon_lottery d ON b.vplayerid = d.vplayerid\n  LEFT JOIN sand_suit ss ON b.vplayerid = ss.vplayerid\n  LEFT JOIN floral_suit fs ON b.vplayerid = fs.vplayerid\n  LEFT JOIN dragon_suit ds ON b.vplayerid = ds.vplayerid\n)\nSELECT\n  SUM(CASE WHEN has_sand_lottery = 1 THEN 1 ELSE 0 END) AS base_sand_lottery_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 THEN 1 ELSE 0 END) AS base_floral_lottery_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 THEN 1 ELSE 0 END) AS base_dragon_lottery_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_sand_suit = 0 THEN 1 ELSE 0 END) AS base_sand_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_floral_suit = 0 THEN 1 ELSE 0 END) AS base_floral_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 AND has_dragon_suit = 0 THEN 1 ELSE 0 END) AS base_dragon_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_floral_lottery = 1 AND has_sand_suit = 1 AND has_floral_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_floral_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_dragon_lottery = 1 AND has_sand_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_dragon_lottery = 1 AND has_floral_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_floral_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 0 AND has_floral_lottery = 0 AND has_dragon_lottery = 0 THEN 1 ELSE 0 END) AS base_without_three_lottery_cnt\nFROM enriched;"}], "rejected": "WITH base_users AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) = '2025-01-22'\n    AND activitytype = 815\n), sand_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 690\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-04-29' AND '2024-06-09'\n), floral_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 748\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-06-10' AND '2024-07-28'\n), dragon_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 750\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-07-29' AND '2024-08-25'\n), sand_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430179\n    AND addorreduce = 0\n), floral_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430265\n    AND addorreduce = 0\n), dragon_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430225\n    AND addorreduce = 0\n), enriched AS (\n  SELECT\n    b.vplayerid,\n    CASE WHEN s.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_lottery,\n    CASE WHEN f.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_lottery,\n    CASE WHEN d.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_lottery,\n    CASE WHEN ss.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_suit,\n    CASE WHEN fs.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_suit,\n    CASE WHEN ds.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_suit\n  FROM base_users b\n  LEFT JOIN sand_lottery s ON b.vplayerid = s.vplayerid\n  LEFT JOIN floral_lottery f ON b.vplayerid = f.vplayerid\n  LEFT JOIN dragon_lottery d ON b.vplayerid = d.vplayerid\n  LEFT JOIN sand_suit ss ON b.vplayerid = ss.vplayerid\n  LEFT JOIN floral_suit fs ON b.vplayerid = fs.vplayerid\n  LEFT JOIN dragon_suit ds ON b.vplayerid = ds.vplayerid\n)\nSELECT\n  SUM(CASE WHEN has_sand_lottery = 1 THEN 1 ELSE 0 END) AS base_sand_lottery_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 THEN 1 ELSE 0 END) AS base_floral_lottery_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 THEN 1 ELSE 0 END) AS base_dragon_lottery_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_sand_suit = 0 THEN 1 ELSE 0 END) AS base_sand_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_floral_suit = 0 THEN 1 ELSE 0 END) AS base_floral_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 AND has_dragon_suit = 0 THEN 1 ELSE 0 END) AS base_dragon_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_floral_lottery = 1 AND has_sand_suit = 1 AND has_floral_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_floral_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_dragon_lottery = 1 AND has_sand_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_dragon_lottery = 1 AND has_floral_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_floral_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 0 AND has_floral_lottery = 0 AND has_dragon_lottery = 0 THEN 1 ELSE 0 END) AS base_without_three_lottery_cnt\nFROM enriched;", "meta": {"origin": "sql_78", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_109_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计 20250428-20250512 期间 传统和休闲的胜利情况\n\n 胜利数分布层次：1,2-10,11-20,21-50,51-80,81-100，101-200,201-500,501以上\n 输出：胜利数分布层次，人数\n【表】dwd_jordass_roundlog_funnymode_hi, dwd_jordass_roundflow_hi\n【口径】传统模式： mode in(101,102,103,401,402,403)\n 休闲：mode in(201,202,203,601,602,603) \n 胜利：teamrank =1"}, {"role": "assistant", "content": "WITH combined AS (\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-28' AND '2025-05-12'\n  UNION ALL\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundlog_funnymode_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-28' AND '2025-05-12'\n), total_wins AS (\n  SELECT\n    vplayerid,\n    SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n    SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) AS win_cnt\n  FROM combined\n  GROUP BY vplayerid\n  HAVING SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n         SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) > 0\n), bucketed AS (\n  SELECT\n    CASE\n      WHEN win_cnt = 1 THEN '1'\n      WHEN win_cnt BETWEEN 2 AND 10 THEN '2-10'\n      WHEN win_cnt BETWEEN 11 AND 20 THEN '11-20'\n      WHEN win_cnt BETWEEN 21 AND 50 THEN '21-50'\n      WHEN win_cnt BETWEEN 51 AND 80 THEN '51-80'\n      WHEN win_cnt BETWEEN 81 AND 100 THEN '81-100'\n      WHEN win_cnt BETWEEN 101 AND 200 THEN '101-200'\n      WHEN win_cnt BETWEEN 201 AND 500 THEN '201-500'\n      ELSE '501+'\n    END AS win_bucket\n  FROM total_wins\n)\nSELECT\n  win_bucket,\n  COUNT(*) AS user_cnt\nFROM bucketed\nGROUP BY win_bucket\nORDER BY CASE win_bucket\n  WHEN '1' THEN 1\n  WHEN '2-10' THEN 2\n  WHEN '11-20' THEN 3\n  WHEN '21-50' THEN 4\n  WHEN '51-80' THEN 5\n  WHEN '81-100' THEN 6\n  WHEN '101-200' THEN 7\n  WHEN '201-500' THEN 8\n  ELSE 9\nEND;"}], "rejected": "WITH combined AS (\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-28' AND '2025-05-12'\n  UNION ALL\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundlog_funnymode_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-28' AND '2025-05-12'\n), total_wins AS (\n  SELECT\n    vplayerid,\n    SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n    SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) AS win_cnt\n  FROM combined\n  GROUP BY vplayerid\n  HAVING SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n         SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) > 0\n), bucketed AS (\n  SELECT\n    CASE\n      WHEN win_cnt = 1 THEN '1'\n      WHEN win_cnt BETWEEN 2 AND 10 THEN '2-10'\n      WHEN win_cnt BETWEEN 11 AND 20 THEN '11-20'\n      WHEN win_cnt BETWEEN 21 AND 50 THEN '21-50'\n      WHEN win_cnt BETWEEN 51 AND 80 THEN '51-80'\n      WHEN win_cnt BETWEEN 81 AND 100 THEN '81-100'\n      WHEN win_cnt BETWEEN 101 AND 200 THEN '101-200'\n      WHEN win_cnt BETWEEN 201 AND 500 THEN '201-500'\n      ELSE '501+'\n    END AS win_bucket\n  FROM total_wins\n)\nSELECT\n  win_bucket,\n  COUNT(*) AS user_cnt\nFROM bucketed\nGROUP BY win_bucket\nORDER BY CASE win_bucket\n  WHEN '1' THEN 1\n  WHEN '2-10' THEN 2\n  WHEN '11-20' THEN 3\n  WHEN '21-50' THEN 4\n  WHEN '51-80' THEN 5\n  WHEN '81-100' THEN 6\n  WHEN '101-200' THEN 7\n  WHEN '201-500' THEN 8\n  ELSE 9\nEND;", "meta": {"origin": "sql_109", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_7_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.07.03-2025.07.08 开白渠道（排除内部体验、买量测试，排除全平台）指定注册渠道的新进用户数。\n输出：日期（20250705...20250708）、注册渠道、新进用户数\n【表】dws_argothek_ce1_cbt2_vplayerid_suserid_di, dwd_argothek_cbt2kaibai_hi\n【口径】渠道范围：iregway in (\"89903934\",\"89903933\",\"89903932\",\"89902725\",\"89902724\",\"89902723\",\"89900960\",\"89900961\",\"89900962\")\n排除 sourcename in ('内部体验','买量测试')\n排除全平台：platid <> 255\n所有日期统一使用字符串 YYYYMMDD"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH open_channel AS (\n  SELECT DISTINCT gplayerid\n  FROM dwd_argothek_cbt2kaibai_hi\n  WHERE dteventtime >= '2025-07-05 00:00:00'\n    AND dteventtime <= '2025-07-08 23:59:59'\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n),\nfiltered AS (\n  SELECT\n    dtstatdate,\n    vplayerid,\n    iregway\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate BETWEEN '20250705' AND '20250708'\n    AND iregway IN ('89903934','89903933','89903932','89902725','89902724','89902723','89900960','89900961','89900962')\n    AND is_reg = '1'\n    AND platid <> 255\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n)\nSELECT\n  f.dtstatdate AS stat_date,\n  f.iregway,\n  COUNT(DISTINCT f.vplayerid) AS new_user_cnt\nFROM filtered f\nJOIN open_channel o\n  ON f.vplayerid = o.gplayerid\nGROUP BY f.dtstatdate, f.iregway\nORDER BY f.dtstatdate, f.iregway\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH open_channel AS (\n  SELECT DISTINCT gplayerid\n  FROM dwd_argothek_cbt2kaibai_hi\n  WHERE dteventtime >= '2025-07-05 00:00:00'\n    AND dteventtime <= '2025-07-08 23:59:59'\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n),\nfiltered AS (\n  SELECT\n    dtstatdate,\n    vplayerid,\n    iregway\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate > '20250705'\n    AND iregway IN ('89903934','89903933','89903932','89902725','89902724','89902723','89900960','89900961','89900962')\n    AND is_reg = '1'\n    AND platid <> 255\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n)\nSELECT\n  f.dtstatdate AS stat_date,\n  f.iregway,\n  COUNT(DISTINCT f.vplayerid) AS new_user_cnt\nFROM filtered f\nJOIN open_channel o\n  ON f.vplayerid = o.gplayerid\nGROUP BY f.dtstatdate, f.iregway\nORDER BY f.dtstatdate, f.iregway\n) AS final_query;", "meta": {"origin": "sql_7", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_97_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】在2023.7.19-2023.7.25时间范围内，分别统计参与了隐匿的用户人数、既参与隐匿也参与了桥梁争夺的用户、既参与隐匿也参与了隐匿模式的用户\n输出：参与了隐匿的不重复的人的个数、参与隐匿并且参与了桥梁争夺的不重复的人的个数、参与隐匿并且参与了隐匿模式的不重复的人的个数\n【表】dws_jordass_matchlog_stat_di, dws_jordass_mode_roundrecord_di\n【口径】隐匿的用户：imode = 1307095884553538304  and platid <> 255\n桥梁争夺的用户：imode = 1310822585431254784  and platid <> 255\n隐匿模式的用户：mode=2370\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with hidden as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate between '20230728' and '20230803'\n    and imode = 1307095884553538304\n    and platid <> 255\n),\nbridge as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate between '20230728' and '20230803'\n    and imode = 1310822585431254784\n    and platid <> 255\n),\nhidden_mode as (\n  select distinct vplayerid\n  from dws_jordass_mode_roundrecord_di\n  where dtstatdate between '20230728' and '20230803'\n    and mode = 2370\n)\nselect\n  (select count(*) from hidden) as hidden_user_cnt,\n  (select count(*) from hidden h join bridge b on h.vplayerid = b.vplayerid) as hidden_and_bridge_cnt,\n  (select count(*) from hidden h join hidden_mode m on h.vplayerid = m.vplayerid) as hidden_and_mode_cnt;"}], "rejected": "with hidden as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate > '20230728'\n    and imode = 1307095884553538304\n    and platid <> 255\n),\nbridge as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate between '20230728' and '20230803'\n    and imode = 1310822585431254784\n    and platid <> 255\n),\nhidden_mode as (\n  select distinct vplayerid\n  from dws_jordass_mode_roundrecord_di\n  where dtstatdate between '20230728' and '20230803'\n    and mode = 2370\n)\nselect\n  (select count(*) from hidden) as hidden_user_cnt,\n  (select count(*) from hidden h join bridge b on h.vplayerid = b.vplayerid) as hidden_and_bridge_cnt,\n  (select count(*) from hidden h join hidden_mode m on h.vplayerid = m.vplayerid) as hidden_and_mode_cnt;", "meta": {"origin": "sql_97", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_24_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计下列英雄和对应上线日期，新英雄上线首周的持续选择情况。限定除自定义模式，新手、训练场外所有模式\n输出：英雄id、首周选择新英雄次数超过3次的玩家、首周选择新英雄次数超过10次的玩家、首周选择过新英雄的玩家、超过3次的玩家占比、超过10次的玩家占比\n【表】dwd_argothek_playermatchdetail_hi\n【口径】英雄筛选逻辑：\n英雄1上线日期：2023/07/29\n英雄2上线日期：2023/11/04\n英雄3上线日期：2024/03/30\n英雄4上线日期：2024/09/01\n英雄5上线日期：2025/01/12\n英雄6上线日期：2025/03/09\n英雄1对应id:\"e370fa57-4757-3604-3648-499e1f642d3f\",\"cc8b64c8-4b25-4ff9-6e7f-37b4da43d235\"\n英雄2对应id:\"0e38b510-41a8-5780-5e8f-568b2a4f2d6c\"\n英雄3对应id:\"1dbf2edd-4729-0984-3115-daa5eed44993\"\n英雄4对应id:\"efba5359-4016-a1e5-7626-b1ae76895940\"\n英雄5对应id:\"b444168c-4e35-8076-db47-ef9bf368f384\"\n英雄6对应id:\"df1cb487-4902-002e-5c17-d28e83e78588\"\n\n对局筛选逻辑：\nprovisioningflowid = \"Matchmaking\" -- 除自定义模式、新手、训练场外所有模式"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH heroes AS (\n  SELECT 'e370fa57-4757-3604-3648-499e1f642d3f' AS hero_id, DATE '2023-07-29' AS start_date UNION ALL\n  SELECT 'cc8b64c8-4b25-4ff9-6e7f-37b4da43d235', DATE '2023-07-29' UNION ALL\n  SELECT '0e38b510-41a8-5780-5e8f-568b2a4f2d6c', DATE '2023-11-04' UNION ALL\n  SELECT '1dbf2edd-4729-0984-3115-daa5eed44993', DATE '2024-03-30' UNION ALL\n  SELECT 'efba5359-4016-a1e5-7626-b1ae76895940', DATE '2024-09-01' UNION ALL\n  SELECT 'b444168c-4e35-8076-db47-ef9bf368f384', DATE '2025-01-12' UNION ALL\n  SELECT 'df1cb487-4902-002e-5c17-d28e83e78588', DATE '2025-03-09'\n),\nfirst_week_matches AS (\n  SELECT\n    h.hero_id,\n    md.subject AS player_id,\n    COUNT(*) AS pick_cnt\n  FROM dwd_argothek_playermatchdetail_hi md\n  JOIN heroes h\n    ON md.characterid = h.hero_id\n  WHERE md.provisioningflowid = 'Matchmaking'\n    AND CAST(md.dteventtime AS DATE) BETWEEN h.start_date AND DATE_ADD(h.start_date, INTERVAL 6 DAY)\n  GROUP BY h.hero_id, md.subject\n),\nhero_summary AS (\n  SELECT\n    hero_id,\n    COUNT(*) AS total_players,\n    SUM(CASE WHEN pick_cnt > 3 THEN 1 ELSE 0 END) AS players_over_3,\n    SUM(CASE WHEN pick_cnt > 10 THEN 1 ELSE 0 END) AS players_over_10\n  FROM first_week_matches\n  GROUP BY hero_id\n)\nSELECT\n  hero_id,\n  players_over_3,\n  players_over_10,\n  total_players AS players_over_0,\n  IF(total_players = 0, 0, ROUND(players_over_3 / total_players, 4)) AS ratio_over_3,\n  IF(total_players = 0, 0, ROUND(players_over_10 / total_players, 4)) AS ratio_over_10\nFROM hero_summary\nORDER BY hero_id\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH heroes AS (\n  SELECT 'e370fa57-4757-3604-3648-499e1f642d3f' AS hero_id, DATE '2023-07-29' AS start_date UNION ALL\n  SELECT 'cc8b64c8-4b25-4ff9-6e7f-37b4da43d235', DATE '2023-07-29' UNION ALL\n  SELECT '0e38b510-41a8-5780-5e8f-568b2a4f2d6c', DATE '2023-11-04' UNION ALL\n  SELECT '1dbf2edd-4729-0984-3115-daa5eed44993', DATE '2024-03-30' UNION ALL\n  SELECT 'efba5359-4016-a1e5-7626-b1ae76895940', DATE '2024-09-01' UNION ALL\n  SELECT 'b444168c-4e35-8076-db47-ef9bf368f384', DATE '2025-01-12' UNION ALL\n  SELECT 'df1cb487-4902-002e-5c17-d28e83e78588', DATE '2025-03-09'\n),\nfirst_week_matches AS (\n  SELECT\n    h.hero_id,\n    md.subject AS player_id,\n    COUNT(*) AS pick_cnt\n  FROM dwd_argothek_playermatchdetail_hi md\n  JOIN heroes h\n    ON md.characterid = h.hero_id\n  WHERE md.provisioningflowid = 'Matchmaking'\n    AND CAST(md.dteventtime AS DATE) BETWEEN h.start_date AND DATE_ADD(h.start_date, INTERVAL 6 DAY)\n  GROUP BY h.hero_id, md.subject\n),\nhero_summary AS (\n  SELECT\n    hero_id,\n    COUNT(*) AS total_players,\n    SUM(CASE WHEN pick_cnt > 3 THEN 1 ELSE 0 END) AS players_over_3,\n    SUM(CASE WHEN pick_cnt > 10 THEN 1 ELSE 0 END) AS players_over_10\n  FROM first_week_matches\n  GROUP BY hero_id\n)\nSELECT\n  hero_id,\n  players_over_3,\n  players_over_10,\n  total_players AS players_over_0,\n  IF(total_players = 0, 0, ROUND(players_over_3 / total_players, 4)) AS ratio_over_3,\n  IF(total_players = 0, 0, ROUND(players_over_10 / total_players, 4)) AS ratio_over_10\nFROM hero_summary\nORDER BY hero_id\n) AS final_query;", "meta": {"origin": "sql_24", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_48_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.12.1流失7天的回流用户数和流失30天的回流用户数\n输出：流失7天的回流用户数，流失30天的回流用户数\n【表】dws_jordass_login_df\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n    count(distinct case when is_backflow_7 then vplayerid end) as backflow_7_user,\n    count(distinct case when is_backflow_30 then vplayerid end) as backflow_30_user\nfrom (\n    select\n        vplayerid,\n        -- 检查是否满足流失7天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 7), '1') = 0) as is_backflow_7,\n        \n        -- 检查是否满足流失30天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 30), '1') = 0) as is_backflow_30\n    from\n        dws_jordass_login_df\n    where\n        dtstatdate = '20231228'\n        and platid = 255\n) as user_flags;"}], "rejected": "select\n    count(distinct case when is_backflow_7 then vplayerid end) as backflow_7_user,\n    count(distinct case when is_backflow_30 then vplayerid end) as backflow_30_user\nfrom (\n    select\n        vplayerid,\n        -- 检查是否满足流失7天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 7), '1') = 0) as is_backflow_7,\n        \n        -- 检查是否满足流失30天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 30), '1') = 0) as is_backflow_30\n    from\n        dws_jordass_login_df\n    where\n        dtstatdate = '20231228'\n        and platid = 255\n) as user_flags;", "meta": {"origin": "sql_48", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_30_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2019.5.8至2025.3.30 分月的玩法主玩情况\n输出：月份(201905、201906、...、202503)、主玩玩法、主玩人数、总参与人数\n【表】dwd_jordass_playerexitgamerecord_hi, dws_jordass_mode_roundrecord_di\n【口径】主玩定义：用户累计对局时长最多的玩法；\n\n玩法：从dws_jordass_mode_roundrecord_di取\n从上往下匹配，如果满足以下任一条件，则返回对应的名称，否则返回“其他模式”。\n如果模式为“传统模式”，且子模式名称以“CG”开头，且地图为“群屿”，则返回“主题群屿”；\n如果模式为“传统模式”且地图为“群屿”，则返回“传统群屿”；\n如果模式为“传统模式”且地图为“假日群岛”，则返回“假日群岛”；\n如果模式为“传统模式”且地图为“荣耀之城”，则返回“荣耀之城”；\n如果子模式是“广域战场模式”，则返回“广域战场”；\n如果子模式是“极能形态模式”，则返回“极能形态”；\n如果模式是“组队竞技”，则返回“组竞”；\n如果模式是“休闲模式”，则返回“休闲”；\n如果模式是“乐园”，则返回“乐园”；\n如果模式是“领地”，则返回“领地”；\n如果模式是“广阔天地”，则返回“广阔天地”\n\n注意，参与隧道模式的用户数据从dwd_jordass_playerexitgamerecord_hi取，时间限制 2024.6.18-2025.3.30，mode in (3001, 3002, 3003)"}, {"role": "assistant", "content": "with main_user as (\n    select substr(dtstatdate, 1, 6) mons,\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end imodename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        sum(roundcnt) roundcnt\n   from dws_jordass_mode_roundrecord_di\n   where dtstatdate between '20190513' and '20250404'\n   group by vplayerid, substr(dtstatdate, 1, 6),\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end\n\n   union all\n   \n   select substr (tdbank_imp_date, 1, 6) mons,\n        '隧道' as modename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        count(distinct gameid) roundcnt\n   from dwd_jordass_playerexitgamerecord_hi\n   where tdbank_imp_date between '2024061800' and '2025033023'\n     and mode in (3001, 3002, 3003)\n   group by substr (tdbank_imp_date, 1, 6), vplayerid\n)\n\nselect a.mons,\n       a.imodename,\n       a.iusernum,\n       b.iusernumall\nfrom (\n    select mons,\n          imodename,\n          count(vplayerid) iusernum\n    from (\n        select mons, vplayerid, imodename\n        from (\n            select mons,\n                vplayerid,\n                imodename,\n                roundtime,\n                row_number() over (partition by mons, vplayerid order by roundtime desc) as rn\n            from main_user\n        )ff1\n        where rn = 1\n    )f1\n   group by mons, imodename\n) a\nleft join (\n    select mons,\n        imodename,\n        count(vplayerid) iusernumall\n   from main_user\n   group by mons, imodename\n) b \non a.imodename = b.imodename and a.mons = b.mons\norder by a.mons, a.imodename\n;"}], "rejected": "with main_user as (\n    select substr(dtstatdate, 1, 6) mons,\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end imodename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        sum(roundcnt) roundcnt\n   from dws_jordass_mode_roundrecord_di\n   where dtstatdate > '20190513'\n   group by vplayerid, substr(dtstatdate, 1, 6),\n        case\n            when modename = '传统模式' and submodename like 'CG%' and mapname = '群屿' then '主题群屿'\n            when modename = '传统模式' and mapname = '群屿' then '传统群屿'\n            when modename = '传统模式' and mapname = '假日群岛' then '假日群岛'\n            when modename = '传统模式' and mapname = '荣耀之城' then '荣耀之城'\n            when submodename = '广域战场模式' then '广域战场'\n            when submodename = '极能形态模式' then '极能形态'\n            when modename = '组队竞技' then '组竞'\n            when modename = '乐园' then '乐园'\n            when modename = '领地' then '领地'\n            when modename = '广阔天地' then '广阔天地'\n            else '其他模式'\n        end\n\n   union all\n   \n   select substr (tdbank_imp_date, 1, 6) mons,\n        '隧道' as modename,\n        vplayerid,\n        sum(roundtime) / 60 roundtime,\n        count(distinct gameid) roundcnt\n   from dwd_jordass_playerexitgamerecord_hi\n   where tdbank_imp_date between '2024061800' and '2025033023'\n     and mode in (3001, 3002, 3003)\n   group by substr (tdbank_imp_date, 1, 6), vplayerid\n)\n\nselect a.mons,\n       a.imodename,\n       a.iusernum,\n       b.iusernumall\nfrom (\n    select mons,\n          imodename,\n          count(vplayerid) iusernum\n    from (\n        select mons, vplayerid, imodename\n        from (\n            select mons,\n                vplayerid,\n                imodename,\n                roundtime,\n                row_number() over (partition by mons, vplayerid order by roundtime desc) as rn\n            from main_user\n        )ff1\n        where rn = 1\n    )f1\n   group by mons, imodename\n) a\nleft join (\n    select mons,\n        imodename,\n        count(vplayerid) iusernumall\n   from main_user\n   group by mons, imodename\n) b \non a.imodename = b.imodename and a.mons = b.mons\norder by a.mons, a.imodename\n;", "meta": {"origin": "sql_30", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_60_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250226往前180天联盟用户，联盟用户的30天滚动付费人数\n输出：统计日期（YYYYMMDD），联盟并付费的人数\n【表】dws_jordass_water_di, dws_jordass_uid_login_df, dwd_jordass_player_allianceactive_hi\n【口径】联盟活跃用户统计日期：\nwhere tdbank_imp_date>=date_sub(\"20250301\",180) and tdbank_imp_date<\"20250301\"\n游戏付费流水统计日期：\nwhere dtstatdate>=date_sub(\"20250301\",210) and dtstatdate<\"20250301\" and platid=255"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH alliance_daily AS (\n  SELECT\n    tdbank_imp_date AS stat_date,\n    CAST(uid AS STRING) AS uid\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE tdbank_imp_date BETWEEN DATE_FORMAT(DATE_SUB('2025-03-01', INTERVAL 180 DAY), '%Y%m%d')\n                            AND DATE_FORMAT(DATE_SUB('2025-03-01', INTERVAL 1 DAY), '%Y%m%d')\n  GROUP BY tdbank_imp_date, uid\n), uid_map AS (\n  SELECT uid, vplayerid\n  FROM (\n    SELECT\n      CAST(uid AS STRING) AS uid,\n      vplayerid,\n      ROW_NUMBER() OVER (PARTITION BY uid ORDER BY dtstatdate DESC) AS rn\n    FROM dws_jordass_uid_login_df\n    WHERE dtstatdate <= '20250301'\n      AND platid = 255\n  ) t\n  WHERE rn = 1\n), rolling_pay AS (\n  SELECT\n    a.stat_date,\n    m.vplayerid\n  FROM alliance_daily a\n  JOIN uid_map m\n    ON a.uid = m.uid\n  WHERE EXISTS (\n    SELECT 1\n    FROM dws_jordass_water_di w\n    WHERE w.vplayerid = m.vplayerid\n      AND w.platid = 255\n      AND w.dtstatdate BETWEEN DATE_FORMAT(DATE_SUB(STR_TO_DATE(a.stat_date, '%Y%m%d'), INTERVAL 29 DAY), '%Y%m%d')\n                          AND a.stat_date\n  )\n)\nSELECT\n  stat_date,\n  COUNT(DISTINCT vplayerid) AS alliance_pay_user_cnt\nFROM rolling_pay\nGROUP BY stat_date\nORDER BY stat_date\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH alliance_daily AS (\n  SELECT\n    tdbank_imp_date AS stat_date,\n    CAST(uid AS STRING) AS uid\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE tdbank_imp_date BETWEEN DATE_FORMAT(DATE_SUB('2025-03-01', INTERVAL 180 DAY), '%Y%m%d')\n                            AND DATE_FORMAT(DATE_SUB('2025-03-01', INTERVAL 1 DAY), '%Y%m%d')\n  GROUP BY tdbank_imp_date, uid\n), uid_map AS (\n  SELECT uid, vplayerid\n  FROM (\n    SELECT\n      CAST(uid AS STRING) AS uid,\n      vplayerid,\n      ROW_NUMBER() OVER (PARTITION BY uid ORDER BY dtstatdate DESC) AS rn\n    FROM dws_jordass_uid_login_df\n    WHERE dtstatdate <= '20250301'\n      AND platid = 255\n  ) t\n  WHERE rn = 1\n), rolling_pay AS (\n  SELECT\n    a.stat_date,\n    m.vplayerid\n  FROM alliance_daily a\n  JOIN uid_map m\n    ON a.uid = m.uid\n  WHERE EXISTS (\n    SELECT 1\n    FROM dws_jordass_water_di w\n    WHERE w.vplayerid = m.vplayerid\n      AND w.platid = 255\n      AND w.dtstatdate BETWEEN DATE_FORMAT(DATE_SUB(STR_TO_DATE(a.stat_date, '%Y%m%d'), INTERVAL 29 DAY), '%Y%m%d')\n                          AND a.stat_date\n  )\n)\nSELECT\n  stat_date,\n  COUNT(DISTINCT vplayerid) AS alliance_pay_user_cnt\nFROM rolling_pay\nGROUP BY stat_date\nORDER BY stat_date\n) AS final_query;", "meta": {"origin": "sql_60", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_112_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2022.04.23-2022.04.30和2022.05.01-2022.05.08传统模式存活时长达到90分钟的玩家人数，每日人数\n输出：统计日期(yyyymmdd)，人数\n【表】dwd_jordass_roundflow_hi\n【口径】传统模式mode in(101,102,103,401,402,403)"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    vplayerid,\n    sum(coalesce(survivaltime, 0)) as total_survival\n  from dwd_jordass_roundflow_hi\n  where ((substr(tdbank_imp_date, 1, 8) between '20220430' and '20220507')\n     or (substr(tdbank_imp_date, 1, 8) between '20220508' and '20220515'))\n    and mode in (101, 102, 103, 401, 402, 403)\n  group by substr(tdbank_imp_date, 1, 8), vplayerid\n)\nselect\n  stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom base\nwhere total_survival >= 5400\ngroup by stat_date\norder by stat_date\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    vplayerid,\n    sum(coalesce(survivaltime, 0)) as total_survival\n  from dwd_jordass_roundflow_hi\n  where ((substr(tdbank_imp_date, 1, 8) > '20220430')\n     or (substr(tdbank_imp_date, 1, 8) between '20220508' and '20220515'))\n    and mode in (101, 102, 103, 401, 402, 403)\n  group by substr(tdbank_imp_date, 1, 8), vplayerid\n)\nselect\n  stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom base\nwhere total_survival >= 5400\ngroup by stat_date\norder by stat_date\n) AS final_query;", "meta": {"origin": "sql_112", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_14_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年5月份活跃但2025年6月未活跃的qq号码包\n输出:用户suserid\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df\n【口径】限定dim_argothek_gplayerid2qqwxid_df的日期为\"20250707\"\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with may_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250528 and 20250627\n),\njune_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250628 and 20250727\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250707'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct m.suserid\nfrom may_active a\njoin qq_map m\n  on a.iuserid = m.iuserid\nleft join june_active j\n  on a.iuserid = j.iuserid\nwhere j.iuserid is null\norder by m.suserid;"}], "rejected": "with may_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250528 and 20250627\n),\njune_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250628 and 20250727\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250707'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct m.suserid\nfrom may_active a\njoin qq_map m\n  on a.iuserid = m.iuserid\nleft join june_active j\n  on a.iuserid = j.iuserid\nwhere j.iuserid is null\norder by m.suserid;", "meta": {"origin": "sql_14", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_28_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计各个玩法上线首周留存情况\n输出：玩法、上线首周首次玩的日期、第几天留存（0,1,2...7)、玩法留存用户数\n\n各玩法首周上线日期：\n\"广域战场\": \"20240724\",\n\"消灭战\": \"20230805\",\n\"幻想混战\": \"20241116\",\n\"荒野传说\": \"20240904\",\n\"策略载具\": \"20241011\",\n\"炎夏混战\": \"20240626\",\n\"单人装备\": \"20240518\",\n\"交叉堡垒\": \"20240413\"\n【表】dws_jordass_mode_roundrecord_di\n【口径】说明：\n广域战场 （2024/7/23）submodename= '广域战场模式'，\n消灭战（2023/8/4） modename='组队竞技' and submodename like '%消灭战模式%'，\n幻想混战（2024/11/16）modename='创意创作间' and submodename='幻想混战'，\n荒野传说（2024-09-04）modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')，\n策略载具（2024-10-11）modename='休闲模式' and submodename like '%策略载具%'，\n炎夏混战（2024-06-26）modename='创意创作间' and submodename like '%炎夏混战%'，\n单人装备（2024.5.17）modename='组队竞技' and submodename like '%单人装备%'，\n交叉堡垒（2024.4.12） modename='组队竞技' and submodename like '%交叉堡垒%'\n\n第几天留存：0表示当天参与、1表示当天参与在第2天也参与、2表示当天参与在第3天也参与，依此类推"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect  a.itype,\n        a.dtstatdate,\n        datediff(b.dtstatdate,a.dtstatdate) as idaynum,\n        count(distinct a.vplayerid)           as iusernum\nfrom (                      \n    select\n        itype,\n        min(dtstatdate) as dtstatdate,\n        vplayerid\n    from  (\n        select '广域战场'      as itype,\n                min(dtstatdate) as dtstatdate,\n                vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240724' and dtstatdate <= date_add('20240724',6)\n        and submodename = '广域战场模式'\n        group by vplayerid\n\n        union all\n        select '消灭战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230805' and dtstatdate <= date_add('20230805',6)\n        and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by vplayerid\n\n        union all\n        select '幻想混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241116' and dtstatdate <= date_add('20241116',6)\n        and modename='创意创作间' and submodename='幻想混战'\n        group by vplayerid\n\n        union all\n        select '荒野传说', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240904' and dtstatdate <= date_add('20240904',6)\n        and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by vplayerid\n\n        union all\n        select '策略载具', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241011' and dtstatdate <= date_add('20241011',6)\n        and modename='休闲模式' and submodename like '%策略载具%'\n        group by vplayerid\n\n        union all\n        select '炎夏混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240626' and dtstatdate <= date_add('20240626',6)\n        and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by vplayerid\n\n        union all\n        select '单人装备', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240518' and dtstatdate <= date_add('20240518',6)\n        and modename='组队竞技' and submodename like '%单人装备%'\n        group by vplayerid\n\n        union all\n        select '交叉堡垒', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240413' and dtstatdate <= date_add('20240413',6)\n        and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by vplayerid\n    ) t\n    group by itype, vplayerid\n) a\nleft join (\n        select '广域战场' as itype, dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240724' and dtstatdate <= date_add('20240724',13)\n          and submodename = '广域战场模式'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '消灭战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230805' and dtstatdate <= date_add('20230805',13)\n          and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '幻想混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241116' and dtstatdate <= date_add('20241116',13)\n          and modename='创意创作间' and submodename='幻想混战'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '荒野传说', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240904' and dtstatdate <= date_add('20240904',13)\n          and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by dtstatdate, vplayerid\n\n        union all\n        select '策略载具', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241011' and dtstatdate <= date_add('20241011',13)\n          and modename='休闲模式' and submodename like '%策略载具%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '炎夏混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240626' and dtstatdate <= date_add('20240626',13)\n          and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '单人装备', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240518' and dtstatdate <= date_add('20240518',13)\n          and modename='组队竞技' and submodename like '%单人装备%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '交叉堡垒', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240413' and dtstatdate <= date_add('20240413',13)\n          and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by dtstatdate, vplayerid\n) b\n  on  a.itype      = b.itype\nand  a.vplayerid    = b.vplayerid\nwhere datediff(b.dtstatdate,a.dtstatdate) between 0 and 7\ngroup by a.itype, a.dtstatdate, datediff(b.dtstatdate,a.dtstatdate)\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect  a.itype,\n        a.dtstatdate,\n        datediff(b.dtstatdate,a.dtstatdate) as idaynum,\n        count(distinct a.vplayerid)           as iusernum\nfrom (                      \n    select\n        itype,\n        min(dtstatdate) as dtstatdate,\n        vplayerid\n    from  (\n        select '广域战场'      as itype,\n                min(dtstatdate) as dtstatdate,\n                vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240724' and dtstatdate <= date_add('20240724',6)\n        and submodename = '广域战场模式'\n        group by vplayerid\n\n        union all\n        select '消灭战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230805' and dtstatdate <= date_add('20230805',6)\n        and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by vplayerid\n\n        union all\n        select '幻想混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241116' and dtstatdate <= date_add('20241116',6)\n        and modename='创意创作间' and submodename='幻想混战'\n        group by vplayerid\n\n        union all\n        select '荒野传说', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240904' and dtstatdate <= date_add('20240904',6)\n        and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by vplayerid\n\n        union all\n        select '策略载具', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241011' and dtstatdate <= date_add('20241011',6)\n        and modename='休闲模式' and submodename like '%策略载具%'\n        group by vplayerid\n\n        union all\n        select '炎夏混战', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240626' and dtstatdate <= date_add('20240626',6)\n        and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by vplayerid\n\n        union all\n        select '单人装备', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240518' and dtstatdate <= date_add('20240518',6)\n        and modename='组队竞技' and submodename like '%单人装备%'\n        group by vplayerid\n\n        union all\n        select '交叉堡垒', min(dtstatdate), vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240413' and dtstatdate <= date_add('20240413',6)\n        and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by vplayerid\n    ) t\n    group by itype, vplayerid\n) a\nleft join (\n        select '广域战场' as itype, dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240724' and dtstatdate <= date_add('20240724',13)\n          and submodename = '广域战场模式'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '消灭战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20230805' and dtstatdate <= date_add('20230805',13)\n          and modename='组队竞技' and submodename like '%消灭战模式%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '幻想混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241116' and dtstatdate <= date_add('20241116',13)\n          and modename='创意创作间' and submodename='幻想混战'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '荒野传说', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240904' and dtstatdate <= date_add('20240904',13)\n          and modename='休闲模式' and submodename in ('荒野传说','荒野沙漠')\n        group by dtstatdate, vplayerid\n\n        union all\n        select '策略载具', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20241011' and dtstatdate <= date_add('20241011',13)\n          and modename='休闲模式' and submodename like '%策略载具%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '炎夏混战', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240626' and dtstatdate <= date_add('20240626',13)\n          and modename='创意创作间' and submodename like '%炎夏混战%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '单人装备', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240518' and dtstatdate <= date_add('20240518',13)\n          and modename='组队竞技' and submodename like '%单人装备%'\n        group by dtstatdate, vplayerid\n\n        union all\n        select '交叉堡垒', dtstatdate, vplayerid\n        from dws_jordass_mode_roundrecord_di\n        where dtstatdate >= '20240413' and dtstatdate <= date_add('20240413',13)\n          and modename='组队竞技' and submodename like '%交叉堡垒%'\n        group by dtstatdate, vplayerid\n) b\n  on  a.itype      = b.itype\nand  a.vplayerid    = b.vplayerid\nwhere datediff(b.dtstatdate,a.dtstatdate) between 0 and 7\ngroup by a.itype, a.dtstatdate, datediff(b.dtstatdate,a.dtstatdate)\n) AS final_query;", "meta": {"origin": "sql_28", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_105_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20240101-20250601全平台每天充值金额数和消耗金币数\n输出：统计日期(yyyymmdd)，充值金额数，消耗金币数\n【表】dws_jordass_water_di, dwd_jordass_currencylog_hi\n【口径】消耗金币：AddOrReduce=1 and imoneytype=1\n 充值和消耗金币都直接使用imoney  \n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with recharge as (\n  select\n    dtstatdate as stat_date,\n    sum(coalesce(imoney, 0)) as recharge_amount\n  from dws_jordass_water_di\n  where dtstatdate between '20240128' and '20250628'\n  group by dtstatdate\n),\ngold_consume as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    sum(coalesce(imoney, 0)) as gold_consume_amount\n  from dwd_jordass_currencylog_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240128' and '20250628'\n    and addorreduce = 1\n    and imoneytype = 1\n  group by substr(tdbank_imp_date, 1, 8)\n),\nall_dates as (\n  select stat_date from recharge\n  union\n  select stat_date from gold_consume\n)\nselect\n  d.stat_date,\n  coalesce(r.recharge_amount, 0) as recharge_amount,\n  coalesce(g.gold_consume_amount, 0) as gold_consume_amount\nfrom all_dates d\nleft join recharge r on d.stat_date = r.stat_date\nleft join gold_consume g on d.stat_date = g.stat_date\norder by d.stat_date;"}], "rejected": "with recharge as (\n  select\n    dtstatdate as stat_date,\n    sum(coalesce(imoney, 0)) as recharge_amount\n  from dws_jordass_water_di\n  where dtstatdate > '20240128'\n  group by dtstatdate\n),\ngold_consume as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    sum(coalesce(imoney, 0)) as gold_consume_amount\n  from dwd_jordass_currencylog_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240128' and '20250628'\n    and addorreduce = 1\n    and imoneytype = 1\n  group by substr(tdbank_imp_date, 1, 8)\n),\nall_dates as (\n  select stat_date from recharge\n  union\n  select stat_date from gold_consume\n)\nselect\n  d.stat_date,\n  coalesce(r.recharge_amount, 0) as recharge_amount,\n  coalesce(g.gold_consume_amount, 0) as gold_consume_amount\nfrom all_dates d\nleft join recharge r on d.stat_date = r.stat_date\nleft join gold_consume g on d.stat_date = g.stat_date\norder by d.stat_date;", "meta": {"origin": "sql_105", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_43_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.1.1-2025.1.31期间活跃度分布\n输出：活跃度（轻度、中度、重度）、玩家数\n\n活跃度：轻度1-5天，中度6-15天，重度大于16天\n【表】dws_jordass_login_di\n【口径】"}, {"role": "assistant", "content": "with jan_active as (\n  select\n    vplayerid,\n    count(distinct dtstatdate) as active_days\n  from dws_jordass_login_di\n  where dtstatdate between '20250106' and '20250205'\n  group by vplayerid\n)\nselect\n  case\n    when active_days between 1 and 5 then '轻度'\n    when active_days between 6 and 15 then '中度'\n    when active_days >= 16 then '重度'\n    else '未知'\n  end as actv_level,\n  count(*) as player_cnt\nfrom jan_active\nwhere active_days > 0\ngroup by actv_level\norder by actv_level;"}], "rejected": "with jan_active as (\n  select\n    vplayerid,\n    count(distinct dtstatdate) as active_days\n  from dws_jordass_login_di\n  where dtstatdate > '20250106'\n  group by vplayerid\n)\nselect\n  case\n    when active_days between 1 and 5 then '轻度'\n    when active_days between 6 and 15 then '中度'\n    when active_days >= 16 then '重度'\n    else '未知'\n  end as actv_level,\n  count(*) as player_cnt\nfrom jan_active\nwhere active_days > 0\ngroup by actv_level\norder by actv_level;", "meta": {"origin": "sql_43", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_107_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2022.1.18-1.24与2021.10.19-12.20这两个时间段\n buttontype =99123并且 ireason=3的人数，以及两个时间段都满足条件的交叉人数\n输出：2022.1.18-1.24人数，2021.10.28-12.20人数，两个时间段交叉的人数\n【表】dwd_jordass_activitypress_hi\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with period_a as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2022011800' and '2022012423'\n    and buttontype = 99123\n    and ireason = 3\n),\nperiod_b as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2021101900' and '2021122023'\n    and buttontype = 99123\n    and ireason = 3\n)\nselect\n  (select count(*) from period_a) as cnt_period_a,\n  (select count(*) from period_b) as cnt_period_b,\n  (select count(*) from period_a a join period_b b on a.uid = b.uid) as cnt_overlap;"}], "rejected": "with period_a as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2022011800' and '2022012423'\n    and buttontype = 99123\n    and ireason = 3\n),\nperiod_b as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2021101900' and '2021122023'\n    and buttontype = 99123\n    and ireason = 3\n)\nselect\n  (select count(*) from period_a) as cnt_period_a,\n  (select count(*) from period_b) as cnt_period_b,\n  (select count(*) from period_a a join period_b b on a.uid = b.uid) as cnt_overlap;", "meta": {"origin": "sql_107", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_18_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250506-20250512期间每日的指定网吧渠道内每个渠道活跃人数\n输出：日期（20250512、...、20250518）、渠道、玩家数\n其中：网吧渠道：iloginway in (1,10,11,12,35,20,28,29,30,31,32,33,34,36)\n【表】dws_argothek_oss_login_di\n【口径】"}, {"role": "assistant", "content": "select\n  statis_date,\n  iloginway,\n  count(distinct iuserid) as player_cnt\nfrom dws_argothek_oss_login_di\nwhere statis_date between 20250512 and 20250518\n  and iloginway in (1,10,11,12,20,28,29,30,31,32,33,34,35,36)\ngroup by statis_date, iloginway\norder by statis_date, iloginway;"}], "rejected": "select\n  statis_date,\n  iloginway,\n  count(distinct iuserid) as player_cnt\nfrom dws_argothek_oss_login_di\nwhere statis_date between 20250512 and 20250518\n  and iloginway in (1,10,11,12,20,28,29,30,31,32,33,34,35,36)\ngroup by statis_date, iloginway\norder by statis_date, iloginway;", "meta": {"origin": "sql_18", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_97_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】在2023.7.19-2023.7.25时间范围内，分别统计参与了隐匿的用户人数、既参与隐匿也参与了桥梁争夺的用户、既参与隐匿也参与了隐匿模式的用户\n输出：参与了隐匿的不重复的人的个数、参与隐匿并且参与了桥梁争夺的不重复的人的个数、参与隐匿并且参与了隐匿模式的不重复的人的个数\n【表】dws_jordass_matchlog_stat_di, dws_jordass_mode_roundrecord_di\n【口径】隐匿的用户：imode = 1307095884553538304  and platid <> 255\n桥梁争夺的用户：imode = 1310822585431254784  and platid <> 255\n隐匿模式的用户：mode=2370"}, {"role": "assistant", "content": "with hidden as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate between '20230724' and '20230730'\n    and imode = 1307095884553538304\n    and platid <> 255\n),\nbridge as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate between '20230724' and '20230730'\n    and imode = 1310822585431254784\n    and platid <> 255\n),\nhidden_mode as (\n  select distinct vplayerid\n  from dws_jordass_mode_roundrecord_di\n  where dtstatdate between '20230724' and '20230730'\n    and mode = 2370\n)\nselect\n  (select count(*) from hidden) as hidden_user_cnt,\n  (select count(*) from hidden h join bridge b on h.vplayerid = b.vplayerid) as hidden_and_bridge_cnt,\n  (select count(*) from hidden h join hidden_mode m on h.vplayerid = m.vplayerid) as hidden_and_mode_cnt;"}], "rejected": "with hidden as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate > '20230724'\n    and imode = 1307095884553538304\n    and platid <> 255\n),\nbridge as (\n  select distinct vplayerid\n  from dws_jordass_matchlog_stat_di\n  where dtstatdate between '20230724' and '20230730'\n    and imode = 1310822585431254784\n    and platid <> 255\n),\nhidden_mode as (\n  select distinct vplayerid\n  from dws_jordass_mode_roundrecord_di\n  where dtstatdate between '20230724' and '20230730'\n    and mode = 2370\n)\nselect\n  (select count(*) from hidden) as hidden_user_cnt,\n  (select count(*) from hidden h join bridge b on h.vplayerid = b.vplayerid) as hidden_and_bridge_cnt,\n  (select count(*) from hidden h join hidden_mode m on h.vplayerid = m.vplayerid) as hidden_and_mode_cnt;", "meta": {"origin": "sql_97", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_23_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年3月24日至2025年3月30日，至少完成过一场对局，且渠道登录的用户qq\n输出:qq\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df, dwd_argothek_playermatchstats_hi, dim_argothek_gplayerid_vroleid_df\n【口径】渠道筛选条件：iloginway = 3\n用户ID筛选swxid_type = \"qq\" -- 筛选swxid_type为\"qq\""}, {"role": "assistant", "content": "with channel_login as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250324 and 20250330\n    and iloginway = 3\n),\nrole_map as (\n  select\n    vroleid,\n    gplayerid\n  from (\n    select\n      vroleid,\n      iuserid as gplayerid,\n      row_number() over(partition by vroleid order by dtstatdate desc) as rn\n    from dim_argothek_gplayerid_vroleid_df\n    where dtstatdate <= '20250330'\n  ) t\n  where rn = 1\n),\nmatch_player as (\n  select distinct rm.gplayerid\n  from dwd_argothek_playermatchstats_hi s\n  join role_map rm on s.vroleid = rm.vroleid\n  where substr(s.tdbank_imp_date, 1, 8) between '20250324' and '20250330'\n    and coalesce(s.ismatchcompleted, 1) = 1\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250330'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom match_player mp\njoin channel_login cl on mp.gplayerid = cl.iuserid\njoin qq_map q on mp.gplayerid = q.iuserid\norder by qq;"}], "rejected": "with channel_login as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250324 and 20250330\n    and iloginway = 3\n),\nrole_map as (\n  select\n    vroleid,\n    gplayerid\n  from (\n    select\n      vroleid,\n      iuserid as gplayerid,\n      row_number() over(partition by vroleid order by dtstatdate desc) as rn\n    from dim_argothek_gplayerid_vroleid_df\n    where dtstatdate <= '20250330'\n  ) t\n  where rn = 1\n),\nmatch_player as (\n  select distinct rm.gplayerid\n  from dwd_argothek_playermatchstats_hi s\n  join role_map rm on s.vroleid = rm.vroleid\n  where substr(s.tdbank_imp_date, 1, 8) > '20250324'\n    and coalesce(s.ismatchcompleted, 1) = 1\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250330'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom match_player mp\njoin channel_login cl on mp.gplayerid = cl.iuserid\njoin qq_map q on mp.gplayerid = q.iuserid\norder by qq;", "meta": {"origin": "sql_23", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_31_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250217-20250318协作平台活跃但是没有在协作玩法活跃用户的主玩玩法分布\n输出：主玩玩法（传统模式、休闲模式、...、生存模式）、人数\n【表】dws_jordass_matchlog_stat_di, dwd_jordass_buttonpress_pre_di, dws_jordass_mode_roundrecord_di\n【口径】主玩定义：用户累计对局时长最多的玩法；\n玩法取 modename in ('传统模式','休闲模式','组队竞技','领地','乐园','广阔天地','创意创作间','生存模式')\n协作平台活跃：ugcmbuttonclick中的玩家；\n协作玩法活跃：vtemp1='协作'  的玩法记录"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH coop_platform AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_buttonpress_pre_di\n  WHERE dtstatdate BETWEEN '20250222' AND '20250323'\n    AND buttontype = 'ugcmbuttonclick'\n),\ncoop_game AS (\n  SELECT DISTINCT m.vplayerid\n  FROM dws_jordass_mode_roundrecord_di m\n  LEFT JOIN dim_jordass_submodeonlinedate_conf c\n    ON m.submode = c.matchsubmodegroup\n  WHERE m.dtstatdate BETWEEN '20250222' AND '20250323'\n    AND COALESCE(c.vtemp1, '') = '协作'\n),\ntarget_player AS (\n  SELECT vplayerid\n  FROM coop_platform\n  WHERE vplayerid NOT IN (SELECT vplayerid FROM coop_game)\n),\nmode_time AS (\n  SELECT\n    m.vplayerid,\n    CASE\n      WHEN modename = '传统模式' THEN '传统模式'\n      WHEN modename = '休闲模式' THEN '休闲模式'\n      WHEN modename = '组队竞技' THEN '组队竞技'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '生存模式'\n      ELSE '其他'\n    END AS main_mode_group,\n    SUM(roundtime) AS total_round_time\n  FROM dws_jordass_mode_roundrecord_di m\n  JOIN target_player t ON m.vplayerid = t.vplayerid\n  WHERE m.dtstatdate BETWEEN '20250222' AND '20250323'\n  GROUP BY m.vplayerid, main_mode_group\n),\nranked_mode AS (\n  SELECT\n    vplayerid,\n    main_mode_group,\n    total_round_time,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY total_round_time DESC) AS rn\n  FROM mode_time\n)\nSELECT\n  main_mode_group AS main_mode,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM ranked_mode\nWHERE rn = 1\nGROUP BY main_mode_group\nORDER BY user_cnt DESC\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH coop_platform AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_buttonpress_pre_di\n  WHERE dtstatdate > '20250222'\n    AND buttontype = 'ugcmbuttonclick'\n),\ncoop_game AS (\n  SELECT DISTINCT m.vplayerid\n  FROM dws_jordass_mode_roundrecord_di m\n  LEFT JOIN dim_jordass_submodeonlinedate_conf c\n    ON m.submode = c.matchsubmodegroup\n  WHERE m.dtstatdate BETWEEN '20250222' AND '20250323'\n    AND COALESCE(c.vtemp1, '') = '协作'\n),\ntarget_player AS (\n  SELECT vplayerid\n  FROM coop_platform\n  WHERE vplayerid NOT IN (SELECT vplayerid FROM coop_game)\n),\nmode_time AS (\n  SELECT\n    m.vplayerid,\n    CASE\n      WHEN modename = '传统模式' THEN '传统模式'\n      WHEN modename = '休闲模式' THEN '休闲模式'\n      WHEN modename = '组队竞技' THEN '组队竞技'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '生存模式'\n      ELSE '其他'\n    END AS main_mode_group,\n    SUM(roundtime) AS total_round_time\n  FROM dws_jordass_mode_roundrecord_di m\n  JOIN target_player t ON m.vplayerid = t.vplayerid\n  WHERE m.dtstatdate BETWEEN '20250222' AND '20250323'\n  GROUP BY m.vplayerid, main_mode_group\n),\nranked_mode AS (\n  SELECT\n    vplayerid,\n    main_mode_group,\n    total_round_time,\n    ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY total_round_time DESC) AS rn\n  FROM mode_time\n)\nSELECT\n  main_mode_group AS main_mode,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM ranked_mode\nWHERE rn = 1\nGROUP BY main_mode_group\nORDER BY user_cnt DESC\n) AS final_query;", "meta": {"origin": "sql_31", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_41_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.1.1～1.3，每天活跃玩家数\n输出：统计日期(20240128、20240129、20240130)、玩家数\n【表】dws_jordass_login_di\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  dtstatdate as stat_date,\n  count(distinct vplayerid) as player_cnt\nfrom dws_jordass_login_di\nwhere dtstatdate between '20240128' and '20240130'\ngroup by dtstatdate\norder by dtstatdate;"}], "rejected": "select\n  dtstatdate as stat_date,\n  count(distinct vplayerid) as player_cnt\nfrom dws_jordass_login_di\nwhere dtstatdate > '20240128'\ngroup by dtstatdate\norder by dtstatdate;", "meta": {"origin": "sql_41", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_22_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：近30天用户在渠道登录的天数为5到8天，取最多天数的用户，并将用户ID转为qq\n输出：QQ\n统计日期：20250405-20250504\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df\n【口径】渠道筛选条件：iloginway = 3\n用户ID筛选swxid_type = \"qq\" -- 筛选swxid_type为\"qq\"\ndim_argothek_gplayerid2qqwxid_df限定20250428"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith login_stat as (\n  select\n    iuserid,\n    count(distinct statis_date) as login_days\n  from dws_argothek_oss_login_di\n  where statis_date between 20250405 and 20250504\n    and iloginway = 3\n  group by iuserid\n  having login_days between 5 and 8\n),\nmax_days as (\n  select max(login_days) as max_login_days from login_stat\n),\nqq_map as (\n  select\n    iuserid,\n    suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250504'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom login_stat l\njoin max_days m on l.login_days = m.max_login_days\njoin qq_map q on l.iuserid = q.iuserid\norder by qq\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith login_stat as (\n  select\n    iuserid,\n    count(distinct statis_date) as login_days\n  from dws_argothek_oss_login_di\n  where statis_date between 20250405 and 20250504\n    and iloginway = 3\n  group by iuserid\n  having login_days between 5 and 8\n),\nmax_days as (\n  select max(login_days) as max_login_days from login_stat\n),\nqq_map as (\n  select\n    iuserid,\n    suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250504'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom login_stat l\njoin max_days m on l.login_days = m.max_login_days\njoin qq_map q on l.iuserid = q.iuserid\norder by qq\n) AS final_query;", "meta": {"origin": "sql_22", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_105_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20240101-20250601全平台每天充值金额数和消耗金币数\n输出：统计日期(yyyymmdd)，充值金额数，消耗金币数\n【表】dws_jordass_water_di, dwd_jordass_currencylog_hi\n【口径】消耗金币：AddOrReduce=1 and imoneytype=1\n 充值和消耗金币都直接使用imoney"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith recharge as (\n  select\n    dtstatdate as stat_date,\n    sum(coalesce(imoney, 0)) as recharge_amount\n  from dws_jordass_water_di\n  where dtstatdate between '20240106' and '20250606'\n  group by dtstatdate\n),\ngold_consume as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    sum(coalesce(imoney, 0)) as gold_consume_amount\n  from dwd_jordass_currencylog_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240106' and '20250606'\n    and addorreduce = 1\n    and imoneytype = 1\n  group by substr(tdbank_imp_date, 1, 8)\n),\nall_dates as (\n  select stat_date from recharge\n  union\n  select stat_date from gold_consume\n)\nselect\n  d.stat_date,\n  coalesce(r.recharge_amount, 0) as recharge_amount,\n  coalesce(g.gold_consume_amount, 0) as gold_consume_amount\nfrom all_dates d\nleft join recharge r on d.stat_date = r.stat_date\nleft join gold_consume g on d.stat_date = g.stat_date\norder by d.stat_date\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith recharge as (\n  select\n    dtstatdate as stat_date,\n    sum(coalesce(imoney, 0)) as recharge_amount\n  from dws_jordass_water_di\n  where dtstatdate > '20240106'\n  group by dtstatdate\n),\ngold_consume as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    sum(coalesce(imoney, 0)) as gold_consume_amount\n  from dwd_jordass_currencylog_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240106' and '20250606'\n    and addorreduce = 1\n    and imoneytype = 1\n  group by substr(tdbank_imp_date, 1, 8)\n),\nall_dates as (\n  select stat_date from recharge\n  union\n  select stat_date from gold_consume\n)\nselect\n  d.stat_date,\n  coalesce(r.recharge_amount, 0) as recharge_amount,\n  coalesce(g.gold_consume_amount, 0) as gold_consume_amount\nfrom all_dates d\nleft join recharge r on d.stat_date = r.stat_date\nleft join gold_consume g on d.stat_date = g.stat_date\norder by d.stat_date\n) AS final_query;", "meta": {"origin": "sql_105", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_4_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计开服至今使用频率最高的用户昵称。\n时间范围：2023.07.28 00:00:00 - 2025.07.31 23:59:59\n输出：昵称（唯一）、人数\n【表】dwd_argothek_playerlogin_hi\n【口径】昵称筛选逻辑：\nnickname 按照 # 进行划分，取 # 前半部分作为昵称\n示例：多喝热水#131234 -> 昵称：多喝热水\n若存在并列最高频率，按昵称字典序最小的记录返回\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH base AS (\n  SELECT\n    CASE\n      WHEN LOCATE('#', vrolename) > 0 THEN SUBSTR(vrolename, 1, LOCATE('#', vrolename) - 1)\n      ELSE vrolename\n    END AS nickname,\n    iuserid\n  FROM dwd_argothek_playerlogin_hi\n  WHERE dteventtime >= '2023-07-28 00:00:00'\n    AND dteventtime <= '2025-07-31 23:59:59'\n    AND IFNULL(vrolename, '') <> ''\n),\nagg AS (\n  SELECT\n    nickname,\n    COUNT(DISTINCT iuserid) AS user_cnt\n  FROM base\n  GROUP BY nickname\n)\nSELECT\n  nickname,\n  user_cnt AS user_num\nFROM agg\nORDER BY user_cnt DESC, nickname\nLIMIT 1;"}], "rejected": "WITH base AS (\n  SELECT\n    CASE\n      WHEN LOCATE('#', vrolename) > 0 THEN SUBSTR(vrolename, 1, LOCATE('#', vrolename) - 1)\n      ELSE vrolename\n    END AS nickname,\n    iuserid\n  FROM dwd_argothek_playerlogin_hi\n  WHERE dteventtime >= '2023-07-28 00:00:00'\n    AND dteventtime <= '2025-07-31 23:59:59'\n    AND IFNULL(vrolename, '') <> ''\n),\nagg AS (\n  SELECT\n    nickname,\n    COUNT(DISTINCT iuserid) AS user_cnt\n  FROM base\n  GROUP BY nickname\n)\nSELECT\n  nickname,\n  user_cnt AS user_num\nFROM agg\nORDER BY user_cnt DESC, nickname\nLIMIT 1;", "meta": {"origin": "sql_4", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_33_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024年12月14日-2024年12月20日参与建筑争夺玩法的玩家人数（去重）有多少，其中多少人是12月13日及以前有参与过建筑争夺的老玩家，有多少是新玩家\n输出: 玩家人数、老玩家人数、新玩家人数\n【表】dws_jordass_playermatchrecord_stat_df, dws_jordass_matchlog_stat_di\n【口径】建筑争夺玩法对应的imode为1344338933661592832\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n    count(distinct a.vplayerid) as total_players,\n    count(distinct case when b.vplayerid is not null then a.vplayerid end) as existing_players,\n    count(distinct case when b.vplayerid is null then a.vplayerid end) as new_players\nfrom (\n    select vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20241229' and '20250104'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) a\nleft join (\n    select vplayerid\n    from dws_jordass_playermatchrecord_stat_df\n    where dtstatdate = '20241228'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) b\non a.vplayerid = b.vplayerid\n;"}], "rejected": "select\n    count(distinct a.vplayerid) as total_players,\n    count(distinct case when b.vplayerid is not null then a.vplayerid end) as existing_players,\n    count(distinct case when b.vplayerid is null then a.vplayerid end) as new_players\nfrom (\n    select vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate > '20241229'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) a\nleft join (\n    select vplayerid\n    from dws_jordass_playermatchrecord_stat_df\n    where dtstatdate = '20241228'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) b\non a.vplayerid = b.vplayerid\n;", "meta": {"origin": "sql_33", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_29_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计周期：2024.6.18至2025年3月30日\n输出：自然周（20240622、20240629、...、20250329），玩法名称，周平均日均参与用户数，周平均日均参与率，周平均日均参与场次\n\n参与率：玩法参与用户数 / 活跃用户数\n周平均日均参与场次：每天不同玩法平均对局数再按周求平均\n【表】dws_jordass_login_di, dws_jordass_mode_roundrecord_di\n【口径】自然周指周一到周日的完整周期，通常以周一作为起始日\n\n玩法：从上往下匹配，如果满足任一条件则返回对应的玩法名称，否则返回“其他模式”。\n如果模式为“传统模式”，且子模式名称以“CG”开头，且地图为“群屿”，则返回“主题群屿”；\n如果模式为“传统模式”且地图为“群屿”，则返回“传统群屿”；\n如果模式为“传统模式”且地图为“假日群岛”，则返回“假日群岛”；\n如果模式为“传统模式”且地图为“荣耀之城”，则返回“荣耀之城”；\n如果子模式是“广域战场模式”，则返回“广域战场”；\n如果子模式是“极能形态模式”，则返回“极能形态”；\n如果模式是“组队竞技”，则返回“组竞”；\n如果模式是“休闲模式”，则返回“休闲”；\n如果模式是“乐园”，则返回“乐园”；\n如果模式是“领地”，则返回“领地”；\n如果模式是“广阔天地”，则返回“广阔天地”\n如果模式是“生存模式”，则返回“隧道”。"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH daily_play AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS play_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    CASE\n      WHEN modename = '传统模式' AND submodename LIKE 'CG%' AND mapname = '群屿' THEN '主题群屿'\n      WHEN modename = '传统模式' AND mapname = '群屿' THEN '传统群屿'\n      WHEN modename = '传统模式' AND mapname = '假日群岛' THEN '假日群岛'\n      WHEN modename = '传统模式' AND mapname = '荣耀之城' THEN '荣耀之城'\n      WHEN submodename = '广域战场模式' THEN '广域战场'\n      WHEN submodename = '极能形态模式' THEN '极能形态'\n      WHEN modename = '组队竞技' THEN '组竞'\n      WHEN modename = '休闲模式' THEN '休闲'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '隧道'\n      ELSE '其他模式'\n    END AS gameplay,\n    COUNT(DISTINCT vplayerid) AS participants,\n    SUM(roundcnt) AS match_cnt\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate BETWEEN '20240623' AND '20250404'\n  GROUP BY play_date, week_start, gameplay\n),\ndaily_active AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS act_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    COUNT(DISTINCT vplayerid) AS active_cnt\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20240623' AND '20250404'\n  GROUP BY act_date, week_start\n),\nmerged AS (\n  SELECT\n    p.week_start,\n    p.play_date,\n    p.gameplay,\n    p.participants,\n    p.match_cnt,\n    COALESCE(a.active_cnt, 0) AS active_cnt,\n    CASE WHEN COALESCE(a.active_cnt, 0) = 0 THEN 0 ELSE p.participants / a.active_cnt END AS daily_rate,\n    CASE WHEN p.participants = 0 THEN 0 ELSE p.match_cnt / p.participants END AS daily_avg_match\n  FROM daily_play p\n  LEFT JOIN daily_active a\n    ON p.play_date = a.act_date\n   AND p.week_start = a.week_start\n),\nweekly_stats AS (\n  SELECT\n    week_start,\n    gameplay,\n    COUNT(DISTINCT play_date) AS days_in_week,\n    SUM(participants) AS total_participants,\n    SUM(active_cnt) AS total_active,\n    SUM(match_cnt) AS total_matches,\n    AVG(participants) AS avg_daily_participants,\n    AVG(daily_rate) AS avg_daily_rate,\n    AVG(daily_avg_match) AS avg_daily_matches\n  FROM merged\n  GROUP BY week_start, gameplay\n)\nSELECT\n  DATE_FORMAT(week_start, '%Y%m%d') AS week_start_label,\n  gameplay,\n  ROUND(avg_daily_participants, 2) AS avg_daily_participants,\n  ROUND(avg_daily_rate, 4) AS avg_daily_participation_rate,\n  ROUND(avg_daily_matches, 4) AS avg_daily_matches\nFROM weekly_stats\nWHERE week_start BETWEEN DATE '2024-06-22' AND DATE '2025-03-29'\nORDER BY week_start, gameplay\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH daily_play AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS play_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    CASE\n      WHEN modename = '传统模式' AND submodename LIKE 'CG%' AND mapname = '群屿' THEN '主题群屿'\n      WHEN modename = '传统模式' AND mapname = '群屿' THEN '传统群屿'\n      WHEN modename = '传统模式' AND mapname = '假日群岛' THEN '假日群岛'\n      WHEN modename = '传统模式' AND mapname = '荣耀之城' THEN '荣耀之城'\n      WHEN submodename = '广域战场模式' THEN '广域战场'\n      WHEN submodename = '极能形态模式' THEN '极能形态'\n      WHEN modename = '组队竞技' THEN '组竞'\n      WHEN modename = '休闲模式' THEN '休闲'\n      WHEN modename = '乐园' THEN '乐园'\n      WHEN modename = '领地' THEN '领地'\n      WHEN modename = '广阔天地' THEN '广阔天地'\n      WHEN modename = '生存模式' THEN '隧道'\n      ELSE '其他模式'\n    END AS gameplay,\n    COUNT(DISTINCT vplayerid) AS participants,\n    SUM(roundcnt) AS match_cnt\n  FROM dws_jordass_mode_roundrecord_di\n  WHERE dtstatdate > '20240623'\n  GROUP BY play_date, week_start, gameplay\n),\ndaily_active AS (\n  SELECT\n    STR_TO_DATE(dtstatdate, '%Y%m%d') AS act_date,\n    DATE_SUB(\n      STR_TO_DATE(dtstatdate, '%Y%m%d'),\n      INTERVAL ((DAYOFWEEK(STR_TO_DATE(dtstatdate, '%Y%m%d')) + 5) % 7) DAY\n    ) AS week_start,\n    COUNT(DISTINCT vplayerid) AS active_cnt\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20240623' AND '20250404'\n  GROUP BY act_date, week_start\n),\nmerged AS (\n  SELECT\n    p.week_start,\n    p.play_date,\n    p.gameplay,\n    p.participants,\n    p.match_cnt,\n    COALESCE(a.active_cnt, 0) AS active_cnt,\n    CASE WHEN COALESCE(a.active_cnt, 0) = 0 THEN 0 ELSE p.participants / a.active_cnt END AS daily_rate,\n    CASE WHEN p.participants = 0 THEN 0 ELSE p.match_cnt / p.participants END AS daily_avg_match\n  FROM daily_play p\n  LEFT JOIN daily_active a\n    ON p.play_date = a.act_date\n   AND p.week_start = a.week_start\n),\nweekly_stats AS (\n  SELECT\n    week_start,\n    gameplay,\n    COUNT(DISTINCT play_date) AS days_in_week,\n    SUM(participants) AS total_participants,\n    SUM(active_cnt) AS total_active,\n    SUM(match_cnt) AS total_matches,\n    AVG(participants) AS avg_daily_participants,\n    AVG(daily_rate) AS avg_daily_rate,\n    AVG(daily_avg_match) AS avg_daily_matches\n  FROM merged\n  GROUP BY week_start, gameplay\n)\nSELECT\n  DATE_FORMAT(week_start, '%Y%m%d') AS week_start_label,\n  gameplay,\n  ROUND(avg_daily_participants, 2) AS avg_daily_participants,\n  ROUND(avg_daily_rate, 4) AS avg_daily_participation_rate,\n  ROUND(avg_daily_matches, 4) AS avg_daily_matches\nFROM weekly_stats\nWHERE week_start BETWEEN DATE '2024-06-22' AND DATE '2025-03-29'\nORDER BY week_start, gameplay\n) AS final_query;", "meta": {"origin": "sql_29", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_58_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计以下时间对应玩法id下的不同对局时长人数分布\n'20230722'-'20230728'  1310822585431254784    \n'20221121'-'20221127' 1282371711108385024    \n'20221128'-'20221204' 1287652322611036928    \n'20230306'-'20230312' 1294211358396518400    \n'20230612''20230618' 1297394991875754752     \n\n对局时长按照 [0-10min)，[10-30min)，[30min-1h)，[1h,2h)，[2h,3h)，[3h,4h)， [4h,5h)，\n[5h,6h)，[6h,7h)，[7h,8h)，[8h,9h)，[9h,10h)，[10h,∞)\t\t\n输出字段：玩法id、对局时长、人数\n【表】dws_jordass_matchlog_stat_di\n【口径】"}, {"role": "assistant", "content": "WITH ranges AS (\n  SELECT '20230722' AS start_dt, '20230728' AS end_dt, '1310822585431254784' AS imode_id UNION ALL\n  SELECT '20221121', '20221127', '1282371711108385024' UNION ALL\n  SELECT '20221128', '20221204', '1287652322611036928' UNION ALL\n  SELECT '20230306', '20230312', '1294211358396518400' UNION ALL\n  SELECT '20230612', '20230618', '1297394991875754752'\n),\nbase AS (\n  SELECT\n    r.imode_id AS gameplay_id,\n    CASE\n      WHEN m.itemp1 < 600 THEN '[0-10min)'\n      WHEN m.itemp1 < 1800 THEN '[10-30min)'\n      WHEN m.itemp1 < 3600 THEN '[30min-1h)'\n      WHEN m.itemp1 < 7200 THEN '[1h,2h)'\n      WHEN m.itemp1 < 10800 THEN '[2h,3h)'\n      WHEN m.itemp1 < 14400 THEN '[3h,4h)'\n      WHEN m.itemp1 < 18000 THEN '[4h,5h)'\n      WHEN m.itemp1 < 21600 THEN '[5h,6h)'\n      WHEN m.itemp1 < 25200 THEN '[6h,7h)'\n      WHEN m.itemp1 < 28800 THEN '[7h,8h)'\n      WHEN m.itemp1 < 32400 THEN '[8h,9h)'\n      WHEN m.itemp1 < 36000 THEN '[9h,10h)'\n      ELSE '[10h,∞)'\n    END AS duration_bucket,\n    m.vplayerid\n  FROM dws_jordass_matchlog_stat_di m\n  JOIN ranges r\n    ON m.imode = r.imode_id\n   AND m.dtstatdate BETWEEN r.start_dt AND r.end_dt\n)\nSELECT\n  gameplay_id AS gameplayid,\n  duration_bucket,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM base\nGROUP BY gameplay_id, duration_bucket\nORDER BY gameplay_id, duration_bucket;"}], "rejected": "WITH ranges AS (\n  SELECT '20230722' AS start_dt, '20230728' AS end_dt, '1310822585431254784' AS imode_id UNION ALL\n  SELECT '20221121', '20221127', '1282371711108385024' UNION ALL\n  SELECT '20221128', '20221204', '1287652322611036928' UNION ALL\n  SELECT '20230306', '20230312', '1294211358396518400' UNION ALL\n  SELECT '20230612', '20230618', '1297394991875754752'\n),\nbase AS (\n  SELECT\n    r.imode_id AS gameplay_id,\n    CASE\n      WHEN m.itemp1 < 600 THEN '[0-10min)'\n      WHEN m.itemp1 < 1800 THEN '[10-30min)'\n      WHEN m.itemp1 < 3600 THEN '[30min-1h)'\n      WHEN m.itemp1 < 7200 THEN '[1h,2h)'\n      WHEN m.itemp1 < 10800 THEN '[2h,3h)'\n      WHEN m.itemp1 < 14400 THEN '[3h,4h)'\n      WHEN m.itemp1 < 18000 THEN '[4h,5h)'\n      WHEN m.itemp1 < 21600 THEN '[5h,6h)'\n      WHEN m.itemp1 < 25200 THEN '[6h,7h)'\n      WHEN m.itemp1 < 28800 THEN '[7h,8h)'\n      WHEN m.itemp1 < 32400 THEN '[8h,9h)'\n      WHEN m.itemp1 < 36000 THEN '[9h,10h)'\n      ELSE '[10h,∞)'\n    END AS duration_bucket,\n    m.vplayerid\n  FROM dws_jordass_matchlog_stat_di m\n  JOIN ranges r\n    ON m.imode = r.imode_id\n   AND m.dtstatdate BETWEEN r.start_dt AND r.end_dt\n)\nSELECT\n  gameplay_id AS gameplayid,\n  duration_bucket,\n  COUNT(DISTINCT vplayerid) AS user_cnt\nFROM base\nGROUP BY gameplay_id, duration_bucket\nORDER BY gameplay_id, duration_bucket;", "meta": {"origin": "sql_58", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_78_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：首日红装活动（20250120）返场抽奖的用户属性\n输出：初日华服回归抽奖&沙漠统治者有抽奖人数\n初日华服回归抽奖&境界双花有抽奖人数\t\t\n初日华服回归抽奖&玄龙凌霄有抽奖人数\t\t\n初日华服回归抽奖&沙漠统治者有抽奖&但没有其主套人数\t\t\n初日华服回归抽奖&境界双花有抽奖&但没有其主套人数\t\t\n初日华服回归抽奖&玄龙凌霄有抽奖&但没有其主套人数\t\t\n初日华服回归抽奖&【沙漠统治者和境界双花有主套】人数\t\t\n初日华服回归抽奖&【沙漠统治者和玄龙凌霄有主套】人数\t\t\t\t\n初日华服回归抽奖&【境界双花和玄龙凌霄有主套】人数\t\t\t\t\n初日华服回归抽奖但【沙漠统治者&境界双花&玄龙凌霄】没有抽奖人数\n【表】dwd_jordass_gearlog_hi, dwd_jordass_lotteryrecord_hi\n【口径】抽奖活动时间：\n沙漠统治者：20240427-20240607 \n镜域双华：20240608-20240726 \n玄龙凌霄：20240727-20240823\n抽奖活动筛选条件：\n初日华服回归抽奖 activitytype = 815\n沙漠统治者有抽奖 activitytype = 690\n境界双花有抽奖 activitytype = 748\n玄龙凌霄有抽奖 activitytype = 750\n主套提取逻辑：\n提取道具沙漠统治者-有主套的用户 igoodsid = 430179 and addorreduce = 0\n提取道具镜域双华-有主套的用户 igoodsid = 430265  and addorreduce = 0\n提取道具玄龙凌霄-有主套用户 igoodsid = 430225  and addorreduce = 0"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH base_users AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) = '2025-01-20'\n    AND activitytype = 815\n), sand_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 690\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-04-27' AND '2024-06-07'\n), floral_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 748\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-06-08' AND '2024-07-26'\n), dragon_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 750\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-07-27' AND '2024-08-23'\n), sand_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430179\n    AND addorreduce = 0\n), floral_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430265\n    AND addorreduce = 0\n), dragon_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430225\n    AND addorreduce = 0\n), enriched AS (\n  SELECT\n    b.vplayerid,\n    CASE WHEN s.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_lottery,\n    CASE WHEN f.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_lottery,\n    CASE WHEN d.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_lottery,\n    CASE WHEN ss.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_suit,\n    CASE WHEN fs.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_suit,\n    CASE WHEN ds.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_suit\n  FROM base_users b\n  LEFT JOIN sand_lottery s ON b.vplayerid = s.vplayerid\n  LEFT JOIN floral_lottery f ON b.vplayerid = f.vplayerid\n  LEFT JOIN dragon_lottery d ON b.vplayerid = d.vplayerid\n  LEFT JOIN sand_suit ss ON b.vplayerid = ss.vplayerid\n  LEFT JOIN floral_suit fs ON b.vplayerid = fs.vplayerid\n  LEFT JOIN dragon_suit ds ON b.vplayerid = ds.vplayerid\n)\nSELECT\n  SUM(CASE WHEN has_sand_lottery = 1 THEN 1 ELSE 0 END) AS base_sand_lottery_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 THEN 1 ELSE 0 END) AS base_floral_lottery_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 THEN 1 ELSE 0 END) AS base_dragon_lottery_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_sand_suit = 0 THEN 1 ELSE 0 END) AS base_sand_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_floral_suit = 0 THEN 1 ELSE 0 END) AS base_floral_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 AND has_dragon_suit = 0 THEN 1 ELSE 0 END) AS base_dragon_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_floral_lottery = 1 AND has_sand_suit = 1 AND has_floral_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_floral_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_dragon_lottery = 1 AND has_sand_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_dragon_lottery = 1 AND has_floral_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_floral_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 0 AND has_floral_lottery = 0 AND has_dragon_lottery = 0 THEN 1 ELSE 0 END) AS base_without_three_lottery_cnt\nFROM enriched\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH base_users AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) = '2025-01-20'\n    AND activitytype = 815\n), sand_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 690\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-04-27' AND '2024-06-07'\n), floral_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 748\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-06-08' AND '2024-07-26'\n), dragon_lottery AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_lotteryrecord_hi\n  WHERE activitytype = 750\n    AND DATE(CAST(dteventtime AS DATE)) BETWEEN '2024-07-27' AND '2024-08-23'\n), sand_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430179\n    AND addorreduce = 0\n), floral_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430265\n    AND addorreduce = 0\n), dragon_suit AS (\n  SELECT DISTINCT vplayerid\n  FROM dwd_jordass_gearlog_hi\n  WHERE igoodsid = 430225\n    AND addorreduce = 0\n), enriched AS (\n  SELECT\n    b.vplayerid,\n    CASE WHEN s.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_lottery,\n    CASE WHEN f.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_lottery,\n    CASE WHEN d.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_lottery,\n    CASE WHEN ss.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_sand_suit,\n    CASE WHEN fs.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_floral_suit,\n    CASE WHEN ds.vplayerid IS NOT NULL THEN 1 ELSE 0 END AS has_dragon_suit\n  FROM base_users b\n  LEFT JOIN sand_lottery s ON b.vplayerid = s.vplayerid\n  LEFT JOIN floral_lottery f ON b.vplayerid = f.vplayerid\n  LEFT JOIN dragon_lottery d ON b.vplayerid = d.vplayerid\n  LEFT JOIN sand_suit ss ON b.vplayerid = ss.vplayerid\n  LEFT JOIN floral_suit fs ON b.vplayerid = fs.vplayerid\n  LEFT JOIN dragon_suit ds ON b.vplayerid = ds.vplayerid\n)\nSELECT\n  SUM(CASE WHEN has_sand_lottery = 1 THEN 1 ELSE 0 END) AS base_sand_lottery_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 THEN 1 ELSE 0 END) AS base_floral_lottery_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 THEN 1 ELSE 0 END) AS base_dragon_lottery_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_sand_suit = 0 THEN 1 ELSE 0 END) AS base_sand_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_floral_suit = 0 THEN 1 ELSE 0 END) AS base_floral_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_dragon_lottery = 1 AND has_dragon_suit = 0 THEN 1 ELSE 0 END) AS base_dragon_lottery_no_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_floral_lottery = 1 AND has_sand_suit = 1 AND has_floral_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_floral_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 1 AND has_dragon_lottery = 1 AND has_sand_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_sand_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_floral_lottery = 1 AND has_dragon_lottery = 1 AND has_floral_suit = 1 AND has_dragon_suit = 1 THEN 1 ELSE 0 END) AS base_with_floral_and_dragon_suit_cnt,\n  SUM(CASE WHEN has_sand_lottery = 0 AND has_floral_lottery = 0 AND has_dragon_lottery = 0 THEN 1 ELSE 0 END) AS base_without_three_lottery_cnt\nFROM enriched\n) AS final_query;", "meta": {"origin": "sql_78", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_112_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2022.04.23-2022.04.30和2022.05.01-2022.05.08传统模式存活时长达到90分钟的玩家人数，每日人数\n输出：统计日期(yyyymmdd)，人数\n【表】dwd_jordass_roundflow_hi\n【口径】传统模式mode in(101,102,103,401,402,403)"}, {"role": "assistant", "content": "with base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    vplayerid,\n    sum(coalesce(survivaltime, 0)) as total_survival\n  from dwd_jordass_roundflow_hi\n  where ((substr(tdbank_imp_date, 1, 8) between '20220425' and '20220502')\n     or (substr(tdbank_imp_date, 1, 8) between '20220503' and '20220510'))\n    and mode in (101, 102, 103, 401, 402, 403)\n  group by substr(tdbank_imp_date, 1, 8), vplayerid\n)\nselect\n  stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom base\nwhere total_survival >= 5400\ngroup by stat_date\norder by stat_date;"}], "rejected": "with base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    vplayerid,\n    sum(coalesce(survivaltime, 0)) as total_survival\n  from dwd_jordass_roundflow_hi\n  where ((substr(tdbank_imp_date, 1, 8) > '20220425')\n     or (substr(tdbank_imp_date, 1, 8) between '20220503' and '20220510'))\n    and mode in (101, 102, 103, 401, 402, 403)\n  group by substr(tdbank_imp_date, 1, 8), vplayerid\n)\nselect\n  stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom base\nwhere total_survival >= 5400\ngroup by stat_date\norder by stat_date;", "meta": {"origin": "sql_112", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_109_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计 20250426-20250510 期间 传统和休闲的胜利情况\n\n 胜利数分布层次：1,2-10,11-20,21-50,51-80,81-100，101-200,201-500,501以上\n 输出：胜利数分布层次，人数\n【表】dwd_jordass_roundlog_funnymode_hi, dwd_jordass_roundflow_hi\n【口径】传统模式： mode in(101,102,103,401,402,403)\n 休闲：mode in(201,202,203,601,602,603) \n 胜利：teamrank =1"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH combined AS (\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-26' AND '2025-05-10'\n  UNION ALL\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundlog_funnymode_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-26' AND '2025-05-10'\n), total_wins AS (\n  SELECT\n    vplayerid,\n    SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n    SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) AS win_cnt\n  FROM combined\n  GROUP BY vplayerid\n  HAVING SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n         SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) > 0\n), bucketed AS (\n  SELECT\n    CASE\n      WHEN win_cnt = 1 THEN '1'\n      WHEN win_cnt BETWEEN 2 AND 10 THEN '2-10'\n      WHEN win_cnt BETWEEN 11 AND 20 THEN '11-20'\n      WHEN win_cnt BETWEEN 21 AND 50 THEN '21-50'\n      WHEN win_cnt BETWEEN 51 AND 80 THEN '51-80'\n      WHEN win_cnt BETWEEN 81 AND 100 THEN '81-100'\n      WHEN win_cnt BETWEEN 101 AND 200 THEN '101-200'\n      WHEN win_cnt BETWEEN 201 AND 500 THEN '201-500'\n      ELSE '501+'\n    END AS win_bucket\n  FROM total_wins\n)\nSELECT\n  win_bucket,\n  COUNT(*) AS user_cnt\nFROM bucketed\nGROUP BY win_bucket\nORDER BY CASE win_bucket\n  WHEN '1' THEN 1\n  WHEN '2-10' THEN 2\n  WHEN '11-20' THEN 3\n  WHEN '21-50' THEN 4\n  WHEN '51-80' THEN 5\n  WHEN '81-100' THEN 6\n  WHEN '101-200' THEN 7\n  WHEN '201-500' THEN 8\n  ELSE 9\nEND\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH combined AS (\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundflow_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-26' AND '2025-05-10'\n  UNION ALL\n  SELECT vplayerid, mode, teamrank\n  FROM dwd_jordass_roundlog_funnymode_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN '2025-04-26' AND '2025-05-10'\n), total_wins AS (\n  SELECT\n    vplayerid,\n    SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n    SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) AS win_cnt\n  FROM combined\n  GROUP BY vplayerid\n  HAVING SUM(CASE WHEN mode IN (101,102,103,401,402,403) AND teamrank = 1 THEN 1 ELSE 0 END) +\n         SUM(CASE WHEN mode IN (201,202,203,601,602,603) AND teamrank = 1 THEN 1 ELSE 0 END) > 0\n), bucketed AS (\n  SELECT\n    CASE\n      WHEN win_cnt = 1 THEN '1'\n      WHEN win_cnt BETWEEN 2 AND 10 THEN '2-10'\n      WHEN win_cnt BETWEEN 11 AND 20 THEN '11-20'\n      WHEN win_cnt BETWEEN 21 AND 50 THEN '21-50'\n      WHEN win_cnt BETWEEN 51 AND 80 THEN '51-80'\n      WHEN win_cnt BETWEEN 81 AND 100 THEN '81-100'\n      WHEN win_cnt BETWEEN 101 AND 200 THEN '101-200'\n      WHEN win_cnt BETWEEN 201 AND 500 THEN '201-500'\n      ELSE '501+'\n    END AS win_bucket\n  FROM total_wins\n)\nSELECT\n  win_bucket,\n  COUNT(*) AS user_cnt\nFROM bucketed\nGROUP BY win_bucket\nORDER BY CASE win_bucket\n  WHEN '1' THEN 1\n  WHEN '2-10' THEN 2\n  WHEN '11-20' THEN 3\n  WHEN '21-50' THEN 4\n  WHEN '51-80' THEN 5\n  WHEN '81-100' THEN 6\n  WHEN '101-200' THEN 7\n  WHEN '201-500' THEN 8\n  ELSE 9\nEND\n) AS final_query;", "meta": {"origin": "sql_109", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_62_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250226联盟前180日（包含当天）基础数据 说明：按照uid计算\n输出：统计日期（YYYYMMDD），角色DAU，联盟参与角色数，联盟完成特训任务角色数，联盟商店兑换次数\n【表】dwd_jordass_allianceshopbuy_hi, dwd_jordass_player_allianceactive_hi, dwd_jordass_alliancebootcamprecord_hi, dwd_jordass_playerlogout_hi, dwd_jordass_playerlogin_hi\n【口径】可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH login_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n),\nalliance_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n),\nbootcamp_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n),\nshop_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n),\nall_dates AS (\n  SELECT stat_date FROM login_dates\n  UNION\n  SELECT stat_date FROM alliance_dates\n  UNION\n  SELECT stat_date FROM bootcamp_dates\n  UNION\n  SELECT stat_date FROM shop_dates\n),\nrole_dau AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS dau_cnt\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n  GROUP BY stat_date\n),\nalliance_participate AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS participate_cnt\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n  GROUP BY stat_date\n),\nbootcamp_finish AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT memberuid) AS bootcamp_cnt\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n  GROUP BY stat_date\n),\nshop_exchange AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(*) AS exchange_cnt\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n  GROUP BY stat_date\n)\nSELECT\n  DATE_FORMAT(d.stat_date, '%Y%m%d') AS stat_date,\n  COALESCE(rd.dau_cnt, 0) AS role_dau,\n  COALESCE(ap.participate_cnt, 0) AS alliance_participate_cnt,\n  COALESCE(bf.bootcamp_cnt, 0) AS bootcamp_finish_role_cnt,\n  COALESCE(se.exchange_cnt, 0) AS alliance_shop_exchange_cnt\nFROM all_dates d\nLEFT JOIN role_dau rd ON d.stat_date = rd.stat_date\nLEFT JOIN alliance_participate ap ON d.stat_date = ap.stat_date\nLEFT JOIN bootcamp_finish bf ON d.stat_date = bf.stat_date\nLEFT JOIN shop_exchange se ON d.stat_date = se.stat_date\nORDER BY d.stat_date;"}], "rejected": "WITH login_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n),\nalliance_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n),\nbootcamp_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n),\nshop_dates AS (\n  SELECT DISTINCT DATE(CAST(dteventtime AS DATE)) AS stat_date\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n),\nall_dates AS (\n  SELECT stat_date FROM login_dates\n  UNION\n  SELECT stat_date FROM alliance_dates\n  UNION\n  SELECT stat_date FROM bootcamp_dates\n  UNION\n  SELECT stat_date FROM shop_dates\n),\nrole_dau AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS dau_cnt\n  FROM dwd_jordass_playerlogin_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n  GROUP BY stat_date\n),\nalliance_participate AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT uid) AS participate_cnt\n  FROM dwd_jordass_player_allianceactive_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n  GROUP BY stat_date\n),\nbootcamp_finish AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(DISTINCT memberuid) AS bootcamp_cnt\n  FROM dwd_jordass_alliancebootcamprecord_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n  GROUP BY stat_date\n),\nshop_exchange AS (\n  SELECT\n    DATE(CAST(dteventtime AS DATE)) AS stat_date,\n    COUNT(*) AS exchange_cnt\n  FROM dwd_jordass_allianceshopbuy_hi\n  WHERE DATE(CAST(dteventtime AS DATE)) BETWEEN DATE_SUB('2025-03-28', INTERVAL 179 DAY) AND '2025-03-28'\n  GROUP BY stat_date\n)\nSELECT\n  DATE_FORMAT(d.stat_date, '%Y%m%d') AS stat_date,\n  COALESCE(rd.dau_cnt, 0) AS role_dau,\n  COALESCE(ap.participate_cnt, 0) AS alliance_participate_cnt,\n  COALESCE(bf.bootcamp_cnt, 0) AS bootcamp_finish_role_cnt,\n  COALESCE(se.exchange_cnt, 0) AS alliance_shop_exchange_cnt\nFROM all_dates d\nLEFT JOIN role_dau rd ON d.stat_date = rd.stat_date\nLEFT JOIN alliance_participate ap ON d.stat_date = ap.stat_date\nLEFT JOIN bootcamp_finish bf ON d.stat_date = bf.stat_date\nLEFT JOIN shop_exchange se ON d.stat_date = se.stat_date\nORDER BY d.stat_date;", "meta": {"origin": "sql_62", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_16_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：近一年（2023/7/12-2025/5/31）按段位统计所有竞技模式对局中，排除掉投降的对局情况。\n输出：日期（20230715-20250603）、段位（黑铁、...、无段位、全量段位）当日竞技模式非投降局对局数、当日竞技模式投降局对局数、当日竞技模式非投降局中 双方胜利回合差>=6和双方胜利回合差>=8的对局数\n【表】dwd_argothek_playermatchstats_hi\n【口径】段位筛选逻辑：\ncase\nwhen competitiveTier in (3, 4, 5) then \"黑铁\"\nwhen competitiveTier in (6, 7, 8) then \"黄铜\"\nwhen competitiveTier in (9, 10, 11) then \"白银\"\nwhen competitiveTier in (12, 13, 14) then \"黄金\"\nwhen competitiveTier in (15, 16, 17) then \"白金\"\nwhen competitiveTier in (18, 19, 20) then \"钻石\"\nwhen competitiveTier in (21, 22, 23) then \"超凡\"\nwhen competitiveTier >= 24 then \"神话及以上\"\nelse \"无段位\"\n竞技模式：模式id等于\"competitive\"\n对局筛选逻辑:\n使用completion_state筛选投降与非投降对局；使用roundsdiff筛选双方胜利回合差"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH base AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    matchid,\n    MAX(CASE WHEN LOWER(completionstate) = 'surrendered' THEN 1 ELSE 0 END) AS is_surrender,\n    MAX(roundswon) AS max_rounds_won,\n    MIN(roundswon) AS min_rounds_won,\n    MAX(competitivetier) AS max_tier\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE queueid = 'competitive'\n    AND DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') BETWEEN '20230715' AND '20250603'\n  GROUP BY DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d'), matchid\n), enriched AS (\n  SELECT\n    statis_date,\n    matchid,\n    CASE\n      WHEN max_tier IN (3, 4, 5) THEN '黑铁'\n      WHEN max_tier IN (6, 7, 8) THEN '黄铜'\n      WHEN max_tier IN (9, 10, 11) THEN '白银'\n      WHEN max_tier IN (12, 13, 14) THEN '黄金'\n      WHEN max_tier IN (15, 16, 17) THEN '白金'\n      WHEN max_tier IN (18, 19, 20) THEN '钻石'\n      WHEN max_tier IN (21, 22, 23) THEN '超凡'\n      WHEN max_tier >= 24 THEN '神话及以上'\n      ELSE '无段位'\n    END AS rank_bucket,\n    is_surrender,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 6 THEN 1 ELSE 0 END AS diff_ge_6,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 8 THEN 1 ELSE 0 END AS diff_ge_8\n  FROM base\n), daily_rank AS (\n  SELECT\n    statis_date,\n    rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date, rank_bucket\n), daily_all AS (\n  SELECT\n    statis_date,\n    '全量段位' AS rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date\n)\nSELECT\n  statis_date AS statis_date,\n  rank_bucket AS rank_name,\n  non_surrender_match_cnt AS non_surrender_match_cnt,\n  surrender_match_cnt AS surrender_match_cnt,\n  diff_ge6_match_cnt AS diff_ge6_match_cnt,\n  diff_ge8_match_cnt AS diff_ge8_match_cnt\nFROM daily_rank\nUNION ALL\nSELECT\n  statis_date,\n  rank_bucket,\n  non_surrender_match_cnt,\n  surrender_match_cnt,\n  diff_ge6_match_cnt,\n  diff_ge8_match_cnt\nFROM daily_all\nORDER BY statis_date, rank_name\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH base AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    matchid,\n    MAX(CASE WHEN LOWER(completionstate) = 'surrendered' THEN 1 ELSE 0 END) AS is_surrender,\n    MAX(roundswon) AS max_rounds_won,\n    MIN(roundswon) AS min_rounds_won,\n    MAX(competitivetier) AS max_tier\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE queueid = 'competitive'\n    AND DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') > '20230715'\n  GROUP BY DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d'), matchid\n), enriched AS (\n  SELECT\n    statis_date,\n    matchid,\n    CASE\n      WHEN max_tier IN (3, 4, 5) THEN '黑铁'\n      WHEN max_tier IN (6, 7, 8) THEN '黄铜'\n      WHEN max_tier IN (9, 10, 11) THEN '白银'\n      WHEN max_tier IN (12, 13, 14) THEN '黄金'\n      WHEN max_tier IN (15, 16, 17) THEN '白金'\n      WHEN max_tier IN (18, 19, 20) THEN '钻石'\n      WHEN max_tier IN (21, 22, 23) THEN '超凡'\n      WHEN max_tier >= 24 THEN '神话及以上'\n      ELSE '无段位'\n    END AS rank_bucket,\n    is_surrender,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 6 THEN 1 ELSE 0 END AS diff_ge_6,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 8 THEN 1 ELSE 0 END AS diff_ge_8\n  FROM base\n), daily_rank AS (\n  SELECT\n    statis_date,\n    rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date, rank_bucket\n), daily_all AS (\n  SELECT\n    statis_date,\n    '全量段位' AS rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date\n)\nSELECT\n  statis_date AS statis_date,\n  rank_bucket AS rank_name,\n  non_surrender_match_cnt AS non_surrender_match_cnt,\n  surrender_match_cnt AS surrender_match_cnt,\n  diff_ge6_match_cnt AS diff_ge6_match_cnt,\n  diff_ge8_match_cnt AS diff_ge8_match_cnt\nFROM daily_rank\nUNION ALL\nSELECT\n  statis_date,\n  rank_bucket,\n  non_surrender_match_cnt,\n  surrender_match_cnt,\n  diff_ge6_match_cnt,\n  diff_ge8_match_cnt\nFROM daily_all\nORDER BY statis_date, rank_name\n) AS final_query;", "meta": {"origin": "sql_16", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_16_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：近一年（2023/7/12-2025/5/31）按段位统计所有竞技模式对局中，排除掉投降的对局情况。\n输出：日期（20230728-20250616）、段位（黑铁、...、无段位、全量段位）当日竞技模式非投降局对局数、当日竞技模式投降局对局数、当日竞技模式非投降局中 双方胜利回合差>=6和双方胜利回合差>=8的对局数\n【表】dwd_argothek_playermatchstats_hi\n【口径】段位筛选逻辑：\ncase\nwhen competitiveTier in (3, 4, 5) then \"黑铁\"\nwhen competitiveTier in (6, 7, 8) then \"黄铜\"\nwhen competitiveTier in (9, 10, 11) then \"白银\"\nwhen competitiveTier in (12, 13, 14) then \"黄金\"\nwhen competitiveTier in (15, 16, 17) then \"白金\"\nwhen competitiveTier in (18, 19, 20) then \"钻石\"\nwhen competitiveTier in (21, 22, 23) then \"超凡\"\nwhen competitiveTier >= 24 then \"神话及以上\"\nelse \"无段位\"\n竞技模式：模式id等于\"competitive\"\n对局筛选逻辑:\n使用completion_state筛选投降与非投降对局；使用roundsdiff筛选双方胜利回合差\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH base AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    matchid,\n    MAX(CASE WHEN LOWER(completionstate) = 'surrendered' THEN 1 ELSE 0 END) AS is_surrender,\n    MAX(roundswon) AS max_rounds_won,\n    MIN(roundswon) AS min_rounds_won,\n    MAX(competitivetier) AS max_tier\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE queueid = 'competitive'\n    AND DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') BETWEEN '20230728' AND '20250616'\n  GROUP BY DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d'), matchid\n), enriched AS (\n  SELECT\n    statis_date,\n    matchid,\n    CASE\n      WHEN max_tier IN (3, 4, 5) THEN '黑铁'\n      WHEN max_tier IN (6, 7, 8) THEN '黄铜'\n      WHEN max_tier IN (9, 10, 11) THEN '白银'\n      WHEN max_tier IN (12, 13, 14) THEN '黄金'\n      WHEN max_tier IN (15, 16, 17) THEN '白金'\n      WHEN max_tier IN (18, 19, 20) THEN '钻石'\n      WHEN max_tier IN (21, 22, 23) THEN '超凡'\n      WHEN max_tier >= 24 THEN '神话及以上'\n      ELSE '无段位'\n    END AS rank_bucket,\n    is_surrender,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 6 THEN 1 ELSE 0 END AS diff_ge_6,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 8 THEN 1 ELSE 0 END AS diff_ge_8\n  FROM base\n), daily_rank AS (\n  SELECT\n    statis_date,\n    rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date, rank_bucket\n), daily_all AS (\n  SELECT\n    statis_date,\n    '全量段位' AS rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date\n)\nSELECT\n  statis_date AS statis_date,\n  rank_bucket AS rank_name,\n  non_surrender_match_cnt AS non_surrender_match_cnt,\n  surrender_match_cnt AS surrender_match_cnt,\n  diff_ge6_match_cnt AS diff_ge6_match_cnt,\n  diff_ge8_match_cnt AS diff_ge8_match_cnt\nFROM daily_rank\nUNION ALL\nSELECT\n  statis_date,\n  rank_bucket,\n  non_surrender_match_cnt,\n  surrender_match_cnt,\n  diff_ge6_match_cnt,\n  diff_ge8_match_cnt\nFROM daily_all\nORDER BY statis_date, rank_name;"}], "rejected": "WITH base AS (\n  SELECT\n    DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') AS statis_date,\n    matchid,\n    MAX(CASE WHEN LOWER(completionstate) = 'surrendered' THEN 1 ELSE 0 END) AS is_surrender,\n    MAX(roundswon) AS max_rounds_won,\n    MIN(roundswon) AS min_rounds_won,\n    MAX(competitivetier) AS max_tier\n  FROM dwd_argothek_playermatchstats_hi\n  WHERE queueid = 'competitive'\n    AND DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d') > '20230728'\n  GROUP BY DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y%m%d'), matchid\n), enriched AS (\n  SELECT\n    statis_date,\n    matchid,\n    CASE\n      WHEN max_tier IN (3, 4, 5) THEN '黑铁'\n      WHEN max_tier IN (6, 7, 8) THEN '黄铜'\n      WHEN max_tier IN (9, 10, 11) THEN '白银'\n      WHEN max_tier IN (12, 13, 14) THEN '黄金'\n      WHEN max_tier IN (15, 16, 17) THEN '白金'\n      WHEN max_tier IN (18, 19, 20) THEN '钻石'\n      WHEN max_tier IN (21, 22, 23) THEN '超凡'\n      WHEN max_tier >= 24 THEN '神话及以上'\n      ELSE '无段位'\n    END AS rank_bucket,\n    is_surrender,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 6 THEN 1 ELSE 0 END AS diff_ge_6,\n    CASE WHEN ABS(max_rounds_won - min_rounds_won) >= 8 THEN 1 ELSE 0 END AS diff_ge_8\n  FROM base\n), daily_rank AS (\n  SELECT\n    statis_date,\n    rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date, rank_bucket\n), daily_all AS (\n  SELECT\n    statis_date,\n    '全量段位' AS rank_bucket,\n    SUM(CASE WHEN is_surrender = 0 THEN 1 ELSE 0 END) AS non_surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 1 THEN 1 ELSE 0 END) AS surrender_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_6 = 1 THEN 1 ELSE 0 END) AS diff_ge6_match_cnt,\n    SUM(CASE WHEN is_surrender = 0 AND diff_ge_8 = 1 THEN 1 ELSE 0 END) AS diff_ge8_match_cnt\n  FROM enriched\n  GROUP BY statis_date\n)\nSELECT\n  statis_date AS statis_date,\n  rank_bucket AS rank_name,\n  non_surrender_match_cnt AS non_surrender_match_cnt,\n  surrender_match_cnt AS surrender_match_cnt,\n  diff_ge6_match_cnt AS diff_ge6_match_cnt,\n  diff_ge8_match_cnt AS diff_ge8_match_cnt\nFROM daily_rank\nUNION ALL\nSELECT\n  statis_date,\n  rank_bucket,\n  non_surrender_match_cnt,\n  surrender_match_cnt,\n  diff_ge6_match_cnt,\n  diff_ge8_match_cnt\nFROM daily_all\nORDER BY statis_date, rank_name;", "meta": {"origin": "sql_16", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_34_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.9.17-2024.9.23 和 2024.10.8-2024.10.20    每天点击按钮后加入玩法，再之后点击确认的人数，以及这些人加入玩法的次数                                                       \n输出：日期(20240923、...、20240929、20241014、...、20241020)，人数，人次\n【表】dws_jordass_buttonpress_pre_di\n【口径】buttontype为411111代表点击按钮，411120代表加入玩法，411123代表确认"}, {"role": "assistant", "content": "select\n    ds,\n    count(distinct vplayerid) as user_cnt,\n    count(distinct vplayerid, irank) as user_times\nfrom (\n    select\n        s2.ds,\n        s2.vplayerid,\n        s2.irank\n    from (\n        -- 获取411111事件（点击按钮）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411111\n        and  ((dtstatdate between '20240923' and '20240929') or (dtstatdate between '20241014' and '20241020'))\n    ) s1\n    join (\n        -- 获取411120事件（加入玩法）并编号\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime,\n            row_number() over (partition by vplayerid order by dteventtime) as irank\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411120\n        and ((dtstatdate between '20240923' and '20240929') or (dtstatdate between '20241014' and '20241020'))\n    ) s2 on s1.vplayerid = s2.vplayerid and s1.ds = s2.ds and s2.dteventtime > s1.dteventtime\n    join (\n        -- 获取411123事件（确认动作）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411123\n        and ((dtstatdate between '20240923' and '20240929') or (dtstatdate between '20241014' and '20241020'))\n    ) s3 on s2.vplayerid = s3.vplayerid and s2.ds = s3.ds and s3.dteventtime > s2.dteventtime\n)f \ngroup by ds\n;"}], "rejected": "select\n    ds,\n    count(distinct vplayerid) as user_cnt,\n    count(distinct vplayerid, irank) as user_times\nfrom (\n    select\n        s2.ds,\n        s2.vplayerid,\n        s2.irank\n    from (\n        -- 获取411111事件（点击按钮）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411111\n        and  ((dtstatdate > '20240923') or (dtstatdate between '20241014' and '20241020'))\n    ) s1\n    join (\n        -- 获取411120事件（加入玩法）并编号\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime,\n            row_number() over (partition by vplayerid order by dteventtime) as irank\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411120\n        and ((dtstatdate between '20240923' and '20240929') or (dtstatdate between '20241014' and '20241020'))\n    ) s2 on s1.vplayerid = s2.vplayerid and s1.ds = s2.ds and s2.dteventtime > s1.dteventtime\n    join (\n        -- 获取411123事件（确认动作）\n        select\n            dtstatdate as ds,\n            vplayerid,\n            dteventtime\n        from dws_jordass_buttonpress_pre_di\n        where buttontype = 411123\n        and ((dtstatdate between '20240923' and '20240929') or (dtstatdate between '20241014' and '20241020'))\n    ) s3 on s2.vplayerid = s3.vplayerid and s2.ds = s3.ds and s3.dteventtime > s2.dteventtime\n)f \ngroup by ds\n;", "meta": {"origin": "sql_34", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_18_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250506-20250512期间每日的指定网吧渠道内每个渠道活跃人数\n输出：日期（20250510、...、20250516）、渠道、玩家数\n其中：网吧渠道：iloginway in (1,10,11,12,35,20,28,29,30,31,32,33,34,36)\n【表】dws_argothek_oss_login_di\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nselect\n  statis_date,\n  iloginway,\n  count(distinct iuserid) as player_cnt\nfrom dws_argothek_oss_login_di\nwhere statis_date between 20250510 and 20250516\n  and iloginway in (1,10,11,12,20,28,29,30,31,32,33,34,35,36)\ngroup by statis_date, iloginway\norder by statis_date, iloginway\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nselect\n  statis_date,\n  iloginway,\n  count(distinct iuserid) as player_cnt\nfrom dws_argothek_oss_login_di\nwhere statis_date between 20250510 and 20250516\n  and iloginway in (1,10,11,12,20,28,29,30,31,32,33,34,35,36)\ngroup by statis_date, iloginway\norder by statis_date, iloginway\n) AS final_query;", "meta": {"origin": "sql_18", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_107_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2022.1.18-1.24与2021.10.19-12.20这两个时间段\n buttontype =99123并且 ireason=3的人数，以及两个时间段都满足条件的交叉人数\n输出：2022.1.18-1.24人数，2021.10.25-12.20人数，两个时间段交叉的人数\n【表】dwd_jordass_activitypress_hi\n【口径】"}, {"role": "assistant", "content": "with period_a as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2022011800' and '2022012423'\n    and buttontype = 99123\n    and ireason = 3\n),\nperiod_b as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2021101900' and '2021122023'\n    and buttontype = 99123\n    and ireason = 3\n)\nselect\n  (select count(*) from period_a) as cnt_period_a,\n  (select count(*) from period_b) as cnt_period_b,\n  (select count(*) from period_a a join period_b b on a.uid = b.uid) as cnt_overlap;"}], "rejected": "with period_a as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2022011800' and '2022012423'\n    and buttontype = 99123\n    and ireason = 3\n),\nperiod_b as (\n  select distinct uid\n  from dwd_jordass_activitypress_hi\n  where tdbank_imp_date between '2021101900' and '2021122023'\n    and buttontype = 99123\n    and ireason = 3\n)\nselect\n  (select count(*) from period_a) as cnt_period_a,\n  (select count(*) from period_b) as cnt_period_b,\n  (select count(*) from period_a a join period_b b on a.uid = b.uid) as cnt_overlap;", "meta": {"origin": "sql_107", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_7_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.07.03-2025.07.10 开白渠道（排除内部体验、买量测试，排除全平台）指定注册渠道的新进用户数。\n输出：日期（20250707...20250710）、注册渠道、新进用户数\n【表】dws_argothek_ce1_cbt2_vplayerid_suserid_di, dwd_argothek_cbt2kaibai_hi\n【口径】渠道范围：iregway in (\"89903934\",\"89903933\",\"89903932\",\"89902725\",\"89902724\",\"89902723\",\"89900960\",\"89900961\",\"89900962\")\n排除 sourcename in ('内部体验','买量测试')\n排除全平台：platid <> 255\n所有日期统一使用字符串 YYYYMMDD"}, {"role": "assistant", "content": "WITH open_channel AS (\n  SELECT DISTINCT gplayerid\n  FROM dwd_argothek_cbt2kaibai_hi\n  WHERE dteventtime >= '2025-07-07 00:00:00'\n    AND dteventtime <= '2025-07-10 23:59:59'\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n),\nfiltered AS (\n  SELECT\n    dtstatdate,\n    vplayerid,\n    iregway\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate BETWEEN '20250707' AND '20250710'\n    AND iregway IN ('89903934','89903933','89903932','89902725','89902724','89902723','89900960','89900961','89900962')\n    AND is_reg = '1'\n    AND platid <> 255\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n)\nSELECT\n  f.dtstatdate AS stat_date,\n  f.iregway,\n  COUNT(DISTINCT f.vplayerid) AS new_user_cnt\nFROM filtered f\nJOIN open_channel o\n  ON f.vplayerid = o.gplayerid\nGROUP BY f.dtstatdate, f.iregway\nORDER BY f.dtstatdate, f.iregway;"}], "rejected": "WITH open_channel AS (\n  SELECT DISTINCT gplayerid\n  FROM dwd_argothek_cbt2kaibai_hi\n  WHERE dteventtime >= '2025-07-07 00:00:00'\n    AND dteventtime <= '2025-07-10 23:59:59'\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n),\nfiltered AS (\n  SELECT\n    dtstatdate,\n    vplayerid,\n    iregway\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate > '20250707'\n    AND iregway IN ('89903934','89903933','89903932','89902725','89902724','89902723','89900960','89900961','89900962')\n    AND is_reg = '1'\n    AND platid <> 255\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n)\nSELECT\n  f.dtstatdate AS stat_date,\n  f.iregway,\n  COUNT(DISTINCT f.vplayerid) AS new_user_cnt\nFROM filtered f\nJOIN open_channel o\n  ON f.vplayerid = o.gplayerid\nGROUP BY f.dtstatdate, f.iregway\nORDER BY f.dtstatdate, f.iregway;", "meta": {"origin": "sql_7", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_64_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：2024.10.28-2024.11.25、2024.11.28-2024.12.25、2024.10.28-10.27、2024.11.03-11.03、2024.11.10-11.10、2024.11.17-11.17、2024.11.24-11.19、2024.11.28-11.24、2024.12.01-12.01、2024.12.08-12.08、2024.12.15-12.15、2024.12.22-12.19几个时间段的最近上新的曝光用户数（UV）、曝光次数（PV）\n输出：统计日期（例:20241029）、UV、PV\n【表】dws_jordass_buttonpress_pre_di\n【口径】buttontype=\"410012\"表示曝光，一条记录代表一次"}, {"role": "assistant", "content": "select\n  dtstatdate,\n  count(distinct vplayerid) as uv,\n  count(*) as pv\nfrom dws_jordass_buttonpress_pre_di\nwhere buttontype = '410012'\n  and (\n        dtstatdate between '20241028' and '20241125'\n     or dtstatdate between '20241128' and '20241225'\n     or dtstatdate between '20241028' and '20241102'\n     or dtstatdate between '20241103' and '20241109'\n     or dtstatdate between '20241110' and '20241116'\n     or dtstatdate between '20241117' and '20241123'\n     or dtstatdate between '20241124' and '20241125'\n     or dtstatdate between '20241128' and '20241130'\n     or dtstatdate between '20241201' and '20241207'\n     or dtstatdate between '20241208' and '20241214'\n     or dtstatdate between '20241215' and '20241221'\n     or dtstatdate between '20241222' and '20241225'\n  )\ngroup by dtstatdate\norder by dtstatdate;"}], "rejected": "select\n  dtstatdate,\n  count(distinct vplayerid) as uv,\n  count(*) as pv\nfrom dws_jordass_buttonpress_pre_di\nwhere buttontype = '410012'\n  and (\n        dtstatdate > '20241028'\n     or dtstatdate between '20241128' and '20241225'\n     or dtstatdate between '20241028' and '20241102'\n     or dtstatdate between '20241103' and '20241109'\n     or dtstatdate between '20241110' and '20241116'\n     or dtstatdate between '20241117' and '20241123'\n     or dtstatdate between '20241124' and '20241125'\n     or dtstatdate between '20241128' and '20241130'\n     or dtstatdate between '20241201' and '20241207'\n     or dtstatdate between '20241208' and '20241214'\n     or dtstatdate between '20241215' and '20241221'\n     or dtstatdate between '20241222' and '20241225'\n  )\ngroup by dtstatdate\norder by dtstatdate;", "meta": {"origin": "sql_64", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_105_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20240101-20250601全平台每天充值金额数和消耗金币数\n输出：统计日期(yyyymmdd)，充值金额数，消耗金币数\n【表】dws_jordass_water_di, dwd_jordass_currencylog_hi\n【口径】消耗金币：AddOrReduce=1 and imoneytype=1\n 充值和消耗金币都直接使用imoney"}, {"role": "assistant", "content": "with recharge as (\n  select\n    dtstatdate as stat_date,\n    sum(coalesce(imoney, 0)) as recharge_amount\n  from dws_jordass_water_di\n  where dtstatdate between '20240101' and '20250601'\n  group by dtstatdate\n),\ngold_consume as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    sum(coalesce(imoney, 0)) as gold_consume_amount\n  from dwd_jordass_currencylog_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240101' and '20250601'\n    and addorreduce = 1\n    and imoneytype = 1\n  group by substr(tdbank_imp_date, 1, 8)\n),\nall_dates as (\n  select stat_date from recharge\n  union\n  select stat_date from gold_consume\n)\nselect\n  d.stat_date,\n  coalesce(r.recharge_amount, 0) as recharge_amount,\n  coalesce(g.gold_consume_amount, 0) as gold_consume_amount\nfrom all_dates d\nleft join recharge r on d.stat_date = r.stat_date\nleft join gold_consume g on d.stat_date = g.stat_date\norder by d.stat_date;"}], "rejected": "with recharge as (\n  select\n    dtstatdate as stat_date,\n    sum(coalesce(imoney, 0)) as recharge_amount\n  from dws_jordass_water_di\n  where dtstatdate > '20240101'\n  group by dtstatdate\n),\ngold_consume as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    sum(coalesce(imoney, 0)) as gold_consume_amount\n  from dwd_jordass_currencylog_hi\n  where substr(tdbank_imp_date, 1, 8) between '20240101' and '20250601'\n    and addorreduce = 1\n    and imoneytype = 1\n  group by substr(tdbank_imp_date, 1, 8)\n),\nall_dates as (\n  select stat_date from recharge\n  union\n  select stat_date from gold_consume\n)\nselect\n  d.stat_date,\n  coalesce(r.recharge_amount, 0) as recharge_amount,\n  coalesce(g.gold_consume_amount, 0) as gold_consume_amount\nfrom all_dates d\nleft join recharge r on d.stat_date = r.stat_date\nleft join gold_consume g on d.stat_date = g.stat_date\norder by d.stat_date;", "meta": {"origin": "sql_105", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_11_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计近30天活跃玩家数，近30天活跃且同时拥有奖池所有道具玩家数\n输出：近30天活跃玩家数、近30天活跃且同时拥有奖池所有道具玩家数\n补充说明：\n当前日期时间：'20250626'\n其中奖池道具id为：\n71d260ca-4bad-81f2-0298-44860341a7a6\n48601754-442d-98cb-2109-3fb2075500ec\na9126263-439c-7be6-d668-52a6c0c0a36f\n34ecc788-4034-71d2-a0ac-c398b8ecb2ae\n56f98991-43f8-dcc8-189e-08b7ae6c42ad\n8453f8ef-4c0b-46e2-8768-3e9e45c67a2c\n06d90274-435f-3e32-9d57-26bc228ae2e5\n8196dea4-4229-c951-13a9-088fb13b3512\n3abc330f-444a-6dfd-5863-81856ba62624\n041a43a4-46fe-dab7-c974-36bf91eab33d\n5b863cb9-4e41-ec89-69ee-49a223d05ff1\n【表】dwd_argothek_gearrecord_df, dws_argothek_oss_useractivity_df\n【口径】这张表的iworldid = 255代表玩家粒度， 奖池道具筛选逻辑：\niGoodsId in (\n\"71d260ca-4bad-81f2-0298-44860341a7a6\",\n\"48601754-442d-98cb-2109-3fb2075500ec\",\n\"a9126263-439c-7be6-d668-52a6c0c0a36f\",\n\"34ecc788-4034-71d2-a0ac-c398b8ecb2ae\",\n\"56f98991-43f8-dcc8-189e-08b7ae6c42ad\",\n\"8453f8ef-4c0b-46e2-8768-3e9e45c67a2c\",\n\"06d90274-435f-3e32-9d57-26bc228ae2e5\",\n\"8196dea4-4229-c951-13a9-088fb13b3512\",\n\"3abc330f-444a-6dfd-5863-81856ba62624\",\n\"041a43a4-46fe-dab7-c974-36bf91eab33d\",\n\"5b863cb9-4e41-ec89-69ee-49a223d05ff1\")\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with active_users as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date between 20250528 and 20250626\n    and iworldid = 255\n),\nall_prize_users as (\n  select iuserid\n  from dwd_argothek_gearrecord_df\n  where igoodsid in (\n    '71d260ca-4bad-81f2-0298-44860341a7a6',\n    '48601754-442d-98cb-2109-3fb2075500ec',\n    'a9126263-439c-7be6-d668-52a6c0c0a36f',\n    '34ecc788-4034-71d2-a0ac-c398b8ecb2ae',\n    '56f98991-43f8-dcc8-189e-08b7ae6c42ad',\n    '8453f8ef-4c0b-46e2-8768-3e9e45c67a2c',\n    '06d90274-435f-3e32-9d57-26bc228ae2e5',\n    '8196dea4-4229-c951-13a9-088fb13b3512',\n    '3abc330f-444a-6dfd-5863-81856ba62624',\n    '041a43a4-46fe-dab7-c974-36bf91eab33d',\n    '5b863cb9-4e41-ec89-69ee-49a223d05ff1'\n  )\n  group by iuserid\n  having count(distinct igoodsid) = 11\n),\nactive_cnt as (\n  select count(*) as active_user_cnt from active_users\n),\nactive_all_cnt as (\n  select count(*) as active_own_all_cnt\n  from active_users a\n  join all_prize_users g on a.iuserid = g.iuserid\n)\nselect\n  a.active_user_cnt as active_30d_user_cnt,\n  b.active_own_all_cnt as active_30d_own_all_cnt\nfrom active_cnt a\ncross join active_all_cnt b;"}], "rejected": "with active_users as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date between 20250528 and 20250626\n    and iworldid = 255\n),\nall_prize_users as (\n  select iuserid\n  from dwd_argothek_gearrecord_df\n  where igoodsid in (\n    '71d260ca-4bad-81f2-0298-44860341a7a6',\n    '48601754-442d-98cb-2109-3fb2075500ec',\n    'a9126263-439c-7be6-d668-52a6c0c0a36f',\n    '34ecc788-4034-71d2-a0ac-c398b8ecb2ae',\n    '56f98991-43f8-dcc8-189e-08b7ae6c42ad',\n    '8453f8ef-4c0b-46e2-8768-3e9e45c67a2c',\n    '06d90274-435f-3e32-9d57-26bc228ae2e5',\n    '8196dea4-4229-c951-13a9-088fb13b3512',\n    '3abc330f-444a-6dfd-5863-81856ba62624',\n    '041a43a4-46fe-dab7-c974-36bf91eab33d',\n    '5b863cb9-4e41-ec89-69ee-49a223d05ff1'\n  )\n  group by iuserid\n  having count(distinct igoodsid) = 11\n),\nactive_cnt as (\n  select count(*) as active_user_cnt from active_users\n),\nactive_all_cnt as (\n  select count(*) as active_own_all_cnt\n  from active_users a\n  join all_prize_users g on a.iuserid = g.iuserid\n)\nselect\n  a.active_user_cnt as active_30d_user_cnt,\n  b.active_own_all_cnt as active_30d_own_all_cnt\nfrom active_cnt a\ncross join active_all_cnt b;", "meta": {"origin": "sql_11", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_35_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024年3月26日~4月3日\n2024年5月28日~6月5日\n不同对局类型的游戏和玩法留存情况\n输出：统计日期(20240330、...、20240407、20240601、...、20240609)、对局类型（第一人称、单排、双排、四排），每日对局人数、次数、对局总时长(秒)、游戏次留人数、游戏7留人数，玩法次留人数、玩法7留人数\n【表】dws_jordass_login_di, dws_jordass_mode_roundrecord_di\n【口径】第一人称：mode 的取值在 401、402 或 403；\n单排： mode 等于 101；\n双排： mode 等于 102；\n四排： mode 等于 103 或 603。\n\n玩法次留：当天参与玩法且第二天同样参与玩法\n游戏次留：当天在游戏活跃且第2天也在游戏活跃"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith round_user as (\n    select dtstatdate,\n        case \n            when mode in (401,402,403) then '第一人称'\n            when mode =101 then '单排'\n            when mode =102 then '双排'\n            when mode in (103,603) then '四排'\n        end modename,\n        vplayerid,\n        sum(roundcnt) roundcnt,\n        sum(roundtime) roundtime\n    from dws_jordass_mode_roundrecord_di\n    where ((dtstatdate between '20240330' and '20240413')\n    or (dtstatdate between '20240601' and '20240615'))\n    and mode in (401,402,403,101,102,103,603)\n    group by dtstatdate,\n    case when mode in (401,402,403) then '第一人称'\n        when mode =101 then '单排'\n        when mode =102 then '双排'\n        when mode in (103,603) then '四排'\n    end,\n    vplayerid\n)\n\nselect \n    a.dtstatdate,\n    a.modename,\n    count(distinct a.vplayerid) iusernum,\n    sum(a.roundcnt) roundcnt,\n    sum(a.roundtime) roundtime,\n    count(distinct b1.vplayerid) stay2,\n    count(distinct b2.vplayerid) stay7,\n    count(distinct c1.vplayerid) playstay2,\n    count(distinct c2.vplayerid) playstay7\nfrom (\n    select * from round_user \n    where((dtstatdate between '20240330' and '20240407') or (dtstatdate between '20240601' and '20240609'))\n) a\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240330' and '20240408') or (dtstatdate between '20240601' and '20240610')) \n    and platid =255\n    group by dtstatdate,vplayerid\n) b1 \non a.vplayerid = b1.vplayerid and date_add(a.dtstatdate,1) = b1.dtstatdate\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240330' and '20240413') or (dtstatdate between '20240601' and '20240615')) and platid =255\n    group by dtstatdate,vplayerid\n) b2 \non a.vplayerid = b2.vplayerid and date_add(a.dtstatdate,6) = b2.dtstatdate\nleft join round_user c1 \non a.vplayerid = c1.vplayerid and date_add(a.dtstatdate,1) = c1.dtstatdate and a.modename= c1.modename\nleft join round_user c2 \non a.vplayerid = c2.vplayerid and date_add(a.dtstatdate,6) = c2.dtstatdate and a.modename= c2.modename\ngroup by a.dtstatdate,a.modename\n\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith round_user as (\n    select dtstatdate,\n        case \n            when mode in (401,402,403) then '第一人称'\n            when mode =101 then '单排'\n            when mode =102 then '双排'\n            when mode in (103,603) then '四排'\n        end modename,\n        vplayerid,\n        sum(roundcnt) roundcnt,\n        sum(roundtime) roundtime\n    from dws_jordass_mode_roundrecord_di\n    where ((dtstatdate > '20240330')\n    or (dtstatdate between '20240601' and '20240615'))\n    and mode in (401,402,403,101,102,103,603)\n    group by dtstatdate,\n    case when mode in (401,402,403) then '第一人称'\n        when mode =101 then '单排'\n        when mode =102 then '双排'\n        when mode in (103,603) then '四排'\n    end,\n    vplayerid\n)\n\nselect \n    a.dtstatdate,\n    a.modename,\n    count(distinct a.vplayerid) iusernum,\n    sum(a.roundcnt) roundcnt,\n    sum(a.roundtime) roundtime,\n    count(distinct b1.vplayerid) stay2,\n    count(distinct b2.vplayerid) stay7,\n    count(distinct c1.vplayerid) playstay2,\n    count(distinct c2.vplayerid) playstay7\nfrom (\n    select * from round_user \n    where((dtstatdate between '20240330' and '20240407') or (dtstatdate between '20240601' and '20240609'))\n) a\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240330' and '20240408') or (dtstatdate between '20240601' and '20240610')) \n    and platid =255\n    group by dtstatdate,vplayerid\n) b1 \non a.vplayerid = b1.vplayerid and date_add(a.dtstatdate,1) = b1.dtstatdate\nleft join (\n    select dtstatdate,vplayerid \n    from dws_jordass_login_di\n    where ((dtstatdate between '20240330' and '20240413') or (dtstatdate between '20240601' and '20240615')) and platid =255\n    group by dtstatdate,vplayerid\n) b2 \non a.vplayerid = b2.vplayerid and date_add(a.dtstatdate,6) = b2.dtstatdate\nleft join round_user c1 \non a.vplayerid = c1.vplayerid and date_add(a.dtstatdate,1) = c1.dtstatdate and a.modename= c1.modename\nleft join round_user c2 \non a.vplayerid = c2.vplayerid and date_add(a.dtstatdate,6) = c2.dtstatdate and a.modename= c2.modename\ngroup by a.dtstatdate,a.modename\n\n) AS final_query;", "meta": {"origin": "sql_35", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_7_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.07.03-2025.07.31 开白渠道（排除内部体验、买量测试，排除全平台）指定注册渠道的新进用户数。\n输出：日期（20250728...20250731）、注册渠道、新进用户数\n【表】dws_argothek_ce1_cbt2_vplayerid_suserid_di, dwd_argothek_cbt2kaibai_hi\n【口径】渠道范围：iregway in (\"89903934\",\"89903933\",\"89903932\",\"89902725\",\"89902724\",\"89902723\",\"89900960\",\"89900961\",\"89900962\")\n排除 sourcename in ('内部体验','买量测试')\n排除全平台：platid <> 255\n所有日期统一使用字符串 YYYYMMDD\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH open_channel AS (\n  SELECT DISTINCT gplayerid\n  FROM dwd_argothek_cbt2kaibai_hi\n  WHERE dteventtime >= '2025-07-28 00:00:00'\n    AND dteventtime <= '2025-07-31 23:59:59'\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n),\nfiltered AS (\n  SELECT\n    dtstatdate,\n    vplayerid,\n    iregway\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate BETWEEN '20250728' AND '20250731'\n    AND iregway IN ('89903934','89903933','89903932','89902725','89902724','89902723','89900960','89900961','89900962')\n    AND is_reg = '1'\n    AND platid <> 255\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n)\nSELECT\n  f.dtstatdate AS stat_date,\n  f.iregway,\n  COUNT(DISTINCT f.vplayerid) AS new_user_cnt\nFROM filtered f\nJOIN open_channel o\n  ON f.vplayerid = o.gplayerid\nGROUP BY f.dtstatdate, f.iregway\nORDER BY f.dtstatdate, f.iregway;"}], "rejected": "WITH open_channel AS (\n  SELECT DISTINCT gplayerid\n  FROM dwd_argothek_cbt2kaibai_hi\n  WHERE dteventtime >= '2025-07-28 00:00:00'\n    AND dteventtime <= '2025-07-31 23:59:59'\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n),\nfiltered AS (\n  SELECT\n    dtstatdate,\n    vplayerid,\n    iregway\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate > '20250728'\n    AND iregway IN ('89903934','89903933','89903932','89902725','89902724','89902723','89900960','89900961','89900962')\n    AND is_reg = '1'\n    AND platid <> 255\n    AND COALESCE(sourcename, '') NOT IN ('内部体验', '买量测试')\n)\nSELECT\n  f.dtstatdate AS stat_date,\n  f.iregway,\n  COUNT(DISTINCT f.vplayerid) AS new_user_cnt\nFROM filtered f\nJOIN open_channel o\n  ON f.vplayerid = o.gplayerid\nGROUP BY f.dtstatdate, f.iregway\nORDER BY f.dtstatdate, f.iregway;", "meta": {"origin": "sql_7", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_59_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：20250128-20250124时间区间内，幻境使者活动抽奖用户第X次触发赠送后，这些用户的总抽奖次数\n输出：第X次触发,触发用户数,用户总抽奖次数\n【表】dwd_jordass_activityrecord_hi\n【口径】actid=2411070621 and acttype= 10062 表示幻境使者活动\narg1表示抽奖次数\nStrArg1<>0表示触发赠送\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select \n    s1.trigger_count as `trigger_count`, -- 第x次触发\n    count(distinct s1.vplayerid) as `trigger_user_cnt`, -- 触发用户数\n    sum(s2.draw_count) as `total_draw_count` -- 用户总抽奖次数\nfrom (\n    select\n        vplayerid,\n        dteventtime,\n        coalesce(lead(dteventtime) over (partition by vplayerid order by dteventtime), '9999-12-31 23:59:59')  as next_dteventtime,\n        row_number() over (partition by vplayerid order by dteventtime) as trigger_count\n    from (\n        select distinct\n            vplayerid,\n            dteventtime\n        from dwd_jordass_activityrecord_hi\n        where tdbank_imp_date >= '2025011100'\n        and tdbank_imp_date <= '2025012423'\n        and actid = 2411070621\n        and acttype = 10062\n        and recodtype in ('1', '2')\n        and strarg1 <> '0'\n    ) ff1\n) s1 \njoin (\n    select\n        vplayerid,\n        dteventtime,\n        sum(arg1) as draw_count\n    from dwd_jordass_activityrecord_hi  -- actgeneralflow表\n    where tdbank_imp_date >= \"2025011100\" and tdbank_imp_date <= \"2025012423\" -- 时间区间：20250128-20250210\n    and actid = 2411070621\n    and acttype = 10062\n    and recodtype in (\"1\", \"2\")\n    group by vplayerid, dteventtime\n\n    \n) s2 \non s1.vplayerid = s2.vplayerid and s2. dteventtime >= s1.dteventtime and s2.dteventtime < s1.next_dteventtime\ngroup by s1.trigger_count;"}], "rejected": "select \n    s1.trigger_count as `trigger_count`, -- 第x次触发\n    count(distinct s1.vplayerid) as `trigger_user_cnt`, -- 触发用户数\n    sum(s2.draw_count) as `total_draw_count` -- 用户总抽奖次数\nfrom (\n    select\n        vplayerid,\n        dteventtime,\n        coalesce(lead(dteventtime) over (partition by vplayerid order by dteventtime), '9999-12-31 23:59:59')  as next_dteventtime,\n        row_number() over (partition by vplayerid order by dteventtime) as trigger_count\n    from (\n        select distinct\n            vplayerid,\n            dteventtime\n        from dwd_jordass_activityrecord_hi\n        where tdbank_imp_date >= '2025011100'\n        and tdbank_imp_date <= '2025012423'\n        and actid = 2411070621\n        and acttype = 10062\n        and recodtype in ('1', '2')\n        and strarg1 <> '0'\n    ) ff1\n) s1 \njoin (\n    select\n        vplayerid,\n        dteventtime,\n        sum(arg1) as draw_count\n    from dwd_jordass_activityrecord_hi  -- actgeneralflow表\n    where tdbank_imp_date >= \"2025011100\" and tdbank_imp_date <= \"2025012423\" -- 时间区间：20250128-20250210\n    and actid = 2411070621\n    and acttype = 10062\n    and recodtype in (\"1\", \"2\")\n    group by vplayerid, dteventtime\n\n    \n) s2 \non s1.vplayerid = s2.vplayerid and s2. dteventtime >= s1.dteventtime and s2.dteventtime < s1.next_dteventtime\ngroup by s1.trigger_count;", "meta": {"origin": "sql_59", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_65_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】查询2024.11.29-2024.12.19期间的任务领取数据，并按类型汇总（跨日期）\n输出 ：日期（YYYYMMDD、汇总），类型，人数，次数\n【表】dwd_jordass_activity_rewardrecord_hi\n【口径】任务领取：actid = 2411291018and acttype = 10045 and awardidx in (1, 2, 3)，一条记录代表领取一次"}, {"role": "assistant", "content": "with base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241202' and '20241222'\n    and actid = 2411291018\n    and acttype = 10045\n    and awardidx in (1, 2, 3)\n),\nstat_detail as (\n  select\n    stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by stat_date, award_type\n),\nstat_summary as (\n  select\n    '汇总' as stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by award_type\n)\nselect\n  stat_date,\n  award_type,\n  user_cnt,\n  receive_cnt\nfrom (\n  select * from stat_detail\n  union all\n  select * from stat_summary\n) t\norder by case when stat_date = '汇总' then 1 else 0 end, stat_date, award_type;"}], "rejected": "with base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    cast(awardidx as string) as award_type,\n    vplayerid\n  from dwd_jordass_activity_rewardrecord_hi\n  where substr(tdbank_imp_date, 1, 8) > '20241202'\n    and actid = 2411291018\n    and acttype = 10045\n    and awardidx in (1, 2, 3)\n),\nstat_detail as (\n  select\n    stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by stat_date, award_type\n),\nstat_summary as (\n  select\n    '汇总' as stat_date,\n    award_type,\n    count(distinct vplayerid) as user_cnt,\n    count(*) as receive_cnt\n  from base\n  group by award_type\n)\nselect\n  stat_date,\n  award_type,\n  user_cnt,\n  receive_cnt\nfrom (\n  select * from stat_detail\n  union all\n  select * from stat_summary\n) t\norder by case when stat_date = '汇总' then 1 else 0 end, stat_date, award_type;", "meta": {"origin": "sql_65", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_11_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计近30天活跃玩家数，近30天活跃且同时拥有奖池所有道具玩家数\n输出：近30天活跃玩家数、近30天活跃且同时拥有奖池所有道具玩家数\n补充说明：\n当前日期时间：'20250622'\n其中奖池道具id为：\n71d260ca-4bad-81f2-0298-44860341a7a6\n48601754-442d-98cb-2109-3fb2075500ec\na9126263-439c-7be6-d668-52a6c0c0a36f\n34ecc788-4034-71d2-a0ac-c398b8ecb2ae\n56f98991-43f8-dcc8-189e-08b7ae6c42ad\n8453f8ef-4c0b-46e2-8768-3e9e45c67a2c\n06d90274-435f-3e32-9d57-26bc228ae2e5\n8196dea4-4229-c951-13a9-088fb13b3512\n3abc330f-444a-6dfd-5863-81856ba62624\n041a43a4-46fe-dab7-c974-36bf91eab33d\n5b863cb9-4e41-ec89-69ee-49a223d05ff1\n【表】dwd_argothek_gearrecord_df, dws_argothek_oss_useractivity_df\n【口径】这张表的iworldid = 255代表玩家粒度， 奖池道具筛选逻辑：\niGoodsId in (\n\"71d260ca-4bad-81f2-0298-44860341a7a6\",\n\"48601754-442d-98cb-2109-3fb2075500ec\",\n\"a9126263-439c-7be6-d668-52a6c0c0a36f\",\n\"34ecc788-4034-71d2-a0ac-c398b8ecb2ae\",\n\"56f98991-43f8-dcc8-189e-08b7ae6c42ad\",\n\"8453f8ef-4c0b-46e2-8768-3e9e45c67a2c\",\n\"06d90274-435f-3e32-9d57-26bc228ae2e5\",\n\"8196dea4-4229-c951-13a9-088fb13b3512\",\n\"3abc330f-444a-6dfd-5863-81856ba62624\",\n\"041a43a4-46fe-dab7-c974-36bf91eab33d\",\n\"5b863cb9-4e41-ec89-69ee-49a223d05ff1\")"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith active_users as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date between 20250524 and 20250622\n    and iworldid = 255\n),\nall_prize_users as (\n  select iuserid\n  from dwd_argothek_gearrecord_df\n  where igoodsid in (\n    '71d260ca-4bad-81f2-0298-44860341a7a6',\n    '48601754-442d-98cb-2109-3fb2075500ec',\n    'a9126263-439c-7be6-d668-52a6c0c0a36f',\n    '34ecc788-4034-71d2-a0ac-c398b8ecb2ae',\n    '56f98991-43f8-dcc8-189e-08b7ae6c42ad',\n    '8453f8ef-4c0b-46e2-8768-3e9e45c67a2c',\n    '06d90274-435f-3e32-9d57-26bc228ae2e5',\n    '8196dea4-4229-c951-13a9-088fb13b3512',\n    '3abc330f-444a-6dfd-5863-81856ba62624',\n    '041a43a4-46fe-dab7-c974-36bf91eab33d',\n    '5b863cb9-4e41-ec89-69ee-49a223d05ff1'\n  )\n  group by iuserid\n  having count(distinct igoodsid) = 11\n),\nactive_cnt as (\n  select count(*) as active_user_cnt from active_users\n),\nactive_all_cnt as (\n  select count(*) as active_own_all_cnt\n  from active_users a\n  join all_prize_users g on a.iuserid = g.iuserid\n)\nselect\n  a.active_user_cnt as active_30d_user_cnt,\n  b.active_own_all_cnt as active_30d_own_all_cnt\nfrom active_cnt a\ncross join active_all_cnt b\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith active_users as (\n  select distinct iuserid\n  from dws_argothek_oss_useractivity_df\n  where statis_date between 20250524 and 20250622\n    and iworldid = 255\n),\nall_prize_users as (\n  select iuserid\n  from dwd_argothek_gearrecord_df\n  where igoodsid in (\n    '71d260ca-4bad-81f2-0298-44860341a7a6',\n    '48601754-442d-98cb-2109-3fb2075500ec',\n    'a9126263-439c-7be6-d668-52a6c0c0a36f',\n    '34ecc788-4034-71d2-a0ac-c398b8ecb2ae',\n    '56f98991-43f8-dcc8-189e-08b7ae6c42ad',\n    '8453f8ef-4c0b-46e2-8768-3e9e45c67a2c',\n    '06d90274-435f-3e32-9d57-26bc228ae2e5',\n    '8196dea4-4229-c951-13a9-088fb13b3512',\n    '3abc330f-444a-6dfd-5863-81856ba62624',\n    '041a43a4-46fe-dab7-c974-36bf91eab33d',\n    '5b863cb9-4e41-ec89-69ee-49a223d05ff1'\n  )\n  group by iuserid\n  having count(distinct igoodsid) = 11\n),\nactive_cnt as (\n  select count(*) as active_user_cnt from active_users\n),\nactive_all_cnt as (\n  select count(*) as active_own_all_cnt\n  from active_users a\n  join all_prize_users g on a.iuserid = g.iuserid\n)\nselect\n  a.active_user_cnt as active_30d_user_cnt,\n  b.active_own_all_cnt as active_30d_own_all_cnt\nfrom active_cnt a\ncross join active_all_cnt b\n) AS final_query;", "meta": {"origin": "sql_11", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_4_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计开服至今使用频率最高的用户昵称。\n时间范围：2023.07.17 00:00:00 - 2025.07.20 23:59:59\n输出：昵称（唯一）、人数\n【表】dwd_argothek_playerlogin_hi\n【口径】昵称筛选逻辑：\nnickname 按照 # 进行划分，取 # 前半部分作为昵称\n示例：多喝热水#131234 -> 昵称：多喝热水\n若存在并列最高频率，按昵称字典序最小的记录返回"}, {"role": "assistant", "content": "WITH base AS (\n  SELECT\n    CASE\n      WHEN LOCATE('#', vrolename) > 0 THEN SUBSTR(vrolename, 1, LOCATE('#', vrolename) - 1)\n      ELSE vrolename\n    END AS nickname,\n    iuserid\n  FROM dwd_argothek_playerlogin_hi\n  WHERE dteventtime >= '2023-07-17 00:00:00'\n    AND dteventtime <= '2025-07-20 23:59:59'\n    AND IFNULL(vrolename, '') <> ''\n),\nagg AS (\n  SELECT\n    nickname,\n    COUNT(DISTINCT iuserid) AS user_cnt\n  FROM base\n  GROUP BY nickname\n)\nSELECT\n  nickname,\n  user_cnt AS user_num\nFROM agg\nORDER BY user_cnt DESC, nickname\nLIMIT 1;"}], "rejected": "WITH base AS (\n  SELECT\n    CASE\n      WHEN LOCATE('#', vrolename) > 0 THEN SUBSTR(vrolename, 1, LOCATE('#', vrolename) - 1)\n      ELSE vrolename\n    END AS nickname,\n    iuserid\n  FROM dwd_argothek_playerlogin_hi\n  WHERE dteventtime >= '2023-07-17 00:00:00'\n    AND dteventtime <= '2025-07-20 23:59:59'\n    AND IFNULL(vrolename, '') <> ''\n),\nagg AS (\n  SELECT\n    nickname,\n    COUNT(DISTINCT iuserid) AS user_cnt\n  FROM base\n  GROUP BY nickname\n)\nSELECT\n  nickname,\n  user_cnt AS user_num\nFROM agg\nORDER BY user_cnt DESC, nickname\nLIMIT 1;", "meta": {"origin": "sql_4", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_33_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024年12月14日-2024年12月20日参与建筑争夺玩法的玩家人数（去重）有多少，其中多少人是12月13日及以前有参与过建筑争夺的老玩家，有多少是新玩家\n输出: 玩家人数、老玩家人数、新玩家人数\n【表】dws_jordass_playermatchrecord_stat_df, dws_jordass_matchlog_stat_di\n【口径】建筑争夺玩法对应的imode为1344338933661592832"}, {"role": "assistant", "content": "select\n    count(distinct a.vplayerid) as total_players,\n    count(distinct case when b.vplayerid is not null then a.vplayerid end) as existing_players,\n    count(distinct case when b.vplayerid is null then a.vplayerid end) as new_players\nfrom (\n    select vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate between '20241217' and '20241223'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) a\nleft join (\n    select vplayerid\n    from dws_jordass_playermatchrecord_stat_df\n    where dtstatdate = '20241216'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) b\non a.vplayerid = b.vplayerid\n;"}], "rejected": "select\n    count(distinct a.vplayerid) as total_players,\n    count(distinct case when b.vplayerid is not null then a.vplayerid end) as existing_players,\n    count(distinct case when b.vplayerid is null then a.vplayerid end) as new_players\nfrom (\n    select vplayerid\n    from dws_jordass_matchlog_stat_di\n    where dtstatdate > '20241217'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) a\nleft join (\n    select vplayerid\n    from dws_jordass_playermatchrecord_stat_df\n    where dtstatdate = '20241216'\n    and imode = 1344338933661592832\n    and platid = 255\n    group by vplayerid\n) b\non a.vplayerid = b.vplayerid\n;", "meta": {"origin": "sql_33", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_73_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20241123-20241222对决冠军，乐园其他，和乐园汇总 三类用户的组队和对局情况\n输出：乐园总参与人数，乐园总参与局数，乐园组队人数，乐园组队局数，对决冠军总参与人数，对决冠军总参与局数，对决冠军组队人数，对决冠军组队局数，乐园其他总参与人数，乐园其他总参与局数，乐园其他组队人数，乐园其他组队局数\n【表】dwd_jordass_player_matchrecord_hi\n【口径】对决冠军：matchmode=1003 and matchsubmodegroup=1345785623905087744\n乐园其他：matchmode=1003 and matchsubmodegroup<>1345785623905087744\n乐园汇总：matchmode=1003\n都需要限制 matchresult=\"ok\"\n组队：teamnum>1"}, {"role": "assistant", "content": "with base as (\n  select\n    vplayerid,\n    cast(coalesce(nullif(teamnum, ''), '1') as int) as team_num,\n    matchmode,\n    matchsubmodegroup\n  from dwd_jordass_player_matchrecord_hi\n  where substr(tdbank_imp_date, 1, 8) between '20241125' and '20241224'\n    and matchresult = 'ok'\n),\nagg as (\n  select\n    '乐园' as category,\n    count(distinct vplayerid) as total_users,\n    count(*) as total_matches,\n    count(distinct case when team_num > 1 then vplayerid end) as team_users,\n    sum(case when team_num > 1 then 1 else 0 end) as team_matches\n  from base\n  where matchmode = 1003\n  union all\n  select\n    '对决冠军',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup = 1345785623905087744\n  union all\n  select\n    '乐园其他',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup <> 1345785623905087744\n)\nselect\n  max(case when category = '乐园' then total_users end) as leyuan_total_users,\n  max(case when category = '乐园' then total_matches end) as leyuan_total_matches,\n  max(case when category = '乐园' then team_users end) as leyuan_team_users,\n  max(case when category = '乐园' then team_matches end) as leyuan_team_matches,\n  max(case when category = '对决冠军' then total_users end) as duel_total_users,\n  max(case when category = '对决冠军' then total_matches end) as duel_total_matches,\n  max(case when category = '对决冠军' then team_users end) as duel_team_users,\n  max(case when category = '对决冠军' then team_matches end) as duel_team_matches,\n  max(case when category = '乐园其他' then total_users end) as leyuan_other_total_users,\n  max(case when category = '乐园其他' then total_matches end) as leyuan_other_total_matches,\n  max(case when category = '乐园其他' then team_users end) as leyuan_other_team_users,\n  max(case when category = '乐园其他' then team_matches end) as leyuan_other_team_matches\nfrom agg;"}], "rejected": "with base as (\n  select\n    vplayerid,\n    cast(coalesce(nullif(teamnum, ''), '1') as int) as team_num,\n    matchmode,\n    matchsubmodegroup\n  from dwd_jordass_player_matchrecord_hi\n  where substr(tdbank_imp_date, 1, 8) > '20241125'\n    and matchresult = 'ok'\n),\nagg as (\n  select\n    '乐园' as category,\n    count(distinct vplayerid) as total_users,\n    count(*) as total_matches,\n    count(distinct case when team_num > 1 then vplayerid end) as team_users,\n    sum(case when team_num > 1 then 1 else 0 end) as team_matches\n  from base\n  where matchmode = 1003\n  union all\n  select\n    '对决冠军',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup = 1345785623905087744\n  union all\n  select\n    '乐园其他',\n    count(distinct vplayerid),\n    count(*),\n    count(distinct case when team_num > 1 then vplayerid end),\n    sum(case when team_num > 1 then 1 else 0 end)\n  from base\n  where matchmode = 1003 and matchsubmodegroup <> 1345785623905087744\n)\nselect\n  max(case when category = '乐园' then total_users end) as leyuan_total_users,\n  max(case when category = '乐园' then total_matches end) as leyuan_total_matches,\n  max(case when category = '乐园' then team_users end) as leyuan_team_users,\n  max(case when category = '乐园' then team_matches end) as leyuan_team_matches,\n  max(case when category = '对决冠军' then total_users end) as duel_total_users,\n  max(case when category = '对决冠军' then total_matches end) as duel_total_matches,\n  max(case when category = '对决冠军' then team_users end) as duel_team_users,\n  max(case when category = '对决冠军' then team_matches end) as duel_team_matches,\n  max(case when category = '乐园其他' then total_users end) as leyuan_other_total_users,\n  max(case when category = '乐园其他' then total_matches end) as leyuan_other_total_matches,\n  max(case when category = '乐园其他' then team_users end) as leyuan_other_team_users,\n  max(case when category = '乐园其他' then team_matches end) as leyuan_other_team_matches\nfrom agg;", "meta": {"origin": "sql_73", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_6_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.06.12-2025.07.14手游 T2 活跃用户在 2025.06.28 之前端游注册的号码包。\n输出：vplayerid\n【表】dim_argothek_gplayerid2qqwxid_df, dws_argothek_ce1_cbt2_vplayerid_suserid_di\n【口径】手游活跃口径：dws_argothek_ce1_cbt2_vplayerid_suserid_di.itag = 'T2'\n端游注册时间：dim_argothek_gplayerid2qqwxid_df.iregdate < '20250628'\n所有日期统一使用字符串 YYYYMMDD\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "WITH mobile_t2 AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate BETWEEN '20250712' AND '20250813'\n    AND itag = 'T2'\n),\npc_reg AS (\n  SELECT DISTINCT iuserid AS vplayerid\n  FROM dim_argothek_gplayerid2qqwxid_df\n  WHERE dtstatdate <= '20250628'\n    AND iregdate < '20250628'\n)\nSELECT DISTINCT m.vplayerid\nFROM mobile_t2 m\nJOIN pc_reg p\n  ON m.vplayerid = p.vplayerid\nORDER BY m.vplayerid;"}], "rejected": "WITH mobile_t2 AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate > '20250712'\n    AND itag = 'T2'\n),\npc_reg AS (\n  SELECT DISTINCT iuserid AS vplayerid\n  FROM dim_argothek_gplayerid2qqwxid_df\n  WHERE dtstatdate <= '20250628'\n    AND iregdate < '20250628'\n)\nSELECT DISTINCT m.vplayerid\nFROM mobile_t2 m\nJOIN pc_reg p\n  ON m.vplayerid = p.vplayerid\nORDER BY m.vplayerid;", "meta": {"origin": "sql_6", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_112_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2022.04.23-2022.04.30和2022.05.01-2022.05.08传统模式存活时长达到90分钟的玩家人数，每日人数\n输出：统计日期(yyyymmdd)，人数\n【表】dwd_jordass_roundflow_hi\n【口径】传统模式mode in(101,102,103,401,402,403)\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    vplayerid,\n    sum(coalesce(survivaltime, 0)) as total_survival\n  from dwd_jordass_roundflow_hi\n  where ((substr(tdbank_imp_date, 1, 8) between '20220428' and '20220505')\n     or (substr(tdbank_imp_date, 1, 8) between '20220506' and '20220513'))\n    and mode in (101, 102, 103, 401, 402, 403)\n  group by substr(tdbank_imp_date, 1, 8), vplayerid\n)\nselect\n  stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom base\nwhere total_survival >= 5400\ngroup by stat_date\norder by stat_date;"}], "rejected": "with base as (\n  select\n    substr(tdbank_imp_date, 1, 8) as stat_date,\n    vplayerid,\n    sum(coalesce(survivaltime, 0)) as total_survival\n  from dwd_jordass_roundflow_hi\n  where ((substr(tdbank_imp_date, 1, 8) > '20220428')\n     or (substr(tdbank_imp_date, 1, 8) between '20220506' and '20220513'))\n    and mode in (101, 102, 103, 401, 402, 403)\n  group by substr(tdbank_imp_date, 1, 8), vplayerid\n)\nselect\n  stat_date,\n  count(distinct vplayerid) as user_cnt\nfrom base\nwhere total_survival >= 5400\ngroup by stat_date\norder by stat_date;", "meta": {"origin": "sql_112", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_48_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2023.12.1流失7天的回流用户数和流失30天的回流用户数\n输出：流失7天的回流用户数，流失30天的回流用户数\n【表】dws_jordass_login_df\n【口径】"}, {"role": "assistant", "content": "select\n    count(distinct case when is_backflow_7 then vplayerid end) as backflow_7_user,\n    count(distinct case when is_backflow_30 then vplayerid end) as backflow_30_user\nfrom (\n    select\n        vplayerid,\n        -- 检查是否满足流失7天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 7), '1') = 0) as is_backflow_7,\n        \n        -- 检查是否满足流失30天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 30), '1') = 0) as is_backflow_30\n    from\n        dws_jordass_login_df\n    where\n        dtstatdate = '20231204'\n        and platid = 255\n) as user_flags;"}], "rejected": "select\n    count(distinct case when is_backflow_7 then vplayerid end) as backflow_7_user,\n    count(distinct case when is_backflow_30 then vplayerid end) as backflow_30_user\nfrom (\n    select\n        vplayerid,\n        -- 检查是否满足流失7天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 7), '1') = 0) as is_backflow_7,\n        \n        -- 检查是否满足流失30天回流条件\n        (dregdate <> dtstatdate) and\n        (instr(substr(cbitmap, 1, 1), '1') > 0) and\n        (instr(substr(cbitmap, 2, 30), '1') = 0) as is_backflow_30\n    from\n        dws_jordass_login_df\n    where\n        dtstatdate = '20231204'\n        and platid = 255\n) as user_flags;", "meta": {"origin": "sql_48", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_14_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年5月份活跃但2025年6月未活跃的qq号码包\n输出:用户suserid\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df\n【口径】限定dim_argothek_gplayerid2qqwxid_df的日期为\"20250614\""}, {"role": "assistant", "content": "with may_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250505 and 20250604\n),\njune_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250605 and 20250704\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250614'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct m.suserid\nfrom may_active a\njoin qq_map m\n  on a.iuserid = m.iuserid\nleft join june_active j\n  on a.iuserid = j.iuserid\nwhere j.iuserid is null\norder by m.suserid;"}], "rejected": "with may_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250505 and 20250604\n),\njune_active as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250605 and 20250704\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250614'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct m.suserid\nfrom may_active a\njoin qq_map m\n  on a.iuserid = m.iuserid\nleft join june_active j\n  on a.iuserid = j.iuserid\nwhere j.iuserid is null\norder by m.suserid;", "meta": {"origin": "sql_14", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_77_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计：20230123开始7日内元素付费金额\n输出：日期（20230128-20230203），人数，元素付费金额\n【表】dwd_jordass_currencylog_hi\n【口径】限定：reason in (189, 190)\n元素付费类型：imoneytype = 1027\n元素付费金额：imoney\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt,\n  sum(coalesce(imoney, 0)) as element_amount\nfrom dwd_jordass_currencylog_hi\nwhere substr(tdbank_imp_date, 1, 8) between '20230128' and '20230203'\n  and reason in (189, 190)\n  and imoneytype = 1027\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date;"}], "rejected": "select\n  substr(tdbank_imp_date, 1, 8) as stat_date,\n  count(distinct vplayerid) as user_cnt,\n  sum(coalesce(imoney, 0)) as element_amount\nfrom dwd_jordass_currencylog_hi\nwhere substr(tdbank_imp_date, 1, 8) > '20230128'\n  and reason in (189, 190)\n  and imoneytype = 1027\ngroup by substr(tdbank_imp_date, 1, 8)\norder by stat_date;", "meta": {"origin": "sql_77", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_9_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计20250702手游fps最后活跃日期为近半年的用户的城市等级分布。\n输出：城市等级，用户人数\n【表】dim_mgamejp_account_allinfo_nf, dim_uf_player_gameinfo_mf\n【口径】用户固定筛选逻辑:\nand saccounttype = \"-100\" -- 账户类型为-100\nand suseridtype in (\"qq\",\"wxid\") -- 用户类型为qq或wxid\nand sgamecode in (\"esports\",\"mobile_live\",\"initiatived\",\"allianceforce\",\"strategy\",\"jordass\",\"su\",\"playzone\",\"battlezone\",\"battlearena\",\"weapon\",\"playhub\",\"manager\",\"apgame\") -- 游戏代码为指定的手游fps\nand splattype = \"-100\" -- 平台类型为-100\n活跃日期逻辑:\n基于当前统计时间20250702向前计算6个月的登陆日期，即ilastactdate >= \"20250106\"\n城市等级分布：\n当前时间为20250702，城市等级分布的相关表是月表，所以需要取kp_imp_date = \"202506\"的数据作为关联数据"}, {"role": "assistant", "content": "with base as (\n  select\n    suserid,\n    suseridtype\n  from dim_mgamejp_account_allinfo_nf\n  where dtstatdate = 20250704\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid')\n    and sgamecode in ('esports','mobile_live','initiatived','allianceforce','strategy','jordass','su','playzone','battlezone','battlearena','weapon','playhub','manager','apgame')\n    and splattype = '-100'\n    and splat = '-100'\n    and ilastactdate >= 20250106\n),\njoined as (\n  select\n    b.suserid,\n    coalesce(u.city_level, '未知') as city_level\n  from base b\n  left join dim_uf_player_gameinfo_mf u\n    on u.kp_imp_date = '202506'\n   and u.userid = b.suserid\n   and u.id_type = case when b.suseridtype = 'wxid' then 'wx' else b.suseridtype end\n)\nselect\n  city_level,\n  count(distinct suserid) as user_cnt\nfrom joined\ngroup by city_level\norder by city_level;"}], "rejected": "with base as (\n  select\n    suserid,\n    suseridtype\n  from dim_mgamejp_account_allinfo_nf\n  where dtstatdate = 20250704\n    and saccounttype = '-100'\n    and suseridtype in ('qq', 'wxid')\n    and sgamecode in ('esports','mobile_live','initiatived','allianceforce','strategy','jordass','su','playzone','battlezone','battlearena','weapon','playhub','manager','apgame')\n    and splattype = '-100'\n    and splat = '-100'\n    and ilastactdate >= 20250106\n),\njoined as (\n  select\n    b.suserid,\n    coalesce(u.city_level, '未知') as city_level\n  from base b\n  left join dim_uf_player_gameinfo_mf u\n    on u.kp_imp_date = '202506'\n   and u.userid = b.suserid\n   and u.id_type = case when b.suseridtype = 'wxid' then 'wx' else b.suseridtype end\n)\nselect\n  city_level,\n  count(distinct suserid) as user_cnt\nfrom joined\ngroup by city_level\norder by city_level;", "meta": {"origin": "sql_9", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_6_v0", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025.06.12-2025.07.14手游 T2 活跃用户在 2025.06.02 之前端游注册的号码包。\n输出：vplayerid\n【表】dim_argothek_gplayerid2qqwxid_df, dws_argothek_ce1_cbt2_vplayerid_suserid_di\n【口径】手游活跃口径：dws_argothek_ce1_cbt2_vplayerid_suserid_di.itag = 'T2'\n端游注册时间：dim_argothek_gplayerid2qqwxid_df.iregdate < '20250602'\n所有日期统一使用字符串 YYYYMMDD"}, {"role": "assistant", "content": "WITH mobile_t2 AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate BETWEEN '20250616' AND '20250718'\n    AND itag = 'T2'\n),\npc_reg AS (\n  SELECT DISTINCT iuserid AS vplayerid\n  FROM dim_argothek_gplayerid2qqwxid_df\n  WHERE dtstatdate <= '20250602'\n    AND iregdate < '20250602'\n)\nSELECT DISTINCT m.vplayerid\nFROM mobile_t2 m\nJOIN pc_reg p\n  ON m.vplayerid = p.vplayerid\nORDER BY m.vplayerid;"}], "rejected": "WITH mobile_t2 AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_argothek_ce1_cbt2_vplayerid_suserid_di\n  WHERE dtstatdate > '20250616'\n    AND itag = 'T2'\n),\npc_reg AS (\n  SELECT DISTINCT iuserid AS vplayerid\n  FROM dim_argothek_gplayerid2qqwxid_df\n  WHERE dtstatdate <= '20250602'\n    AND iregdate < '20250602'\n)\nSELECT DISTINCT m.vplayerid\nFROM mobile_t2 m\nJOIN pc_reg p\n  ON m.vplayerid = p.vplayerid\nORDER BY m.vplayerid;", "meta": {"origin": "sql_6", "scenario": "weekday_monday", "filter_variant": "strict", "structure_variant": "original"}}
{"sql_id": "sql_50_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.10.1-2024.10.31期间点击400211，点击400212，点击400211及400212的重合用户作为用户类型，看不同性别、砺刃活跃度和乐园活跃度情况\n\n输出：用户类型（400211、400212、400211&400212、other），游戏角色性别（male、female、other）、乐园活跃度（light、medium、heavy、other）、砺刃活跃度（light、medium、heavy、other），人数\n\n乐园跟砺刃的活跃度： 轻度1-4天；中度5-15天；重度>=16天\n【表】dws_jordass_matchlog_stat_di, dws_jordass_login_di, dwd_jordass_playerlogin_hi, dws_jordass_buttonpress_pre_di\n【口径】性别根据时间开窗取最新一条"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nWITH base_players AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20241005' AND '20241104'\n    AND platid = 255\n), button_flags AS (\n  SELECT\n    vplayerid,\n    MAX(CASE WHEN buttontype = '400211' THEN 1 ELSE 0 END) AS clicked_400211,\n    MAX(CASE WHEN buttontype = '400212' THEN 1 ELSE 0 END) AS clicked_400212\n  FROM dws_jordass_buttonpress_pre_di\n  WHERE dtstatdate BETWEEN '20241005' AND '20241104'\n  GROUP BY vplayerid\n), user_type_base AS (\n  SELECT\n    b.vplayerid,\n    CASE\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400211&400212'\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 0 THEN '400211'\n      WHEN COALESCE(f.clicked_400211, 0) = 0 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400212'\n      ELSE 'other'\n    END AS user_type\n  FROM base_players b\n  LEFT JOIN button_flags f\n    ON b.vplayerid = f.vplayerid\n), gender_latest AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN gender = 1 THEN 'male'\n      WHEN gender = 2 THEN 'female'\n      ELSE 'other'\n    END AS gender_bucket\n  FROM (\n    SELECT\n      vplayerid,\n      gender,\n      ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n    FROM dwd_jordass_playerlogin_hi\n    WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y-%m-%d') <= '2024-11-04'\n  ) t\n  WHERE rn = 1\n), arena_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS arena_active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20241005' AND '20241104'\n    AND platid = 255\n  GROUP BY vplayerid\n), park_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS park_active_days\n  FROM dws_jordass_matchlog_stat_di\n  WHERE dtstatdate BETWEEN '20241005' AND '20241104'\n    AND platid = 255\n  GROUP BY vplayerid\n), enriched AS (\n  SELECT\n    u.vplayerid,\n    u.user_type,\n    COALESCE(g.gender_bucket, 'other') AS gender_bucket,\n    COALESCE(park_active_days, 0) AS park_days,\n    COALESCE(arena_active_days, 0) AS arena_days\n  FROM user_type_base u\n  LEFT JOIN gender_latest g\n    ON u.vplayerid = g.vplayerid\n  LEFT JOIN park_active p\n    ON u.vplayerid = p.vplayerid\n  LEFT JOIN arena_active a\n    ON u.vplayerid = a.vplayerid\n), final AS (\n  SELECT\n    user_type,\n    gender_bucket,\n    CASE\n      WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN park_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS park_active_level,\n    CASE\n      WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN arena_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS arena_active_level,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM enriched\n  GROUP BY user_type, gender_bucket,\n           CASE\n             WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN park_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END,\n           CASE\n             WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN arena_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END\n)\nSELECT\n  user_type,\n  gender_bucket,\n  park_active_level,\n  arena_active_level,\n  user_cnt\nFROM final\nORDER BY user_type, gender_bucket, park_active_level, arena_active_level\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nWITH base_players AS (\n  SELECT DISTINCT vplayerid\n  FROM dws_jordass_login_di\n  WHERE dtstatdate > '20241005'\n    AND platid = 255\n), button_flags AS (\n  SELECT\n    vplayerid,\n    MAX(CASE WHEN buttontype = '400211' THEN 1 ELSE 0 END) AS clicked_400211,\n    MAX(CASE WHEN buttontype = '400212' THEN 1 ELSE 0 END) AS clicked_400212\n  FROM dws_jordass_buttonpress_pre_di\n  WHERE dtstatdate BETWEEN '20241005' AND '20241104'\n  GROUP BY vplayerid\n), user_type_base AS (\n  SELECT\n    b.vplayerid,\n    CASE\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400211&400212'\n      WHEN COALESCE(f.clicked_400211, 0) = 1 AND COALESCE(f.clicked_400212, 0) = 0 THEN '400211'\n      WHEN COALESCE(f.clicked_400211, 0) = 0 AND COALESCE(f.clicked_400212, 0) = 1 THEN '400212'\n      ELSE 'other'\n    END AS user_type\n  FROM base_players b\n  LEFT JOIN button_flags f\n    ON b.vplayerid = f.vplayerid\n), gender_latest AS (\n  SELECT\n    vplayerid,\n    CASE\n      WHEN gender = 1 THEN 'male'\n      WHEN gender = 2 THEN 'female'\n      ELSE 'other'\n    END AS gender_bucket\n  FROM (\n    SELECT\n      vplayerid,\n      gender,\n      ROW_NUMBER() OVER (PARTITION BY vplayerid ORDER BY dteventtime DESC) AS rn\n    FROM dwd_jordass_playerlogin_hi\n    WHERE DATE_FORMAT(CAST(dteventtime AS DATETIME), '%Y-%m-%d') <= '2024-11-04'\n  ) t\n  WHERE rn = 1\n), arena_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS arena_active_days\n  FROM dws_jordass_login_di\n  WHERE dtstatdate BETWEEN '20241005' AND '20241104'\n    AND platid = 255\n  GROUP BY vplayerid\n), park_active AS (\n  SELECT\n    vplayerid,\n    COUNT(DISTINCT dtstatdate) AS park_active_days\n  FROM dws_jordass_matchlog_stat_di\n  WHERE dtstatdate BETWEEN '20241005' AND '20241104'\n    AND platid = 255\n  GROUP BY vplayerid\n), enriched AS (\n  SELECT\n    u.vplayerid,\n    u.user_type,\n    COALESCE(g.gender_bucket, 'other') AS gender_bucket,\n    COALESCE(park_active_days, 0) AS park_days,\n    COALESCE(arena_active_days, 0) AS arena_days\n  FROM user_type_base u\n  LEFT JOIN gender_latest g\n    ON u.vplayerid = g.vplayerid\n  LEFT JOIN park_active p\n    ON u.vplayerid = p.vplayerid\n  LEFT JOIN arena_active a\n    ON u.vplayerid = a.vplayerid\n), final AS (\n  SELECT\n    user_type,\n    gender_bucket,\n    CASE\n      WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN park_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS park_active_level,\n    CASE\n      WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n      WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n      WHEN arena_days >= 16 THEN 'heavy'\n      ELSE 'other'\n    END AS arena_active_level,\n    COUNT(DISTINCT vplayerid) AS user_cnt\n  FROM enriched\n  GROUP BY user_type, gender_bucket,\n           CASE\n             WHEN park_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN park_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN park_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END,\n           CASE\n             WHEN arena_days BETWEEN 1 AND 4 THEN 'light'\n             WHEN arena_days BETWEEN 5 AND 15 THEN 'medium'\n             WHEN arena_days >= 16 THEN 'heavy'\n             ELSE 'other'\n           END\n)\nSELECT\n  user_type,\n  gender_bucket,\n  park_active_level,\n  arena_active_level,\n  user_cnt\nFROM final\nORDER BY user_type, gender_bucket, park_active_level, arena_active_level\n) AS final_query;", "meta": {"origin": "sql_50", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
{"sql_id": "sql_56_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】时间：2024.01.28-2024.02.27\n每日新增用户的LTV，LTV1~LTV10\n输出：注册日期(20240128、20240129、...、20240227)、新进用户数、LTV1、LTV3、LTV7、LTV14、LTV30、LTV60、LTV90、LTV180\n【表】dws_jordass_water_di, dws_jordass_login_df\n【口径】LTV（Life Time Value，用户生命周期价值）\n从注册日起，到第 N-1 天为止，这批新用户累计产生的总流水 ÷ 这批新用户的总人数。\n单位：元/人，衡量“每个新注册用户在 N 天内平均贡献了多少收入”。\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "select\n    register_date,\n    count(distinct vplayerid) as new_user_cnt,\n    round(sum(case when datediff_pay < 1 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv1,\n    round(sum(case when datediff_pay < 3 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv3,\n    round(sum(case when datediff_pay < 7 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv7,\n    round(sum(case when datediff_pay < 14 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv14,\n    round(sum(case when datediff_pay < 30 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv30,\n    round(sum(case when datediff_pay < 60 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv60,\n    round(sum(case when datediff_pay < 90 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv90,\n    round(sum(case when datediff_pay < 180 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv180\nfrom (\n    select\n        s1.register_date,\n        s1.vplayerid,\n        s2.pay_date,\n        datediff(s2.pay_date, s1.register_date) as datediff_pay,\n        sum(s2.pay_amount) as sum_pay_amount\n    from (\n        select\n            distinct dregdate as register_date,\n            vplayerid\n        from dws_jordass_login_df\n        where dtstatdate = '20240227'\n          and platid = 255\n          and dregdate >= '20240128' and dregdate <= '20240227'\n    ) s1\n    left join (\n        select\n            dtstatdate as pay_date,\n            vplayerid,\n            sum(imoney/100) as pay_amount\n        from dws_jordass_water_di\n        where dtstatdate >= '20240128' and dtstatdate <= date_add('20240227', 179)\n          and platid = 255\n        group by dtstatdate, vplayerid\n    ) s2 on s1.vplayerid = s2.vplayerid\n    group by s1.register_date, s1.vplayerid, s2.pay_date\n) base\ngroup by register_date;"}], "rejected": "select\n    register_date,\n    count(distinct vplayerid) as new_user_cnt,\n    round(sum(case when datediff_pay < 1 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv1,\n    round(sum(case when datediff_pay < 3 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv3,\n    round(sum(case when datediff_pay < 7 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv7,\n    round(sum(case when datediff_pay < 14 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv14,\n    round(sum(case when datediff_pay < 30 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv30,\n    round(sum(case when datediff_pay < 60 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv60,\n    round(sum(case when datediff_pay < 90 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv90,\n    round(sum(case when datediff_pay < 180 then sum_pay_amount else 0 end) / count(distinct vplayerid), 2) as ltv180\nfrom (\n    select\n        s1.register_date,\n        s1.vplayerid,\n        s2.pay_date,\n        datediff(s2.pay_date, s1.register_date) as datediff_pay,\n        sum(s2.pay_amount) as sum_pay_amount\n    from (\n        select\n            distinct dregdate as register_date,\n            vplayerid\n        from dws_jordass_login_df\n        where dtstatdate = '20240227'\n          and platid = 255\n          and dregdate >= '20240128' and dregdate <= '20240227'\n    ) s1\n    left join (\n        select\n            dtstatdate as pay_date,\n            vplayerid,\n            sum(imoney/100) as pay_amount\n        from dws_jordass_water_di\n        where dtstatdate >= '20240128' and dtstatdate <= date_add('20240227', 179)\n          and platid = 255\n        group by dtstatdate, vplayerid\n    ) s2 on s1.vplayerid = s2.vplayerid\n    group by s1.register_date, s1.vplayerid, s2.pay_date\n) base\ngroup by register_date;", "meta": {"origin": "sql_56", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_23_v2", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2025年3月24日至2025年3月30日，至少完成过一场对局，且渠道登录的用户qq\n输出:qq\n【表】dws_argothek_oss_login_di, dim_argothek_gplayerid2qqwxid_df, dwd_argothek_playermatchstats_hi, dim_argothek_gplayerid_vroleid_df\n【口径】渠道筛选条件：iloginway = 3\n用户ID筛选swxid_type = \"qq\" -- 筛选swxid_type为\"qq\"\n可选过滤：平台筛选可按需求追加。"}, {"role": "assistant", "content": "with channel_login as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250328 and 20250403\n    and iloginway = 3\n),\nrole_map as (\n  select\n    vroleid,\n    gplayerid\n  from (\n    select\n      vroleid,\n      iuserid as gplayerid,\n      row_number() over(partition by vroleid order by dtstatdate desc) as rn\n    from dim_argothek_gplayerid_vroleid_df\n    where dtstatdate <= '20250403'\n  ) t\n  where rn = 1\n),\nmatch_player as (\n  select distinct rm.gplayerid\n  from dwd_argothek_playermatchstats_hi s\n  join role_map rm on s.vroleid = rm.vroleid\n  where substr(s.tdbank_imp_date, 1, 8) between '20250328' and '20250403'\n    and coalesce(s.ismatchcompleted, 1) = 1\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250403'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom match_player mp\njoin channel_login cl on mp.gplayerid = cl.iuserid\njoin qq_map q on mp.gplayerid = q.iuserid\norder by qq;"}], "rejected": "with channel_login as (\n  select distinct iuserid\n  from dws_argothek_oss_login_di\n  where statis_date between 20250328 and 20250403\n    and iloginway = 3\n),\nrole_map as (\n  select\n    vroleid,\n    gplayerid\n  from (\n    select\n      vroleid,\n      iuserid as gplayerid,\n      row_number() over(partition by vroleid order by dtstatdate desc) as rn\n    from dim_argothek_gplayerid_vroleid_df\n    where dtstatdate <= '20250403'\n  ) t\n  where rn = 1\n),\nmatch_player as (\n  select distinct rm.gplayerid\n  from dwd_argothek_playermatchstats_hi s\n  join role_map rm on s.vroleid = rm.vroleid\n  where substr(s.tdbank_imp_date, 1, 8) > '20250328'\n    and coalesce(s.ismatchcompleted, 1) = 1\n),\nqq_map as (\n  select iuserid, suserid\n  from dim_argothek_gplayerid2qqwxid_df\n  where dtstatdate = '20250403'\n    and swxid_type = 'qq'\n    and suserid is not null\n)\nselect distinct q.suserid as qq\nfrom match_player mp\njoin channel_login cl on mp.gplayerid = cl.iuserid\njoin qq_map q on mp.gplayerid = q.iuserid\norder by qq;", "meta": {"origin": "sql_23", "scenario": "month_end", "filter_variant": "loose", "structure_variant": "original"}}
{"sql_id": "sql_44_v1", "result": [], "conversations": [{"role": "system", "content": "你是资深数据分析工程师。返回可执行 SQL，遵守口径：所有日期使用字符串 YYYYMMDD，字段名保持题面一致，如需 CTE 请清晰命名。"}, {"role": "user", "content": "【题目】统计2024.01.01-2024.12.31期间，付费用户的付费区间对应的付费人数和付费金额\n输出：付费区间(小R、中R、大R、超R、未知)、付费人数、付费金额（元）\n\n付费区间：小R小于等于12，中R(12,60]，大R(60,180]，超R(180+)\n【表】dws_jordass_water_di\n【口径】"}, {"role": "assistant", "content": "SELECT final_query.*\nFROM (\nwith user_pay as (\n  select\n    vplayerid,\n    sum(imoney) / 100.0 as pay_amount\n  from dws_jordass_water_di\n  where dtstatdate between '20240106' and '20250105'\n  group by vplayerid\n),\nfiltered as (\n  select *\n  from user_pay\n  where pay_amount > 0\n)\nselect\n  case\n    when pay_amount <= 12 then '小R'\n    when pay_amount <= 60 then '中R'\n    when pay_amount <= 180 then '大R'\n    when pay_amount > 180 then '超R'\n    else '未知'\n  end as pay_segment,\n  count(*) as user_cnt,\n  round(sum(pay_amount), 2) as pay_amount\nfrom filtered\ngroup by pay_segment\norder by pay_segment\n) AS final_query;"}], "rejected": "SELECT final_query.*\nFROM (\nwith user_pay as (\n  select\n    vplayerid,\n    sum(imoney) / 100.0 as pay_amount\n  from dws_jordass_water_di\n  where dtstatdate > '20240106'\n  group by vplayerid\n),\nfiltered as (\n  select *\n  from user_pay\n  where pay_amount > 0\n)\nselect\n  case\n    when pay_amount <= 12 then '小R'\n    when pay_amount <= 60 then '中R'\n    when pay_amount <= 180 then '大R'\n    when pay_amount > 180 then '超R'\n    else '未知'\n  end as pay_segment,\n  count(*) as user_cnt,\n  round(sum(pay_amount), 2) as pay_amount\nfrom filtered\ngroup by pay_segment\norder by pay_segment\n) AS final_query;", "meta": {"origin": "sql_44", "scenario": "weekend_saturday", "filter_variant": "expanded", "structure_variant": "wrapped"}}
